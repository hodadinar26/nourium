<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0A0F1F">
    <meta name="description" content="Nourium ‚Äî ŸÜÿ∏ÿßŸÖ ÿ™ÿ±ŸÉŸäÿ≤ ÿπŸÑŸÖŸä ŸÑÿ∑ÿßŸÑÿ® ÿßŸÑÿ∑ÿ®. Focus. Discipline. Rise.">
    <title>Nourium | Focus ¬∑ Discipline ¬∑ Rise</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=DM+Sans:wght@300;400;600;700&family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       NOURIUM v1.0 ‚Äî Calm Interface ¬∑ Deep System
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    :root {
        /* Nourium v1.0 ‚Äî Cool Sky System (Light Mode) */
        --primary:      #1D4ED8;
        --primary-mid:  #2563EB;
        --primary-soft: #DBEAFE;
        --accent:       #38BDF8;
        --accent-light: #7DD3FC;
        --danger:       #DC2626;
        --success:      #059669;
        --break:        #6366F1;

        --bg:           #F4F9FF;
        --card-bg:      #FFFFFF;
        --text:         #0F172A;
        --text-muted:   #475569;
        --border:       #E0ECFF;

        /* Unified radius */
        --radius:       16px;

        /* Minimal shadows */
        --shadow-xs:    0 1px 3px rgba(29,78,216,0.06);
        --shadow-sm:    0 2px 8px rgba(29,78,216,0.10);
        --shadow:       0 4px 16px rgba(29,78,216,0.14);

        /* Beam glow ‚Äî use sparingly */
        --beam-glow:    0 0 30px rgba(99,102,241,0.25);
    }
    body.dark-mode {
        /* Nourium v1.0 ‚Äî Indigo Depth System (Dark Mode) */
        --primary:      #3B82F6;
        --primary-mid:  #60A5FA;
        --primary-soft: #16204D;
        --accent:       #6366F1;
        --accent-light: rgba(99,102,241,0.25);
        --bg:           #0A0F1F;
        --card-bg:      #11183A;
        --text:         #E6EDFF;
        --text-muted:   #A5B4FC;
        --border:       #24306B;
        --shadow-xs:    0 1px 3px rgba(0,0,0,0.4);
        --shadow-sm:    0 2px 8px rgba(0,0,0,0.5);
        --shadow:       0 4px 16px rgba(0,0,0,0.6);
        --beam-glow:    0 0 30px rgba(99,102,241,0.25);
    }

    /* ‚îÄ‚îÄ Reset ‚îÄ‚îÄ */
    * { box-sizing: border-box; margin: 0; padding: 0;
        font-family: 'Tajawal', sans-serif;
        -webkit-tap-highlight-color: transparent; }

    body {
        background: var(--bg);
        background-image: linear-gradient(135deg, #F4F9FF 0%, #DBEAFE 40%, #93C5FD 75%, #38BDF8 100%);
        background-attachment: fixed;
        color: var(--text);
        padding-bottom: 72px;
        overflow-x: hidden;
        transition: background 0.3s, color 0.3s;
    }
    body.dark-mode {
        background: #0A0F1F;
        background-image: linear-gradient(135deg, #0A0F1F 0%, #11183A 40%, #1E2A78 75%, #6366F1 100%);
        background-attachment: fixed;
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    header {
        background: var(--card-bg);
        padding: 12px 18px;
        display: flex; justify-content: space-between; align-items: center;
        position: sticky; top: 0; z-index: 100;
        border-bottom: 1px solid var(--border);
        box-shadow: var(--shadow-xs);
    }
    .logo { display: flex; align-items: center; gap: 9px; cursor: default; }
    .logo-mark {
        width: 34px; height: 34px;
        background: var(--primary);
        border-radius: 10px;
        display: flex; align-items: center; justify-content: center;
        flex-shrink: 0;
    }
    .logo-mark svg { width: 20px; height: 20px; }
    .logo-wordmark { font-weight: 800; font-size: 1.2rem; letter-spacing: -0.5px; color: var(--primary); }
    .logo-wordmark em { font-style: normal; color: var(--accent); }
    .header-actions { display: flex; gap: 8px; align-items: center; }
    .btn-icon {
        background: none; border: none;
        color: var(--text-muted); font-size: 1.05rem;
        cursor: pointer; padding: 7px; border-radius: 9px;
        transition: background 0.2s, color 0.2s;
    }
    .btn-icon:hover { background: var(--primary-soft); color: var(--primary); }

    /* ‚îÄ‚îÄ Side Panel ‚îÄ‚îÄ */
    .side-panel { position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 200;
        opacity: 0; visibility: hidden; transition: 0.3s; }
    .side-panel.open { opacity: 1; visibility: visible; }
    .panel-content {
        position: absolute; top: 0; left: 0;
        width: 85%; max-width: 340px; height: 100%;
        background: var(--card-bg); padding: 20px;
        transform: translateX(-100%); transition: 0.3s cubic-bezier(.4,0,.2,1);
        overflow-y: auto; border-right: 1px solid var(--border);
        box-shadow: var(--shadow);
    }
    .side-panel.open .panel-content { transform: translateX(0); }
    .close-panel { float: left; font-size: 1.4rem; cursor: pointer;
        color: var(--text-muted); line-height: 1; transition: color 0.2s; }
    .close-panel:hover { color: var(--primary); }

    /* ‚îÄ‚îÄ Panel Tabs ‚îÄ‚îÄ */
    .panel-tabs {
        display: flex; gap: 6px; margin: 16px 0;
        background: var(--bg); border-radius: var(--radius);
        padding: 4px;
    }
    .panel-tab {
        flex: 1; padding: 8px; text-align: center;
        border-radius: 12px; cursor: pointer;
        font-size: 0.82rem; font-weight: 600;
        color: var(--text-muted); transition: all 0.2s;
        border: none; background: none; font-family: 'Tajawal', sans-serif;
    }
    .panel-tab.active {
        background: var(--card-bg); color: var(--primary);
        box-shadow: var(--shadow-xs);
    }
    .panel-tab-content { display: none; }
    .panel-tab-content.active { display: block; }

    /* ‚îÄ‚îÄ Level Card (Panel) ‚îÄ‚îÄ */
    .level-card {
        background: var(--primary);
        color: white; padding: 18px; border-radius: var(--radius);
        text-align: center; margin-bottom: 14px;
        box-shadow: var(--shadow-sm);
    }
    .level-badge { font-size: 2.4rem; margin-bottom: 6px; }
    .progress-bar { background: rgba(255,255,255,0.25); height: 6px; border-radius: 3px;
        margin-top: 10px; overflow: hidden; }
    .progress-fill { background: var(--accent-light);
        height: 100%; width: 0%; transition: width 0.6s ease; }

    /* ‚îÄ‚îÄ Streak Row ‚îÄ‚îÄ */
    .streak-row {
        display: flex; align-items: center; justify-content: space-between;
        background: var(--bg); border-radius: var(--radius);
        padding: 12px 16px; margin-bottom: 14px;
        border: 1px solid var(--border);
    }
    .streak-count { font-size: 1.8rem; font-weight: 800; color: var(--primary); }

    /* ‚îÄ‚îÄ Sections ‚îÄ‚îÄ */
    .section { display: none; padding: 16px; animation: fadeIn 0.2s ease; }
    .section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); }
                        to   { opacity: 1; transform: translateY(0); } }

    /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
    .card {
        background: var(--card-bg); border-radius: var(--radius);
        padding: 18px 20px; margin-bottom: 14px;
        box-shadow: var(--shadow-xs); border: 1px solid var(--border);
        transition: box-shadow 0.2s;
    }
    .card:hover { box-shadow: var(--shadow-sm); }

    /* ‚îÄ‚îÄ Typography ‚îÄ‚îÄ */
    h2 { font-size: 1rem; margin-bottom: 14px; color: var(--text);
        display: flex; align-items: center; gap: 8px;
        font-weight: 700; }
    h2 i { color: var(--primary-mid); font-size: 0.9rem; }

    /* ‚îÄ‚îÄ Timer ‚Äî Hero Element ‚îÄ‚îÄ */
    .timer-hero {
        text-align: center; padding: 28px 0 20px;
    }
    .timer-display {
        font-size: 5.5rem; font-weight: 800; text-align: center;
        font-variant-numeric: tabular-nums;
        letter-spacing: 4px; color: var(--primary);
        transition: color 0.3s;
        line-height: 1;
    }
    .timer-display.running { color: var(--accent); }
    .timer-display.break-mode { color: var(--break); }

    .timer-mode { text-align: center; margin-bottom: 14px; display: flex; justify-content: center; gap: 8px; }
    .mode-btn {
        padding: 7px 20px; border: 1.5px solid var(--border);
        background: var(--bg); border-radius: 50px; 
        cursor: pointer; color: var(--text-muted); font-family: 'Tajawal', sans-serif;
        font-size: 0.88rem; font-weight: 600; transition: all 0.2s;
    }
    .mode-btn.active { border-color: var(--primary-mid);
        background: var(--primary); color: white; }
    .mode-btn.break.active { background: var(--break); border-color: var(--break); }

    .duration-selector { display: flex; justify-content: center; gap: 7px;
        margin-bottom: 20px; flex-wrap: wrap; }
    .dur-btn {
        padding: 6px 14px; border: 1.5px solid var(--border);
        background: var(--bg); border-radius: 50px;
        cursor: pointer; color: var(--text-muted); font-weight: 600;
        font-family: 'Tajawal', sans-serif; font-size: 0.85rem; transition: all 0.2s;
    }
    .dur-btn.active { background: var(--primary-mid); color: white;
        border-color: var(--primary-mid); }

    .timer-subject-badge { display: inline-block; padding: 4px 12px;
        border-radius: 50px; font-size: 0.82rem; color: white;
        margin: 0 auto 12px; text-align: center; }
    .timer-controls { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }

    /* ‚îÄ‚îÄ Main Start Button ‚îÄ‚îÄ */
    .btn-start-main {
        padding: 16px 48px; border-radius: 50px; font-size: 1.15rem;
        font-weight: 800; border: none; cursor: pointer;
        background: var(--primary); color: white;
        box-shadow: var(--beam-glow), var(--shadow-sm);
        transition: transform 0.15s, box-shadow 0.2s;
        font-family: 'Tajawal', sans-serif;
    }
    .btn-start-main:hover { transform: translateY(-1px); box-shadow: var(--beam-glow), var(--shadow); }
    .btn-start-main:active { transform: scale(0.96) !important; }

    /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
    .btn {
        border: none; padding: 11px 22px; border-radius: 50px;
        font-weight: 700; cursor: pointer; font-size: 0.92rem;
        transition: transform 0.15s, box-shadow 0.2s;
        font-family: 'Tajawal', sans-serif;
    }
    .btn-primary {
        background: var(--primary); color: #fff;
        box-shadow: var(--shadow-sm);
    }
    .btn-primary:hover { box-shadow: var(--shadow); transform: translateY(-1px); }
    .btn-resume  { background: var(--success); color: #fff; }
    .btn-break   { background: var(--break); color: #fff; }
    .btn-secondary { background: var(--bg); color: var(--text);
        border: 1.5px solid var(--border); }
    .btn-secondary:hover { border-color: var(--primary-mid); color: var(--primary); }
    .btn-danger  { background: #FEE2E2; color: #DC2626; border: 1.5px solid #FECACA; }
    .btn:active  { transform: scale(0.94) !important; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

    /* ‚îÄ‚îÄ Accordion ‚îÄ‚îÄ */
    .accordion {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        margin-bottom: 10px;
        overflow: hidden;
    }
    .accordion-header {
        display: flex; justify-content: space-between; align-items: center;
        padding: 14px 18px; cursor: pointer;
        font-weight: 700; font-size: 0.95rem;
        color: var(--text); user-select: none;
        transition: background 0.2s;
    }
    .accordion-header:hover { background: var(--primary-soft); }
    .accordion-arrow {
        color: var(--text-muted); font-size: 0.8rem;
        transition: transform 0.25s;
    }
    .accordion.open .accordion-arrow { transform: rotate(90deg); }
    .accordion-body {
        max-height: 0; overflow: hidden;
        transition: max-height 0.3s ease, padding 0.2s;
        padding: 0 18px;
    }
    .accordion.open .accordion-body {
        max-height: 1000px;
        padding: 0 18px 16px;
    }

    /* ‚îÄ‚îÄ Inputs ‚îÄ‚îÄ */
    input, select, textarea {
        width: 100%; padding: 11px 13px;
        border: 1.5px solid var(--border);
        border-radius: 12px; background: var(--bg);
        color: var(--text); outline: none; margin-bottom: 10px;
        font-family: 'Tajawal', sans-serif; font-size: 0.97rem;
        transition: border-color 0.2s;
    }
    input:focus, select:focus, textarea:focus {
        border-color: var(--primary-mid);
        box-shadow: 0 0 0 3px rgba(99,102,241,0.12);
    }
    input[type="color"] { width: 48px; height: 40px; padding: 3px;
        border: none; cursor: pointer; border-radius: 8px; }
    input[type="date"], input[type="number"] { direction: ltr; text-align: right; }
    select { appearance: auto; }

    /* ‚îÄ‚îÄ Subject Tags ‚îÄ‚îÄ */
    .subject-tags { display: flex; flex-wrap: wrap; gap: 7px; margin-bottom: 12px; }
    .subject-tag { padding: 5px 12px; border-radius: 50px; font-size: 0.83rem;
        color: white; display: flex; align-items: center; gap: 7px; }
    .subject-tag .remove-sub { cursor: pointer; opacity: 0.75; transition: opacity 0.2s; }
    .subject-tag .remove-sub:hover { opacity: 1; }

    /* ‚îÄ‚îÄ Todo Items ‚îÄ‚îÄ */
    .todo-item {
        background: var(--card-bg); padding: 13px 15px;
        border-radius: var(--radius); margin-bottom: 9px;
        display: flex; justify-content: space-between; align-items: center;
        border: 1px solid var(--border);
        border-right: 3px solid var(--primary-mid);
        transition: opacity 0.3s, box-shadow 0.2s;
    }
    .todo-item:hover { box-shadow: var(--shadow-xs); }
    .todo-item.completed { opacity: 0.5; border-right-color: var(--success); }
    .todo-item.completed .task-text { text-decoration: line-through; }
    .task-info { flex: 1; cursor: pointer; }
    .task-subject { padding: 2px 8px; border-radius: 50px; font-size: 0.7rem;
        color: white; margin-left: 6px; display: inline-block; }

    /* ‚îÄ‚îÄ Weekly Chart ‚îÄ‚îÄ */
    .chart-container { margin: 16px 0; display: flex; justify-content: space-around;
        align-items: flex-end; height: 130px; gap: 5px; }
    .chart-bar-wrapper { display: flex; flex-direction: column; align-items: center;
        flex: 1; height: 100%; justify-content: flex-end; }
    .chart-bar { width: 100%; max-width: 36px; background: var(--primary-mid);
        border-radius: 5px 5px 0 0; position: relative;
        transition: height 0.5s ease; min-height: 4px; opacity: 0.7; }
    .chart-bar.today-bar { background: var(--accent); opacity: 1; }
    .chart-bar:hover { opacity: 1; }
    .chart-value { position: absolute; top: -18px; left: 50%;
        transform: translateX(-50%); font-size: 0.6rem; font-weight: 700;
        color: var(--primary); white-space: nowrap; }
    .chart-label { text-align: center; font-size: 0.65rem;
        color: var(--text-muted); margin-top: 4px; }

    /* ‚îÄ‚îÄ Stats Grid ‚îÄ‚îÄ */
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .stat-card {
        background: var(--bg); padding: 14px; border-radius: var(--radius);
        text-align: center; border: 1px solid var(--border);
    }
    .stat-val { font-size: 1.5rem; font-weight: 800; color: var(--primary); }
    .stat-label { font-size: 0.68rem; color: var(--text-muted); margin-top: 4px; }

    /* ‚îÄ‚îÄ Calendar ‚îÄ‚îÄ */
    .calendar-header { display: flex; justify-content: space-between;
        align-items: center; margin-bottom: 12px; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; }
    .calendar-day-name { text-align: center; font-size: 0.65rem;
        color: var(--text-muted); padding: 4px 0; }
    .calendar-day { aspect-ratio: 1; display: flex; align-items: center;
        justify-content: center; font-size: 0.8rem; border-radius: 8px;
        background: var(--bg); position: relative; border: 1px solid transparent;
        transition: background 0.2s; }
    .calendar-day.today { border: 2px solid var(--primary-mid);
        font-weight: 800; background: var(--primary-soft); }
    .calendar-day.has-study::after { content: ''; position: absolute;
        bottom: 2px; left: 50%; transform: translateX(-50%);
        width: 4px; height: 4px; background: var(--success); border-radius: 50%; }
    .calendar-day.has-study.many::after { background: var(--accent); }
    .calendar-day.streak-day { background: rgba(29,78,216,0.08);
        border-color: rgba(29,78,216,0.3); }
    .calendar-day.exam-day { background: rgba(220,38,38,0.08);
        border-color: rgba(220,38,38,0.3); font-weight: 700; }
    .calendar-day.exam-day::before { content: 'üìå'; position: absolute;
        top: -2px; right: -2px; font-size: 0.5rem; }

    /* ‚îÄ‚îÄ Insight Cards ‚îÄ‚îÄ */
    .insight-card { padding: 13px 16px; border-radius: var(--radius); margin-bottom: 11px;
        border: 1px solid var(--border); }
    .insight-card.green   { background: rgba(5,150,105,0.08); color: var(--text); border-color: rgba(5,150,105,0.25); }
    .insight-card.warning { background: rgba(99,102,241,0.08); color: var(--text); border-color: rgba(99,102,241,0.25); }
    .insight-card.streak-insight { background: rgba(99,102,241,0.08); color: var(--text); border-color: rgba(99,102,241,0.25); }
    .insight-card.info    { background: var(--primary-soft); color: var(--text); border-color: var(--border); }
    .insight-card.purple  { background: rgba(124,58,237,0.08); color: var(--text); border-color: rgba(124,58,237,0.2); }
    .insight-card.danger  { background: rgba(220,38,38,0.08); color: var(--text); border-color: rgba(220,38,38,0.2); }
    .insight-title { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px; }
    .insight-value { font-size: 0.97rem; font-weight: 700; }

    /* ‚îÄ‚îÄ Bottom Nav ‚îÄ‚îÄ */
    .bottom-nav {
        position: fixed; bottom: 0; width: 100%;
        background: var(--card-bg);
        display: flex; justify-content: space-around;
        padding: 8px 0 12px;
        border-top: 1px solid var(--border);
        box-shadow: var(--shadow-xs);
        z-index: 90;
    }
    .nav-item { text-align: center; color: var(--text-muted); font-size: 0.54rem;
        cursor: pointer; padding: 4px 6px; border-radius: 9px;
        transition: color 0.2s;
        display: flex; flex-direction: column; align-items: center; gap: 3px; }
    .nav-item i { font-size: 1.1rem; display: block; }
    .nav-item.active { color: var(--primary-mid); }
    .nav-item:active { transform: scale(0.88); }

    /* ‚îÄ‚îÄ Notification Toast ‚îÄ‚îÄ */
    .notification { position: fixed; top: 20px; left: 50%;
        transform: translateX(-50%); color: white;
        padding: 10px 22px; border-radius: 50px; z-index: 1000;
        animation: slideDown 0.3s forwards;
        box-shadow: var(--shadow);
        font-weight: 600; white-space: nowrap;
        max-width: 90vw; text-align: center; font-size: 0.88rem; }
    @keyframes slideDown { from{top:-60px;opacity:0} to{top:20px;opacity:1} }
    .notification.fade-out { animation: slideUp 0.3s forwards; }
    @keyframes slideUp { from{top:20px;opacity:1} to{top:-60px;opacity:0} }

    /* ‚îÄ‚îÄ Form helpers ‚îÄ‚îÄ */
    .add-subject-form { display: flex; gap: 8px; align-items: center; margin-bottom: 12px; }
    .add-subject-form input[type="text"] { flex: 1; margin-bottom: 0; }
    .add-subject-form input[type="color"] { margin-bottom: 0; flex-shrink: 0; }
    .subject-select { margin-bottom: 12px; }
    .goal-progress-wrapper { margin-top: 8px; }
    .goal-bar-bg { background: var(--border); height: 6px; border-radius: 3px;
        overflow: hidden; margin-top: 5px; }
    .goal-bar-fill { background: var(--primary-mid);
        height: 100%; border-radius: 3px; transition: width 0.5s; }
    .goal-label { display: flex; justify-content: space-between;
        font-size: 0.76rem; color: var(--text-muted); }
    .goal-input-row { display: flex; gap: 10px; align-items: center; }
    .goal-input-row input { flex: 1; margin-bottom: 0; }
    .empty-state { text-align: center; color: var(--text-muted); padding: 28px 0; }
    .empty-state i { font-size: 2.2rem; margin-bottom: 8px; display: block; opacity: 0.3; }

    /* ‚îÄ‚îÄ Review Items ‚îÄ‚îÄ */
    .review-item { background: var(--card-bg); border: 1px solid var(--border);
        border-right: 3px solid var(--primary-mid); border-radius: var(--radius);
        padding: 13px; margin-bottom: 9px;
        display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    .review-item.due-today { border-right-color: var(--danger); }
    .review-item.due-soon  { border-right-color: var(--accent); }
    .review-badge { padding: 3px 9px; border-radius: 50px; font-size: 0.7rem;
        font-weight: 700; color: white; white-space: nowrap; }
    .review-badge.overdue  { background: var(--danger); }
    .review-badge.today    { background: var(--accent); }
    .review-badge.upcoming { background: var(--primary-mid); }
    .review-badge.done     { background: var(--success); }
    .review-actions { display: flex; gap: 6px; flex-shrink: 0; }
    .review-btn { padding: 5px 10px; border-radius: 8px; font-size: 0.78rem;
        font-weight: 700; border: none; cursor: pointer;
        font-family: 'Tajawal', sans-serif; transition: 0.2s; }
    .review-btn:active { transform: scale(0.93); }
    .add-review-form { display: grid; gap: 8px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .form-row input, .form-row select { margin-bottom: 0; }

    /* ‚îÄ‚îÄ Exam Items ‚îÄ‚îÄ */
    .exam-item { background: var(--card-bg); border: 1px solid var(--border);
        border-radius: var(--radius); padding: 15px; margin-bottom: 12px;
        position: relative; overflow: hidden; }
    .exam-item::before { content: ''; position: absolute; top: 0; right: 0;
        width: 3px; height: 100%; background: var(--danger); }
    .exam-countdown { font-size: 2rem; font-weight: 800; color: var(--danger); line-height: 1; }
    .exam-countdown.safe { color: var(--success); }
    .exam-countdown.warn { color: var(--accent); }
    .exam-daily-hours { font-size: 1rem; font-weight: 700; color: var(--primary); margin-top: 4px; }
    .exam-detail { font-size: 0.76rem; color: var(--text-muted); margin-top: 3px; }
    .exam-header { display: flex; justify-content: space-between; align-items: flex-start; }
    .exam-name { font-weight: 700; font-size: 0.95rem; }
    .exam-progress-fill { height: 5px; border-radius: 3px;
        background: var(--primary-mid); transition: width 0.5s; }

    /* ‚îÄ‚îÄ Balance Chart ‚îÄ‚îÄ */
    .balance-chart { display: flex; gap: 7px; align-items: flex-end;
        height: 100px; margin: 12px 0; }
    .balance-bar-wrap { flex: 1; display: flex; flex-direction: column;
        align-items: center; justify-content: flex-end; height: 100%; }
    .balance-bar { width: 100%; border-radius: 5px 5px 0 0; min-height: 4px;
        position: relative; transition: height 0.5s ease; }
    .balance-bar .b-val { position: absolute; top: -16px; left: 50%;
        transform: translateX(-50%); font-size: 0.6rem; font-weight: 700; white-space: nowrap; }
    .balance-label { font-size: 0.58rem; text-align: center;
        margin-top: 4px; color: var(--text-muted); word-break: break-all; }
    .balance-score-card { border-radius: var(--radius); padding: 14px; margin-bottom: 12px; text-align: center;
        border: 1px solid var(--border); }
    .balance-score-card.excellent { background: rgba(5,150,105,0.08); }
    .balance-score-card.good      { background: var(--primary-soft); }
    .balance-score-card.fair      { background: rgba(99,102,241,0.08); }
    .balance-score-card.poor      { background: rgba(220,38,38,0.08); }
    .balance-score-num   { font-size: 2.5rem; font-weight: 800; color: var(--primary); }
    .balance-score-label { font-size: 0.88rem; color: var(--text-muted); }
    .balance-subject-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .balance-subject-name { font-size: 0.86rem; font-weight: 600; }
    .balance-subject-pct  { font-size: 0.78rem; color: var(--text-muted); }
    .balance-subject-bar-bg { flex: 1; height: 6px; background: var(--border);
        border-radius: 3px; margin: 0 10px; overflow: hidden; }
    .balance-subject-bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s; }
    .balance-alert { border-radius: 10px; padding: 9px 13px; margin-bottom: 7px;
        font-size: 0.82rem; display: flex; align-items: center; gap: 8px; }
    .balance-alert.over    { background: rgba(220,38,38,0.07); color:#991B1B; border: 1px solid rgba(220,38,38,0.15); }
    .balance-alert.under   { background: rgba(29,78,216,0.07); color:#1D4ED8; border: 1px solid rgba(29,78,216,0.15); }
    .balance-alert.perfect { background: rgba(5,150,105,0.07); color:#065F46; border: 1px solid rgba(5,150,105,0.15); }
    body.dark-mode .balance-alert.over    { color:#FCA5A5; }
    body.dark-mode .balance-alert.under   { color:#A5B4FC; }
    body.dark-mode .balance-alert.perfect { color:#6EE7B7; }

    /* ‚îÄ‚îÄ Drag & Drop ‚îÄ‚îÄ */
    .todo-item[draggable="true"] { cursor: grab; }
    .todo-item[draggable="true"]:active { cursor: grabbing; }
    .todo-item.drag-over {
        border-color: var(--accent) !important;
        background: rgba(56,189,248,0.05) !important;
        transform: scale(1.01);
    }
    .todo-item.dragging { opacity: 0.4; transform: scale(0.97); }
    .drag-handle { color: var(--text-muted); font-size: 1rem; padding: 0 8px 0 0;
        cursor: grab; flex-shrink: 0; opacity: 0.4; transition: opacity 0.2s; }
    .drag-handle:hover { opacity: 0.8; }

    /* ‚îÄ‚îÄ Lux Panel (simplified) ‚îÄ‚îÄ */
    .lux-panel {
        background: var(--primary);
        border-radius: var(--radius); padding: 18px 20px; margin-bottom: 14px;
        color: white; box-shadow: var(--shadow-sm);
    }
    /* Keep lux-N classes but remove glow animations */
    .lux-panel.lux-0 { background: var(--primary); }
    .lux-panel.lux-1 { background: var(--primary); }
    .lux-panel.lux-2 { background: var(--primary); }
    .lux-panel.lux-3 { background: linear-gradient(135deg, var(--primary), var(--primary-mid)); }
    .lux-panel.lux-4 { background: linear-gradient(135deg, var(--primary), var(--break)); }
    .lux-panel.lux-5 { background: linear-gradient(135deg, var(--primary), var(--break) 70%, var(--accent)); }
    .lux-aura { display: none; } /* removed */
    .lux-beam { display: none; } /* removed */
    .lux-label { font-size: 0.72rem; opacity: 0.8; margin-bottom: 4px; }
    .lux-title { font-size: 1.05rem; font-weight: 800; margin-bottom: 10px; }
    .lux-bar-track { background: rgba(255,255,255,0.2); height: 6px;
        border-radius: 3px; overflow: hidden; margin: 6px 0; }
    .lux-bar-fill { background: rgba(255,255,255,0.6);
        height: 100%; border-radius: 3px;
        transition: width 0.6s ease; }
    .lux-stats { display: flex; gap: 16px; flex-wrap: wrap; margin-top: 8px; }
    .lux-stat { text-align: center; }
    .lux-stat-val { font-size: 1.3rem; font-weight: 800; line-height: 1; }
    .lux-stat-label { font-size: 0.62rem; opacity: 0.75; margin-top: 2px; }

    /* ‚îÄ‚îÄ Storage Warning ‚îÄ‚îÄ */
    .storage-warning { background: rgba(220,38,38,0.07); border: 1px solid rgba(220,38,38,0.2);
        border-radius: 10px; padding: 9px 13px; margin-bottom: 10px;
        font-size: 0.8rem; color: var(--danger); display: flex; align-items: center; gap: 7px; }

    /* ‚îÄ‚îÄ Wake Lock Badge ‚îÄ‚îÄ */
    .wakelocked-badge { display: inline-flex; align-items: center; gap: 4px;
        padding: 3px 9px; background: rgba(5,150,105,0.1); color: var(--success);
        border-radius: 50px; font-size: 0.72rem; font-weight: 700;
        border: 1px solid rgba(5,150,105,0.25); margin-top: 7px; }

    /* ‚îÄ‚îÄ XP Limit badge ‚îÄ‚îÄ */
    .xp-cap-note { font-size: 0.7rem; color: var(--text-muted); margin-top: 4px; text-align: center; }

    /* ‚îÄ‚îÄ Share Modal ‚îÄ‚îÄ */
    .share-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.6);
        z-index: 500; display: flex; align-items: center; justify-content: center;
        padding: 20px; animation: fadeIn 0.2s ease;
    }
    .share-modal {
        background: var(--card-bg); border-radius: 20px; width: 100%; max-width: 360px;
        padding: 22px; border: 1px solid var(--border);
        box-shadow: var(--shadow);
    }
    .share-card-preview {
        border-radius: var(--radius); padding: 20px; margin-bottom: 16px; color: white; text-align: center;
        background: var(--primary); position: relative; overflow: hidden;
    }
    .share-logo { font-size: 0.78rem; opacity: 0.6; margin-bottom: 12px; letter-spacing: 2px; }
    .share-achievement { font-size: 2.6rem; margin-bottom: 7px; }
    .share-title { font-size: 1.05rem; font-weight: 800; margin-bottom: 3px; }
    .share-subtitle { font-size: 0.8rem; opacity: 0.8; }
    .share-stats-row { display: flex; justify-content: center; gap: 18px; margin-top: 14px; }
    .share-stat-item { text-align: center; }
    .share-stat-val { font-size: 1.3rem; font-weight: 800; }
    .share-stat-lbl { font-size: 0.58rem; opacity: 0.7; }
    .share-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 9px; }
    .share-btn {
        padding: 11px; border-radius: var(--radius); border: none; cursor: pointer;
        font-weight: 700; font-size: 0.85rem; font-family: 'Tajawal', sans-serif;
        display: flex; align-items: center; justify-content: center; gap: 5px;
        transition: transform 0.15s;
    }
    .share-btn:active { transform: scale(0.94); }
    .share-btn-copy { background: var(--primary-soft); color: var(--primary); border: 1px solid var(--border); }
    .share-btn-img  { background: var(--primary); color: white; }
    .share-btn-wa   { background: #25D366; color: white; }
    .share-btn-close{ background: var(--bg); color: var(--text); border: 1px solid var(--border); grid-column: 1/-1; }

    /* ‚îÄ‚îÄ Share FAB ‚îÄ‚îÄ */
    .share-fab {
        position: fixed; bottom: 82px; left: 16px;
        width: 46px; height: 46px; border-radius: 50%;
        background: var(--primary); color: white; border: none; cursor: pointer;
        box-shadow: var(--shadow-sm); z-index: 80;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.05rem; transition: transform 0.2s;
    }
    .share-fab:hover { transform: scale(1.08); }
    .share-fab:active { transform: scale(0.93); }

    /* ‚îÄ‚îÄ Quran Verse Card ‚îÄ‚îÄ */

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       üåô SPIRITUAL REGULATION SYSTEM
       ÿπÿßŸÑŸÖ ÿßŸÑÿ±Ÿàÿ≠ ‚Äî ÿ£ŸáÿØÿ£ÿå ÿ£ÿπŸÖŸÇÿå ÿ£ŸÉÿ´ÿ± ŸÖÿ≥ÿßÿ≠ÿ©
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    /* Custom calm palette */
    .spirit-world { --sp-deep: #0d1117; --sp-navy: #0f172a; --sp-indigo: #1e1b4b;
        --sp-mid: #312e81; --sp-soft: #4338ca; --sp-glow: rgba(99,102,241,0.12);
        --sp-text: #e0e7ff; --sp-muted: rgba(224,231,255,0.55); }

    #spiritual { background: var(--bg); padding: 0 0 100px; }

    /* ‚îÄ‚îÄ Hero Card ‚îÄ‚îÄ */

    .spirit-hero::before {
        content: ''; position: absolute; top: -80px; left: -60px;
        width: 260px; height: 260px; border-radius: 50%;
        background: radial-gradient(circle, rgba(99,102,241,0.07) 0%, transparent 70%);
    }
    .spirit-hero::after {
        content: ''; position: absolute; bottom: -40px; right: -30px;
        width: 180px; height: 180px; border-radius: 50%;
        background: radial-gradient(circle, rgba(167,139,250,0.06) 0%, transparent 70%);
    }
    .spirit-bismillah {
        font-size: 0.7rem; letter-spacing: 3px; color: rgba(199,210,254,0.5);
        text-align: center; margin-bottom: 16px; position: relative; z-index: 1;
        text-transform: uppercase;
    }
    .spirit-verse {
        font-size: 1.15rem; font-weight: 700; color: #e0e7ff;
        text-align: center; line-height: 1.8; margin-bottom: 8px;
        position: relative; z-index: 1; direction: rtl;
    }
    .spirit-verse-ref {
        font-size: 0.68rem; color: rgba(199,210,254,0.5);
        text-align: center; margin-bottom: 24px; position: relative; z-index: 1;
    }
    /* Serene pills row */
    .spirit-hero-pills {
        display: flex; gap: 8px; justify-content: center;
        flex-wrap: wrap; margin-bottom: 20px; position: relative; z-index: 1;
    }
    .spirit-hero-pill {
        background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1);
        border-radius: 50px; padding: 6px 14px; font-size: 0.72rem; font-weight: 700;
        color: rgba(224,231,255,0.8); cursor: default;
        display: flex; align-items: center; gap: 6px;
    }
    .spirit-hero-pill .dot {
        width: 7px; height: 7px; border-radius: 50%;
        background: #818cf8; animation: spiritPulse 2.4s ease-in-out infinite;
    }
    @keyframes spiritPulse {
        0%,100% { opacity: 1; transform: scale(1); }
        50%      { opacity: 0.4; transform: scale(0.7); }
    }
    /* Emergency button ‚Äî calm, full */
    .spirit-sos-btn {
        width: calc(100% - 0px); padding: 14px 20px; border: none; border-radius: 14px;
        background: rgba(239,68,68,0.1); border: 1.5px solid rgba(239,68,68,0.25);
        color: #fca5a5; font-size: 0.9rem; font-weight: 800;
        font-family: 'Tajawal', sans-serif; cursor: pointer;
        display: flex; align-items: center; justify-content: center; gap: 10px;
        transition: background 0.2s, transform 0.15s;
        position: relative; z-index: 1;
    }
    .spirit-sos-btn:hover  { background: rgba(239,68,68,0.18); }
    .spirit-sos-btn:active { transform: scale(0.97); }

    /* ‚îÄ‚îÄ Now Mode ‚Äî 4 action buttons ‚îÄ‚îÄ */
    .spirit-now-wrap { padding: 20px 20px 0; }
    .spirit-now-title {
        font-size: 0.68rem; font-weight: 800; letter-spacing: 2px;
        text-transform: uppercase; color: var(--text-muted);
        margin-bottom: 12px; display: flex; align-items: center; gap: 8px;
    }
    .spirit-now-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }
    .spirit-now-grid {
        display: grid; grid-template-columns: 1fr 1fr;
        gap: 10px; margin-bottom: 0;
    }
    .spirit-now-btn {
        background: var(--card-bg); border: 1px solid var(--border);
        border-radius: 16px; padding: 16px 14px;
        cursor: pointer; font-family: 'Tajawal', sans-serif;
        display: flex; flex-direction: column; align-items: flex-start;
        gap: 8px; transition: box-shadow 0.2s, transform 0.15s, border-color 0.2s;
        box-shadow: var(--shadow-xs); text-align: right;
    }
    .spirit-now-btn:hover  { box-shadow: var(--shadow-sm); transform: translateY(-2px); border-color: var(--primary-mid); }
    .spirit-now-btn:active { transform: scale(0.96); }
    .spirit-now-icon { font-size: 1.5rem; line-height: 1; }
    .spirit-now-label { font-size: 0.78rem; font-weight: 800; color: var(--text); line-height: 1.3; }
    .spirit-now-sub   { font-size: 0.62rem; color: var(--text-muted); }

    /* ‚îÄ‚îÄ Dua Categories (Mood-based) ‚îÄ‚îÄ */
    .spirit-duas-wrap { padding: 20px 20px 0; }
    .spirit-cat-scroll {
        display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px;
        margin-bottom: 14px; scrollbar-width: none;
    }
    .spirit-cat-scroll::-webkit-scrollbar { display: none; }
    .spirit-cat-pill {
        white-space: nowrap; padding: 8px 14px; border-radius: 50px;
        border: 1.5px solid var(--border); background: var(--card-bg);
        font-size: 0.75rem; font-weight: 700; color: var(--text-muted);
        cursor: pointer; font-family: 'Tajawal', sans-serif;
        transition: all 0.2s; flex-shrink: 0;
    }
    .spirit-cat-pill.active {
        border-color: var(--primary-mid); background: var(--primary-soft);
        color: var(--primary);
    }
    .spirit-cat-pill:hover { border-color: var(--primary-mid); }
    /* Dua card ‚Äî calmer version */
    .sdua-card {
        background: var(--card-bg); border: 1px solid var(--border);
        border-radius: 14px; padding: 16px 18px; margin-bottom: 10px;
        position: relative; overflow: hidden;
        transition: box-shadow 0.2s;
    }
    .sdua-card:hover { box-shadow: var(--shadow-sm); }
    .sdua-accent { position: absolute; top: 0; right: 0; width: 3px; height: 100%; }
    .sdua-emoji  { font-size: 1.2rem; margin-bottom: 8px; }
    .sdua-text   {
        font-size: 0.95rem; font-weight: 700; color: var(--text);
        line-height: 1.8; direction: rtl; margin-bottom: 10px;
    }
    .sdua-actions { display: flex; gap: 8px; }
    .sdua-btn {
        background: var(--bg); border: 1px solid var(--border);
        border-radius: 50px; padding: 5px 12px;
        font-size: 0.68rem; font-weight: 700; color: var(--text-muted);
        cursor: pointer; font-family: 'Tajawal', sans-serif;
        transition: background 0.2s, color 0.2s;
        display: flex; align-items: center; gap: 4px;
    }
    .sdua-btn:hover { background: var(--primary-soft); color: var(--primary); border-color: var(--primary-mid); }
    .sdua-btn.fav-on { background: rgba(245,158,11,0.1); color: #f59e0b; border-color: rgba(245,158,11,0.3); }

    /* ‚úÖ FIX: Duas collapsed by default - expand on click */
    .sdua-card { cursor: pointer; }
    .sdua-body {
        max-height: 0; overflow: hidden;
        transition: max-height 0.4s cubic-bezier(.4,0,.2,1), opacity 0.3s ease;
        opacity: 0;
    }
    .sdua-card.expanded .sdua-body {
        max-height: 200px; opacity: 1;
    }
    .sdua-card.expanded { box-shadow: var(--shadow-sm); border-color: var(--primary-mid) !important; }
    .sdua-preview {
        font-size: 0.85rem; color: var(--text-muted);
        direction: rtl; line-height: 1.5;
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        padding: 4px 0 8px;
    }
    .sdua-expand-icon {
        margin-right: auto; font-size: 0.7rem; color: var(--text-muted);
        transition: transform 0.3s ease; display: inline-block;
    }
    .sdua-card.expanded .sdua-expand-icon { transform: rotate(180deg); }

    /* Celebration sparkle burst */
    @keyframes duaSparkle {
        0%   { opacity: 1; transform: translate(0,0) scale(1); }
        100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0.3); }
    }
    .dua-sparkle {
        position: fixed; pointer-events: none; z-index: 9999;
        font-size: 1.2rem; animation: duaSparkle 0.8s ease-out forwards;
    }

    /* ‚îÄ‚îÄ Spiritual Tracker ‚îÄ‚îÄ */
    .spirit-tracker-wrap { padding: 20px 20px 0; }
    .spirit-tracker-card {
        background: var(--card-bg); border: 1px solid var(--border);
        border-radius: var(--radius); padding: 18px 18px 14px;
        box-shadow: var(--shadow-xs);
    }
    .spirit-tracker-title { font-size: 0.88rem; font-weight: 800; color: var(--text); margin-bottom: 14px; }
    .strack-row {
        display: flex; align-items: center; justify-content: space-between;
        padding: 10px 0; border-bottom: 1px solid var(--border);
    }
    .strack-row:last-child { border-bottom: none; padding-bottom: 0; }
    .strack-left { display: flex; align-items: center; gap: 10px; }
    .strack-icon { font-size: 1.1rem; }
    .strack-label { font-size: 0.82rem; font-weight: 700; color: var(--text); }
    .strack-check {
        width: 28px; height: 28px; border-radius: 50%;
        border: 2px solid var(--border); background: var(--bg);
        cursor: pointer; display: flex; align-items: center; justify-content: center;
        font-size: 0.85rem; transition: all 0.2s; flex-shrink: 0;
    }
    .strack-check.done { background: #22c55e; border-color: #22c55e; color: white; }
    /* Tranquility slider */
    .spirit-tranq-wrap { margin-top: 14px; }
    .spirit-tranq-hdr { display: flex; justify-content: space-between; font-size: 0.78rem; font-weight: 700; color: var(--text); margin-bottom: 8px; }
    .spirit-tranq-emojis { display: flex; justify-content: space-between; margin-top: 6px; font-size: 1rem; }
    /* Tracker chart */
    .spirit-tracker-chart {
        margin-top: 16px; padding-top: 14px; border-top: 1px solid var(--border);
    }
    .spirit-tracker-chart-title { font-size: 0.72rem; color: var(--text-muted); font-weight: 700; margin-bottom: 8px; }
    .stchart-bars { display: flex; align-items: flex-end; gap: 5px; height: 56px; }
    .stchart-col { flex: 1; display: flex; flex-direction: column; align-items: center; height: 100%; justify-content: flex-end; gap: 3px; }
    .stchart-bar { width: 100%; border-radius: 4px 4px 0 0; min-height: 3px; transition: height 0.5s ease; }
    .stchart-day { font-size: 0.55rem; color: var(--text-muted); }

    /* ‚îÄ‚îÄ Context Banner (Smart linking) ‚îÄ‚îÄ */
    .spirit-context-banner {
        margin: 16px 20px 0;
        border-radius: 14px; padding: 14px 16px;
        display: flex; align-items: flex-start; gap: 12px;
        border: 1px solid rgba(99,102,241,0.2);
        background: linear-gradient(135deg, rgba(30,27,75,0.4), rgba(49,46,129,0.3));
    }
    .spirit-context-banner.hidden { display: none; }
    .scb-icon { font-size: 1.4rem; flex-shrink: 0; margin-top: 2px; }
    .scb-title { font-size: 0.82rem; font-weight: 800; color: var(--text); margin-bottom: 3px; }
    .scb-text  { font-size: 0.75rem; color: var(--text-muted); line-height: 1.5; }
    .scb-dua   { font-size: 0.85rem; font-weight: 700; color: #a5b4fc; margin-top: 6px; line-height: 1.7; direction: rtl; }

    /* ‚îÄ‚îÄ SOS full-screen modal ‚îÄ‚îÄ */
    .spirit-sos-overlay {
        position: fixed; inset: 0; z-index: 2000;
        background: linear-gradient(175deg, #040810 0%, #0a0f1e 50%, #0f1630 100%);
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        padding: 32px 24px;
        animation: sosFadeIn 0.4s ease;
    }
    @keyframes sosFadeIn { from { opacity: 0; } to { opacity: 1; } }
    .sos-close {
        position: absolute; top: 20px; left: 20px;
        background: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.1);
        border-radius: 50%; width: 38px; height: 38px;
        color: rgba(255,255,255,0.6); cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        font-size: 1rem; transition: background 0.2s;
    }
    .sos-close:hover { background: rgba(255,255,255,0.14); }
    .sos-title { font-size: 1.1rem; font-weight: 800; color: #e0e7ff; margin-bottom: 6px; text-align: center; }
    .sos-sub   { font-size: 0.78rem; color: rgba(199,210,254,0.55); margin-bottom: 36px; text-align: center; }
    /* Breathing ring */
    .sos-breath-ring {
        width: 120px; height: 120px; border-radius: 50%;
        border: 2px solid rgba(99,102,241,0.3);
        display: flex; align-items: center; justify-content: center;
        margin-bottom: 12px; position: relative;
    }
    .sos-breath-ring::before {
        content: ''; position: absolute; inset: -8px; border-radius: 50%;
        border: 1px solid rgba(99,102,241,0.15);
    }
    .sos-breath-ring.inhale  { animation: breatheIn  4s ease-in-out forwards; }
    .sos-breath-ring.hold    { animation: breatheHold 4s ease-in-out forwards; }
    .sos-breath-ring.exhale  { animation: breatheOut  4s ease-in-out forwards; }
    @keyframes breatheIn   { from { transform: scale(0.85); opacity: 0.6; } to { transform: scale(1.15); opacity: 1; } }
    @keyframes breatheHold { from { transform: scale(1.15); opacity: 1; } to { transform: scale(1.15); opacity: 1; } }
    @keyframes breatheOut  { from { transform: scale(1.15); opacity: 1; } to { transform: scale(0.85); opacity: 0.6; } }
    .sos-breath-label { font-size: 1.1rem; font-weight: 800; color: #c7d2fe; margin-bottom: 28px; }
    .sos-step-label { font-size: 0.82rem; color: rgba(199,210,254,0.5); }
    .sos-verse-box {
        background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08);
        border-radius: 16px; padding: 16px 18px; text-align: center;
        margin-bottom: 14px; width: 100%;
    }
    .sos-verse-text { font-size: 0.95rem; font-weight: 700; color: #e0e7ff; line-height: 1.8; direction: rtl; }
    .sos-verse-ref  { font-size: 0.65rem; color: rgba(199,210,254,0.45); margin-top: 6px; }
    .sos-dua-box {
        background: rgba(99,102,241,0.08); border: 1px solid rgba(99,102,241,0.18);
        border-radius: 14px; padding: 14px 16px; text-align: center;
        margin-bottom: 20px; width: 100%;
    }
    .sos-dua-text { font-size: 0.9rem; font-weight: 700; color: #a5b4fc; line-height: 1.8; direction: rtl; }
    .sos-msg-box  { font-size: 0.8rem; color: rgba(199,210,254,0.55); text-align: center; margin-bottom: 28px; line-height: 1.6; }
    .sos-done-btn {
        width: 100%; padding: 14px; border: none; border-radius: 50px;
        background: rgba(99,102,241,0.2); border: 1px solid rgba(99,102,241,0.3);
        color: #a5b4fc; font-size: 0.9rem; font-weight: 800;
        cursor: pointer; font-family: 'Tajawal', sans-serif;
        transition: background 0.2s;
    }
    .sos-done-btn:hover { background: rgba(99,102,241,0.3); }
    /* Mute notifications pill */
    .sos-mute-hint {
        font-size: 0.65rem; color: rgba(199,210,254,0.35);
        margin-top: 12px; text-align: center;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       SPIRIT WORLD v2 ‚Äî ŸÜÿ∏ÿßŸÖ ÿßŸÑÿßÿ≥ÿ™ŸÇÿ±ÿßÿ± ÿßŸÑŸÜŸÅÿ≥Ÿä
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    /* spirit bg v3 */

    /* ‚îÄ‚îÄ Breath Orb (new animated element) ‚îÄ‚îÄ */
    .spirit-orb-wrap {
        display: flex; justify-content: center; margin: 28px 0 16px;
        position: relative;
    }
    .spirit-orb {
        width: 130px; height: 130px; border-radius: 50%; position: relative;
        background: radial-gradient(circle at 38% 35%, rgba(139,92,246,0.18), rgba(99,102,241,0.08) 55%, transparent 70%);
        border: 1.5px solid rgba(99,102,241,0.2);
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; transition: transform 0.2s;
    }
    .spirit-orb::before {
        content: ''; position: absolute; inset: -12px; border-radius: 50%;
        border: 1px solid rgba(99,102,241,0.08);
        animation: orbPulse 4s ease-in-out infinite;
    }
    .spirit-orb::after {
        content: ''; position: absolute; inset: -24px; border-radius: 50%;
        border: 1px solid rgba(99,102,241,0.04);
        animation: orbPulse 4s ease-in-out infinite 1s;
    }
    .spirit-orb:hover { transform: scale(1.04); }
    @keyframes orbPulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50%       { transform: scale(1.08); opacity: 0.5; }
    }
    .spirit-orb-inner {
        font-size: 2.2rem; text-align: center; line-height: 1;
        animation: orbFloat 5s ease-in-out infinite;
    }
    @keyframes orbFloat {
        0%, 100% { transform: translateY(0); }
        50%       { transform: translateY(-6px); }
    }
    .spirit-orb-hint {
        position: absolute; bottom: -24px; left: 50%; transform: translateX(-50%);
        font-size: 0.6rem; color: rgba(199,210,254,0.3); white-space: nowrap;
        letter-spacing: 1.5px; text-transform: uppercase;
    }

    /* ‚îÄ‚îÄ NOW MODE: 2x2 grid upgraded ‚îÄ‚îÄ */
    .spirit-now-grid { gap: 12px !important; }
    .spirit-now-btn {
        background: var(--card-bg) !important;
        border: 1px solid var(--border) !important;
        border-radius: 18px !important;
        transition: background 0.2s, border-color 0.2s, transform 0.15s !important;
    }
    .spirit-now-btn:hover {
        background: var(--primary-soft) !important;
        border-color: var(--primary-mid) !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 16px rgba(99,102,241,0.12) !important;
    }

    .spirit-now-label { color: var(--text) !important; }
    .spirit-now-sub   { color: var(--text-muted) !important; }

    /* ‚îÄ‚îÄ DUA LIBRARY ‚îÄ‚îÄ */
    .spirit-duas-wrap { padding: 24px 20px 0 !important; }
    .spirit-cat-pill {
        background: rgba(255,255,255,0.03) !important;
        border: 1px solid rgba(255,255,255,0.08) !important;
        color: rgba(199,210,254,0.6) !important;
    }
    .spirit-cat-pill.active {
        background: rgba(99,102,241,0.15) !important;
        border-color: rgba(99,102,241,0.35) !important;
        color: #a5b4fc !important;
    }
    .sdua-card {
        background: var(--card-bg) !important;
        border: 1px solid var(--border) !important;
        border-radius: 18px !important;
    }
    body.dark-mode .sdua-card {
        background: rgba(255,255,255,0.025) !important;
        border: 1px solid rgba(255,255,255,0.06) !important;
    }
    .sdua-text { color: var(--text) !important; }
    body.dark-mode .sdua-text { color: rgba(224,231,255,0.85) !important; }
    .sdua-btn {
        background: var(--bg) !important;
        border-color: var(--border) !important;
        color: var(--text-muted) !important;
    }
    body.dark-mode .sdua-btn {
        background: rgba(255,255,255,0.04) !important;
        border-color: rgba(255,255,255,0.07) !important;
        color: rgba(199,210,254,0.5) !important;
    }
    .sdua-btn:hover {
        background: rgba(99,102,241,0.12) !important;
        color: #a5b4fc !important;
        border-color: rgba(99,102,241,0.3) !important;
    }

    /* ‚îÄ‚îÄ SPIRITUAL TRACKER: dark style ‚îÄ‚îÄ */
    .spirit-tracker-wrap { padding: 24px 20px 0 !important; }
    .spirit-tracker-card {
        background: rgba(255,255,255,0.025) !important;
        border: 1px solid rgba(255,255,255,0.06) !important;
    }
    .spirit-tracker-title { color: rgba(224,231,255,0.85) !important; }
    .strack-label { color: rgba(224,231,255,0.8) !important; }
    .strack-row { border-bottom-color: rgba(255,255,255,0.05) !important; }
    .strack-check { border-color: rgba(255,255,255,0.15) !important; background: rgba(255,255,255,0.03) !important; }
    .spirit-tranq-hdr { color: rgba(224,231,255,0.7) !important; }
    .spirit-tracker-chart-title { color: rgba(199,210,254,0.4) !important; }
    .stchart-day { color: rgba(199,210,254,0.35) !important; }

    /* ‚îÄ‚îÄ Section title in spirit world ‚îÄ‚îÄ */
    .spirit-now-title {
        color: rgba(199,210,254,0.35) !important;
    }
    .spirit-now-title::after { background: rgba(255,255,255,0.06) !important; }

    /* ‚îÄ‚îÄ Context Banner: spirit dark ‚îÄ‚îÄ */
    .spirit-context-banner {
        background: rgba(30,27,75,0.5) !important;
        border-color: rgba(99,102,241,0.15) !important;
        margin: 16px 20px 0 !important;
    }
    .scb-title { color: rgba(224,231,255,0.9) !important; }
    .scb-text  { color: rgba(199,210,254,0.55) !important; }

    /* ‚îÄ‚îÄ Spirit section padding ‚îÄ‚îÄ */



    .quran-verse-card {
        background: var(--primary);
        border-radius: var(--radius); padding: 16px 18px; margin-bottom: 10px;
        color: white;
        animation: fadeIn 0.4s ease;
    }
    .quran-bismillah {
        font-size: 0.7rem; color: rgba(255,255,255,0.6);
        text-align: center; margin-bottom: 8px;
    }
    .quran-verse-text {
        font-size: 1rem; line-height: 2; text-align: center;
        color: #A5B4FC; font-weight: 700;
    }
    .quran-verse-ref {
        font-size: 0.7rem; color: rgba(255,255,255,0.5);
        text-align: center; margin-top: 8px;
    }


    /* ‚îÄ‚îÄ Spiritual Nav Grid ‚îÄ‚îÄ */
    .spirit-nav-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 8px;
        margin-bottom: 16px;
    }
    .spirit-nav-btn {
        display: flex; flex-direction: column; align-items: center;
        gap: 5px; padding: 12px 6px;
        border: 1.5px solid var(--border);
        border-radius: var(--radius);
        background: var(--card-bg);
        cursor: pointer; font-family: 'Tajawal', sans-serif;
        transition: all 0.2s;
    }
    .spirit-nav-btn:active { transform: scale(0.95); }
    .spirit-nav-btn.active {
        background: var(--primary-soft);
        border-color: var(--primary-mid);
        color: var(--primary);
    }
    .spirit-nav-icon { font-size: 1.4rem; line-height: 1; }
    .spirit-nav-label { font-size: 0.7rem; font-weight: 700; color: var(--text-muted); text-align: center; line-height: 1.2; }
    .spirit-nav-btn.active .spirit-nav-label { color: var(--primary); }

    /* ‚îÄ‚îÄ Section Header (spirit) ‚îÄ‚îÄ */
    .spirit-section-header {
        display: flex; align-items: center; gap: 10px;
        padding: 0 0 12px; margin-bottom: 14px;
        border-bottom: 1px solid var(--border);
    }
    .spirit-section-icon { font-size: 1.5rem; }
    .spirit-section-title { font-size: 0.97rem; font-weight: 800; color: var(--text); }
    .spirit-section-sub { font-size: 0.72rem; color: var(--text-muted); margin-top: 2px; }

    /* ‚îÄ‚îÄ Dua Card (simplified) ‚îÄ‚îÄ */
    .dua-card {
        background: var(--card-bg); border-radius: var(--radius);
        border: 1px solid var(--border); margin-bottom: 10px;
        overflow: hidden;
    }
    .dua-header {
        display: flex; align-items: flex-start; gap: 10px;
        padding: 14px 16px;
    }
    .dua-icon {
        width: 34px; height: 34px; border-radius: 10px; flex-shrink: 0;
        display: flex; align-items: center; justify-content: center;
        font-size: 1rem; background: var(--primary-soft);
    }
    .dua-text {
        flex: 1; font-size: 0.94rem; line-height: 2;
        color: var(--text); font-weight: 500;
        direction: rtl; text-align: right;
    }
    .dua-actions {
        display: flex; gap: 6px; padding: 0 14px 12px;
        justify-content: flex-end; border-top: 1px solid var(--border);
        padding-top: 10px; margin: 0 14px;
    }
    .dua-action-btn {
        padding: 4px 10px; border-radius: 8px; border: 1px solid var(--border);
        background: var(--bg); color: var(--text-muted);
        font-size: 0.72rem; font-weight: 700; cursor: pointer;
        font-family: 'Tajawal', sans-serif; transition: all 0.2s;
        display: flex; align-items: center; gap: 4px;
    }
    .dua-action-btn:hover { border-color: var(--primary-mid); color: var(--primary); }
    .dua-action-btn.fav-active { background: var(--primary-soft); border-color: var(--primary); color: var(--primary); }

    /* ‚îÄ‚îÄ Emergency Button ‚îÄ‚îÄ */
    .emergency-btn {
        width: 100%; padding: 13px; border-radius: var(--radius); border: 1.5px solid rgba(220,38,38,0.3);
        background: rgba(220,38,38,0.06); color: var(--danger);
        font-size: 0.92rem; font-weight: 700;
        font-family: 'Tajawal', sans-serif; cursor: pointer;
        display: flex; align-items: center; justify-content: center; gap: 8px;
        transition: background 0.2s; margin-top: 4px;
    }
    .emergency-btn:hover { background: rgba(220,38,38,0.12); }
    .emergency-btn:active { transform: scale(0.97); }

    /* ‚îÄ‚îÄ Yaseen Card ‚îÄ‚îÄ */
    .yaseen-card {
        background: var(--success); border-radius: var(--radius);
        padding: 13px 16px; margin-bottom: 14px; color: white;
    }
    .yaseen-dismiss {
        background: rgba(255,255,255,0.2); border: none; border-radius: 50px;
        padding: 4px 12px; color: white; font-size: 0.75rem; font-weight: 700;
        cursor: pointer; font-family: 'Tajawal', sans-serif; margin-top: 8px; display: inline-block;
    }
    .smart-notif-banner {
        position: fixed; top: 68px; left: 50%; transform: translateX(-50%);
        width: calc(100% - 30px); max-width: 400px;
        background: var(--card-bg); border: 1px solid var(--border);
        border-radius: var(--radius); padding: 14px 16px;
        box-shadow: var(--shadow);
        z-index: 200; animation: bannerSlide 0.35s cubic-bezier(.4,0,.2,1);
        display: flex; gap: 12px; align-items: flex-start;
    }
    @keyframes bannerSlide {
        from { top: 48px; opacity: 0; }
        to   { top: 68px; opacity: 1; }
    }
    .smart-notif-banner.hiding { animation: bannerHide 0.25s forwards; }
    @keyframes bannerHide { to { top: 40px; opacity: 0; } }
    .smart-notif-icon { font-size: 1.6rem; line-height: 1; flex-shrink: 0; }
    .smart-notif-body { flex: 1; }
    .smart-notif-title { font-weight: 800; font-size: 0.9rem; margin-bottom: 3px; }
    .smart-notif-text  { font-size: 0.78rem; color: var(--text-muted); line-height: 1.5; }
    .smart-notif-close { background: none; border: none; font-size: 1rem; cursor: pointer;
        color: var(--text-muted); padding: 0; line-height: 1; flex-shrink: 0; }
    .smart-notif-banner.type-streak  { border-right: 3px solid var(--accent); }
    .smart-notif-banner.type-dua     { border-right: 3px solid var(--success); }
    .smart-notif-banner.type-motiv   { border-right: 3px solid var(--primary-mid); }
    .smart-notif-banner.type-session { border-right: 3px solid var(--success); }
    .smart-notif-banner.type-daily   { border-right: 3px solid var(--primary-mid); }

    /* ‚îÄ‚îÄ Toggle Switch ‚îÄ‚îÄ */
    .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; flex-shrink: 0; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider {
        position: absolute; cursor: pointer; inset: 0;
        background: var(--border); border-radius: 24px; transition: 0.3s;
    }
    .toggle-slider::before {
        content: ''; position: absolute;
        width: 18px; height: 18px; border-radius: 50%; background: white;
        bottom: 3px; right: 3px; transition: 0.3s;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .toggle-switch input:checked + .toggle-slider { background: var(--primary-mid); }
    .toggle-switch input:checked + .toggle-slider::before { transform: translateX(-20px); }

    /* ‚îÄ‚îÄ Notif System ‚îÄ‚îÄ */
    .notif-row {
        display: flex; align-items: center; justify-content: space-between;
        gap: 12px; padding: 4px 0;
    }
    .notif-row-info { flex: 1; }
    .notif-row-title { font-size: 0.86rem; font-weight: 700; color: var(--text); }
    .notif-row-sub   { font-size: 0.71rem; color: var(--text-muted); margin-top: 2px; }
    .notif-divider   { height: 1px; background: var(--border); margin: 11px 0; }
    .notif-sub-row   {
        display: flex; align-items: center; gap: 10px;
        margin-top: -5px; margin-bottom: 7px; padding-right: 4px;
    }

    /* ‚îÄ‚îÄ Focus Mode (during session) ‚îÄ‚îÄ */
    body.focus-mode header,
    body.focus-mode .bottom-nav,
    body.focus-mode .share-fab { display: none !important; }
    body.focus-mode .section { padding: 0; }
    body.focus-mode #home { 
        display: flex; flex-direction: column;
        justify-content: center; align-items: center;
        min-height: 100vh; padding: 20px;
    }
    body.focus-mode .home-accordions,
    body.focus-mode .home-alerts,
    body.focus-mode .home-level-card { display: none !important; }
    body.focus-mode .timer-card { 
        border: none; box-shadow: none; background: transparent;
        width: 100%; max-width: 380px;
    }
    .focus-exit-btn {
        display: none; position: fixed; top: 14px; left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.5); color: white;
        border: none; border-radius: 50px; padding: 7px 16px;
        font-family: 'Tajawal', sans-serif; font-size: 0.82rem; font-weight: 700;
        cursor: pointer; z-index: 999;
    }
    body.focus-mode .focus-exit-btn { display: block; }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       NOURIUM BRAND IDENTITY SYSTEM ‚Äî Injected v1.0
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    /* ‚îÄ‚îÄ Splash Screen ‚îÄ‚îÄ */
    .splash-screen {
        position: fixed; inset: 0; z-index: 9999;
        background: linear-gradient(135deg, #0A0F1F 0%, #16204D 40%, #1E2A78 70%, #6366F1 100%);
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        gap: 20px;
        transition: opacity 0.6s ease, transform 0.6s ease;
    }
    .splash-screen.hiding {
        opacity: 0; transform: scale(1.04);
        pointer-events: none;
    }
    .splash-logo-wrap {
        display: flex; align-items: center; gap: 14px;
        animation: splashEntry 0.8s cubic-bezier(.4,0,.2,1) forwards;
        opacity: 0;
    }
    @keyframes splashEntry {
        from { opacity: 0; transform: translateY(20px); }
        to   { opacity: 1; transform: translateY(0); }
    }
    .splash-wordmark {
        font-family: 'DM Sans', 'Tajawal', sans-serif;
        font-size: 2.8rem; font-weight: 300; letter-spacing: -1px;
        color: rgba(255,255,255,0.92);
        animation: splashEntry 0.9s cubic-bezier(.4,0,.2,1) 0.15s forwards;
        opacity: 0;
    }
    .splash-wordmark strong { font-weight: 800; color: #A5B4FC; }
    .splash-tagline {
        font-family: 'DM Sans', sans-serif;
        font-size: 0.72rem; letter-spacing: 5px; text-transform: uppercase;
        color: rgba(255,255,255,0.4);
        animation: splashEntry 0.9s cubic-bezier(.4,0,.2,1) 0.3s forwards;
        opacity: 0;
    }
    .splash-beam {
        width: 120px; height: 2px; border-radius: 1px;
        background: linear-gradient(90deg, transparent, #6366F1, transparent);
        animation: splashEntry 0.9s cubic-bezier(.4,0,.2,1) 0.1s forwards,
                   beamSweep 1.8s ease-in-out 0.4s infinite;
        opacity: 0;
    }
    @keyframes beamSweep {
        0%, 100% { transform: scaleX(0.5); opacity: 0.3; }
        50%       { transform: scaleX(1.2); opacity: 1; }
    }

    /* ‚îÄ‚îÄ Enhanced Logo ‚îÄ‚îÄ */
    .logo-wordmark {
        font-family: 'DM Sans', 'Tajawal', sans-serif;
        font-weight: 300; font-size: 1.2rem; letter-spacing: -0.5px;
        color: var(--text);
    }
    .logo-wordmark strong { font-weight: 800; color: var(--primary); }

    /* ‚îÄ‚îÄ Brand Greeting Banner (first visit) ‚îÄ‚îÄ */
    .brand-banner {
        background: linear-gradient(135deg, var(--primary), var(--accent));
        border-radius: var(--radius); padding: 14px 18px; margin-bottom: 14px;
        color: white; text-align: center; position: relative; overflow: hidden;
        display: none;
    }
    .brand-banner.visible { display: block; }
    .brand-banner::before {
        content: '';
        position: absolute; top: -20px; right: -20px;
        width: 100px; height: 100px; border-radius: 50%;
        background: rgba(255,255,255,0.08);
    }
    .brand-banner-title {
        font-family: 'DM Sans', sans-serif;
        font-size: 0.9rem; font-weight: 700; margin-bottom: 4px;
    }
    .brand-banner-sub { font-size: 0.78rem; opacity: 0.85; }

    /* ‚îÄ‚îÄ Version badge in footer ‚îÄ‚îÄ */
    .version-badge {
        display: inline-flex; align-items: center; gap: 5px;
        padding: 3px 10px; border-radius: 50px;
        background: rgba(99,102,241,0.12);
        border: 1px solid rgba(99,102,241,0.2);
        color: var(--text-muted); font-size: 0.68rem;
        font-family: 'IBM Plex Mono', monospace;
    }

    /* ‚îÄ‚îÄ IBM Plex Mono for code/version text ‚îÄ‚îÄ */
    .mono { font-family: 'IBM Plex Mono', monospace; }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       CHALLENGES ‚Äî ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ÿ≠ÿØŸäÿßÿ™
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .challenges-hero {
        background: linear-gradient(135deg, #1a0533 0%, #2d1b69 45%, #1e3a8a 100%);
        border-radius: var(--radius); padding: 20px; margin-bottom: 14px;
        color: white; position: relative; overflow: hidden;
    }
    body:not(.dark-mode) .challenges-hero {
        background: linear-gradient(135deg, #312e81 0%, #4338ca 50%, #1d4ed8 100%);
    }
    .challenges-hero::before {
        content: ''; position: absolute; top: -50px; left: -50px;
        width: 180px; height: 180px; border-radius: 50%;
        background: radial-gradient(circle, rgba(167,139,250,0.15) 0%, transparent 70%);
    }
    .challenges-hero::after {
        content: ''; position: absolute; bottom: -30px; right: -20px;
        width: 140px; height: 140px; border-radius: 50%;
        background: radial-gradient(circle, rgba(96,165,250,0.12) 0%, transparent 70%);
    }
    .challenges-hero-title {
        font-size: 1.15rem; font-weight: 800;
        display: flex; align-items: center; gap: 9px;
        margin-bottom: 5px; position: relative; z-index: 1;
    }
    .challenges-hero-sub { font-size: 0.77rem; opacity: 0.75; position: relative; z-index: 1; }
    .challenges-hero-stats {
        display: flex; gap: 10px; margin-top: 14px; flex-wrap: wrap;
        position: relative; z-index: 1;
    }
    .ch-stat-pill {
        background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.15);
        border-radius: 50px; padding: 6px 14px;
        font-size: 0.78rem; font-weight: 700;
        display: flex; align-items: center; gap: 6px;
    }
    .ch-stat-pill span { opacity: 0.75; font-weight: 400; font-size: 0.72rem; }

    .ch-section-label {
        font-size: 0.72rem; font-weight: 800; letter-spacing: 1.5px;
        text-transform: uppercase; color: var(--text-muted);
        margin: 18px 0 10px; display: flex; align-items: center; gap: 8px;
    }
    .ch-section-label::after { content: ''; flex: 1; height: 1px; background: var(--border); }

    .ch-card {
        background: var(--card-bg); border: 1px solid var(--border);
        border-radius: var(--radius); padding: 16px 18px; margin-bottom: 10px;
        box-shadow: var(--shadow-xs); transition: box-shadow 0.2s, transform 0.15s;
        position: relative; overflow: hidden;
    }
    .ch-card:active { transform: scale(0.985); }
    .ch-card.ch-done {
        border-color: rgba(34,197,94,0.3);
        background: linear-gradient(135deg, var(--card-bg), rgba(34,197,94,0.04));
    }
    .ch-card-accent {
        position: absolute; top: 0; right: 0;
        width: 4px; height: 100%;
    }
    .ch-top {
        display: flex; align-items: flex-start;
        justify-content: space-between; gap: 12px; margin-bottom: 10px;
    }
    .ch-icon-wrap {
        width: 44px; height: 44px; border-radius: 12px;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.4rem; flex-shrink: 0;
    }
    .ch-info { flex: 1; }
    .ch-title  { font-size: 0.9rem; font-weight: 800; color: var(--text); margin-bottom: 3px; }
    .ch-desc   { font-size: 0.75rem; color: var(--text-muted); line-height: 1.4; }
    .ch-reward {
        display: flex; align-items: center; gap: 5px;
        background: var(--primary-soft); border-radius: 50px;
        padding: 4px 10px; font-size: 0.72rem; font-weight: 700;
        color: var(--primary); flex-shrink: 0; white-space: nowrap;
    }
    .ch-progress-row { display: flex; align-items: center; gap: 10px; }
    .ch-bar-bg { flex: 1; background: var(--border); height: 6px; border-radius: 3px; overflow: hidden; }
    .ch-bar-fill {
        height: 100%; border-radius: 3px;
        transition: width 0.6s cubic-bezier(.4,0,.2,1);
        position: relative; overflow: hidden;
    }
    .ch-bar-fill:not(.done)::after {
        content: '';
        position: absolute; top: 0; left: -100%;
        width: 60%; height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        animation: chShimmer 1.8s ease-in-out infinite;
    }
    @keyframes chShimmer { 0% { left: -60%; } 100% { left: 120%; } }
    .ch-pct { font-size: 0.7rem; font-weight: 800; color: var(--text-muted); min-width: 32px; text-align: left; }
    .ch-done-badge {
        display: inline-flex; align-items: center; gap: 5px;
        background: rgba(34,197,94,0.12); border: 1px solid rgba(34,197,94,0.3);
        border-radius: 50px; padding: 3px 10px;
        font-size: 0.72rem; font-weight: 800; color: #16a34a;
    }
    .ch-weekly-card {
        background: var(--card-bg); border: 1px solid var(--border);
        border-radius: var(--radius); overflow: hidden;
        margin-bottom: 10px; box-shadow: var(--shadow-xs);
    }
    .ch-weekly-header { padding: 14px 18px 10px; display: flex; align-items: center; gap: 10px; }
    .ch-weekly-icon {
        width: 40px; height: 40px; border-radius: 10px;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.3rem; flex-shrink: 0;
    }
    .ch-weekly-title { font-size: 0.9rem; font-weight: 800; color: var(--text); }
    .ch-weekly-sub   { font-size: 0.73rem; color: var(--text-muted); margin-top: 2px; }
    .ch-weekly-body  { padding: 0 18px 14px; }
    .ch-weekly-subject-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .ch-weekly-dot   { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
    .ch-weekly-name  { flex: 1; font-size: 0.82rem; font-weight: 600; color: var(--text); }
    .ch-weekly-val   { font-size: 0.78rem; font-weight: 700; color: var(--primary); }
    .ch-weekly-bar-bg { width: 80px; height: 5px; background: var(--border); border-radius: 3px; overflow: hidden; }
    .ch-weekly-bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
    .ch-ring-wrap    { display: flex; align-items: center; gap: 16px; padding: 4px 0; }
    .ch-ring-pct     { font-size: 1.6rem; font-weight: 800; color: var(--primary); line-height: 1; }
    .ch-ring-label   { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }
    .ch-ring-days    { display: flex; flex-wrap: wrap; gap: 3px; margin-top: 8px; }
    .ch-ring-day {
        width: 22px; height: 22px; border-radius: 6px;
        font-size: 0.55rem; display: flex; align-items: center; justify-content: center;
    }
    .ch-ring-day.studied { background: var(--primary); color: white; }
    .ch-ring-day.empty   { background: var(--border); color: var(--text-muted); }
    .ch-ring-day.today   { outline: 2px solid var(--primary-mid); outline-offset: 1px; }
    .ch-claim-btn {
        display: inline-flex; align-items: center; gap: 6px;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        color: white; border: none; border-radius: 50px;
        padding: 7px 16px; font-size: 0.8rem; font-weight: 800;
        cursor: pointer; font-family: 'Tajawal', sans-serif;
        box-shadow: 0 2px 8px rgba(99,102,241,0.3);
        transition: transform 0.15s, box-shadow 0.2s; margin-top: 8px;
    }
    .ch-claim-btn:hover  { transform: translateY(-1px); box-shadow: 0 4px 14px rgba(99,102,241,0.4); }
    .ch-claim-btn:active { transform: scale(0.94); }
    .ch-confetti {
        position: fixed; pointer-events: none; z-index: 9999; font-size: 1.4rem;
        animation: chConfettiUp 1.8s ease-out forwards;
    }
    @keyframes chConfettiUp {
        0%   { transform: translateY(0) rotate(0deg) scale(1); opacity: 1; }
        100% { transform: translateY(-140px) rotate(400deg) scale(0.2); opacity: 0; }
    }
    .ch-reset-badge {
        font-size: 0.68rem; color: var(--text-muted);
        text-align: center; margin-top: 14px; padding-bottom: 4px;
        display: flex; align-items: center; justify-content: center; gap: 6px;
    }
    .ch-reset-badge i { color: var(--primary-mid); }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       MOOD TRACKER ‚Äî ÿ™ÿ™ÿ®ÿπ ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑŸÜŸÅÿ≥Ÿäÿ©
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .mood-overlay {
        position: fixed; inset: 0; z-index: 1000;
        background: rgba(0,0,0,0.55); backdrop-filter: blur(6px);
        display: flex; align-items: flex-end; justify-content: center;
        animation: moodFadeIn 0.25s ease;
    }
    @keyframes moodFadeIn { from { opacity: 0; } to { opacity: 1; } }
    .mood-sheet {
        background: var(--card-bg); border-radius: 24px 24px 0 0;
        padding: 24px 20px 36px; width: 100%; max-width: 480px;
        box-shadow: 0 -8px 40px rgba(0,0,0,0.25);
        animation: moodSlideUp 0.32s cubic-bezier(.4,0,.2,1);
    }
    @keyframes moodSlideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .mood-handle {
        width: 40px; height: 4px; border-radius: 2px;
        background: var(--border); margin: 0 auto 18px;
    }
    .mood-sheet-title { font-size: 1.05rem; font-weight: 800; color: var(--text); text-align: center; margin-bottom: 3px; }
    .mood-sheet-sub   { font-size: 0.78rem; color: var(--text-muted); text-align: center; margin-bottom: 20px; }
    .mood-emoji-row { display: flex; justify-content: space-around; margin-bottom: 20px; gap: 4px; }
    .mood-emoji-btn {
        display: flex; flex-direction: column; align-items: center; gap: 4px;
        background: var(--bg); border: 2px solid transparent;
        border-radius: 16px; padding: 12px 6px; cursor: pointer;
        flex: 1; transition: all 0.18s; font-family: 'Tajawal', sans-serif;
    }
    .mood-emoji-btn:hover { transform: translateY(-3px); }
    .mood-emoji-btn.selected {
        border-color: var(--primary-mid); background: var(--primary-soft);
        box-shadow: 0 4px 12px rgba(99,102,241,0.2);
        transform: translateY(-4px) scale(1.06);
    }
    .mood-emoji-icon  { font-size: 1.9rem; line-height: 1; }
    .mood-emoji-label { font-size: 0.6rem; color: var(--text-muted); font-weight: 700; }
    .mood-slider-row  { margin-bottom: 14px; }
    .mood-slider-hdr  { display: flex; justify-content: space-between; font-size: 0.8rem; font-weight: 700; color: var(--text); margin-bottom: 6px; }
    .mood-slider-val  { color: var(--primary); }
    input.mood-slider {
        -webkit-appearance: none; width: 100%; height: 6px;
        border-radius: 3px; outline: none; cursor: pointer;
        background: var(--border); margin: 0; padding: 0; border: none; box-shadow: none;
    }
    input.mood-slider::-webkit-slider-thumb {
        -webkit-appearance: none; width: 22px; height: 22px; border-radius: 50%;
        background: var(--primary); cursor: pointer;
        box-shadow: 0 2px 8px rgba(99,102,241,0.4);
        transition: transform 0.15s;
    }
    input.mood-slider:active::-webkit-slider-thumb { transform: scale(1.3); }
    textarea.mood-note {
        width: 100%; border: 1.5px solid var(--border); border-radius: 12px;
        padding: 10px 13px; background: var(--bg); color: var(--text);
        font-family: 'Tajawal', sans-serif; font-size: 0.88rem;
        resize: none; outline: none; margin-bottom: 16px; transition: border-color 0.2s;
    }
    textarea.mood-note:focus { border-color: var(--primary-mid); }
    .mood-save-btn {
        width: 100%; padding: 14px; border: none; border-radius: 50px;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        color: white; font-size: 1rem; font-weight: 800;
        cursor: pointer; font-family: 'Tajawal', sans-serif;
        box-shadow: 0 4px 14px rgba(99,102,241,0.35);
        transition: transform 0.15s, box-shadow 0.2s;
    }
    .mood-save-btn:hover  { transform: translateY(-1px); }
    .mood-save-btn:active { transform: scale(0.96); }

    #mood-section { padding: 16px; animation: fadeIn 0.2s ease; }
    .mood-hero {
        background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #312e81 100%);
        border-radius: var(--radius); padding: 20px; margin-bottom: 14px;
        color: white; position: relative; overflow: hidden;
    }
    body:not(.dark-mode) .mood-hero {
        background: linear-gradient(135deg, #1e1b4b 0%, #4338ca 60%, #7c3aed 100%);
    }
    .mood-hero::before {
        content: ''; position: absolute; top: -60px; right: -40px;
        width: 200px; height: 200px; border-radius: 50%;
        background: radial-gradient(circle, rgba(196,181,253,0.12) 0%, transparent 70%);
    }
    .mood-hero-title {
        font-size: 1.1rem; font-weight: 800; display: flex; align-items: center; gap: 9px;
        margin-bottom: 4px; position: relative; z-index: 1;
    }
    .mood-hero-sub  { font-size: 0.77rem; opacity: 0.75; margin-bottom: 14px; position: relative; z-index: 1; }
    .mood-today-pill {
        display: inline-flex; align-items: center; gap: 8px;
        background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.18);
        border-radius: 50px; padding: 8px 16px; font-size: 0.82rem; font-weight: 700;
        position: relative; z-index: 1;
    }
    .mood-today-big { font-size: 1.5rem; }
    .mood-chart-wrap {
        display: flex; align-items: flex-end; gap: 5px;
        height: 90px; margin: 10px 0 6px;
    }
    .mood-bar-col {
        flex: 1; display: flex; flex-direction: column;
        align-items: center; height: 100%; justify-content: flex-end;
    }
    .mood-bar { width: 100%; border-radius: 6px 6px 0 0; min-height: 4px; }
    .mood-bar-emoji { font-size: 0.85rem; line-height: 1; margin-bottom: 2px; }
    .mood-bar-day   { font-size: 0.58rem; color: var(--text-muted); margin-top: 2px; }
    .mood-corr-row  { display: flex; align-items: center; gap: 10px; margin-bottom: 7px; }
    .mood-corr-label { font-size: 0.75rem; color: var(--text-muted); min-width: 80px; }
    .mood-corr-bg   { flex: 1; height: 7px; background: var(--border); border-radius: 4px; overflow: hidden; }
    .mood-corr-fill { height: 100%; border-radius: 4px; transition: width 0.6s ease; }
    .mood-corr-val  { font-size: 0.72rem; font-weight: 700; color: var(--primary); min-width: 34px; text-align: left; }
    .mood-log-item {
        display: flex; align-items: flex-start; gap: 12px;
        padding: 12px 14px; border-radius: 12px;
        background: var(--bg); border: 1px solid var(--border); margin-bottom: 8px;
    }
    .mood-log-emoji { font-size: 1.6rem; flex-shrink: 0; line-height: 1; margin-top: 2px; }
    .mood-log-info  { flex: 1; }
    .mood-log-top   { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 2px; }
    .mood-log-label { font-size: 0.85rem; font-weight: 700; color: var(--text); }
    .mood-log-date  { font-size: 0.68rem; color: var(--text-muted); }
    .mood-log-note  { font-size: 0.75rem; color: var(--text-muted); margin-top: 3px; line-height: 1.4; }
    .mood-log-pills { display: flex; gap: 6px; margin-top: 5px; flex-wrap: wrap; }
    .mood-log-pill  {
        font-size: 0.65rem; font-weight: 700; padding: 2px 8px;
        border-radius: 50px; background: var(--primary-soft); color: var(--primary);
    }
    .mood-tip-card {
        border-radius: 14px; padding: 14px 16px; margin-bottom: 9px;
        border: 1px solid var(--border); cursor: pointer;
        transition: box-shadow 0.2s, transform 0.15s;
        background: var(--card-bg); position: relative; overflow: hidden;
    }
    .mood-tip-card:hover { box-shadow: var(--shadow-sm); transform: translateY(-1px); }
    .mood-tip-accent { position: absolute; top: 0; right: 0; width: 3px; height: 100%; }
    .mood-tip-top { display: flex; align-items: center; gap: 10px; margin-bottom: 4px; }
    .mood-tip-icon  { font-size: 1.3rem; }
    .mood-tip-title { font-size: 0.87rem; font-weight: 800; color: var(--text); flex: 1; }
    .mood-tip-dur   { font-size: 0.68rem; font-weight: 700; background: var(--primary-soft); color: var(--primary); border-radius: 50px; padding: 2px 8px; }
    .mood-tip-desc  { font-size: 0.76rem; color: var(--text-muted); line-height: 1.5; margin-right: 34px; margin-bottom: 6px; }
    .mood-tip-steps { display: none; background: var(--bg); border-radius: 10px; padding: 10px 12px; margin-top: 4px; }
    .mood-tip-steps.open { display: block; }
    .mood-tip-step  { font-size: 0.74rem; color: var(--text); padding: 3px 0; display: flex; gap: 7px; }
    .mood-tip-step::before { content: '‚ó¶'; color: var(--primary); flex-shrink: 0; }



    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       NOURI ‚Äî ÿßŸÑÿ£ÿ±ŸÜÿ® ÿßŸÑŸÖÿ±ÿßŸÅŸÇ
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .nouri-wrap {
        display: flex; flex-direction: column; align-items: center;
        margin: 14px auto 4px; position: relative; width: fit-content;
        z-index: 10;
    }
    .nouri-bubble {
        background: var(--card-bg);
        border: 2px solid var(--primary-soft);
        border-radius: 18px 18px 18px 4px;
        padding: 10px 15px; font-size: 0.82rem; font-weight: 700;
        color: var(--text); max-width: 220px; text-align: center;
        box-shadow: var(--shadow-sm); margin-bottom: 10px;
        opacity: 0; transform: translateY(8px) scale(0.95);
        transition: opacity 0.35s ease, transform 0.35s cubic-bezier(.4,0,.2,1);
        pointer-events: none; line-height: 1.45;
    }
    .nouri-bubble.visible {
        opacity: 1; transform: translateY(0) scale(1);
    }
    .nouri-bubble::after {
        content: '';
        position: absolute; bottom: -10px; left: 28px;
        border-width: 10px 8px 0; border-style: solid;
        border-color: var(--card-bg) transparent transparent;
    }
    .nouri-svg-wrap {
        cursor: pointer; position: relative;
        animation: nouriFloat 3.2s ease-in-out infinite;
        transition: transform 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        filter: drop-shadow(0 6px 12px rgba(99,102,241,0.18));
    }
    .nouri-svg-wrap:hover { transform: scale(1.18) rotate(6deg); animation-play-state: paused; }
    .nouri-svg-wrap:active { transform: scale(0.92) rotate(-4deg); }
    @keyframes nouriFloat {
        0%, 100% { transform: translateY(0); }
        50%       { transform: translateY(-9px); }
    }
    /* Ear wiggle on speak */
    .nouri-svg-wrap.speaking .nouri-ear-l { animation: earWiggleL 0.4s ease-in-out 2; }
    .nouri-svg-wrap.speaking .nouri-ear-r { animation: earWiggleR 0.4s ease-in-out 2 0.1s; }
    @keyframes earWiggleL {
        0%,100% { transform: rotate(0); transform-origin: 50% 100%; }
        50%      { transform: rotate(-14deg); transform-origin: 50% 100%; }
    }
    @keyframes earWiggleR {
        0%,100% { transform: rotate(0); transform-origin: 50% 100%; }
        50%      { transform: rotate(14deg); transform-origin: 50% 100%; }
    }
    /* Happy bounce on session complete */
    @keyframes nouriBounce {
        0%,100% { transform: translateY(0) scale(1); }
        25%      { transform: translateY(-18px) scale(1.05); }
        50%      { transform: translateY(-4px) scale(0.97); }
        75%      { transform: translateY(-12px) scale(1.03); }
    }
    .nouri-svg-wrap.celebrate { animation: nouriBounce 0.8s cubic-bezier(.4,0,.2,1) 2; }
    /* Mood color tint on body */
    .nouri-body-fill { transition: fill 0.6s ease; }

    /* ‚îÄ‚îÄ Session Light Wave (on timer start) ‚îÄ‚îÄ */
    @keyframes lightWave {
        0%   { transform: translateX(-100%); opacity: 0; }
        20%  { opacity: 0.6; }
        100% { transform: translateX(200%); opacity: 0; }
    }
    .timer-card { position: relative; overflow: hidden; }
    .timer-card.session-active::before {
        content: '';
        position: absolute; top: 0; left: 0;
        width: 50%; height: 100%;
        background: linear-gradient(90deg, transparent, rgba(99,102,241,0.06), transparent);
        animation: lightWave 1.8s ease-out forwards;
        pointer-events: none;
    }

    /* ‚îÄ‚îÄ Bottom Nav Active indicator ‚îÄ‚îÄ */
    .nav-item.active::after {
        content: '';
        display: block; width: 18px; height: 2px;
        background: var(--primary-mid);
        border-radius: 1px; margin: 2px auto 0;
    }

    /* ‚îÄ‚îÄ Yaseen / dua card  ‚îÄ‚îÄ */
    .yaseen-card {
        background: linear-gradient(135deg, var(--primary), var(--break));
        border-radius: var(--radius); padding: 16px 18px; margin-bottom: 14px;
        color: white; animation: fadeIn 0.4s ease;
    }
    .yaseen-dismiss {
        background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.25);
        border-radius: 50px; padding: 5px 12px; color: white;
        font-family: 'Tajawal', sans-serif; font-weight: 700; font-size: 0.8rem;
        cursor: pointer; transition: background 0.2s;
    }
    .yaseen-dismiss:hover { background: rgba(255,255,255,0.25); }

    /* ‚îÄ‚îÄ Dua action buttons enhanced ‚îÄ‚îÄ */
    .dua-action-btn {
        padding: 7px 14px; border-radius: 50px;
        background: var(--bg); color: var(--text-muted);
        border: 1px solid var(--border);
        font-family: 'Tajawal', sans-serif; font-size: 0.8rem; font-weight: 700;
        cursor: pointer; transition: all 0.18s;
        display: inline-flex; align-items: center; gap: 5px;
    }
    .dua-action-btn:hover { border-color: var(--primary-mid); color: var(--primary); }
    .dua-action-btn.fav-active {
        background: rgba(99,102,241,0.12);
        border-color: rgba(99,102,241,0.3);
        color: #6366F1;
    }

    /* ‚îÄ‚îÄ Emergency button ‚îÄ‚îÄ */
    .emergency-btn {
        display: block; width: 100%; margin: 20px 0 8px;
        padding: 13px; border-radius: var(--radius);
        background: transparent; color: var(--danger);
        border: 1.5px dashed rgba(220,38,38,0.3);
        font-family: 'Tajawal', sans-serif; font-weight: 700;
        cursor: pointer; font-size: 0.9rem;
        transition: all 0.2s;
    }
    .emergency-btn:hover {
        background: rgba(220,38,38,0.06);
        border-style: solid;
    }

    /* ‚îÄ‚îÄ Quran verse animation ‚îÄ‚îÄ */
    @keyframes verseAppear {
        from { opacity: 0; transform: translateY(8px); }
        to   { opacity: 1; transform: translateY(0); }
    }


    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       REDESIGN v2 ‚Äî Three Worlds Layout
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    /* Refined spacing */
    .card { margin-bottom: 18px; }
    .section { padding: 18px 16px; }

    /* Softer shadows */
    :root {
        --shadow-xs: 0 1px 3px rgba(29,78,216,0.04);
        --shadow-sm: 0 2px 8px rgba(29,78,216,0.07);
        --shadow:    0 4px 16px rgba(29,78,216,0.10);
    }
    body.dark-mode {
        --shadow-xs: 0 1px 3px rgba(0,0,0,0.3);
        --shadow-sm: 0 2px 8px rgba(0,0,0,0.38);
        --shadow:    0 4px 16px rgba(0,0,0,0.5);
    }

    /* ‚îÄ‚îÄ Hero Zone ‚îÄ‚îÄ */
    .hero-zone {
        padding: 10px 16px 0;
    }
    .hero-zone .timer-hero {
        background: transparent;
        border: none; box-shadow: none;
        padding: 10px 0 0;
        margin: 0;
    }

    /* ‚îÄ‚îÄ Today Snapshot Card ‚îÄ‚îÄ */
    .snapshot-card {
        display: flex; align-items: center;
        background: var(--card-bg); border: 1px solid var(--border);
        border-radius: var(--radius); margin: 16px 16px 0;
        padding: 16px 12px; box-shadow: var(--shadow-xs);
        gap: 8px;
    }
    .snapshot-col {
        flex: 1; text-align: center;
    }
    .snapshot-val {
        font-size: 1.45rem; font-weight: 800; color: var(--primary);
        line-height: 1; margin-bottom: 4px;
        font-family: 'IBM Plex Mono', monospace;
    }
    .snapshot-lbl {
        font-size: 0.62rem; color: var(--text-muted); font-weight: 600;
    }
    .snapshot-bar-bg {
        height: 3px; background: var(--border); border-radius: 2px;
        margin-top: 6px; overflow: hidden;
    }
    .snapshot-bar-fill {
        height: 100%; border-radius: 2px;
        background: linear-gradient(90deg, var(--primary), var(--accent));
        transition: width 0.6s ease;
    }
    .snapshot-divider {
        width: 1px; height: 40px; background: var(--border); flex-shrink: 0;
    }

    /* ‚îÄ‚îÄ System Collapse ‚îÄ‚îÄ */
    .system-collapse {
        margin: 14px 16px 0; border-radius: var(--radius);
        overflow: hidden; border: 1px solid var(--border);
        background: var(--card-bg); box-shadow: var(--shadow-xs);
    }
    .system-toggle {
        width: 100%; display: flex; align-items: center;
        justify-content: space-between; padding: 13px 16px;
        background: none; border: none; cursor: pointer;
        font-family: 'Tajawal', sans-serif; font-size: 0.88rem;
        font-weight: 700; color: var(--text);
        transition: background 0.2s;
    }
    .system-toggle:hover { background: var(--primary-soft); }
    .system-chevron { color: var(--text-muted); font-size: 0.78rem; transition: transform 0.3s; }
    .system-chevron.open { transform: rotate(180deg); }
    .system-body {
        max-height: 0; overflow: hidden;
        transition: max-height 0.4s cubic-bezier(.4,0,.2,1);
        padding: 0 16px;
    }
    .system-body.open {
        max-height: 900px;
        padding: 0 16px 14px;
    }

    /* ‚îÄ‚îÄ Center Nav Button ‚îÄ‚îÄ */
    .nav-center-btn {
        position: relative; margin-top: -20px;
        flex-shrink: 0;
    }
    .nav-center-ring {
        width: 54px; height: 54px; border-radius: 50%;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 18px rgba(99,102,241,0.45);
        transition: transform 0.2s, box-shadow 0.2s;
        border: 3px solid var(--card-bg);
    }
    .nav-center-btn:active .nav-center-ring {
        transform: scale(0.92);
        box-shadow: 0 2px 8px rgba(99,102,241,0.3);
    }
    .nav-center-ring i { color: white; font-size: 1.2rem; }
    .nav-item span { display: block; }
    /* Active state for center button */
    .nav-center-btn.active .nav-center-ring {
        background: linear-gradient(135deg, var(--primary), var(--break));
    }
    /* Active indicator override for center */
    .nav-center-btn.active::after { display: none; }

    /* ‚îÄ‚îÄ Share FAB ‚Äî softer ‚îÄ‚îÄ */
    .share-fab {
        background: var(--card-bg) !important;
        color: var(--text-muted) !important;
        border: 1.5px solid var(--border) !important;
        box-shadow: var(--shadow-sm) !important;
    }
    .share-fab:hover {
        color: var(--primary) !important;
        border-color: var(--primary-mid) !important;
        box-shadow: var(--shadow) !important;
    }

    /* ‚îÄ‚îÄ World Headers ‚îÄ‚îÄ */
    .world-header {
        border-radius: var(--radius); padding: 16px 18px; margin-bottom: 14px;
        color: white;
    }
    .world-title { font-size: 1rem; font-weight: 800; margin-bottom: 3px; }
    .world-sub   { font-size: 0.75rem; opacity: 0.75; }

    /* ‚îÄ‚îÄ Growth Grid ‚îÄ‚îÄ */
    .growth-grid {
        display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
        margin-bottom: 18px;
    }
    .growth-tile {
        background: var(--card-bg); border: 1px solid var(--border);
        border-radius: 14px; padding: 14px 8px;
        cursor: pointer; font-family: 'Tajawal', sans-serif;
        display: flex; flex-direction: column; align-items: center; gap: 7px;
        transition: box-shadow 0.2s, transform 0.15s;
        box-shadow: var(--shadow-xs);
    }
    .growth-tile:hover  { box-shadow: var(--shadow-sm); transform: translateY(-2px); }
    .growth-tile:active { transform: scale(0.93); }
    .growth-tile-icon {
        width: 38px; height: 38px; border-radius: 10px;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.2rem;
    }
    .growth-tile-label {
        font-size: 0.62rem; font-weight: 700; color: var(--text-muted);
        text-align: center;
    }

    /* ‚îÄ‚îÄ More menu grid ‚îÄ‚îÄ */
    .more-tile {
        background: var(--bg); border: 1px solid var(--border);
        border-radius: 12px; padding: 12px 6px;
        cursor: pointer; display: flex; flex-direction: column;
        align-items: center; gap: 5px;
        font-family: 'Tajawal', sans-serif;
        transition: background 0.2s, transform 0.15s;
    }
    .more-tile:hover  { background: var(--primary-soft); }
    .more-tile:active { transform: scale(0.92); }
    .more-tile-icon  { font-size: 1.3rem; }
    .more-tile-label { font-size: 0.6rem; font-weight: 700; color: var(--text-muted); text-align: center; }

    /* ‚îÄ‚îÄ Reduced bottom padding ‚îÄ‚îÄ */
    body { padding-bottom: 80px; }
    .bottom-nav { padding: 6px 4px 10px; }

    /* ‚îÄ‚îÄ Focus ring accessibility ‚îÄ‚îÄ */
    button:focus-visible {
        outline: 2px solid var(--primary-mid);
        outline-offset: 2px;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       KNOWLEDGE TREE ‚Äî ÿ¥ÿ¨ÿ±ÿ© ÿßŸÑŸÖÿπÿ±ŸÅÿ©
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    #tree-section {
        padding: 16px;
        animation: fadeIn 0.2s ease;
    }

    .tree-header-card {
        background: linear-gradient(135deg, #0f4c2a 0%, #1a6b3a 50%, #065F46 100%);
        border-radius: var(--radius);
        padding: 18px 20px;
        margin-bottom: 14px;
        color: white;
        position: relative;
        overflow: hidden;
    }
    body:not(.dark-mode) .tree-header-card {
        background: linear-gradient(135deg, #14532d 0%, #166534 50%, #15803d 100%);
    }
    .tree-header-card::before {
        content: '';
        position: absolute; top: -40px; right: -40px;
        width: 120px; height: 120px; border-radius: 50%;
        background: rgba(255,255,255,0.05);
    }
    .tree-header-card::after {
        content: '';
        position: absolute; bottom: -30px; left: -20px;
        width: 90px; height: 90px; border-radius: 50%;
        background: rgba(255,255,255,0.04);
    }
    .tree-header-title {
        font-size: 1.1rem; font-weight: 800; margin-bottom: 4px;
        display: flex; align-items: center; gap: 8px;
    }
    .tree-header-sub {
        font-size: 0.78rem; opacity: 0.8;
    }
    .tree-level-row {
        display: flex; align-items: center; gap: 12px; margin-top: 12px;
        background: rgba(255,255,255,0.1); border-radius: 12px; padding: 10px 14px;
    }
    .tree-level-icon { font-size: 1.6rem; }
    .tree-level-text { font-size: 0.82rem; font-weight: 700; opacity: 0.95; }
    .tree-level-sub  { font-size: 0.7rem;  opacity: 0.7; margin-top: 1px; }
    .tree-hours-bar  { flex: 1; background: rgba(255,255,255,0.2); height: 5px; border-radius: 3px; overflow: hidden; margin-top: 5px; }
    .tree-hours-fill { height: 100%; background: #86efac; border-radius: 3px; transition: width 0.8s cubic-bezier(.4,0,.2,1); }

    /* ‚îÄ‚îÄ Canvas wrapper ‚îÄ‚îÄ */
    .tree-canvas-wrap {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        margin-bottom: 14px;
        overflow: hidden;
        position: relative;
        box-shadow: var(--shadow-xs);
    }
    #knowledgeTreeCanvas {
        display: block;
        width: 100%;
        cursor: pointer;
    }
    .tree-canvas-hint {
        position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
        background: rgba(0,0,0,0.5); color: white; font-size: 0.68rem;
        padding: 4px 10px; border-radius: 50px; pointer-events: none;
        white-space: nowrap; opacity: 0.7;
    }

    /* ‚îÄ‚îÄ Flower bloom animation ‚îÄ‚îÄ */
    @keyframes flowerBloom {
        0%   { transform: scale(0) rotate(-180deg); opacity: 0; }
        60%  { transform: scale(1.3) rotate(10deg); opacity: 1; }
        100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }
    .flower-particle {
        position: fixed; pointer-events: none;
        font-size: 1.6rem; z-index: 9999;
        animation: flowerBloom 0.6s cubic-bezier(.4,0,.2,1) forwards,
                   flowerFloat 2s ease-out 0.3s forwards;
    }
    @keyframes flowerFloat {
        0%   { transform: translateY(0) scale(1); opacity: 1; }
        100% { transform: translateY(-80px) scale(0.5); opacity: 0; }
    }

    /* ‚îÄ‚îÄ Branch cards ‚îÄ‚îÄ */
    .branches-grid {
        display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
        margin-bottom: 14px;
    }
    .branch-card {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 13px 14px;
        box-shadow: var(--shadow-xs);
        transition: box-shadow 0.2s, transform 0.2s;
        position: relative; overflow: hidden;
    }
    .branch-card:active { transform: scale(0.97); }
    .branch-card::before {
        content: '';
        position: absolute; top: 0; right: 0;
        width: 100%; height: 3px;
        border-radius: 0;
    }
    .branch-card-color { width: 100%; height: 3px; border-radius: 3px 3px 0 0; position: absolute; top: 0; right: 0; left: 0; }
    .branch-icon { font-size: 1.4rem; margin-bottom: 4px; }
    .branch-name { font-size: 0.83rem; font-weight: 700; color: var(--text); margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .branch-hours { font-size: 0.7rem; color: var(--text-muted); }
    .branch-flowers { font-size: 0.75rem; margin-top: 4px; letter-spacing: 1px; }
    .branch-bar-bg { background: var(--border); height: 4px; border-radius: 2px; margin-top: 6px; overflow: hidden; }
    .branch-bar-fill { height: 100%; border-radius: 2px; transition: width 0.6s ease; }

    /* ‚îÄ‚îÄ Flower grid ‚îÄ‚îÄ */
    .flowers-card {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 16px 18px;
        margin-bottom: 14px;
        box-shadow: var(--shadow-xs);
    }
    .flowers-grid {
        display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;
    }
    .flower-badge {
        display: flex; flex-direction: column; align-items: center;
        background: var(--bg); border: 1px solid var(--border);
        border-radius: 12px; padding: 10px 13px; gap: 3px;
        min-width: 70px;
        transition: transform 0.2s;
    }
    .flower-badge:active { transform: scale(0.95); }
    .flower-badge.locked { opacity: 0.35; filter: grayscale(1); }
    .flower-emoji { font-size: 1.5rem; }
    .flower-label { font-size: 0.62rem; color: var(--text-muted); text-align: center; }
    .flower-req   { font-size: 0.58rem; color: var(--primary); font-weight: 700; margin-top: 1px; }

    /* ‚îÄ‚îÄ Tree milestones ‚îÄ‚îÄ */
    .milestones-timeline {
        position: relative; padding-right: 22px;
    }
    .milestones-timeline::before {
        content: '';
        position: absolute; top: 0; bottom: 0; right: 8px;
        width: 2px; background: var(--border); border-radius: 1px;
    }
    .milestone-item {
        display: flex; gap: 12px; margin-bottom: 14px;
        position: relative;
    }
    .milestone-dot {
        position: absolute; right: -18px; top: 3px;
        width: 10px; height: 10px; border-radius: 50%;
        background: var(--border); border: 2px solid var(--card-bg);
        flex-shrink: 0;
    }
    .milestone-dot.done { background: #22c55e; }
    .milestone-dot.current { background: var(--primary); box-shadow: 0 0 0 3px rgba(99,102,241,0.2); }
    .milestone-text { font-size: 0.83rem; font-weight: 700; color: var(--text); }
    .milestone-sub  { font-size: 0.7rem; color: var(--text-muted); margin-top: 2px; }
    .milestone-badge { font-size: 0.68rem; padding: 2px 8px; border-radius: 50px;
        background: var(--primary-soft); color: var(--primary); font-weight: 700; display: inline-block; margin-top: 4px; }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       SPIRIT WORLD v3 ‚Äî ÿ®ÿ≥ÿßÿ∑ÿ© ¬∑ ÿ´ÿ®ÿßÿ™ ¬∑ ÿ±Ÿàÿ≠
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    #spiritual.spirit-world {
        background: #0d1526 !important;
        padding: 0 0 110px !important;
        min-height: 100vh;
    }
    body:not(.dark-mode) #spiritual.spirit-world {
        background: #f0f4ff !important;
    }
    .sp-section-label {
        font-size: 0.65rem; font-weight: 800; letter-spacing: 2.5px;
        text-transform: uppercase; color: rgba(165,180,252,0.6);
        margin-bottom: 12px; display: flex; align-items: center; gap: 8px;
        padding: 0 20px;
    }
    body:not(.dark-mode) .sp-section-label { color: var(--text-muted); }
    .sp-section-label::after { content: ''; flex: 1; height: 1px; background: rgba(99,102,241,0.15); }
    body:not(.dark-mode) .sp-section-label::after { background: var(--border); }

    /* 1. ŸÜŸäÿ© */
    .sp-niyya-card {
        background: linear-gradient(160deg, #1e1b4b 0%, #312e81 100%);
        padding: 32px 24px 24px; text-align: center;
        position: relative; overflow: hidden;
        border-bottom: 1px solid rgba(99,102,241,0.2);
    }
    body:not(.dark-mode) .sp-niyya-card {
        background: linear-gradient(160deg, #1e3a8a 0%, #1d4ed8 100%);
    }
    .sp-niyya-card::before {
        content: ''; position: absolute; width: 220px; height: 220px; border-radius: 50%;
        background: radial-gradient(circle, rgba(99,102,241,0.07), transparent 70%);
        top: -80px; left: 50%; transform: translateX(-50%);
    }
    .sp-niyya-label {
        font-size: 0.62rem; letter-spacing: 3px; text-transform: uppercase;
        color: rgba(199,210,254,0.45); margin-bottom: 16px; position: relative;
    }
    .sp-niyya-text {
        font-size: 1.08rem; font-weight: 700; color: #e0e7ff;
        line-height: 1.9; direction: rtl; position: relative;
        margin-bottom: 20px; min-height: 2.5em;
        transition: opacity 0.3s ease;
    }
    .sp-niyya-btn {
        background: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.12);
        border-radius: 50px; padding: 8px 20px; color: rgba(199,210,254,0.7);
        font-size: 0.73rem; font-weight: 700; cursor: pointer;
        font-family: 'Tajawal', sans-serif; transition: background 0.2s, color 0.2s;
        position: relative;
    }
    .sp-niyya-btn:hover { background: rgba(255,255,255,0.13); color: #e0e7ff; }

    /* 2. ÿ¢Ÿäÿ© ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ */
    .sp-week-verse-wrap { padding: 28px 20px 0; }
    .sp-week-verse-card {
        background: var(--card-bg); border: 1px solid var(--border);
        border-radius: 18px; padding: 22px 20px;
        box-shadow: 0 2px 12px rgba(99,102,241,0.06);
    }
    body.dark-mode .sp-week-verse-card {
        background: rgba(255,255,255,0.03); border-color: rgba(99,102,241,0.15);
    }
    .sp-week-verse-text {
        font-size: 1.18rem; font-weight: 700; color: var(--primary);
        line-height: 1.9; direction: rtl; text-align: center; margin-bottom: 8px;
    }
    body.dark-mode .sp-week-verse-text { color: #a5b4fc; }
    .sp-week-verse-ref {
        font-size: 0.65rem; color: var(--text-muted); text-align: center; margin-bottom: 14px;
    }
    .sp-week-verse-tafsir {
        font-size: 0.78rem; color: var(--text-muted); line-height: 1.7;
        text-align: center; direction: rtl;
        padding-top: 12px; border-top: 1px solid var(--border);
    }
    body.dark-mode .sp-week-verse-tafsir {
        color: rgba(165,180,252,0.5); border-color: rgba(99,102,241,0.1);
    }

    /* 3. ÿ≤ÿßÿØ ÿ∑ÿßŸÑÿ®ÿ© ÿßŸÑÿπŸÑŸÖ */
    .sp-duas-wrap { padding: 28px 20px 0; }
    .sp-duas-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .sp-dua-card {
        background: var(--card-bg); border: 1px solid var(--border);
        border-radius: 16px; padding: 16px 14px;
        cursor: pointer; position: relative; overflow: hidden;
        transition: box-shadow 0.25s, border-color 0.25s, grid-column 0.3s;
    }
    body.dark-mode .sp-dua-card {
        background: rgba(255,255,255,0.025); border-color: rgba(255,255,255,0.06);
    }
    .sp-dua-card:hover { box-shadow: 0 4px 16px rgba(99,102,241,0.1); }
    .sp-dua-card.open {
        grid-column: 1 / -1;
        border-color: var(--primary-mid);
        box-shadow: 0 4px 20px rgba(99,102,241,0.12);
    }
    body.dark-mode .sp-dua-card.open { border-color: rgba(99,102,241,0.4); }
    .sp-dua-icon { font-size: 1.4rem; margin-bottom: 8px; }
    .sp-dua-title { font-size: 0.82rem; font-weight: 800; color: var(--text); line-height: 1.3; }
    body.dark-mode .sp-dua-title { color: rgba(224,231,255,0.88); }
    .sp-dua-hint { font-size: 0.65rem; color: var(--text-muted); margin-top: 3px; }
    body.dark-mode .sp-dua-hint { color: rgba(165,180,252,0.4); }
    .sp-dua-body {
        max-height: 0; overflow: hidden;
        transition: max-height 0.45s cubic-bezier(.4,0,.2,1), opacity 0.35s;
        opacity: 0;
    }
    .sp-dua-card.open .sp-dua-body { max-height: 320px; opacity: 1; }
    .sp-dua-full-text {
        font-size: 0.95rem; font-weight: 700; direction: rtl; line-height: 1.9;
        color: var(--text); margin-top: 14px; padding-top: 12px;
        border-top: 1px solid var(--border);
    }
    body.dark-mode .sp-dua-full-text {
        color: rgba(224,231,255,0.88); border-color: rgba(99,102,241,0.1);
    }
    .sp-dua-copy-btn {
        display: inline-flex; align-items: center; gap: 5px;
        margin-top: 10px; padding: 5px 14px;
        background: rgba(99,102,241,0.08); border: 1px solid rgba(99,102,241,0.2);
        border-radius: 50px; font-size: 0.68rem; font-weight: 700;
        color: var(--primary); cursor: pointer; font-family: 'Tajawal', sans-serif;
        transition: background 0.2s;
    }
    body.dark-mode .sp-dua-copy-btn { color: #a5b4fc; }
    .sp-dua-copy-btn:hover { background: rgba(99,102,241,0.15); }
    @keyframes spDuaSparkle {
        0%   { opacity: 1; transform: translate(0,0) scale(1); }
        100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0.2); }
    }
    .sp-dua-sparkle {
        position: fixed; pointer-events: none; z-index: 9999;
        font-size: 1rem; animation: spDuaSparkle 0.75s ease-out forwards;
    }

    /* 4. ÿπÿØÿßÿØ ÿßŸÑÿ∞ŸÉÿ± */
    .sp-thikr-wrap { padding: 28px 20px 0; }
    .sp-thikr-card {
        background: var(--card-bg); border: 1px solid var(--border);
        border-radius: 18px; overflow: hidden;
        box-shadow: 0 1px 6px rgba(99,102,241,0.05);
    }
    body.dark-mode .sp-thikr-card {
        background: rgba(255,255,255,0.025); border-color: rgba(255,255,255,0.06);
    }
    .sp-thikr-row {
        display: flex; align-items: center; justify-content: space-between;
        padding: 18px 20px;
    }
    .sp-thikr-divider { height: 1px; background: var(--border); margin: 0 20px; }
    body.dark-mode .sp-thikr-divider { background: rgba(99,102,241,0.1); }
    .sp-thikr-name { font-size: 0.9rem; font-weight: 700; color: var(--text); margin-bottom: 4px; }
    body.dark-mode .sp-thikr-name { color: rgba(224,231,255,0.85); }
    .sp-thikr-count {
        font-size: 1.8rem; font-weight: 800; color: var(--primary);
        font-variant-numeric: tabular-nums; line-height: 1;
    }
    body.dark-mode .sp-thikr-count { color: #818cf8; }
    .sp-thikr-btn {
        width: 50px; height: 50px; border-radius: 50%;
        background: var(--primary); color: white; border: none;
        font-size: 1.6rem; font-weight: 300; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        transition: transform 0.1s, box-shadow 0.2s;
        box-shadow: 0 3px 10px rgba(99,102,241,0.3); flex-shrink: 0;
    }
    .sp-thikr-btn:active { transform: scale(0.88); }
    body.dark-mode .sp-thikr-btn { background: #4f46e5; }
    .sp-thikr-reset {
        display: block; width: 100%; background: none; border: none;
        font-size: 0.7rem; color: var(--text-muted); cursor: pointer;
        font-family: 'Tajawal', sans-serif; text-align: center;
        padding: 10px 20px 14px; transition: color 0.2s;
    }
    .sp-thikr-reset:hover { color: var(--danger); }

    /* 5. ŸÖŸÑÿ¨ÿ¶Ÿä */
    .sp-refuge-wrap { padding: 28px 20px 0; }
    .sp-refuge-btn {
        width: 100%; padding: 18px 20px;
        background: rgba(99,102,241,0.07);
        border: 1.5px solid rgba(99,102,241,0.18);
        border-radius: 18px; color: rgba(165,180,252,0.85);
        font-size: 1rem; font-weight: 800; cursor: pointer;
        font-family: 'Tajawal', sans-serif; letter-spacing: 0.5px;
        transition: background 0.25s, border-color 0.25s;
    }
    body:not(.dark-mode) .sp-refuge-btn {
        background: var(--primary-soft); border-color: var(--primary-mid); color: var(--primary);
    }
    .sp-refuge-btn:hover { background: rgba(99,102,241,0.13); border-color: rgba(99,102,241,0.35); }
    body:not(.dark-mode) .sp-refuge-btn:hover { background: #dbeafe; }

    /* ÿßÿ≠ÿ™ÿ≥ÿßÿ® ÿßŸÑÿ£ÿ¨ÿ± */
    .ihtisab-wrap {
        display: flex; align-items: center; gap: 10px;
        padding: 9px 14px; margin: 8px 0 2px;
        background: rgba(99,102,241,0.05); border-radius: 12px;
        border: 1px solid rgba(99,102,241,0.1); cursor: pointer;
        transition: background 0.2s;
    }
    .ihtisab-wrap:hover { background: rgba(99,102,241,0.09); }
    .ihtisab-check {
        width: 20px; height: 20px; border-radius: 6px;
        border: 1.5px solid rgba(99,102,241,0.35);
        background: transparent; display: flex; align-items: center;
        justify-content: center; flex-shrink: 0; transition: all 0.2s; font-size: 0.75rem;
    }
    .ihtisab-check.on { background: #6366f1; border-color: #6366f1; color: white; }
    .ihtisab-label { font-size: 0.8rem; font-weight: 700; color: var(--text-muted); flex: 1; }
    .ihtisab-label.on { color: #6366f1; }
    body.dark-mode .ihtisab-label.on { color: #a5b4fc; }
    .ihtisab-done-banner {
        background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(139,92,246,0.06));
        border: 1px solid rgba(99,102,241,0.18); border-radius: 14px;
        padding: 16px 18px; text-align: center; margin: 8px 0; animation: fadeIn 0.4s ease;
    }
    .ihtisab-done-text {
        font-size: 0.92rem; font-weight: 700; color: #818cf8; line-height: 1.7; direction: rtl;
    }
    body:not(.dark-mode) .ihtisab-done-text { color: var(--primary); }
    
    </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê Splash Screen ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="splash-screen" id="splashScreen">
    <svg width="64" height="64" viewBox="0 0 72 72" fill="none" class="splash-logo-wrap">
        <rect width="72" height="72" rx="18" fill="url(#splashIconGrad)"/>
        <path d="M20 52V20L52 52V20" stroke="url(#splashBeamGrad)" stroke-width="5"
              stroke-linecap="round" stroke-linejoin="round"/>
        <line x1="36" y1="36" x2="56" y2="16" stroke="#6366F1" stroke-width="1.8"
              stroke-dasharray="2 3" opacity="0.8"/>
        <circle cx="56" cy="16" r="3" fill="#A5B4FC"/>
        <defs>
            <linearGradient id="splashIconGrad" x1="0" y1="0" x2="72" y2="72" gradientUnits="userSpaceOnUse">
                <stop offset="0%" stop-color="#16204D"/>
                <stop offset="100%" stop-color="#1E2A78"/>
            </linearGradient>
            <linearGradient id="splashBeamGrad" x1="20" y1="20" x2="52" y2="52" gradientUnits="userSpaceOnUse">
                <stop offset="0%" stop-color="#60A5FA"/>
                <stop offset="100%" stop-color="#A5B4FC"/>
            </linearGradient>
        </defs>
    </svg>
    <div class="splash-wordmark"><strong>N</strong>ourium</div>
    <div class="splash-beam"></div>
    <div class="splash-tagline">Focus ¬∑ Discipline ¬∑ Rise</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê Header ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<header>
    <div class="logo">
        <div class="logo-mark">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M5 18V6L19 18V6" stroke="#7DD3FC" stroke-width="2.4"
                      stroke-linecap="round" stroke-linejoin="round"/>
                <line x1="12" y1="12" x2="19" y2="5" stroke="#A5B4FC"
                      stroke-width="1" stroke-dasharray="1.5 2" opacity="0.7"/>
            </svg>
        </div>
        <span class="logo-wordmark"><strong>N</strong>ourium</span>
    </div>
    <div class="header-actions">
        <button class="btn-icon" id="wakeLockBtn" onclick="toggleWakeLock()" title="ŸÖŸÜÿπ ÿ•ÿ∑ŸÅÿßÿ° ÿßŸÑÿ¥ÿßÿ¥ÿ©" style="display:none;">
            <i class="fas fa-eye"></i>
        </button>
        <button class="btn-icon" onclick="toggleSidePanel()" title="ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™">
            <i class="fas fa-chart-pie"></i>
        </button>
        <button class="btn-icon" onclick="toggleTheme()" title="ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÖÿ∏Ÿáÿ±">
            <i class="fas fa-moon" id="themeIcon"></i>
        </button>
    </div>
</header>

<!-- Focus exit button -->
<button class="focus-exit-btn" onclick="exitFocusMode()">‚úï ÿÆÿ±Ÿàÿ¨ ŸÖŸÜ Ÿàÿ∂ÿπ ÿßŸÑÿ™ÿ±ŸÉŸäÿ≤</button>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ÿßŸÑŸÑŸàÿ≠ÿ© ÿßŸÑÿ¨ÿßŸÜÿ®Ÿäÿ© ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="side-panel" id="sidePanel" onclick="handlePanelClick(event)">
    <div class="panel-content">
        <span class="close-panel" onclick="toggleSidePanel()">&times;</span>
        <h2 style="margin-top:16px;">ŸÑŸàÿ≠ÿ© ÿßŸÑŸÇÿßÿ¶ÿØ</h2>

        <div class="panel-tabs">
            <button class="panel-tab active" onclick="switchPanelTab('progress', this)">ÿ™ŸÇÿØŸÖŸä</button>
            <button class="panel-tab" onclick="switchPanelTab('settings', this)">ÿßŸÑŸáÿØŸÅ</button>
            <button class="panel-tab" onclick="switchPanelTab('subjects', this)">ÿßŸÑŸÖŸàÿßÿØ</button>
        </div>

        <!-- Tab 1: Progress -->
        <div class="panel-tab-content active" id="panelTab-progress">
            <div class="streak-row">
                <div>
                    <div style="font-size:0.75rem;color:var(--text-muted);">ÿßŸÑÿ£ŸäÿßŸÖ ÿßŸÑŸÖÿ™ÿ™ÿßŸÑŸäÿ©</div>
                    <div style="display:flex;align-items:baseline;gap:5px;">
                        <span class="streak-count" id="streakCount">0</span>
                        <span style="font-size:0.85rem;color:var(--text-muted);">ŸäŸàŸÖ</span>
                        <span id="streakFire" style="font-size:1.4rem;">üî•</span>
                    </div>
                </div>
            </div>

            <div class="level-card">
                <div class="level-badge" id="levelIcon">üéì</div>
                <h3 id="levelName" style="font-size:0.95rem;margin-bottom:3px;">ÿ∑ÿßŸÑÿ® ÿ≥ŸÜÿ© 1</h3>
                <p style="font-size:0.82rem;opacity:0.8;">ÿßŸÑŸÜŸÇÿßÿ∑: <span id="xpPoints">0</span></p>
                <div class="progress-bar"><div class="progress-fill" id="xpBar"></div></div>
                <p style="font-size:0.7rem;opacity:0.7;margin-top:6px;" id="xpToNext"></p>
            </div>

            <h3 style="margin-bottom:9px;font-size:0.9rem;color:var(--text-muted);">ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿ≥ÿ±Ÿäÿπÿ©</h3>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-val" id="statDailySessions">0</div><div class="stat-label">ÿ¨ŸÑÿ≥ÿßÿ™ ÿßŸÑŸäŸàŸÖ</div></div>
                <div class="stat-card"><div class="stat-val" id="statWeeklySessions">0</div><div class="stat-label">ÿ¨ŸÑÿ≥ÿßÿ™ ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ</div></div>
                <div class="stat-card"><div class="stat-val" id="statMonthlyMins">0</div><div class="stat-label">ÿØŸÇÿßÿ¶ŸÇ ÿßŸÑÿ¥Ÿáÿ±</div></div>
                <div class="stat-card"><div class="stat-val" id="totalSessions">0</div><div class="stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ¨ŸÑÿ≥ÿßÿ™</div></div>
            </div>
        </div>

        <!-- Tab 2: Goal -->
        <div class="panel-tab-content" id="panelTab-settings">
            <h3 style="margin-bottom:9px;font-size:0.9rem;">ÿßŸÑŸáÿØŸÅ ÿßŸÑŸäŸàŸÖŸä</h3>
            <div class="goal-input-row" style="margin-bottom:10px;">
                <input type="number" id="dailyGoalInput" placeholder="ÿπÿØÿØ ÿßŸÑÿ¨ŸÑÿ≥ÿßÿ™" min="1" max="20" style="margin-bottom:0">
                <button class="btn btn-primary" onclick="saveDailyGoal()" style="padding:10px 14px;white-space:nowrap;">ÿ≠ŸÅÿ∏</button>
            </div>
            <div class="goal-progress-wrapper" id="goalProgressWrapper" style="display:none;">
                <div class="goal-label">
                    <span id="goalCurrentLabel">0 ÿ¨ŸÑÿ≥ÿ©</span>
                    <span id="goalTargetLabel">/ 0</span>
                </div>
                <div class="goal-bar-bg"><div class="goal-bar-fill" id="goalBarFill"></div></div>
            </div>
        </div>

        <!-- Tab 3: Subjects -->
        <div class="panel-tab-content" id="panelTab-subjects">
            <h3 style="margin-bottom:9px;font-size:0.9rem;">ŸÖŸàÿßÿØŸä ÿßŸÑÿØÿ±ÿßÿ≥Ÿäÿ©</h3>
            <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:12px;">ÿ£ÿ∂ŸÅ ŸÖŸàÿßÿØŸÉ Ÿàÿ≠ÿØÿØ ŸÑŸàŸÜÿßŸã ŸÖŸÖŸäÿ≤ÿßŸã ŸÑŸÉŸÑ ŸÖŸÜŸáÿß</p>
            <div class="add-subject-form" style="display:flex;gap:6px;align-items:center;margin-bottom:12px;">
                <input type="text" id="newSubjectNamePanel" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖÿßÿØÿ©..." onkeypress="if(event.key==='Enter') addSubjectFromPanel()" style="flex:1;margin-bottom:0;font-size:0.85rem;padding:8px 10px;">
                <input type="color" id="newSubjectColorPanel" value="#4F46E5" style="width:38px;height:36px;padding:2px;border:none;cursor:pointer;border-radius:8px;flex-shrink:0;margin-bottom:0;">
                <button class="btn btn-primary" onclick="addSubjectFromPanel()" style="padding:8px 12px;flex-shrink:0;white-space:nowrap;font-size:0.82rem;">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div style="display:flex;flex-wrap:wrap;gap:6px;" id="subjectTagsContainerPanel"></div>
            <div id="noSubjectsMsgPanel" style="display:none;text-align:center;color:var(--text-muted);font-size:0.82rem;padding:16px 0;">
                <i class="fas fa-book-open" style="font-size:1.5rem;margin-bottom:6px;display:block;"></i>
                ŸÑŸÖ ÿ™ÿ∂ŸÅ ÿ£Ÿä ŸÖÿßÿØÿ© ÿ®ÿπÿØ
            </div>
        </div>

        <div id="storageWarningPanel"></div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="home" class="section active">
    <!-- hidden alerts (still functional) -->
    <div style="display:none">
        <div id="homeReviewAlerts"></div>
        <div id="homeExamAlerts"></div>
    </div>

    <!-- ‚îÄ‚îÄ HERO ZONE: Timer only ‚îÄ‚îÄ -->
    <div class="hero-zone">

        <!-- Mode pills -->
        <div class="timer-mode">
            <button class="mode-btn active" id="focusBtn" onclick="setTimerMode('focus', this)">ÿØÿ±ÿßÿ≥ÿ©</button>
            <button class="mode-btn break" id="breakBtn" onclick="setTimerMode('break', this)">ÿßÿ≥ÿ™ÿ±ÿßÿ≠ÿ©</button>
        </div>

        <!-- Subject select -->
        <div class="subject-select" id="subjectSelectWrapper">
            <select id="timerSubjectSelect" onchange="updateTimerSubjectBadge()">
                <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿßÿØÿ© (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)...</option>
            </select>
            <div id="timerSubjectBadge" style="display:none;text-align:center;">
                <span class="timer-subject-badge" id="timerSubjectBadgeText"></span>
            </div>
        </div>

        <!-- Duration pills -->
        <div class="duration-selector" id="durationSelector">
            <button class="dur-btn active" onclick="setDuration(25, this)">25 ÿØ</button>
            <button class="dur-btn" onclick="setDuration(45, this)">45 ÿØ</button>
            <button class="dur-btn" onclick="setDuration(50, this)">50 ÿØ</button>
            <button class="dur-btn" onclick="setDuration(90, this)">90 ÿØ</button>
        </div>

        <!-- Nouri + Timer -->
        <div class="timer-hero timer-card">
            <div class="nouri-wrap" id="nouriWrap">
                <div class="nouri-bubble" id="nouriBubble">ÿ£ŸáŸÑÿßŸã! ÿ£ŸÜÿß ŸÜŸàÿ±Ÿäÿå ÿ±ŸÅŸäŸÇŸÉ ŸÅŸä ÿ±ÿ≠ŸÑÿ© ÿßŸÑÿ∑ÿ® üêá</div>
                <div class="nouri-svg-wrap" id="nouriSvg" onclick="nouriSpeakManual()" title="ÿßŸÜŸÇÿ± ŸÑÿ£ÿ≥ŸÖÿπ ŸÜŸàÿ±Ÿä!">
                    <svg width="88" height="90" viewBox="0 0 88 90" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <ellipse class="nouri-ear-l" cx="28" cy="22" rx="8" ry="18" fill="#c084fc" opacity="0.9" transform="rotate(-12 28 22)"/>
                        <ellipse cx="28" cy="22" rx="4" ry="11" fill="#f0abfc" opacity="0.8" transform="rotate(-12 28 22)"/>
                        <ellipse class="nouri-ear-r" cx="60" cy="20" rx="8" ry="18" fill="#c084fc" opacity="0.9" transform="rotate(12 60 20)"/>
                        <ellipse cx="60" cy="20" rx="4" ry="11" fill="#f0abfc" opacity="0.8" transform="rotate(12 60 20)"/>
                        <ellipse class="nouri-body-fill" cx="44" cy="64" rx="26" ry="22" fill="#a78bfa"/>
                        <circle class="nouri-body-fill" cx="44" cy="42" r="22" fill="#c4b5fd"/>
                        <ellipse cx="36" cy="40" rx="3.5" ry="4" fill="#1e1b4b"/>
                        <ellipse cx="52" cy="40" rx="3.5" ry="4" fill="#1e1b4b"/>
                        <circle cx="37.5" cy="38.5" r="1.2" fill="white"/>
                        <circle cx="53.5" cy="38.5" r="1.2" fill="white"/>
                        <ellipse cx="44" cy="47" rx="2.5" ry="1.8" fill="#f472b6"/>
                        <path d="M39 50 Q44 54 49 50" stroke="#7c3aed" stroke-width="1.8" fill="none" stroke-linecap="round"/>
                        <ellipse cx="33" cy="46" rx="4" ry="2.5" fill="#f9a8d4" opacity="0.5"/>
                        <ellipse cx="55" cy="46" rx="4" ry="2.5" fill="#f9a8d4" opacity="0.5"/>
                        <ellipse cx="24" cy="74" rx="7" ry="5" fill="#a78bfa" opacity="0.8"/>
                        <ellipse cx="64" cy="74" rx="7" ry="5" fill="#a78bfa" opacity="0.8"/>
                        <circle cx="70" cy="72" r="6" fill="#e9d5ff" opacity="0.9"/>
                    </svg>
                </div>
            </div>
            <div class="timer-display" id="timer">25:00</div>
            <div id="wakeLockStatus" style="text-align:center;margin-top:6px;"></div>
        </div>

        <!-- ÿßÿ≠ÿ™ÿ≥ÿßÿ® ÿßŸÑÿ£ÿ¨ÿ± -->
        <div class="ihtisab-wrap" id="ihtisabWrap" onclick="toggleIhtisab()">
            <div class="ihtisab-check" id="ihtisabCheck"></div>
            <div class="ihtisab-label" id="ihtisabLabel">‚òë ÿ£ÿ≠ÿ™ÿ≥ÿ® Ÿáÿ∞Ÿá ÿßŸÑÿ¨ŸÑÿ≥ÿ© ŸÑŸÑŸá</div>
        </div>

        <!-- Controls -->
        <div class="timer-controls">
            <button class="btn-start-main" id="startBtn" onclick="toggleTimer()">
                <i class="fas fa-play"></i> ÿßÿ®ÿØÿ£
            </button>
            <button class="btn btn-secondary" id="pauseBtn" onclick="pauseTimer()" style="display:none;">
                <i class="fas fa-pause"></i> ÿ•ŸäŸÇÿßŸÅ
            </button>
            <button class="btn btn-secondary" onclick="resetTimer()" style="padding:11px 16px;">
                <i class="fas fa-redo"></i>
            </button>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ TODAY SNAPSHOT CARD ‚îÄ‚îÄ -->
    <div class="snapshot-card" id="snapshotCard">
        <div class="snapshot-col">
            <div class="snapshot-val" id="snapHours">0.0</div>
            <div class="snapshot-lbl">ÿ≥ÿßÿπÿßÿ™ ÿßŸÑŸäŸàŸÖ</div>
            <div class="snapshot-bar-bg"><div class="snapshot-bar-fill" id="snapHoursBar" style="width:0%"></div></div>
        </div>
        <div class="snapshot-divider"></div>
        <div class="snapshot-col">
            <div class="snapshot-val" id="snapStreak">0 üî•</div>
            <div class="snapshot-lbl">ÿ£ŸäÿßŸÖ ŸÖÿ™ÿ™ÿßŸÑŸäÿ©</div>
        </div>
        <div class="snapshot-divider"></div>
        <div class="snapshot-col">
            <div class="snapshot-val" id="snapLevel">üéì</div>
            <div class="snapshot-lbl" id="snapLevelName">ÿßÿ®ÿØÿ£ ÿ±ÿ≠ŸÑÿ™ŸÉ</div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ MY SYSTEM (Collapsible) ‚îÄ‚îÄ -->
    <div class="system-collapse" id="systemCollapse">
        <button class="system-toggle" onclick="toggleSystemCollapse()" id="systemToggleBtn">
            <span>üìä ŸÜÿ∏ÿßŸÖŸä</span>
            <i class="fas fa-chevron-down system-chevron" id="systemChevron"></i>
        </button>
        <div class="system-body" id="systemBody">
            <!-- Lux -->
            <div class="lux-panel lux-0" id="luxPanel" style="margin-bottom:12px;">
                <div class="lux-aura lux-aura-1"></div>
                <div class="lux-aura lux-aura-2"></div>
                <div class="lux-beam"></div>
                <div class="lux-label" id="luxLabel">ŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑŸÜŸàÿ±</div>
                <div class="lux-title" id="luxTitle">üåë ÿßÿ®ÿØÿ£ ÿ±ÿ≠ŸÑÿ™ŸÉ</div>
                <div class="lux-bar-track"><div class="lux-bar-fill" id="luxBarFill" style="width:0%"></div></div>
                <div class="lux-stats">
                    <div class="lux-stat"><div class="lux-stat-val" id="luxTodaySessions">0</div><div class="lux-stat-label">ÿ¨ŸÑÿ≥ÿßÿ™ ÿßŸÑŸäŸàŸÖ</div></div>
                    <div class="lux-stat"><div class="lux-stat-val" id="luxStreak">0</div><div class="lux-stat-label">ŸäŸàŸÖ ŸÖÿ™ÿ™ÿßŸÑŸä üî•</div></div>
                    <div class="lux-stat"><div class="lux-stat-val" id="luxWeekMins">0</div><div class="lux-stat-label">ÿØŸÇŸäŸÇÿ© Ÿáÿ∞ÿß ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ</div></div>
                </div>
            </div>
            <!-- Level + XP -->
            <div class="home-level-card" onclick="toggleSidePanel()" style="cursor:pointer;background:var(--bg);border-radius:12px;padding:12px 14px;border:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                <div>
                    <div style="font-weight:700;color:var(--primary);font-size:0.9rem;" id="homeLevelName">ÿ∑ÿßŸÑÿ® ÿ≥ŸÜÿ© 1</div>
                    <div style="font-size:0.72rem;color:var(--text-muted);" id="homeXpLabel"></div>
                </div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <span style="font-size:1.3rem;" id="homeLevelIcon">üéì</span>
                    <i class="fas fa-chevron-left" style="color:var(--text-muted);font-size:0.8rem;"></i>
                </div>
            </div>
            <div class="progress-bar" style="margin-bottom:12px;background:var(--border);border-radius:3px;">
                <div class="progress-fill" id="homeXpBar" style="background:var(--primary-mid);"></div>
            </div>
            <!-- Alerts -->
            <div id="homeReviewAlertsInner"></div>
            <div id="homeExamAlertsInner"></div>
        </div>
    </div>

</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ÿßŸÑŸÜŸÖŸà (Growth Hub) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="growth" class="section">
    <div style="padding:16px 16px 0;">
        <div class="world-header" style="background:linear-gradient(135deg,#0f172a,#1e3a8a 60%,#3730a3);">
            <div class="world-title">üìä ÿπÿßŸÑŸÖ ÿßŸÑŸÜŸÖŸà</div>
            <div class="world-sub">ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ŸÉ ¬∑ ÿ™Ÿàÿßÿ≤ŸÜŸÉ ¬∑ ÿ¥ÿ¨ÿ±ÿ™ŸÉ ¬∑ ÿ™ÿ≠ÿØŸäÿßÿ™ŸÉ</div>
        </div>
        <div class="growth-grid">
            <button class="growth-tile" onclick="switchTab('analytics',this.closest('.section').querySelector('.nav-item'))">
                <div class="growth-tile-icon" style="background:rgba(99,102,241,0.15);">üìà</div>
                <div class="growth-tile-label">ÿ™ÿ≠ŸÑŸäŸÑÿßÿ™</div>
            </button>
            <button class="growth-tile" onclick="switchTab('tree-section',null)">
                <div class="growth-tile-icon" style="background:rgba(34,197,94,0.15);">üå≥</div>
                <div class="growth-tile-label">ÿ¥ÿ¨ÿ±ÿ™Ÿä</div>
            </button>
            <button class="growth-tile" onclick="switchTab('challenges',null)">
                <div class="growth-tile-icon" style="background:rgba(245,158,11,0.15);">‚öîÔ∏è</div>
                <div class="growth-tile-label">ÿ™ÿ≠ÿØŸäÿßÿ™</div>
            </button>
            <button class="growth-tile" onclick="switchTab('mood-section',null)">
                <div class="growth-tile-icon" style="background:rgba(139,92,246,0.15);">üß†</div>
                <div class="growth-tile-label">ŸÖÿ≤ÿßÿ¨Ÿä</div>
            </button>
            <button class="growth-tile" onclick="switchTab('balance',null)">
                <div class="growth-tile-icon" style="background:rgba(6,182,212,0.15);">‚öñÔ∏è</div>
                <div class="growth-tile-label">ÿ™Ÿàÿßÿ≤ŸÜ</div>
            </button>
            <button class="growth-tile" onclick="switchTab('exams',null)">
                <div class="growth-tile-icon" style="background:rgba(239,68,68,0.15);">üìÖ</div>
                <div class="growth-tile-label">ÿßŸÖÿ™ÿ≠ÿßŸÜÿßÿ™</div>
            </button>
            <button class="growth-tile" onclick="switchTab('review',null)">
                <div class="growth-tile-icon" style="background:rgba(16,185,129,0.15);">üîÑ</div>
                <div class="growth-tile-label">ŸÖÿ±ÿßÿ¨ÿπÿ©</div>
            </button>
            <button class="growth-tile" onclick="switchTab('subjects',null)">
                <div class="growth-tile-icon" style="background:rgba(251,146,60,0.15);">üìö</div>
                <div class="growth-tile-label">ŸÖŸàÿßÿØŸä</div>
            </button>
        </div>
    </div>
</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="analytics" class="section">
    <div class="card">
        <h2><i class="fas fa-brain"></i> ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ™ÿ±ŸÉŸäÿ≤</h2>
        <div class="insight-card streak-insight" id="streakInsight" style="display:none;">
            <div class="insight-title">üî• ÿ•ŸÜÿ¨ÿßÿ≤ ÿßŸÑÿ£ŸäÿßŸÖ ÿßŸÑŸÖÿ™ÿ™ÿßŸÑŸäÿ©</div>
            <div class="insight-value" id="streakMessage"></div>
        </div>
        <div class="insight-card info">
            <div class="insight-title">‚è∞ ÿ£ŸÅÿ∂ŸÑ ŸàŸÇÿ™ ŸÑŸÑÿØÿ±ÿßÿ≥ÿ©</div>
            <div class="insight-value" id="bestTimeInsight">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ...</div>
        </div>
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-val" id="avgSession">0</div><div class="stat-label">ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿ¨ŸÑÿ≥ÿ© (ÿØŸÇŸäŸÇÿ©)</div></div>
            <div class="stat-card"><div class="stat-val" id="totalHours">0</div><div class="stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ≥ÿßÿπÿßÿ™</div></div>
        </div>
    </div>
    <div class="card">
        <h2><i class="fas fa-chart-bar"></i> ÿ™ÿ∑Ÿàÿ± ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ ÿßŸÑÿ≠ÿßŸÑŸä</h2>
        <div class="chart-container" id="weeklyChart"></div>
    </div>
    <div class="card">
        <h2><i class="fas fa-book"></i> ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸàÿßÿØ</h2>
        <div id="subjectAnalysis"></div>
    </div>
    <div class="card">
        <h2><i class="fas fa-calendar-alt"></i> ÿ™ŸÇŸàŸäŸÖ ÿßŸÑÿØÿ±ÿßÿ≥ÿ©</h2>
        <div class="calendar-header">
            <button class="btn btn-secondary" onclick="changeMonth(-1)" style="padding:8px 13px;">
                <i class="fas fa-chevron-right"></i>
            </button>
            <span id="calendarMonth" style="font-weight:700;"></span>
            <button class="btn btn-secondary" onclick="changeMonth(1)" style="padding:8px 13px;">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
        <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:12px;font-size:0.72rem;color:var(--text-light);">
            <span><span style="display:inline-block;width:9px;height:9px;background:var(--success);border-radius:50%;margin-left:4px;"></span>ÿ¨ŸÑÿ≥ÿ©</span>
            <span><span style="display:inline-block;width:9px;height:9px;background:var(--accent);border-radius:50%;margin-left:4px;box-shadow:var(--glow-gold);"></span>3+</span>
            <span><span style="display:inline-block;width:9px;height:9px;background:rgba(99,102,241,0.3);border-radius:2px;border:1px solid var(--accent);margin-left:4px;"></span>ŸÖÿ™ÿ™ÿßŸÑŸä</span>
            <span><span style="display:inline-block;width:9px;height:9px;background:rgba(220,38,38,0.2);border-radius:2px;border:1px solid var(--danger);margin-left:4px;"></span>ÿßŸÖÿ™ÿ≠ÿßŸÜ</span>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ÿßŸÑŸÖŸàÿßÿØ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="subjects" class="section">
    <div class="card">
        <h2><i class="fas fa-layer-group"></i> ŸÖŸàÿßÿØŸä ÿßŸÑÿØÿ±ÿßÿ≥Ÿäÿ©</h2>
        <p style="font-size:0.85rem;color:var(--text-light);margin-bottom:16px;">ÿ£ÿ∂ŸÅ ŸÖŸàÿßÿØŸÉ Ÿàÿ≠ÿØÿØ ŸÑŸàŸÜÿßŸã ŸÖŸÖŸäÿ≤ÿßŸã ŸÑŸÉŸÑ ŸÖŸÜŸáÿß ‚Äî ÿ≥ÿ™Ÿèÿ±ÿ®ÿ∑ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ®ÿßŸÑŸÖŸáÿßŸÖ ŸàÿßŸÑÿ¨ŸÑÿ≥ÿßÿ™ ŸàÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™</p>
        <div class="add-subject-form" style="display:flex;gap:8px;align-items:center;margin-bottom:16px;">
            <input type="text" id="newSubjectName" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖÿßÿØÿ© (ŸÖÿ´ŸÑ: ÿßŸÑÿ™ÿ¥ÿ±Ÿäÿ≠ÿå ÿßŸÑŸÅÿ≥ŸäŸàŸÑŸàÿ¨Ÿäÿß...)"
                   onkeypress="if(event.key==='Enter') addSubject()" style="flex:1;margin-bottom:0;">
            <input type="color" id="newSubjectColor" value="#4F46E5" style="width:46px;height:42px;padding:3px;border:none;cursor:pointer;border-radius:8px;flex-shrink:0;margin-bottom:0;">
            <button class="btn btn-primary" onclick="addSubject()" style="padding:10px 16px;flex-shrink:0;white-space:nowrap;">
                <i class="fas fa-plus"></i> ÿ•ÿ∂ÿßŸÅÿ©
            </button>
        </div>
        <div style="display:flex;flex-wrap:wrap;gap:8px;" id="subjectTagsContainer"></div>
        <div id="noSubjectsMsg" class="empty-state" style="display:none;">
            <i class="fas fa-book-open"></i>
            <p>ŸÑŸÖ ÿ™ÿ∂ŸÅ ÿ£Ÿä ŸÖÿßÿØÿ© ÿ®ÿπÿØ</p>
            <p style="font-size:0.78rem;margin-top:6px;">ÿßÿ®ÿØÿ£ ÿ®ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸàÿßÿØŸÉ ÿßŸÑÿØÿ±ÿßÿ≥Ÿäÿ© ŸÑÿ™ÿ™ÿ®ÿπ ÿ™ŸÇÿØŸÖŸÉ</p>
        </div>
    </div>
    <!-- ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿ≥ÿ±Ÿäÿπÿ© ŸÑŸÉŸÑ ŸÖÿßÿØÿ© -->
    <div id="subjectStatsContainer"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ÿßŸÑŸÖŸáÿßŸÖ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="tasks" class="section">
    <div class="card">
        <h2><i class="fas fa-plus-circle"></i> ŸÖŸáŸÖÿ© ÿ¨ÿØŸäÿØÿ©</h2>
        <input type="text" id="taskInput" placeholder="ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÖŸáŸÖÿ©..."
               onkeypress="if(event.key==='Enter') addTask()">
        <select id="taskSubjectSelect"><option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿßÿØÿ© (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)...</option></select>
        <button class="btn btn-primary" style="width:100%;" onclick="addTask()">
            <i class="fas fa-plus"></i> ÿ•ÿ∂ÿßŸÅÿ© (+10 ŸÜŸÇÿßÿ∑)
        </button>
        <p class="xp-cap-note" id="xpCapNote"></p>
    </div>
    <div id="taskListContainer"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ© ÿßŸÑŸÖÿ™ÿ®ÿßÿπÿØÿ© ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="review" class="section">
    <div class="card">
        <h2><i class="fas fa-rotate"></i> ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ© ÿßŸÑŸÖÿ™ÿ®ÿßÿπÿØÿ©</h2>
        <p style="font-size:0.85rem;color:var(--text-light);margin-bottom:14px;">ÿ£ÿ∂ŸÅ ŸÖŸàÿ∂ŸàÿπÿßŸã Ÿàÿ≥Ÿäÿ∞ŸÉŸëÿ±ŸÉ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ®ŸÖÿ±ÿßÿ¨ÿπÿ™Ÿá.</p>
        <div class="add-review-form">
            <input type="text" id="reviewTopicInput" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖŸàÿ∂Ÿàÿπ ÿ£Ÿà ÿßŸÑŸÅÿµŸÑ...">
            <div class="form-row">
                <select id="reviewSubjectSelect"><option value="">ÿßŸÑŸÖÿßÿØÿ©...</option></select>
                <select id="reviewIntervalSelect">
                    <option value="3">ŸÖÿ±ÿßÿ¨ÿπÿ© ÿ®ÿπÿØ 3 ÿ£ŸäÿßŸÖ</option>
                    <option value="7" selected>ŸÖÿ±ÿßÿ¨ÿπÿ© ÿ®ÿπÿØ 7 ÿ£ŸäÿßŸÖ</option>
                    <option value="14">ŸÖÿ±ÿßÿ¨ÿπÿ© ÿ®ÿπÿØ 14 ŸäŸàŸÖ</option>
                    <option value="30">ŸÖÿ±ÿßÿ¨ÿπÿ© ÿ®ÿπÿØ 30 ŸäŸàŸÖ</option>
                </select>
            </div>
            <button class="btn btn-primary" style="width:100%;" onclick="addReviewItem()">
                <i class="fas fa-plus"></i> ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑŸÖÿ±ÿßÿ¨ÿπÿ©
            </button>
        </div>
    </div>
    <div id="reviewDueList"></div>
    <div id="reviewUpcomingList"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ÿ≠ÿßÿ≥ÿ®ÿ© ÿßŸÑÿßŸÖÿ™ÿ≠ÿßŸÜÿßÿ™ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="exams" class="section">
    <div class="card">
        <h2><i class="fas fa-calendar-check"></i> ÿ≠ÿßÿ≥ÿ®ÿ© ÿßŸÑÿßŸÖÿ™ÿ≠ÿßŸÜÿßÿ™</h2>
        <p style="font-size:0.85rem;color:var(--text-light);margin-bottom:14px;">ÿ£ÿØÿÆŸÑ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÖÿ™ÿ≠ÿßŸÜ ŸàÿπÿØÿØ ÿ≥ÿßÿπÿßÿ™ ÿßŸÑÿØÿ±ÿßÿ≥ÿ© ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©.</p>
        <div class="add-review-form">
            <input type="text" id="examNameInput" placeholder="ÿßÿ≥ŸÖ ÿßŸÑÿßŸÖÿ™ÿ≠ÿßŸÜ / ÿßŸÑŸÖÿßÿØÿ©...">
            <div class="form-row">
                <input type="date" id="examDateInput" style="margin-bottom:0">
                <input type="number" id="examHoursInput" placeholder="ÿ≥ÿßÿπÿßÿ™ ÿßŸÑÿØÿ±ÿßÿ≥ÿ© ÿßŸÑŸÉŸÑŸäÿ©" min="1" style="margin-bottom:0">
            </div>
            <select id="examSubjectSelect" style="margin-top:8px">
                <option value="">ÿ±ÿ®ÿ∑ ÿ®ŸÖÿßÿØÿ© (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)...</option>
            </select>
            <button class="btn btn-primary" style="width:100%;" onclick="addExam()">
                <i class="fas fa-plus"></i> ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÖÿ™ÿ≠ÿßŸÜ
            </button>
        </div>
    </div>
    <div id="examsList"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ÿßŸÑÿ™Ÿàÿßÿ≤ŸÜ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="balance" class="section">
    <div class="card">
        <h2><i class="fas fa-scale-balanced"></i> ŸÖÿ§ÿ¥ÿ± ÿßŸÑÿ™Ÿàÿßÿ≤ŸÜ ÿßŸÑÿØÿ±ÿßÿ≥Ÿä</h2>
        <p style="font-size:0.85rem;color:var(--text-light);margin-bottom:14px;">ŸäŸÉÿ¥ŸÅ ÿ•ÿ∞ÿß ŸÉŸÜÿ™ ÿ™ŸáŸÖŸÑ ŸÖÿßÿØÿ©Ÿã Ÿàÿ™ÿ±ŸÉÿ≤ ŸÖŸÅÿ±ÿ∑ÿßŸã ÿπŸÑŸâ ÿ£ÿÆÿ±Ÿâ.</p>
        <div id="balanceContent"></div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="notes" class="section">
    <div class="card">
        <h2><i class="fas fa-sticky-note"></i> ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™Ÿä</h2>
        <textarea id="noteInput" rows="3" placeholder="ÿßŸÉÿ™ÿ® ŸÖŸÑÿßÿ≠ÿ∏ÿ™ŸÉ ŸáŸÜÿß..."></textarea>
        <button class="btn btn-primary" style="width:100%;" onclick="addNote()">
            <i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ©
        </button>
    </div>
    <div id="notesListContainer"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="profile" class="section">
    <div class="card">
        <h2><i class="fas fa-cog"></i> ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</h2>
        <button class="btn btn-secondary" style="width:100%;margin-bottom:10px;" onclick="toggleTheme()">
            <i class="fas fa-moon"></i> ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÑŸäŸÑŸä
        </button>
        <button class="btn btn-secondary" style="width:100%;margin-bottom:10px;" onclick="exportData()">
            <i class="fas fa-file-export"></i> ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        </button>
        <button class="btn btn-secondary" style="width:100%;margin-bottom:10px;" onclick="importData()">
            <i class="fas fa-file-import"></i> ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        </button>
        <button class="btn btn-secondary" style="width:100%;margin-bottom:10px;" onclick="trimOldSessionsManual()">
            <i class="fas fa-broom"></i> ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑÿ¨ŸÑÿ≥ÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ© (+1 ÿ≥ŸÜÿ©)
        </button>
        <button class="btn btn-secondary" style="width:100%;margin-bottom:10px;" id="yaseenToggleBtn" onclick="toggleYaseenReminder()">
            <i class="fas fa-bell"></i> ÿ™ÿ∞ŸÉŸäÿ± ÿ≥Ÿàÿ±ÿ© Ÿäÿ≥: <span id="yaseenStatus">ŸÖŸÅÿπŸëŸÑ</span>
        </button>
        <hr style="border-color:var(--border);margin:15px 0;">
        <button class="btn btn-danger" style="width:100%;" onclick="clearAllData()">
            <i class="fas fa-trash"></i> ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
        </button>
        <div id="storageInfo" style="margin-top:16px;"></div>
        <p style="text-align:center;margin-top:22px;font-size:0.78rem;color:var(--text-muted);">
            <span class="version-badge">Nourium v9.0 ¬∑ Brand System v1.0</span>
        </p>
    </div>


</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ÿßŸÑÿØŸÑŸäŸÑ ÿßŸÑÿ±Ÿàÿ≠Ÿä ‚Äî ÿπÿßŸÑŸÖ ÿßŸÑÿ±Ÿàÿ≠ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="spiritual" class="section spirit-world">

    <!-- ‚ïê‚ïê 1. ÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑŸÜŸäÿ© ‚ïê‚ïê -->
    <div class="sp-niyya-card">
        <div class="sp-niyya-label">üïä ŸÜŸäÿ© ÿßŸÑŸäŸàŸÖ</div>
        <div class="sp-niyya-text" id="spNiyyaText">ÿßŸÑŸÑŸáŸÖ ÿ•ŸÜŸä ÿ£ÿ∑ŸÑÿ® ÿßŸÑÿπŸÑŸÖ ÿßÿ®ÿ™ÿ∫ÿßÿ°Ÿã ŸÑŸàÿ¨ŸáŸÉ ÿßŸÑŸÉÿ±ŸäŸÖ</div>
        <button class="sp-niyya-btn" onclick="renewNiyya()">üîÑ ÿ™ÿ¨ÿØŸäÿØ ÿßŸÑŸÜŸäÿ©</button>
    </div>

    <!-- ‚ïê‚ïê 2. ÿ¢Ÿäÿ© ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ ‚ïê‚ïê -->
    <div class="sp-week-verse-wrap">
        <div class="sp-section-label">üìñ ÿ¢Ÿäÿ© ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ</div>
        <div class="sp-week-verse-card">
            <div class="sp-week-verse-text" id="spWeekVerseText">Ô¥ø ŸàŸéŸÇŸèŸÑ ÿ±ŸéŸëÿ®ŸêŸë ÿ≤ŸêÿØŸíŸÜŸêŸä ÿπŸêŸÑŸíŸÖŸãÿß Ô¥æ</div>
            <div class="sp-week-verse-ref" id="spWeekVerseRef">ÿ≥Ÿàÿ±ÿ© ÿ∑Ÿá ‚Äì ÿßŸÑÿ¢Ÿäÿ© 114</div>
            <div class="sp-week-verse-tafsir" id="spWeekVerseTafsir">ÿßŸÑÿπŸÑŸÖ ŸÜŸàÿ± ŸäŸèÿ∂ÿßÿ° ÿ®Ÿá ÿßŸÑŸÇŸÑÿ®. ÿßÿ¨ÿπŸÑ ÿ∑ŸÑÿ®ŸÉ ŸÑŸá ÿÆÿßŸÑÿµÿßŸã ŸÑŸàÿ¨Ÿá ÿßŸÑŸÑŸá.</div>
        </div>
    </div>

    <!-- ‚ïê‚ïê 3. ÿ≤ÿßÿØ ÿ∑ÿßŸÑÿ®ÿ© ÿßŸÑÿπŸÑŸÖ ‚ïê‚ïê -->
    <div class="sp-duas-wrap">
        <div class="sp-section-label">üìö ÿ≤ÿßÿØ ÿ∑ÿßŸÑÿ®ÿ© ÿßŸÑÿπŸÑŸÖ</div>
        <div class="sp-duas-grid" id="spStudyDuasGrid">
            <!-- filled by JS -->
        </div>
    </div>

    <!-- ‚ïê‚ïê 4. ÿπÿØÿßÿØ ÿßŸÑÿ∞ŸÉÿ± ‚ïê‚ïê -->
    <div class="sp-thikr-wrap">
        <div class="sp-section-label">üìø ÿπÿØÿßÿØ ÿßŸÑÿ∞ŸÉÿ±</div>
        <div class="sp-thikr-card">
            <div class="sp-thikr-row">
                <div class="sp-thikr-info">
                    <div class="sp-thikr-name">ÿ≥ÿ®ÿ≠ÿßŸÜ ÿßŸÑŸÑŸá</div>
                    <div class="sp-thikr-count" id="thikrTasbih">0</div>
                </div>
                <button class="sp-thikr-btn" onclick="incrementThikr('tasbih')">+</button>
            </div>
            <div class="sp-thikr-divider"></div>
            <div class="sp-thikr-row">
                <div class="sp-thikr-info">
                    <div class="sp-thikr-name">ÿßŸÑÿµŸÑÿßÿ© ÿπŸÑŸâ ÿßŸÑŸÜÿ®Ÿä Ô∑∫</div>
                    <div class="sp-thikr-count" id="thikrSalah">0</div>
                </div>
                <button class="sp-thikr-btn" onclick="incrementThikr('salah')">+</button>
            </div>
            <button class="sp-thikr-reset" onclick="resetThikr()">ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸäŸàŸÖ</button>
        </div>
    </div>

    <!-- ‚ïê‚ïê 5. ŸÖŸÑÿ¨ÿ¶Ÿä ‚ïê‚ïê -->
    <div class="sp-refuge-wrap">
        <button class="sp-refuge-btn" onclick="openSpiritSOS()">
            ü§ç ŸÖŸÑÿ¨ÿ¶Ÿä
        </button>
    </div>

    <!-- hidden IDs needed by old JS -->
    <div style="display:none;">
        <div id="spiritHeroVerse"></div>
        <div id="spiritHeroRef"></div>
        <div id="spiritTranqLabel"></div>
        <div id="spiritTrackerSummary"></div>
        <div id="spiritContextBanner"></div>
        <div id="scbIcon"></div><div id="scbTitle"></div>
        <div id="scbText"></div><div id="scbDua"></div>
        <div id="spiritOrb"></div><div id="spiritOrbEmoji"></div>
        <div id="spiritCatScroll"></div>
        <div id="spiritDuaList"></div>
        <div id="st_verse"></div><div id="st_thikr"></div><div id="st_prayer"></div>
        <div id="spiritTranqVal"></div><div id="spiritTranqSlider"></div>
        <div id="spiritTranqChart"></div><div id="spiritProdCard"></div>
        <div id="spiritContent"></div><div id="spiritTabs"></div>
        <div id="yaseenCard"></div>
    </div>

    <div style="height:30px;"></div>
</div>


<!-- ÿ≤ÿ± ÿßŸÑŸÖÿ¥ÿßÿ±ŸÉÿ© ÿßŸÑÿπÿßÿ¶ŸÖ -->
<button class="share-fab" onclick="openShareModal()" title="ÿ¥ÿßÿ±ŸÉ ÿ•ŸÜÿ¨ÿßÿ≤ŸÉ">
    <i class="fas fa-share-alt"></i>
</button>

<!-- canvas ŸÖÿÆŸÅŸä ŸÑÿ™ŸàŸÑŸäÿØ ÿµŸàÿ±ÿ© ÿßŸÑŸÖÿ¥ÿßÿ±ŸÉÿ© -->
<canvas id="shareCanvas" style="display:none;"></canvas>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖÿ≤ÿßÿ¨ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="mood-section" class="section">

    <!-- Hero -->
    <div class="mood-hero">
        <div class="mood-hero-title">üß† ÿ™ÿ™ÿ®ÿπ ÿ≠ÿßŸÑÿ™ŸÉ ÿßŸÑŸÜŸÅÿ≥Ÿäÿ©</div>
        <div class="mood-hero-sub">ŸÉŸäŸÅ ÿ™ÿ¥ÿπÿ± ÿ®ÿπÿØ ÿ¨ŸÑÿ≥ÿ© ÿßŸÑÿØÿ±ÿßÿ≥ÿ©ÿü ÿ≥ÿ¨ŸëŸÑ ŸÖÿ≤ÿßÿ¨ŸÉ ŸÑŸÜŸÉÿ™ÿ¥ŸÅ ÿ£ŸÜŸÖÿßÿ∑ŸÉ ŸÖÿπÿßŸã</div>
        <div class="mood-today-pill">
            <span class="mood-today-big" id="moodTodayEmoji">‚Äî</span>
            <div>
                <div style="font-size:0.8rem;font-weight:800;" id="moodTodayLabel">ŸÑŸÖ ÿ™ÿ≥ÿ¨ŸëŸÑ ÿ®ÿπÿØ ÿßŸÑŸäŸàŸÖ</div>
                <div style="font-size:0.68rem;opacity:0.7;" id="moodTodayTime"></div>
            </div>
        </div>
    </div>

    <!-- Quick log button -->
    <button class="btn btn-primary" style="width:100%;margin-bottom:14px;" onclick="openMoodModal()">
        <i class="fas fa-smile"></i> ÿ≥ÿ¨ŸëŸÑ ŸÖÿ≤ÿßÿ¨ŸÉ ÿßŸÑÿ¢ŸÜ
    </button>

    <!-- 7-day chart -->
    <div class="card">
        <h2><i class="fas fa-chart-bar" style="color:#8b5cf6;"></i> ŸÖÿ≤ÿßÿ¨ŸÉ ÿÆŸÑÿßŸÑ 7 ÿ£ŸäÿßŸÖ</h2>
        <div class="mood-chart-wrap" id="moodChart7Days"></div>
        <div style="font-size:0.7rem;color:var(--text-muted);text-align:center;margin-top:4px;">
            ŸÉŸÑ ÿ¥ÿ±Ÿäÿ∑ ŸäŸÖÿ´ŸÑ ŸÖÿ™Ÿàÿ≥ÿ∑ ŸÖÿ≤ÿßÿ¨ŸÉ ŸÑŸäŸàŸÖ ŸÉÿßŸÖŸÑ
        </div>
    </div>

    <!-- Correlation card -->
    <div class="card">
        <h2><i class="fas fa-link" style="color:#06b6d4;"></i> ÿßŸÑŸÖÿ≤ÿßÿ¨ ŸàÿßŸÑÿ•ŸÜÿ™ÿßÿ¨Ÿäÿ©</h2>
        <p style="font-size:0.78rem;color:var(--text-muted);margin-bottom:14px;">
            ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿπŸÑÿßŸÇÿ© ÿ®ŸäŸÜ ÿ≠ÿßŸÑÿ™ŸÉ ÿßŸÑŸÜŸÅÿ≥Ÿäÿ© ŸàŸÖÿ≥ÿ™ŸàŸâ ÿ™ÿ±ŸÉŸäÿ≤ŸÉ Ÿàÿ∑ÿßŸÇÿ™ŸÉ ÿÆŸÑÿßŸÑ ÿßŸÑÿ¨ŸÑÿ≥ÿßÿ™
        </p>
        <div id="moodCorrContent">
            <div style="text-align:center;color:var(--text-muted);font-size:0.83rem;padding:10px 0;">
                ÿ≥ÿ¨ŸëŸÑ 3 ÿ¨ŸÑÿ≥ÿßÿ™ ÿ£Ÿà ÿ£ŸÉÿ´ÿ± ŸÑÿ±ÿ§Ÿäÿ© ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ üìä
            </div>
        </div>
    </div>

    <!-- Improvement Tips -->
    <div class="card">
        <h2><i class="fas fa-lightbulb" style="color:#f59e0b;"></i> ÿßŸÇÿ™ÿ±ÿßÿ≠ÿßÿ™ ŸÑÿ™ÿ≠ÿ≥ŸäŸÜ ŸÖÿ≤ÿßÿ¨ŸÉ</h2>
        <p style="font-size:0.78rem;color:var(--text-muted);margin-bottom:12px;">
            ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ£Ÿä ÿ™ŸÖÿ±ŸäŸÜ ŸÑÿπÿ±ÿ∂ ÿßŸÑÿÆÿ∑Ÿàÿßÿ™ ÿßŸÑÿ™ŸÅÿµŸäŸÑŸäÿ©
        </p>
        <div id="moodTipsList"></div>
    </div>

    <!-- Log history -->
    <div class="card">
        <h2><i class="fas fa-history" style="color:#64748b;"></i> ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿ≤ÿßÿ¨</h2>
        <div id="moodLogList">
            <div style="text-align:center;color:var(--text-muted);font-size:0.83rem;padding:14px 0;">
                ŸÑÿß ŸäŸàÿ¨ÿØ ÿ≥ÿ¨ŸÑ ÿ®ÿπÿØ ‚Äî ÿ≥ÿ¨ŸëŸÑ ŸÖÿ≤ÿßÿ¨ŸÉ ÿ®ÿπÿØ ŸÉŸÑ ÿ¨ŸÑÿ≥ÿ© üå±
            </div>
        </div>
    </div>

</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ÿßŸÑÿ™ÿ≠ÿØŸäÿßÿ™ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="challenges" class="section">

    <!-- Hero -->
    <div class="challenges-hero">
        <div class="challenges-hero-title">‚öîÔ∏è ÿ≥ÿßÿ≠ÿ© ÿßŸÑÿ™ÿ≠ÿØŸäÿßÿ™</div>
        <div class="challenges-hero-sub">ÿ£ŸÉŸÖŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿßÿ™ ÿßŸÑŸäŸàŸÖŸäÿ© ŸàÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸäÿ© ŸÑŸÉÿ≥ÿ® ŸÖŸÉÿßŸÅÿ¢ÿ™ XP ÿ•ÿ∂ÿßŸÅŸäÿ©</div>
        <div class="challenges-hero-stats">
            <div class="ch-stat-pill">üèÖ <span id="chDoneToday">0</span> / <span id="chTotalToday">3</span> <span>ÿßŸÑŸäŸàŸÖ</span></div>
            <div class="ch-stat-pill">üóìÔ∏è <span id="chDoneWeek">0</span> / <span id="chTotalWeek">2</span> <span>ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ</span></div>
            <div class="ch-stat-pill">‚≠ê <span id="chTotalXpEarned">0</span> <span>XP ÿ™ÿ≠ÿØŸäÿßÿ™</span></div>
        </div>
    </div>

    <!-- Daily Challenges -->
    <div class="ch-section-label">üìÖ ÿßŸÑÿ™ÿ≠ÿØŸäÿßÿ™ ÿßŸÑŸäŸàŸÖŸäÿ©</div>
    <div id="chDailyList"></div>

    <!-- Weekly Challenges -->
    <div class="ch-section-label">üóìÔ∏è ÿßŸÑÿ™ÿ≠ÿØŸäÿßÿ™ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸäÿ©</div>
    <div id="chWeeklyList"></div>

    <!-- Reset note -->
    <div class="ch-reset-badge">
        <i class="fas fa-clock"></i>
        ÿßŸÑÿ™ÿ≠ÿØŸäÿßÿ™ ÿßŸÑŸäŸàŸÖŸäÿ© ÿ™Ÿèÿ¨ÿØŸéŸëÿØ ÿ®ÿπÿØ ŸÖŸÜÿ™ÿµŸÅ ÿßŸÑŸÑŸäŸÑ ¬∑ ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸäÿ© ÿ™Ÿèÿ¨ÿØŸéŸëÿØ ŸÉŸÑ ÿ≥ÿ®ÿ™
    </div>

</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ÿ¥ÿ¨ÿ±ÿ© ÿßŸÑŸÖÿπÿ±ŸÅÿ© ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="tree-section" class="section">

    <!-- ÿ±ÿ£ÿ≥ ÿßŸÑÿ¥ÿ¨ÿ±ÿ© -->
    <div class="tree-header-card">
        <div class="tree-header-title">üå≥ ÿ¥ÿ¨ÿ±ÿ© ŸÖÿπÿ±ŸÅÿ™Ÿä</div>
        <div class="tree-header-sub">ŸÉŸÑ ÿ¨ŸÑÿ≥ÿ© ÿØÿ±ÿßÿ≥ÿ© ÿ™ŸèŸÜŸÖŸä ÿ¥ÿ¨ÿ±ÿ™ŸÉ ‚Äî ŸàŸÉŸÑ ÿ•ŸÜÿ¨ÿßÿ≤ ŸäŸèŸÅÿ™ÿ≠ ÿ£ÿ≤Ÿáÿßÿ±ÿßŸã ÿ¨ÿØŸäÿØÿ©</div>
        <div class="tree-level-row">
            <div class="tree-level-icon" id="treeLevelIcon">üå±</div>
            <div style="flex:1;">
                <div class="tree-level-text" id="treeLevelName">ÿ®ÿ∞ÿ±ÿ©</div>
                <div class="tree-level-sub" id="treeLevelSub">0 ÿ≥ÿßÿπÿ© ÿØÿ±ÿßÿ≥ÿ©</div>
                <div class="tree-hours-bar"><div class="tree-hours-fill" id="treeHoursFill" style="width:0%"></div></div>
            </div>
            <div style="text-align:left;font-size:0.7rem;opacity:0.75;" id="treeNextGoal"></div>
        </div>
    </div>

    <!-- ÿ±ÿ≥ŸÖ ÿßŸÑÿ¥ÿ¨ÿ±ÿ© -->
    <div class="tree-canvas-wrap">
        <canvas id="knowledgeTreeCanvas" height="320"></canvas>
        <div class="tree-canvas-hint" id="treeCanvasHint">ÿßÿ∂ÿ∫ÿ∑ ŸÑÿ™ÿ¥ÿ∫ŸäŸÑ ÿ£ŸÜŸäŸÖŸäÿ¥ŸÜ ÿßŸÑŸÜŸÖŸà üåø</div>
    </div>

    <!-- ŸÅÿ±Ÿàÿπ ÿßŸÑŸÖŸàÿßÿØ -->
    <div class="card">
        <h2><i class="fas fa-code-branch" style="color:#22c55e;"></i> ŸÅÿ±Ÿàÿπ ÿßŸÑŸÖŸàÿßÿØ</h2>
        <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:12px;">ŸÉŸÑ ŸÖÿßÿØÿ© ÿØÿ±ÿßÿ≥Ÿäÿ© ÿ™ŸèŸÖÿ´ŸëŸÑ ŸÅÿ±ÿπÿßŸã ŸÅŸä ÿ¥ÿ¨ÿ±ÿ™ŸÉ ‚Äî ÿ≥ÿßÿπÿßÿ™ŸÉ ÿ™ÿ±ÿ≥ŸÖ ÿ≠ÿ¨ŸÖ ŸÉŸÑ ŸÅÿ±ÿπ</p>
        <div class="branches-grid" id="treeBranchesGrid">
            <div style="grid-column:1/-1;text-align:center;padding:20px;color:var(--text-muted);font-size:0.85rem;">
                ÿ£ÿ∂ŸÅ ŸÖŸàÿßÿØŸÉ ÿßŸÑÿØÿ±ÿßÿ≥Ÿäÿ© ŸÖŸÜ ÿ™ÿ®ŸàŸäÿ® "ŸÖŸàÿßÿØ" ŸÑÿ™ÿ∏Ÿáÿ± ŸÅÿ±Ÿàÿπ ÿ¥ÿ¨ÿ±ÿ™ŸÉ üåø
            </div>
        </div>
    </div>

    <!-- ÿ£ÿ≤Ÿáÿßÿ± ÿßŸÑÿ•ŸÜÿ¨ÿßÿ≤ -->
    <div class="flowers-card">
        <h2 style="margin-bottom:0;"><i class="fas fa-spa" style="color:#f472b6;"></i> ÿ£ÿ≤Ÿáÿßÿ± ÿßŸÑÿ•ŸÜÿ¨ÿßÿ≤</h2>
        <p style="font-size:0.78rem;color:var(--text-muted);margin-top:4px;">ÿ™ŸèŸÅÿ™ÿ≠ ÿßŸÑÿ£ÿ≤Ÿáÿßÿ± ÿπŸÜÿØ ÿ™ÿ≠ŸÇŸäŸÇ ÿ•ŸÜÿ¨ÿßÿ≤ÿßÿ™ ‚Äî ÿßÿ¨ŸÖÿπŸáÿß ÿ¨ŸÖŸäÿπÿßŸã!</p>
        <div class="flowers-grid" id="treeFlowersGrid"></div>
    </div>

    <!-- ŸÖÿ±ÿßÿ≠ŸÑ ÿßŸÑŸÜŸÖŸà -->
    <div class="card">
        <h2><i class="fas fa-seedling" style="color:#22c55e;"></i> ŸÖÿ±ÿßÿ≠ŸÑ ŸÜŸÖŸà ÿßŸÑÿ¥ÿ¨ÿ±ÿ©</h2>
        <div class="milestones-timeline" id="treeMilestones"></div>
    </div>

</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ŸÜŸÇŸÑ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<nav class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('home', this)" data-tab="focus">
        <i class="fas fa-bolt"></i><span>ÿ™ÿ±ŸÉŸäÿ≤</span>
    </div>
    <div class="nav-item" onclick="switchTab('tasks', this)" data-tab="tasks">
        <i class="fas fa-check-circle"></i><span>ŸÖŸáÿßŸÖ</span>
    </div>
    <div class="nav-item nav-center-btn" onclick="switchTab('home', this)" data-tab="home-center" id="navCenterBtn">
        <div class="nav-center-ring">
            <i class="fas fa-play"></i>
        </div>
    </div>
    <div class="nav-item" onclick="switchTab('growth', this)" data-tab="growth">
        <i class="fas fa-chart-line"></i><span>ŸÜŸÖŸà</span>
    </div>
    <div class="nav-item" onclick="switchTab('spiritual', this)" data-tab="spirit">
        <i class="fas fa-moon"></i><span>ÿ±Ÿàÿ≠</span>
    </div>
</nav>

<!-- More menu overlay -->
<div id="moreMenuOverlay" style="display:none;position:fixed;inset:0;z-index:300;background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);" onclick="closeMoreMenu()">
    <div id="moreMenuSheet" style="position:absolute;bottom:72px;left:0;right:0;background:var(--card-bg);border-radius:24px 24px 0 0;padding:20px 16px 8px;box-shadow:0 -8px 40px rgba(0,0,0,0.2);" onclick="event.stopPropagation()">
        <div style="width:40px;height:4px;border-radius:2px;background:var(--border);margin:0 auto 16px;"></div>
        <div style="font-size:0.72rem;font-weight:800;letter-spacing:2px;color:var(--text-muted);margin-bottom:12px;text-align:center;">ŸÉŸÑ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ</div>
        <div id="moreMenuGrid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px;"></div>
    </div>
</div>

<!-- ÿ≤ÿ± ÿßŸÑŸÖÿ¥ÿßÿ±ŸÉÿ© ÿßŸÑÿπÿßÿ¶ŸÖ -->
<button class="share-fab" onclick="openShareModal()" title="ÿ¥ÿßÿ±ŸÉ ÿ•ŸÜÿ¨ÿßÿ≤ŸÉ">
    <i class="fas fa-share-alt"></i>
</button>

<!-- canvas ŸÖÿÆŸÅŸä -->
<canvas id="shareCanvas" style="display:none;"></canvas>

<script>
'use strict';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let xp            = parseInt(localStorage.getItem('medorus_xp'))            || 0;
let subjects      = JSON.parse(localStorage.getItem('medorus_subjects'))    || [];
let tasks         = JSON.parse(localStorage.getItem('medorus_tasks'))       || [];
let notes         = JSON.parse(localStorage.getItem('medorus_notes'))       || [];
let sessions      = JSON.parse(localStorage.getItem('medorus_sessions'))    || [];
let streak        = parseInt(localStorage.getItem('medorus_streak'))        || 0;
let lastStudyDate = localStorage.getItem('medorus_last_study_date')         || null;
let dailyGoal     = parseInt(localStorage.getItem('medorus_daily_goal'))    || 0;
let reviewItems   = JSON.parse(localStorage.getItem('medorus_reviews'))     || [];
let examItems     = JSON.parse(localStorage.getItem('medorus_exams'))       || [];

let stats = JSON.parse(localStorage.getItem('medorus_stats')) || {
    sessions: { daily: 0, weekly: 0, monthly: 0 },
    tasks:    { daily: 0, weekly: 0, monthly: 0 },
    minutes:  { daily: 0, weekly: 0, monthly: 0 },
    lastUpdate: new Date().toISOString()
};

// ‚îÄ‚îÄ ÿßŸÑŸÖÿ§ŸÇÿ™ ‚îÄ‚îÄ
let timerInterval       = null;
let timeLeft            = 25 * 60;
let isRunning           = false;
let sessionCompleted    = false;   // ‚úÖ FIX 3: guard ÿ∂ÿØ ÿ™ŸÉÿ±ÿßÿ± ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ¨ŸÑÿ≥ÿ©
let timerMode           = 'focus';
let currentDuration     = 25;
let timerStartTimestamp = null;
let timerStartTimeLeft  = 0;
let _lastTitleUpdate    = 0;       // ‚úÖ FIX: ÿ™ÿ≠ÿØŸäÿ´ ÿπŸÜŸàÿßŸÜ ÿßŸÑÿµŸÅÿ≠ÿ© ŸÉŸÑ 5 ÿ´ŸàÿßŸÜŸç ŸÅŸÇÿ∑
let currentCalendarDate = new Date();

// ‚îÄ‚îÄ Wake Lock ‚îÄ‚îÄ
let wakeLock = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ÿ´Ÿàÿßÿ®ÿ™ ÿπÿßŸÖÿ© ‚Äî Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ŸÇÿ®ŸÑ init()
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DAILY_TASK_XP_LIMIT = 100;

const MOTIVATIONAL_MSGS = [
    { icon: 'ü©∫', title: 'ÿ±ÿ≥ÿßŸÑÿ© ŸÑÿ∑ÿ®Ÿäÿ® ÿßŸÑŸÖÿ≥ÿ™ŸÇÿ®ŸÑ', text: 'ŸÉŸÑ ÿµŸÅÿ≠ÿ© ÿ™ŸÇÿ±ÿ§Ÿáÿß ÿßŸÑŸäŸàŸÖ ŸÇÿØ ÿ™ŸÜŸÇÿ∞ ŸÖÿ±Ÿäÿ∂ÿßŸã ÿ∫ÿØÿßŸã.' },
    { icon: 'üíô', title: 'ÿ£ŸÜÿ™ ÿ£ŸÉÿ´ÿ± ŸÖŸÜ ÿ∑ÿßŸÑÿ®', text: 'ÿ£ŸÜÿ™ ŸÑÿß ÿ™ÿØÿ±ÿ≥‚Ä¶ ÿ£ŸÜÿ™ ÿ™ÿ®ŸÜŸä ÿ•ŸÜÿ≥ÿßŸÜÿßŸã ŸäÿπÿßŸÑÿ¨ ÿ•ŸÜÿ≥ÿßŸÜÿßŸã.' },
    { icon: '‚≠ê', title: 'ÿßŸÑÿßÿ≥ÿ™ŸÖÿ±ÿßÿ±Ÿäÿ© ÿ≥ÿ±Ÿë ÿßŸÑŸÜÿ¨ÿßÿ≠', text: 'ÿßŸÑÿ£ÿ∑ÿ®ÿßÿ° ÿßŸÑÿπÿ∏ŸÖÿßÿ° ŸÑŸÖ Ÿäÿµÿ®ÿ≠Ÿàÿß ŸÉÿ∞ŸÑŸÉ ŸÅŸä ŸÑŸäŸÑÿ© ‚Äî ÿ®ŸÑ ÿ®ŸÄ 1% ŸäŸàŸÖŸäÿßŸã.' },
    { icon: 'üåô', title: 'ÿ¨ŸáÿØŸÉ ŸÑÿß Ÿäÿ∂Ÿäÿπ', text: 'ŸÉŸÑ ÿØŸÇŸäŸÇÿ© ÿØÿ±ÿßÿ≥ÿ© ÿßŸÑÿ¢ŸÜ ŸáŸä ÿßÿ®ÿ™ÿ≥ÿßŸÖÿ© ŸÖÿ±Ÿäÿ∂ ŸÖÿ≥ÿ™ŸÇÿ®ŸÑÿßŸã.' },
    { icon: 'üèÜ', title: 'ÿ£ŸÜÿ™ ŸÅŸä ÿßŸÑÿ∑ÿ±ŸäŸÇ ÿßŸÑÿµÿ≠Ÿäÿ≠', text: 'ŸÖŸÜ ÿ£ÿÆÿ∞ ÿ∑ÿ±ŸäŸÇ ÿßŸÑÿπŸÑŸÖ ÿ≥ŸáŸëŸÑ ÿßŸÑŸÑŸá ŸÑŸá ÿ∑ÿ±ŸäŸÇÿßŸã ÿ•ŸÑŸâ ÿßŸÑÿ¨ŸÜÿ©.' },
    { icon: 'üî¨', title: 'ÿßŸÑÿπŸÑŸÖ ŸÜŸàÿ±', text: 'ÿßŸÑÿ∑ÿ® ÿ£ŸÖÿßŸÜÿ© ‚Äî ŸàŸÉŸÑ ÿØÿ±ÿ≥ ÿ™ÿ∞ÿßŸÉÿ±Ÿá ŸáŸà ÿßÿ≥ÿ™ÿπÿØÿßÿØ ŸÑÿ≠ŸÖŸÑ Ÿáÿ∞Ÿá ÿßŸÑÿ£ŸÖÿßŸÜÿ©.' },
];

const DUA_MSGS = [
    { icon: 'ü§ç', title: 'ÿØÿπÿßÿ° ŸÇÿ®ŸÑ ÿßŸÑŸÖÿ∞ÿßŸÉÿ±ÿ©', text: '¬´ÿ±ÿ® ÿßÿ¥ÿ±ÿ≠ ŸÑŸä ÿµÿØÿ±Ÿä ŸàŸäÿ≥ÿ± ŸÑŸä ÿ£ŸÖÿ±Ÿä Ÿàÿßÿ≠ŸÑŸÑ ÿπŸÇÿØÿ© ŸÖŸÜ ŸÑÿ≥ÿßŸÜŸä¬ª' },
    { icon: 'üìñ', title: 'ÿ™ÿ∞ŸÉŸäÿ± ÿ±Ÿàÿ≠Ÿä', text: 'ŸäŸèÿ≥ÿ™ÿ≠ÿ® ŸÇÿ±ÿßÿ°ÿ© ÿ≥Ÿàÿ±ÿ© Ÿäÿ≥ ŸÇÿ®ŸÑ ÿßŸÑŸÖÿ∞ÿßŸÉÿ±ÿ© ÿ∑ŸÑÿ®Ÿãÿß ŸÑŸÑÿ™ŸàŸÅŸäŸÇ ŸàÿßŸÑÿ®ÿ±ŸÉÿ©.' },
    { icon: 'üåø', title: 'ÿØÿπÿßÿ° ÿßŸÑÿπŸÑŸÖ', text: '¬´ÿßŸÑŸÑŸáŸÖ ÿßŸÜŸÅÿπŸÜŸä ÿ®ŸÖÿß ÿπŸÑŸÖÿ™ŸÜŸä ŸàÿπŸÑŸÖŸÜŸä ŸÖÿß ŸäŸÜŸÅÿπŸÜŸä Ÿàÿ≤ÿØŸÜŸä ÿπŸÑŸÖÿßŸã¬ª' },
];

// ÿØÿßŸÑÿ© ÿ™ŸèÿπŸäÿØ ÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑŸÄ Streak ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÇŸäŸÖÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© ÿπŸÜÿØ ÿßŸÑÿßÿ≥ÿ™ÿØÿπÿßÿ°
function getStreakMsgs() {
    return [
        { icon: 'üî•', title: 'ŸÑÿß ÿ™ŸÉÿ≥ÿ± ÿ≥ŸÑÿ≥ŸÑÿ™ŸÉ!', text: `ÿ≠ÿßŸÅÿ∏ÿ™ ÿπŸÑŸâ ${streak} ŸäŸàŸÖ ŸÖÿ™ÿ™ÿßŸÑŸä ‚Äî ÿ¨ŸÑÿ≥ÿ© Ÿàÿßÿ≠ÿØÿ© ÿ™ŸÉŸÅŸä ŸÑÿ™ÿ≠ŸÖŸäŸáÿß ÿßŸÑŸäŸàŸÖ.` },
        { icon: 'üí™', title: 'ÿ•ŸÜÿ¨ÿßÿ≤ŸÉ ŸÅŸä ÿÆÿ∑ÿ±!', text: 'ŸÑÿß ÿ™ÿØÿπ ÿ™ÿπÿ® ÿßŸÑŸäŸàŸÖ ŸäŸèÿ∂Ÿäÿπ ÿ™ÿπÿ® ÿßŸÑÿ£ŸÖÿ≥. ÿ¨ŸÑÿ≥ÿ© ÿµÿ∫Ÿäÿ±ÿ© ÿ™ŸÉŸÅŸä!' },
    ];
}

const SESSION_DONE_MSGS = [
    { icon: '‚úÖ', title: 'ÿ£ÿ≠ÿ≥ŸÜÿ™ Ÿäÿß ÿ∑ÿ®Ÿäÿ® ÿßŸÑŸÖÿ≥ÿ™ŸÇÿ®ŸÑ!', text: 'ÿÆÿ∑Ÿàÿ© ÿ£ÿÆÿ±Ÿâ ŸÜÿ≠Ÿà ŸáÿØŸÅŸÉ. ÿßŸÑÿ≠ŸÖÿØ ŸÑŸÑŸá ÿßŸÑÿ∞Ÿä ÿ®ŸÜÿπŸÖÿ™Ÿá ÿ™ÿ™ŸÖ ÿßŸÑÿµÿßŸÑÿ≠ÿßÿ™.' },
    { icon: 'üéØ', title: 'ÿ¨ŸÑÿ≥ÿ© ŸÜÿßÿ¨ÿ≠ÿ©!', text: 'ÿßŸÑŸÑŸáŸÖ ÿ®ÿßÿ±ŸÉ ŸÑŸÜÿß ŸÅŸäŸÖÿß ÿ™ÿπŸÑŸÖŸÜÿß Ÿàÿ´ÿ®Ÿëÿ™Ÿá ŸÅŸä ŸÇŸÑŸàÿ®ŸÜÿß.' },
    { icon: '‚≠ê', title: 'ÿ±ÿßÿ¶ÿπ!', text: 'ŸÑÿß ÿ™ŸÜÿ≥Ÿé ŸÖÿ±ÿßÿ¨ÿπÿ© ŸÖÿß ÿ™ÿπŸÑŸÖÿ™Ÿá ŸÇÿ±Ÿäÿ®ÿßŸã ŸÑŸÑÿ™ÿ´ÿ®Ÿäÿ™.' },
];

let notifSettings = JSON.parse(localStorage.getItem('nourium_notif_settings') || 'null') || {
    dailyEnabled:  false,
    dailyTime:     '08:00',
    streakEnabled: true,
    duaEnabled:    false,
    motivEnabled:  false,
    sessionDone:   true,
};
let notifTimers      = {};
let smartBannerQueue = [];
let smartBannerActive = false;

const QURAN_VERSES = [
    { text: 'Ô¥ø ŸäŸéÿ±ŸíŸÅŸéÿπŸê ÿßŸÑŸÑŸéŸëŸáŸè ÿßŸÑŸéŸëÿ∞ŸêŸäŸÜŸé ÿ¢ŸÖŸéŸÜŸèŸàÿß ŸÖŸêŸÜŸÉŸèŸÖŸí ŸàŸéÿßŸÑŸéŸëÿ∞ŸêŸäŸÜŸé ÿ£ŸèŸàÿ™ŸèŸàÿß ÿßŸÑŸíÿπŸêŸÑŸíŸÖŸé ÿØŸéÿ±Ÿéÿ¨Ÿéÿßÿ™Ÿç Ô¥æ', ref: 'üìñ ÿ≥Ÿàÿ±ÿ© ÿßŸÑŸÖÿ¨ÿßÿØŸÑÿ© ‚Äì ÿßŸÑÿ¢Ÿäÿ© 11' },
    { text: 'Ô¥ø ŸÇŸèŸÑŸí ŸáŸéŸÑŸí ŸäŸéÿ≥Ÿíÿ™ŸéŸàŸêŸä ÿßŸÑŸéŸëÿ∞ŸêŸäŸÜŸé ŸäŸéÿπŸíŸÑŸéŸÖŸèŸàŸÜŸé ŸàŸéÿßŸÑŸéŸëÿ∞ŸêŸäŸÜŸé ŸÑŸéÿß ŸäŸéÿπŸíŸÑŸéŸÖŸèŸàŸÜŸé Ô¥æ', ref: 'üìñ ÿ≥Ÿàÿ±ÿ© ÿßŸÑÿ≤ŸÖÿ± ‚Äì ÿßŸÑÿ¢Ÿäÿ© 9' },
    { text: 'Ô¥ø ÿ¥ŸéŸáŸêÿØŸé ÿßŸÑŸÑŸéŸëŸáŸè ÿ£ŸéŸÜŸéŸëŸáŸè ŸÑŸéÿß ÿ•ŸêŸÑŸéŸ∞ŸáŸé ÿ•ŸêŸÑŸéŸëÿß ŸáŸèŸàŸé ŸàŸéÿßŸÑŸíŸÖŸéŸÑŸéÿßÿ¶ŸêŸÉŸéÿ©Ÿè ŸàŸéÿ£ŸèŸàŸÑŸèŸà ÿßŸÑŸíÿπŸêŸÑŸíŸÖŸê ŸÇŸéÿßÿ¶ŸêŸÖŸãÿß ÿ®ŸêÿßŸÑŸíŸÇŸêÿ≥Ÿíÿ∑Ÿê Ô¥æ', ref: 'üìñ ÿ≥Ÿàÿ±ÿ© ÿ¢ŸÑ ÿπŸÖÿ±ÿßŸÜ ‚Äì ÿßŸÑÿ¢Ÿäÿ© 18' },
    { text: 'Ô¥ø ÿ•ŸêŸÜŸéŸëŸÖŸéÿß ŸäŸéÿÆŸíÿ¥ŸéŸâ ÿßŸÑŸÑŸéŸëŸáŸé ŸÖŸêŸÜŸí ÿπŸêÿ®ŸéÿßÿØŸêŸáŸê ÿßŸÑŸíÿπŸèŸÑŸéŸÖŸéÿßÿ°Ÿè Ô¥æ', ref: 'üìñ ÿ≥Ÿàÿ±ÿ© ŸÅÿßÿ∑ÿ± ‚Äì ÿßŸÑÿ¢Ÿäÿ© 28' },
    { text: 'Ô¥ø ŸàŸéŸÇŸèŸÑ ÿ±ŸéŸëÿ®ŸêŸë ÿ≤ŸêÿØŸíŸÜŸêŸä ÿπŸêŸÑŸíŸÖŸãÿß Ô¥æ', ref: 'üìñ ÿ≥Ÿàÿ±ÿ© ÿ∑Ÿá ‚Äì ÿßŸÑÿ¢Ÿäÿ© 114' },
];

let currentVerseIndex = -1;
let verseInterval     = null;

const DUAS_DATA = {
    before: {
        icon: 'üåÖ', title: 'ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÜŸäÿ© ŸàÿßŸÑŸÇŸÑÿ®', subtitle: 'ŸÇÿ®ŸÑ ÿ®ÿØÿ° ÿßŸÑŸÖÿ∞ÿßŸÉÿ±ÿ©',
        color: '#065F46',
        duas: [
            { id: 'b1', text: 'ÿßŸÑŸÑŸáŸÖ ÿ•ŸÜŸä ÿ£ÿ≥ÿ£ŸÑŸÉ ŸÅŸáŸÖ ÿßŸÑŸÜÿ®ŸäŸäŸÜÿå Ÿàÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ±ÿ≥ŸÑŸäŸÜÿå Ÿàÿ•ŸÑŸáÿßŸÖ ÿßŸÑŸÖŸÑÿßÿ¶ŸÉÿ© ÿßŸÑŸÖŸÇÿ±ÿ®ŸäŸÜ.' },
            { id: 'b2', text: 'ÿ±ÿ® ÿßÿ¥ÿ±ÿ≠ ŸÑŸä ÿµÿØÿ±Ÿä ŸàŸäÿ≥ÿ± ŸÑŸä ÿ£ŸÖÿ±Ÿä Ÿàÿßÿ≠ŸÑŸÑ ÿπŸÇÿØÿ© ŸÖŸÜ ŸÑÿ≥ÿßŸÜŸä ŸäŸÅŸÇŸáŸàÿß ŸÇŸàŸÑŸä.' },
            { id: 'b3', text: 'ÿßŸÑŸÑŸáŸÖ ÿßŸÜŸÅÿπŸÜŸä ÿ®ŸÖÿß ÿπŸÑŸÖÿ™ŸÜŸä ŸàÿπŸÑŸÖŸÜŸä ŸÖÿß ŸäŸÜŸÅÿπŸÜŸä Ÿàÿ≤ÿØŸÜŸä ÿπŸÑŸÖÿß.' },
            { id: 'b4', text: 'ÿßŸÑŸÑŸáŸÖ ÿßÿ¨ÿπŸÑ Ÿáÿ∞ÿß ÿßŸÑÿπŸÑŸÖ ÿÆÿßŸÑÿµŸãÿß ŸÑŸàÿ¨ŸáŸÉ ÿßŸÑŸÉÿ±ŸäŸÖ.' },
            { id: 'b5', text: 'ÿßŸÑŸÑŸáŸÖ ÿßÿ¨ÿπŸÑŸÜŸä ÿ≥ÿ®ÿ® ÿ¥ŸÅÿßÿ° ŸÑÿß ÿ≥ÿ®ÿ® ÿ£ŸÑŸÖÿå Ÿàÿ≥ÿ®ÿ® ÿ±ÿ≠ŸÖÿ© ŸÑÿß ÿ≥ÿ®ÿ® ŸÖÿπÿßŸÜÿßÿ©.' },
        ]
    },
    during: {
        icon: 'üìñ', title: 'ÿπŸÜÿØ ÿµÿπŸàÿ®ÿ© ŸÅŸáŸÖ ÿßŸÑŸÖÿπŸÑŸàŸÖÿ©', subtitle: 'ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑŸÖÿ∞ÿßŸÉÿ±ÿ©',
        color: '#4338CA',
        duas: [
            { id: 'd1', text: 'ÿßŸÑŸÑŸáŸÖ ŸÑÿß ÿ≥ŸáŸÑ ÿ•ŸÑÿß ŸÖÿß ÿ¨ÿπŸÑÿ™Ÿá ÿ≥ŸáŸÑÿß Ÿàÿ£ŸÜÿ™ ÿ™ÿ¨ÿπŸÑ ÿßŸÑÿ≠ÿ≤ŸÜ ÿ•ÿ∞ÿß ÿ¥ÿ¶ÿ™ ÿ≥ŸáŸÑÿß.' },
            { id: 'd2', text: 'ÿßŸÑŸÑŸáŸÖ ÿßŸÅÿ™ÿ≠ ÿπŸÑŸäŸéŸë ŸÅÿ™ÿ≠Ÿãÿß ŸÖÿ®ŸäŸÜŸãÿß.' },
            { id: 'd3', text: 'Ÿäÿß ŸÖÿπŸÑŸÖ ÿ•ÿ®ÿ±ÿßŸáŸäŸÖ ÿπŸÑŸÖŸÜŸäÿå ŸàŸäÿß ŸÖŸÅŸáŸÖ ÿ≥ŸÑŸäŸÖÿßŸÜ ŸÅŸáŸÖŸÜŸä.' },
            { id: 'd4', text: 'ÿßŸÑŸÑŸáŸÖ ÿßÿ±ÿ≤ŸÇŸÜŸä ŸÜŸàÿ± ÿßŸÑŸÅŸáŸÖ Ÿàÿ≥ÿ±ÿπÿ© ÿßŸÑÿßÿ≥ÿ™Ÿäÿπÿßÿ®.' },
        ]
    },
    emergency: {
        icon: '‚ö°', title: 'ÿπŸÜÿØ ÿßŸÑŸÜÿ≥ŸäÿßŸÜ', subtitle: 'ÿ£ÿØÿπŸäÿ© ÿßŸÑŸÅÿ≤ÿπ ŸàÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶',
        color: '#991B1B',
        duas: [
            { id: 'e1', text: 'ÿßŸÑŸÑŸáŸÖ Ÿäÿß ÿ¨ÿßŸÖÿπ ÿßŸÑŸÜÿßÿ≥ ŸÑŸäŸàŸÖ ŸÑÿß ÿ±Ÿäÿ® ŸÅŸäŸá ÿßÿ¨ŸÖÿπ ÿπŸÑŸäŸéŸë ÿ∂ÿßŸÑÿ™Ÿä.' },
            { id: 'e2', text: 'ÿ±ÿ® ŸÑÿß ÿ™ÿ∞ÿ±ŸÜŸä ŸÅÿ±ÿØŸãÿß Ÿàÿ£ŸÜÿ™ ÿÆŸäÿ± ÿßŸÑŸàÿßÿ±ÿ´ŸäŸÜ.' },
            { id: 'e3', text: 'ÿßŸÑŸÑŸáŸÖ ÿ∞ŸÉÿ±ŸÜŸä ŸÖŸÜŸá ŸÖÿß ŸÜÿ≥Ÿäÿ™ ŸàŸÑÿß ÿ™ŸÜÿ≥ŸÜŸä ŸÖŸÜŸá ŸÖÿß ÿ∞ŸÉÿ±ÿ™.' },
        ]
    },
    after: {
        icon: 'üåô', title: 'ÿØÿπÿßÿ° ÿÆÿ™ŸÖ ÿ¨ŸÑÿ≥ÿ© ÿßŸÑÿØÿ±ÿßÿ≥ÿ©', subtitle: 'ÿ®ÿπÿØ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ° ŸÖŸÜ ÿßŸÑŸÖÿ∞ÿßŸÉÿ±ÿ©',
        color: '#1E1B6B',
        duas: [
            { id: 'a1', text: 'ÿßŸÑÿ≠ŸÖÿØ ŸÑŸÑŸá ÿßŸÑÿ∞Ÿä ÿ®ŸÜÿπŸÖÿ™Ÿá ÿ™ÿ™ŸÖ ÿßŸÑÿµÿßŸÑÿ≠ÿßÿ™.' },
            { id: 'a2', text: 'ÿßŸÑŸÑŸáŸÖ ÿ®ÿßÿ±ŸÉ ŸÑŸä ŸÅŸäŸÖÿß ÿ™ÿπŸÑŸÖÿ™ Ÿàÿ´ÿ®ÿ™Ÿá ŸÅŸä ŸÇŸÑÿ®Ÿä.' },
            { id: 'a3', text: 'ÿßŸÑŸÑŸáŸÖ ÿßÿ¨ÿπŸÑ Ÿáÿ∞ÿß ÿßŸÑÿπŸÑŸÖ ÿ≠ÿ¨ÿ© ŸÑŸä ŸÑÿß ÿπŸÑŸäŸë.' },
            { id: 'a4', text: 'ÿßŸÑŸÑŸáŸÖ ÿßÿ¨ÿπŸÑ ÿπŸÖŸÑŸä Ÿáÿ∞ÿß ŸÅŸä ŸÖŸäÿ≤ÿßŸÜ ÿ≠ÿ≥ŸÜÿßÿ™Ÿä.' },
        ]
    },
    time: {
        icon: '‚è≥', title: 'ÿ®ÿ±ŸÉÿ© ÿßŸÑŸàŸÇÿ™ ŸàÿßŸÑÿ•ŸÜÿ™ÿßÿ¨Ÿäÿ©', subtitle: 'ÿØÿπÿßÿ° ÿ™ŸÜÿ∏ŸäŸÖ ÿßŸÑŸàŸÇÿ™',
        color: '#3730A3',
        duas: [
            { id: 't1', text: 'ÿßŸÑŸÑŸáŸÖ ÿ®ÿßÿ±ŸÉ ŸÑŸä ŸÅŸä ŸàŸÇÿ™Ÿä ŸàŸÜÿ∏ŸÖ ŸÑŸä ÿ£ŸäÿßŸÖŸä.' },
            { id: 't2', text: 'ÿßŸÑŸÑŸáŸÖ ÿ£ÿπŸÜŸä ÿπŸÑŸâ ÿ∞ŸÉÿ±ŸÉ Ÿàÿ¥ŸÉÿ±ŸÉ Ÿàÿ≠ÿ≥ŸÜ ÿπÿ®ÿßÿØÿ™ŸÉ.' },
            { id: 't3', text: 'ÿßŸÑŸÑŸáŸÖ ÿ•ŸÜŸä ÿ£ÿπŸàÿ∞ ÿ®ŸÉ ŸÖŸÜ ÿßŸÑÿπÿ¨ÿ≤ ŸàÿßŸÑŸÉÿ≥ŸÑ.' },
            { id: 't4', text: 'ÿßŸÑŸÑŸáŸÖ ÿßÿ¨ÿπŸÑ ŸäŸàŸÖŸä Ÿáÿ∞ÿß ŸÖŸÑŸäÿ¶Ÿãÿß ÿ®ÿßŸÑÿ•ŸÜÿ¨ÿßÿ≤ ŸàÿßŸÑÿ±ÿ∂ÿß.' },
        ]
    },
    doctor: {
        icon: 'ü©∫', title: 'ÿØÿπÿßÿ° ÿ∑ÿßŸÑÿ® ÿßŸÑÿ∑ÿ®', subtitle: 'ÿÆÿßÿµ ÿ®ÿ∑ŸÑÿßÿ® ÿßŸÑÿ∑ÿ® ŸàÿßŸÑÿµÿ≠ÿ©',
        color: '#065F46',
        duas: [
            { id: 'dr1', text: 'ÿßŸÑŸÑŸáŸÖ ÿ≥ÿÆÿ± ŸÑŸä ÿ£ÿ≥ÿ®ÿßÿ® ÿßŸÑÿπŸÑŸÖ.' },
            { id: 'dr2', text: 'ÿßŸÑŸÑŸáŸÖ ÿßÿ±ÿ≤ŸÇŸÜŸä ÿßŸÑÿ•ÿÆŸÑÿßÿµ ŸÅŸä ÿ™ÿπŸÑŸÖ ÿßŸÑÿ∑ÿ® ŸàÿÆÿØŸÖÿ© ÿßŸÑŸÖÿ±ÿ∂Ÿâ.' },
            { id: 'dr3', text: 'ÿßŸÑŸÑŸáŸÖ ÿßÿ¨ÿπŸÑŸÜŸä ÿ∑ÿ®Ÿäÿ®Ÿãÿß ÿ±ÿ≠ŸäŸÖŸãÿß.' },
            { id: 'dr4', text: 'ÿßŸÑŸÑŸáŸÖ ÿßÿ¨ÿπŸÑ ÿπŸÑŸÖŸä ŸÜŸàÿ±Ÿãÿß ŸàÿπŸÖŸÑŸä ÿ£ÿ¨ÿ±Ÿãÿß.' },
            { id: 'dr5', text: 'ÿßŸÑŸÑŸáŸÖ ÿßŸÉÿ™ÿ® ŸÑŸä ÿ£ÿ¨ÿ± ŸÉŸÑ ŸÖÿ±Ÿäÿ∂ ÿ£ÿØÿßŸàŸäŸá.' },
        ]
    }
};

let spiritCurrentTab = 'before';
let favoriteDuas     = JSON.parse(localStorage.getItem('nourium_fav_duas') || '[]');
let yaseenReminderOn = localStorage.getItem('nourium_yaseen_reminder') !== 'off';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  XP ŸàÿßŸÑŸÖÿ≥ÿ™ŸàŸäÿßÿ™
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const LEVELS = [
    { name: 'ÿ∑ÿßŸÑÿ® ÿ≥ŸÜÿ© 1',   icon: 'üéì', minXP: 0,    maxXP: 200  },
    { name: 'ÿ∑ÿßŸÑÿ® ÿ≥ŸÜÿ© 3',   icon: 'üìö', minXP: 200,  maxXP: 500  },
    { name: 'ÿ∑ÿ®Ÿäÿ® ÿπÿßŸÖ',     icon: 'üë®‚Äç‚öïÔ∏è', minXP: 500,  maxXP: 1000 },
    { name: 'ÿ∑ÿ®Ÿäÿ® ŸÖŸÇŸäŸÖ',    icon: 'ü©∫', minXP: 1000, maxXP: 2000 },
    { name: 'ÿ£ÿ≥ÿ™ÿßÿ∞ ŸÖÿ≠ÿßÿ∂ÿ±',  icon: 'üë®‚Äçüè´', minXP: 2000, maxXP: 3000 },
    { name: 'ÿÆÿ®Ÿäÿ± ÿ£ŸÉÿßÿØŸäŸÖŸä', icon: 'üèÜ', minXP: 3000, maxXP: 5000 },
];

function getCurrentLevel() {
    for (let i = LEVELS.length - 1; i >= 0; i--) {
        if (xp >= LEVELS[i].minXP) return { ...LEVELS[i], index: i };
    }
    return { ...LEVELS[0], index: 0 };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ÿßŸÑÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ£ŸàŸÑŸäÿ©
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function init() {
    if (localStorage.getItem('medorus_theme') === 'dark') {
        document.body.classList.add('dark-mode');
        document.getElementById('themeIcon').className = 'fas fa-sun';
    }

    const draft = localStorage.getItem('medorus_draft_note');
    if (draft) document.getElementById('noteInput').value = draft;
    if (dailyGoal > 0) document.getElementById('dailyGoalInput').value = dailyGoal;

    // ‚úÖ FIX: ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑÿ¨ŸÑÿ≥ÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ© ÿπŸÜÿØ ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ
    trimOldSessions();
    cleanupOldTaskXP(); // ‚úÖ ÿ™ŸÜÿ∏ŸäŸÅ ŸÖŸÅÿßÿ™Ÿäÿ≠ XP ÿßŸÑŸÇÿØŸäŸÖÿ©
    checkStatsReset();
    updateStreak(false);
    updateLevelUI();
    updateStatsUI();
    renderSubjects();
    updateSubjectSelects();
    renderTasks();
    renderNotes();
    renderReviews();
    renderExams();
    updateTimerDisplay();
    renderCalendar();
    updateGoalProgress();
    updateLuxPanel();
    checkStorageUsage();
    startVerseRotation(); // ‚úÖ ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ¢Ÿäÿßÿ™ ÿßŸÑŸÇÿ±ÿ¢ŸÜŸäÿ©
    updateYaseenToggleUI(); // ‚úÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿ≤ÿ± Ÿäÿ≥ ŸÅŸä ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
    initNotifSystem(); // ‚úÖ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿ∞ŸÉŸäÿ©

    // ‚úÖ FIX: ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿßŸÑÿ™Ÿä ÿ™ÿ≠ÿ™ÿßÿ¨ ÿ®ŸäÿßŸÜÿßÿ™ ÿπŸÜÿØ ÿ£ŸàŸÑ ÿ™ÿ≠ŸÖŸäŸÑ
    setTimeout(function() {
        initKnowledgeTree();
        renderMoodTips();   // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÇÿ™ÿ±ÿßÿ≠ÿßÿ™ ÿßŸÑŸÖÿ≤ÿßÿ¨ ŸÅŸàÿ±ÿßŸã
        initChallenges();   // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿßÿ™ ŸÅŸàÿ±ÿßŸã
        initSpiritV3();     // ÿ™ŸáŸäÿ¶ÿ© ŸÇÿ≥ŸÖ ÿ±Ÿàÿ≠ ÿßŸÑÿ¨ÿØŸäÿØ
    }, 200);

    // Wake Lock ÿ≤ÿ± ‚Äî Ÿäÿ∏Ÿáÿ± ŸÅŸÇÿ∑ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸäÿØÿπŸÖŸá
    if ('wakeLock' in navigator) {
        document.getElementById('wakeLockBtn').style.display = 'inline-flex';
    }

    document.getElementById('noteInput').addEventListener('input', function() {
        localStorage.setItem('medorus_draft_note', this.value);
    });
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ŸÖÿ≥ÿßÿπÿØÿßÿ™ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ (ÿ¢ŸÖŸÜÿ© ŸàÿØŸÇŸäŸÇÿ©)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toDateKey(date) {
    // ‚úÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ™ŸàŸÇŸäÿ™ ÿßŸÑŸÖÿ≠ŸÑŸä ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ (ŸÑÿß UTC) ŸÑÿ£ŸÜ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ŸÖÿ≠ŸÑŸä ÿ®ÿ∑ÿ®Ÿäÿπÿ™Ÿá
    const d = date instanceof Date ? date : new Date(date);
    return d.getFullYear() + '-' +
           String(d.getMonth() + 1).padStart(2, '0') + '-' +
           String(d.getDate()).padStart(2, '0');
}

function isSameDay(d1, d2) {
    return toDateKey(d1) === toDateKey(d2);
}

function isYesterday(dateStr) {
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    return dateStr === toDateKey(yesterday);
}

function getTodayKey() {
    return toDateKey(new Date());
}

// ‚úÖ FIX 1: ÿØÿßŸÑÿ© ŸÖŸÇÿßÿ±ŸÜÿ© ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ ÿßŸÑÿ£ŸÉÿ´ÿ± ÿØŸÇÿ© ‚Äî ÿ®ÿØŸàŸÜ getWeekNumber() ÿßŸÑŸÖÿπŸäÿ®ÿ©
function isSameCalendarWeek(d1, d2) {
    const getWeekStart = (date) => {
        const d = new Date(date);
        d.setHours(0, 0, 0, 0);
        d.setDate(d.getDate() - d.getDay()); // ÿßŸÑÿ£ÿ≠ÿØ = ÿ®ÿØÿßŸäÿ© ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ
        return d.getTime();
    };
    return getWeekStart(d1) === getWeekStart(d2);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ‚Äî ŸÖÿµÿ≠ŸéŸëÿ≠ÿ©
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkStatsReset() {
    const now        = new Date();
    const lastUpdate = stats.lastUpdate ? new Date(stats.lastUpdate) : now;
    let   changed    = false;

    // ŸäŸàŸÖŸä
    if (!isSameDay(now, lastUpdate)) {
        stats.sessions.daily = 0;
        stats.tasks.daily    = 0;
        stats.minutes.daily  = 0;
        changed = true;
    }

    // ‚úÖ FIX 1: ÿ£ÿ≥ÿ®ŸàÿπŸä ÿ®ÿßŸÑÿØÿßŸÑÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ©
    if (!isSameCalendarWeek(now, lastUpdate)) {
        stats.sessions.weekly = 0;
        stats.tasks.weekly    = 0;
        stats.minutes.weekly  = 0;
        changed = true;
    }

    // ÿ¥Ÿáÿ±Ÿä
    if (now.getMonth()    !== lastUpdate.getMonth() ||
        now.getFullYear() !== lastUpdate.getFullYear()) {
        stats.sessions.monthly = 0;
        stats.tasks.monthly    = 0;
        stats.minutes.monthly  = 0;
        changed = true;
    }

    if (changed) {
        stats.lastUpdate = now.toISOString();
        saveStats();
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑÿ¨ŸÑÿ≥ÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ© ‚Äî FIX ÿ¨ÿØŸäÿØ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function trimOldSessions() {
    const cutoff = new Date();
    cutoff.setFullYear(cutoff.getFullYear() - 1);
    const before = sessions.length;
    sessions = sessions.filter(s => new Date(s.date) >= cutoff);
    if (sessions.length !== before) {
        localStorage.setItem('medorus_sessions', JSON.stringify(sessions));
    }
}

// ‚úÖ FIX 5: ÿ£ÿ±ÿ¥ŸÅÿ© ÿ™ŸÑŸÇÿßÿ¶Ÿäÿ© ŸÑŸÑÿ¨ŸÑÿ≥ÿßÿ™ ÿßŸÑÿ£ŸÇÿØŸÖ ŸÖŸÜ 30 ŸäŸàŸÖÿßŸã ŸÖÿπ ÿ™ŸÜÿ®ŸäŸá ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
function autoArchiveOldSessions() {
    const cutoff = new Date();
    cutoff.setDate(cutoff.getDate() - 30);
    const old30 = sessions.filter(s => new Date(s.date) < cutoff);
    if (old30.length === 0) return;

    // ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ¨ŸÑÿ≥ÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ© ÿ£ŸàŸÑÿßŸã (ÿ£ÿ±ÿ¥ŸÅÿ© ÿ¢ŸÖŸÜÿ©)
    try {
        const archiveData = { archivedAt: new Date().toISOString(), sessions: old30 };
        const blob = new Blob([JSON.stringify(archiveData, null, 2)], { type: 'application/json' });
        const url  = URL.createObjectURL(blob);
        const a    = document.createElement('a');
        a.href     = url;
        a.download = 'nourium-archive-' + toDateKey(new Date()) + '.json';
        a.click();
        URL.revokeObjectURL(url);
    } catch(e) {}

    // ÿ≠ÿ∞ŸÅŸáÿß ŸÖŸÜ ÿßŸÑÿ∞ÿßŸÉÿ±ÿ© ÿßŸÑŸÜÿ¥ÿ∑ÿ©
    sessions = sessions.filter(s => new Date(s.date) >= cutoff);
    localStorage.setItem('medorus_sessions', JSON.stringify(sessions));
    showNotification(`‚úÖ ÿ™ŸÖ ÿ£ÿ±ÿ¥ŸÅÿ© ${old30.length} ÿ¨ŸÑÿ≥ÿ© ŸÇÿØŸäŸÖÿ© (ÿ£ŸÉÿ´ÿ± ŸÖŸÜ 30 ŸäŸàŸÖ)`, 'success');
    checkStorageUsage();
}

function trimOldSessionsManual() {
    const before = sessions.length;
    trimOldSessions();
    const removed = before - sessions.length;
    showNotification(removed > 0 ? `‚úÖ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ${removed} ÿ¨ŸÑÿ≥ÿ© ŸÇÿØŸäŸÖÿ©` : 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ¨ŸÑÿ≥ÿßÿ™ ŸÇÿØŸäŸÖÿ© ŸÑŸÑÿ≠ÿ∞ŸÅ', 'info');
    checkStorageUsage();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ŸÅÿ≠ÿµ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkStorageUsage() {
    try {
        let total = 0;
        for (let key in localStorage) {
            if (localStorage.hasOwnProperty(key)) {
                total += (localStorage[key].length + key.length) * 2; // bytes (UTF-16)
            }
        }
        const usedKB  = Math.round(total / 1024);
        const limitKB = 5120; // ~5MB
        const pct     = Math.round((usedKB / limitKB) * 100);

        // ÿπÿ±ÿ∂ ŸÅŸä ÿµŸÅÿ≠ÿ© ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
        const infoEl = document.getElementById('storageInfo');
        if (infoEl) {
            infoEl.innerHTML = `
                <div style="font-size:0.82rem;color:var(--text-light);margin-bottom:8px;">
                    <i class="fas fa-database"></i> ÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ${usedKB} KB / ~5120 KB (${pct}%)
                </div>
                <div class="goal-bar-bg">
                    <div class="goal-bar-fill" style="width:${Math.min(pct,100)}%;background:${pct>80?'var(--danger)':pct>60?'var(--warning)':'var(--success)'};"></div>
                </div>`;
        }

        // ÿ™ÿ≠ÿ∞Ÿäÿ± ŸÅŸä ÿßŸÑŸÑŸàÿ≠ÿ© ÿßŸÑÿ¨ÿßŸÜÿ®Ÿäÿ© + ÿ£ÿ±ÿ¥ŸÅÿ© ÿ™ŸÑŸÇÿßÿ¶Ÿäÿ© ÿπŸÜÿØ ÿßŸÑÿ∂ÿ±Ÿàÿ±ÿ©
        const warningEl = document.getElementById('storageWarningPanel');
        if (warningEl) {
            if (pct >= 85) {
                // ‚úÖ FIX 5: ÿ£ÿ±ÿ¥ŸÅÿ© ÿ™ŸÑŸÇÿßÿ¶Ÿäÿ© ÿπŸÜÿØ 85% ÿØŸàŸÜ ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
                warningEl.innerHTML = `
                    <div class="storage-warning" style="margin-top:14px;background:rgba(220,38,38,0.1);border:1px solid #dc2626;border-radius:12px;padding:12px;">
                        <i class="fas fa-exclamation-triangle" style="color:#dc2626;"></i>
                        <strong>ÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ ŸÖŸÖÿ™ŸÑÿ¶ ${pct}%!</strong><br>
                        <span style="font-size:0.8rem;">ÿ™ŸÖ ÿ®ÿØÿ° ÿßŸÑÿ£ÿ±ÿ¥ŸÅÿ© ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿäÿ© ŸÑŸÑÿ¨ŸÑÿ≥ÿßÿ™ ÿßŸÑÿ£ŸÇÿØŸÖ ŸÖŸÜ 30 ŸäŸàŸÖÿßŸã...</span>
                        <br><button onclick="autoArchiveOldSessions()" style="margin-top:8px;padding:6px 14px;background:#dc2626;color:white;border:none;border-radius:8px;cursor:pointer;font-size:0.82rem;">üóÑÔ∏è ÿ£ÿ±ÿ¥ŸÅÿ© ÿßŸÑÿ¢ŸÜ</button>
                    </div>`;
            } else if (pct > 70) {
                warningEl.innerHTML = `
                    <div class="storage-warning" style="margin-top:14px;background:rgba(245,158,11,0.1);border:1px solid #f59e0b;border-radius:12px;padding:12px;">
                        <i class="fas fa-exclamation-triangle" style="color:#f59e0b;"></i>
                        ÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ ŸÖŸÖÿ™ŸÑÿ¶ ${pct}% ‚Äî ŸäŸèŸÜÿµÿ≠ ÿ®ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ£Ÿà ÿ£ÿ±ÿ¥ŸÅÿ© ÿßŸÑÿ¨ŸÑÿ≥ÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ©
                        <br><button onclick="autoArchiveOldSessions()" style="margin-top:8px;padding:6px 14px;background:#f59e0b;color:white;border:none;border-radius:8px;cursor:pointer;font-size:0.82rem;">üóÑÔ∏è ÿ£ÿ±ÿ¥ŸÅÿ© ÿßŸÑÿ¨ŸÑÿ≥ÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ©</button>
                    </div>`;
            } else {
                warningEl.innerHTML = '';
            }
        }
    } catch(e) {}
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FIX: ŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑŸÖÿ§ŸÇÿ™ ÿπŸÜÿØ ÿπŸàÿØÿ© ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ŸÑŸÑÿ™ÿ±ŸÉŸäÿ≤ (Page Visibility API)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('visibilitychange', function() {
    if (!document.hidden && isRunning && timerStartTimestamp) {
        // ÿ•ÿπÿßÿØÿ© ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿ≠ŸÇŸäŸÇŸä ÿ®ÿπÿØ ÿπŸàÿØÿ© ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
        const elapsed = Math.floor((Date.now() - timerStartTimestamp) / 1000);
        timeLeft = Math.max(timerStartTimeLeft - elapsed, 0);
        updateTimerDisplay();
        if (timeLeft <= 0) {
            completeTimerSession();
        }
    }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ÿßŸÑÿ¢Ÿäÿßÿ™ ÿßŸÑŸÇÿ±ÿ¢ŸÜŸäÿ©
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showRandomVerse() {
    const card   = document.getElementById('quranVerseCard');
    const textEl = document.getElementById('quranVerseText');
    const refEl  = document.getElementById('quranVerseRef');
    if (!card || !textEl || !refEl) return;

    let newIndex;
    do { newIndex = Math.floor(Math.random() * QURAN_VERSES.length); }
    while (newIndex === currentVerseIndex && QURAN_VERSES.length > 1);
    currentVerseIndex = newIndex;

    const verse = QURAN_VERSES[currentVerseIndex];
    card.style.animation = 'none';
    card.offsetHeight; // reflow
    card.style.animation = 'verseAppear 0.6s ease';
    textEl.innerText = verse.text;
    refEl.innerText  = verse.ref;
}

function startVerseRotation() {
    showRandomVerse();
    if (verseInterval) clearInterval(verseInterval);
    verseInterval = setInterval(showRandomVerse, 45000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showNotification(message, type = 'success') {
    document.querySelectorAll('.notification').forEach(n => n.remove());
    const colors = { success:'#10B981', error:'#EF4444', info:'#3B82F6', warning:'#6366F1' };
    const n = document.createElement('div');
    n.className = 'notification';
    n.style.background = colors[type] || colors.success;
    n.innerText = message;
    document.body.appendChild(n);
    setTimeout(() => { n.classList.add('fade-out'); setTimeout(() => n.remove(), 300); }, 2700);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ÿßŸÑÿµŸàÿ™ + ÿßŸÑÿßŸáÿ™ÿ≤ÿßÿ≤ ÿπŸÜÿØ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑÿ¨ŸÑÿ≥ÿ©
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function playCompletionSound() {
    // ‚úÖ ÿßŸÑÿßŸáÿ™ÿ≤ÿßÿ≤ ÿπŸÑŸâ ÿßŸÑÿ¨ŸàÿßŸÑ
    if ('vibrate' in navigator) {
        navigator.vibrate([200, 100, 200]);
    }

    try {
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        if (!AudioCtx) return;
        const ctx = new AudioCtx();
        const noteFreqs = [523, 659, 784];
        noteFreqs.forEach((freq, i) => {
            const osc  = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            osc.frequency.value = freq;
            osc.type = 'sine';
            const start = ctx.currentTime + i * 0.2;
            gain.gain.setValueAtTime(0.4, start);
            gain.gain.exponentialRampToValueAtTime(0.01, start + 0.4);
            osc.start(start); osc.stop(start + 0.4);
        });
    } catch(e) {}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  Wake Lock API ‚Äî ŸÖŸÜÿπ ÿ•ÿ∑ŸÅÿßÿ° ÿßŸÑÿ¥ÿßÿ¥ÿ©
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function requestWakeLock() {
    if (!('wakeLock' in navigator)) return;
    try {
        wakeLock = await navigator.wakeLock.request('screen');
        wakeLock.addEventListener('release', () => {
            wakeLock = null;
            updateWakeLockUI();
        });
        updateWakeLockUI();
    } catch(e) {}
}

async function releaseWakeLock() {
    if (wakeLock) {
        try { await wakeLock.release(); } catch(e) {}
        wakeLock = null;
    }
    updateWakeLockUI();
}

async function toggleWakeLock() {
    if (wakeLock) { await releaseWakeLock(); }
    else { await requestWakeLock(); }
}

function updateWakeLockUI() {
    const btn    = document.getElementById('wakeLockBtn');
    const status = document.getElementById('wakeLockStatus');
    if (!btn) return;

    if (wakeLock) {
        btn.innerHTML = '<i class="fas fa-eye" style="color:var(--success)"></i>';
        btn.title = 'ÿßŸÑÿ¥ÿßÿ¥ÿ© ŸÖŸèÿ´ÿ®ŸéŸëÿ™ÿ© ‚Äî ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑÿ•ŸäŸÇÿßŸÅ';
        if (status) status.innerHTML = '<div class="wakelocked-badge"><i class="fas fa-eye"></i> ÿßŸÑÿ¥ÿßÿ¥ÿ© ŸÖŸèÿ´ÿ®ŸéŸëÿ™ÿ©</div>';
    } else {
        btn.innerHTML = '<i class="fas fa-eye-slash"></i>';
        btn.title = 'ŸÖŸÜÿπ ÿ•ÿ∑ŸÅÿßÿ° ÿßŸÑÿ¥ÿßÿ¥ÿ©';
        if (status) status.innerHTML = '';
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ÿßŸÑÿ™ŸÜŸÇŸÑ ÿ®ŸäŸÜ ÿßŸÑÿµŸÅÿ≠ÿßÿ™
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(tabId, el) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    el.classList.add('active');

    if (tabId === 'analytics') updateAnalytics();
    if (tabId === 'tasks')     renderTasks();
    if (tabId === 'subjects')  renderSubjects();
    if (tabId === 'review')    renderReviews();
    if (tabId === 'exams')     renderExams();
    if (tabId === 'balance')   renderBalance();
    if (tabId === 'notes')     renderNotes();
    if (tabId === 'profile')   { checkStorageUsage(); loadNotifSettingsUI(); updateNotifPermissionBanner(); updateNotifStatusBar(); }
    if (tabId === 'spiritual') initSpiritualGuide();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ÿßŸÑÿ´ŸäŸÖ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    localStorage.setItem('medorus_theme', isDark ? 'dark' : 'light');
    document.getElementById('themeIcon').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ÿßŸÑŸÑŸàÿ≠ÿ© ÿßŸÑÿ¨ÿßŸÜÿ®Ÿäÿ©
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleSidePanel() {
    const panel = document.getElementById('sidePanel');
    panel.classList.toggle('open');
    if (panel.classList.contains('open')) {
        updateStreak(false);
        updateStatsUI();
        updateGoalProgress();
        checkStorageUsage();
    }
}

function handlePanelClick(e) {
    if (e.target === document.getElementById('sidePanel')) toggleSidePanel();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  XP ‚Äî ŸÖÿπ ÿ≠ÿØ ŸäŸàŸÖŸä ŸÖŸÜ ÿßŸÑŸÖŸáÿßŸÖ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addXP(amount) {
    const prevLevel = getCurrentLevel();
    xp += amount;
    localStorage.setItem('medorus_xp', xp);
    const newLevel = getCurrentLevel();
    if (newLevel.index > prevLevel.index) {
        setTimeout(() => showNotification('üéä ÿ™ÿ±ŸÇŸäÿ©! ÿ£ÿµÿ®ÿ≠ÿ™ ' + newLevel.name + '!', 'success'), 500);
    }
    updateLevelUI();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ÿ≠ÿØ ŸäŸàŸÖŸä XP ŸÖŸÜ ÿßŸÑŸÖŸáÿßŸÖ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getTodayTaskXP() {
    const key  = 'task_xp_' + getTodayKey();
    const value = localStorage.getItem(key);
    return value ? (parseInt(value) || 0) : 0; // ‚úÖ ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿ±ŸÇŸÖ
}

function addTodayTaskXP(amount) {
    const key = 'task_xp_' + getTodayKey();
    const current = getTodayTaskXP();
    localStorage.setItem(key, current + amount);
    updateXpCapNote();
}

function updateXpCapNote() {
    const note = document.getElementById('xpCapNote');
    if (!note) return;
    const used = getTodayTaskXP();
    const remaining = Math.max(DAILY_TASK_XP_LIMIT - used, 0);
    if (remaining === 0) {
        note.innerText = '‚ö†Ô∏è ŸàÿµŸÑÿ™ ŸÑŸÑÿ≠ÿØ ÿßŸÑŸäŸàŸÖŸä ŸÑŸÑŸÜŸÇÿßÿ∑ ŸÖŸÜ ÿßŸÑŸÖŸáÿßŸÖ (100 ŸÜŸÇÿ∑ÿ©)';
        note.style.color = 'var(--warning)';
    } else {
        note.innerText = `ŸÜŸÇÿßÿ∑ ÿßŸÑŸÖŸáÿßŸÖ ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ© ÿßŸÑŸäŸàŸÖ: ${remaining}`;
        note.style.color = 'var(--text-light)';
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  Lux Panel
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateLuxPanel() {
    const panel     = document.getElementById('luxPanel');
    const barFill   = document.getElementById('luxBarFill');
    const titleEl   = document.getElementById('luxTitle');
    const labelEl   = document.getElementById('luxLabel');
    const todayStat = document.getElementById('luxTodaySessions');
    const streakStat= document.getElementById('luxStreak');
    const weekStat  = document.getElementById('luxWeekMins');
    if (!panel) return;

    const todaySessions = stats.sessions.daily  || 0;
    const weekMins      = stats.minutes.weekly  || 0;
    const streakVal     = streak || 0;

    const score = (todaySessions * 20) + (streakVal * 15) + Math.floor(weekMins / 60) * 10;

    let luxLevel, luxTitle, luxLabelText, pct;
    if      (score === 0)  { luxLevel = 0; luxTitle = 'üåë ÿßÿ®ÿØÿ£ ÿ±ÿ≠ŸÑÿ™ŸÉ';     luxLabelText = 'ÿßŸÑŸÜŸàÿ± ŸäŸÜÿ™ÿ∏ÿ±ŸÉ';         pct = 0; }
    else if (score < 30)   { luxLevel = 1; luxTitle = 'üåí ÿ¥ÿ±ÿßÿ±ÿ© ÿ£ŸàŸÑŸâ';     luxLabelText = 'ÿßŸÑŸÜŸàÿ± Ÿäÿ™ŸÇÿØ';           pct = Math.min(score/30*100, 99); }
    else if (score < 80)   { luxLevel = 2; luxTitle = 'üåì ŸÜŸàÿ± ŸÖÿ™ÿµÿßÿπÿØ';     luxLabelText = 'ÿßÿ≥ÿ™ŸÖÿ± ŸÅŸä ÿßŸÑÿ™ÿ£ŸÑŸÇ';      pct = Math.min((score-30)/50*100, 99); }
    else if (score < 160)  { luxLevel = 3; luxTitle = 'üåî ÿ•ÿ¥ÿ±ÿßŸÇ ŸÇŸàŸä';      luxLabelText = 'ÿ£ŸÜÿ™ ÿ™ÿ≥ÿ∑ÿπ ÿßŸÑŸäŸàŸÖ!';     pct = Math.min((score-80)/80*100, 99); }
    else if (score < 280)  { luxLevel = 4; luxTitle = 'üåï ŸÖŸÜÿßÿ±ÿ© ÿ≥ÿßÿ∑ÿπÿ©';    luxLabelText = 'ÿ£ÿØÿßÿ° ÿßÿ≥ÿ™ÿ´ŸÜÿßÿ¶Ÿä üèÜ';    pct = Math.min((score-160)/120*100, 99); }
    else                   { luxLevel = 5; luxTitle = '‚ú® ŸÑŸàŸÖŸäÿØŸàÿ≥ ÿßŸÑŸÉÿßŸÖŸÑ'; luxLabelText = 'ŸàÿµŸÑÿ™ ŸÑŸÑŸÇŸÖÿ© ÿßŸÑŸäŸàŸÖ! üåü'; pct = 100; }

    panel.className = 'lux-panel lux-' + luxLevel;
    barFill.style.width = pct + '%';
    titleEl.innerText   = luxTitle;
    labelEl.innerText   = luxLabelText;
    if (todayStat)  todayStat.innerText  = todaySessions;
    if (streakStat) streakStat.innerText = streakVal;
    if (weekStat)   weekStat.innerText   = weekMins;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  Level UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateLevelUI() {
    const level     = getCurrentLevel();
    const nextLevel = LEVELS[Math.min(level.index + 1, LEVELS.length - 1)];
    const range     = nextLevel.minXP - level.minXP || 1;
    const progress  = Math.min(((xp - level.minXP) / range) * 100, 100);
    const xpToNext  = level.index < LEVELS.length - 1
        ? (nextLevel.minXP - xp) + ' ŸÜŸÇÿ∑ÿ© ŸÑŸÑŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿ™ÿßŸÑŸä'
        : 'üèÜ ÿ£ÿπŸÑŸâ ŸÖÿ≥ÿ™ŸàŸâ!';

    ['levelName','homeLevelName'].forEach(id => { const el=document.getElementById(id); if(el) el.innerText=level.name; });
    ['levelIcon','homeLevelIcon'].forEach(id => { const el=document.getElementById(id); if(el) el.innerText=level.icon; });

    document.getElementById('xpPoints').innerText      = xp;
    document.getElementById('xpBar').style.width       = progress + '%';
    document.getElementById('homeXpBar').style.width   = progress + '%';
    document.getElementById('xpToNext').innerText      = xpToNext;
    document.getElementById('homeXpLabel').innerText   = xpToNext;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ÿßŸÑÿ£ŸäÿßŸÖ ÿßŸÑŸÖÿ™ÿ™ÿßŸÑŸäÿ© (streak) ‚Äî ŸÖÿµÿ≠ŸéŸëÿ≠ÿ©
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateStreak(save = true) {
    const count   = document.getElementById('streakCount');
    const fire    = document.getElementById('streakFire');
    const insight = document.getElementById('streakInsight');
    const msg     = document.getElementById('streakMessage');

    count.innerText = streak;

    if (streak === 0) {
        fire.innerText = 'üî•';
        if (insight) insight.style.display = 'none';
    } else {
        fire.innerText = streak >= 30 ? 'üî•üî•üî•' : streak >= 14 ? 'üî•üî•' : 'üî•';
        if (insight && streak >= 7) {
            insight.style.display = 'block';
            msg.innerText = streak + ' ÿ£ŸäÿßŸÖ ŸÖÿ™ÿ™ÿßŸÑŸäÿ©! ÿßÿ≥ÿ™ŸÖÿ± ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑÿ•ŸäŸÇÿßÿπ ÿßŸÑÿ±ÿßÿ¶ÿπ!';
        } else if (insight) {
            insight.style.display = 'none';
        }
    }

    if (save) {
        localStorage.setItem('medorus_streak', streak);
        localStorage.setItem('medorus_last_study_date', lastStudyDate || '');
    }
    updateLuxPanel();
}

function recordStudyDay() {
    const today = getTodayKey();
    // ‚úÖ ÿßŸÑÿ≠ŸÖÿßŸäÿ© ÿßŸÑÿ£ŸàŸÑŸâ: ÿ•ÿ∞ÿß ÿ≥ÿ¨ŸëŸÑŸÜÿß ÿßŸÑŸäŸàŸÖ ÿ®ÿßŸÑŸÅÿπŸÑ
    if (lastStudyDate === today) return;

    // ‚úÖ FIX: ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿ¨ŸÑÿ≥ÿ© ŸÅÿπŸÑŸäÿ© ŸÑŸÑŸäŸàŸÖ ŸÇÿ®ŸÑ ÿ™ÿ≥ÿ¨ŸäŸÑ ŸäŸàŸÖ ÿØÿ±ÿßÿ≥Ÿä
    const hasTodaySession = sessions.some(s => toDateKey(new Date(s.date)) === today);
    if (!hasTodaySession) return;

    if (lastStudyDate && isYesterday(lastStudyDate)) {
        streak++;
        if (streak === 7)  { addXP(100); showNotification('üéâ 7 ÿ£ŸäÿßŸÖ ŸÖÿ™ÿ™ÿßŸÑŸäÿ©! +100 ŸÜŸÇÿ∑ÿ©', 'success'); }
        if (streak === 14) { addXP(200); showNotification('üåü 14 ŸäŸàŸÖ ŸÖÿ™ÿ™ÿßŸÑŸä! +200 ŸÜŸÇÿ∑ÿ©', 'success'); }
        if (streak === 30) { addXP(500); showNotification('üíé 30 ŸäŸàŸÖ ŸÖÿ™ÿ™ÿßŸÑŸä! +500 ŸÜŸÇÿ∑ÿ©', 'success'); }
    } else {
        streak = 1;
    }

    lastStudyDate = today;
    updateStreak(true);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ÿßŸÑŸÖÿ§ŸÇÿ™ ‚Äî ŸÖÿµÿ≠ŸéŸëÿ≠ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setTimerMode(mode, btn) {
    clearInterval(timerInterval);
    isRunning        = false;
    sessionCompleted = false;

    timerMode = mode;
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    const durationSelector     = document.getElementById('durationSelector');
    const subjectSelectWrapper = document.getElementById('subjectSelectWrapper');

    if (mode === 'break') {
        durationSelector.style.display    = 'none';
        subjectSelectWrapper.style.display = 'none';
        timeLeft = 5 * 60;
    } else {
        durationSelector.style.display    = 'flex';
        subjectSelectWrapper.style.display = 'block';
        timeLeft = currentDuration * 60;
    }

    resetTimerButtons();
    updateTimerDisplay();
    document.title = 'Nourium';
    releaseWakeLock();
}

function setDuration(mins, btn) {
    currentDuration = mins;
    if (timerMode === 'focus') timeLeft = mins * 60;
    document.querySelectorAll('.dur-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    if (!isRunning) updateTimerDisplay();
}

function updateTimerDisplay() {
    const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
    const s = (timeLeft % 60).toString().padStart(2, '0');
    document.getElementById('timer').innerText = m + ':' + s;
    // ‚úÖ ÿ™ÿ≠ÿØŸäÿ´ ÿπŸÜŸàÿßŸÜ ÿßŸÑÿµŸÅÿ≠ÿ© ŸÉŸÑ 5 ÿ´ŸàÿßŸÜŸç ŸÅŸÇÿ∑ ŸÑÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿ£ÿØÿßÿ°
    const now = Date.now();
    if (now - _lastTitleUpdate > 5000) {
        document.title = isRunning ? m + ':' + s + ' ‚Äî Nourium' : 'Nourium';
        _lastTitleUpdate = now;
    }
}

function resetTimerButtons() {
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    startBtn.innerHTML      = '<i class="fas fa-play"></i> ÿßÿ®ÿØÿ£';
    startBtn.className      = 'btn-start-main';
    startBtn.disabled       = false;
    startBtn.style.display  = 'inline-block';
    pauseBtn.style.display  = 'none';
}

// ‚úÖ FIX 2: ÿßŸÑÿ≠ŸÖÿßŸäÿ© ŸÖŸÜ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿßŸÑŸÖÿ≤ÿØŸàÿ¨ ÿßŸÑÿ≥ÿ±Ÿäÿπ
function toggleTimer() {
    const startBtn = document.getElementById('startBtn');
    startBtn.disabled = true; // ÿ£ŸàŸÑ ÿ•ÿ¨ÿ±ÿßÿ°

    if (isRunning) {
        startBtn.disabled = false;
        return;
    }

    isRunning           = true;
    sessionCompleted    = false; // ‚úÖ FIX 3: reset guard
    timerStartTimestamp = Date.now();
    timerStartTimeLeft  = timeLeft;

    startBtn.style.display = 'none';
    document.getElementById('pauseBtn').style.display = 'inline-block';

    const td = document.getElementById('timer');
    td.classList.remove('running', 'break-mode');
    td.classList.add(timerMode === 'break' ? 'break-mode' : 'running');

    // Enter focus mode during session
    if (timerMode === 'focus') { enterFocusMode(); requestWakeLock(); }

    timerInterval = setInterval(function() {
        const elapsed = Math.floor((Date.now() - timerStartTimestamp) / 1000);
        timeLeft = Math.max(timerStartTimeLeft - elapsed, 0);
        updateTimerDisplay();
        if (timeLeft <= 0) completeTimerSession();
    }, 500);
}

function pauseTimer() {
    if (!isRunning) return;
    clearInterval(timerInterval);
    isRunning = false;

    const elapsed = Math.floor((Date.now() - timerStartTimestamp) / 1000);
    timeLeft = Math.max(timerStartTimeLeft - elapsed, 0);
    timerStartTimestamp = null;
    timerStartTimeLeft  = 0;

    document.getElementById('timer').classList.remove('running', 'break-mode');
    updateTimerDisplay();

    const startBtn = document.getElementById('startBtn');
    startBtn.innerHTML     = '<i class="fas fa-play"></i> ÿßÿ≥ÿ™ÿ¶ŸÜÿßŸÅ';
    startBtn.className     = 'btn btn-start-main btn-resume';
    startBtn.disabled      = false;
    startBtn.style.display = 'inline-block';
    document.getElementById('pauseBtn').style.display = 'none';
    document.title = 'Nourium (ŸÖÿ™ŸàŸÇŸÅ)';

    exitFocusMode();
    // ‚úÖ ÿ≠ÿ±ÿ± Wake Lock ÿπŸÜÿØ ÿßŸÑÿ•ŸäŸÇÿßŸÅ
    releaseWakeLock();
}

function resetTimer() {
    clearInterval(timerInterval);
    isRunning           = false;
    sessionCompleted    = false;
    timerStartTimestamp = null;
    timerStartTimeLeft  = 0;
    timeLeft = timerMode === 'break' ? 5 * 60 : currentDuration * 60;

    resetTimerButtons();
    document.getElementById('timer').classList.remove('running', 'break-mode');
    updateTimerDisplay();
    document.title = 'Nourium';
    dismissBanner();
    exitFocusMode();
    releaseWakeLock();
}

// ‚úÖ FIX 3: guard ÿ∂ÿØ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ¨ŸÑÿ≥ÿ© ŸÖÿ±ÿ™ŸäŸÜ
function completeTimerSession() {
    if (sessionCompleted) return; // ‚Üê ÿßŸÑÿ≠ŸÖÿßŸäÿ© ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©
    sessionCompleted = true;

    clearInterval(timerInterval);
    isRunning           = false;
    timerStartTimestamp = null;
    timerStartTimeLeft  = 0;

    document.getElementById('timer').classList.remove('running', 'break-mode');
    resetTimerButtons();
    exitFocusMode();
    releaseWakeLock();
    playCompletionSound();

    if (typeof Notification !== 'undefined' && Notification.permission === 'granted') {
        try {
            new Notification('Nourium', {
                body: timerMode === 'focus' ? 'üéâ ÿßŸÜÿ™Ÿáÿ™ ÿ¨ŸÑÿ≥ÿ© ÿßŸÑÿØÿ±ÿßÿ≥ÿ©!' : '‚òï ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑÿßÿ≥ÿ™ÿ±ÿßÿ≠ÿ©!'
            });
        } catch(e) {}
    }

    if (timerMode === 'focus') {
        const selectedSubject = document.getElementById('timerSubjectSelect').value;
        const sessionData = {
            date:     new Date().toISOString(),
            duration: currentDuration,
            hour:     new Date().getHours(),
            subject:  selectedSubject || 'ÿπÿßŸÖ'
        };
        sessions.push(sessionData);
        localStorage.setItem('medorus_sessions', JSON.stringify(sessions));

        addXP(20);
        updateSessionStats(currentDuration);
        recordStudyDay();
        updateGoalProgress();
        renderCalendar();
        checkStorageUsage();
        sendSessionDoneNotif(); // ‚úÖ ÿ•ÿ¥ÿπÿßÿ± ŸÖÿß ÿ®ÿπÿØ ÿßŸÑÿ¨ŸÑÿ≥ÿ©
        showPostSessionBanner('focus');
        refreshKnowledgeTree(); // üå≥ ÿ™ÿ≠ÿØŸäÿ´ ÿ¥ÿ¨ÿ±ÿ© ÿßŸÑŸÖÿπÿ±ŸÅÿ©
        setTimeout(function(){ nouriCelebrate(); nouriSpeak(nouriPick(NOURI_MSGS.done), 8000); }, 500);
        if (document.getElementById('challenges')?.classList.contains('active')) renderChallenges();
        promptMoodAfterSession(); // üß† ÿ∑ŸÑÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑŸÖÿ≤ÿßÿ¨
        triggerSpiritAfterSession(currentDuration); // üåô ÿ•ŸÑŸáÿßŸÖ ÿ±Ÿàÿ≠Ÿä
        showIhtisabDoneBanner(); // ü§ç ÿßÿ≠ÿ™ÿ≥ÿßÿ® ÿßŸÑÿ£ÿ¨ÿ±
    } else {
        showPostSessionBanner('break');
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ÿ®ÿßŸÜÿ± ŸÖÿß ÿ®ÿπÿØ ÿßŸÑÿ¨ŸÑÿ≥ÿ©
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showPostSessionBanner(completedMode) {
    const old = document.getElementById('postSessionBanner');
    if (old) { clearTimeout(old._autoClose); old.remove(); }

    const isStudy = completedMode === 'focus';
    const banner  = document.createElement('div');
    banner.id     = 'postSessionBanner';
    banner.style.cssText = `
        position:fixed; bottom:85px; left:50%; transform:translateX(-50%);
        background:var(--card-bg); border:2px solid var(--primary);
        border-radius:16px; padding:16px 20px; z-index:500;
        box-shadow:0 8px 30px rgba(0,0,0,0.15); text-align:center;
        width:88%; max-width:360px; animation:bannerSlideUp 0.3s ease;`;

    if (!document.getElementById('bannerAnim')) {
        const s = document.createElement('style');
        s.id = 'bannerAnim';
        s.textContent = '@keyframes bannerSlideUp{from{bottom:40px;opacity:0}to{bottom:85px;opacity:1}}';
        document.head.appendChild(s);
    }

    if (isStudy) {
        banner.innerHTML = `
            <div style="font-size:1.4rem;margin-bottom:6px;">üéâ</div>
            <div style="font-weight:700;font-size:1rem;margin-bottom:4px;">ÿ£ŸÉŸÖŸÑÿ™ ÿ¨ŸÑÿ≥ÿ© ÿØÿ±ÿßÿ≥ÿ©! +20 ŸÜŸÇÿ∑ÿ©</div>
            <div style="font-size:0.85rem;color:var(--text-light);margin-bottom:14px;">ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ£ÿÆÿ∞ ÿßÿ≥ÿ™ÿ±ÿßÿ≠ÿ©ÿü</div>
            <div style="display:flex;gap:10px;justify-content:center;">
                <button onclick="startBreakFromBanner()" style="padding:10px 18px;border:none;border-radius:50px;background:var(--break);color:white;font-weight:700;cursor:pointer;font-family:'Tajawal',sans-serif;">‚òï ÿßÿ≥ÿ™ÿ±ÿßÿ≠ÿ© 5 ÿØ</button>
                <button onclick="dismissBanner()" style="padding:10px 18px;border:1px solid var(--border);border-radius:50px;background:var(--bg);color:var(--text);font-weight:700;cursor:pointer;font-family:'Tajawal',sans-serif;">‚è© ÿ™ÿÆÿ∑ŸëŸä</button>
            </div>`;
    } else {
        banner.innerHTML = `
            <div style="font-size:1.4rem;margin-bottom:6px;">‚òï</div>
            <div style="font-weight:700;font-size:1rem;margin-bottom:4px;">ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑÿßÿ≥ÿ™ÿ±ÿßÿ≠ÿ©!</div>
            <div style="font-size:0.85rem;color:var(--text-light);margin-bottom:14px;">ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ≥ÿ™ÿπÿØ ŸÑÿ¨ŸÑÿ≥ÿ© ÿØÿ±ÿßÿ≥ÿ©ÿü</div>
            <div style="display:flex;gap:10px;justify-content:center;">
                <button onclick="startStudyFromBanner()" style="padding:10px 18px;border:none;border-radius:50px;background:var(--primary);color:white;font-weight:700;cursor:pointer;font-family:'Tajawal',sans-serif;">üß† ÿßÿ®ÿØÿ£ ÿßŸÑÿØÿ±ÿßÿ≥ÿ©</button>
                <button onclick="dismissBanner()" style="padding:10px 18px;border:1px solid var(--border);border-radius:50px;background:var(--bg);color:var(--text);font-weight:700;cursor:pointer;font-family:'Tajawal',sans-serif;">ŸÑÿßÿ≠ŸÇÿßŸã</button>
            </div>`;
    }

    document.body.appendChild(banner);
    banner._autoClose = setTimeout(dismissBanner, 30000);
}

function dismissBanner() {
    const b = document.getElementById('postSessionBanner');
    if (b) { clearTimeout(b._autoClose); b.remove(); }
}

function startBreakFromBanner() {
    dismissBanner();
    const breakBtn = document.getElementById('breakBtn');
    if (breakBtn) setTimerMode('break', breakBtn);
}

function startStudyFromBanner() {
    dismissBanner();
    const focusBtn = document.getElementById('focusBtn');
    if (focusBtn) setTimerMode('focus', focusBtn);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ÿ¥ÿßÿ±ÿ© ÿßŸÑŸÖÿßÿØÿ© ŸÅŸä ÿßŸÑŸÖÿ§ŸÇÿ™
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateTimerSubjectBadge() {
    const select = document.getElementById('timerSubjectSelect');
    const badge  = document.getElementById('timerSubjectBadge');
    const text   = document.getElementById('timerSubjectBadgeText');
    if (!select || !badge || !text) return; // ‚úÖ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßŸÑÿπŸÜÿßÿµÿ±
    const value  = select.value;

    if (value) {
        const sub = subjects.find(s => s.name === value);
        badge.style.display   = 'block';
        text.innerText        = 'üìå ' + value;
        text.style.background = sub ? sub.color : 'var(--primary)';
    } else {
        badge.style.display = 'none';
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateSessionStats(minutes) {
    stats.sessions.daily++;
    stats.sessions.weekly++;
    stats.sessions.monthly++;
    stats.minutes.daily   += minutes;
    stats.minutes.weekly  += minutes;
    stats.minutes.monthly += minutes;
    stats.lastUpdate = new Date().toISOString();
    saveStats();
    updateStatsUI();
}

function updateTaskStats() {
    stats.tasks.daily++;
    stats.tasks.weekly++;
    stats.tasks.monthly++;
    stats.lastUpdate = new Date().toISOString();
    saveStats();
    updateStatsUI();
}

function saveStats() {
    localStorage.setItem('medorus_stats', JSON.stringify(stats));
}

function updateStatsUI() {
    document.getElementById('statDailySessions').innerText  = stats.sessions.daily  || 0;
    document.getElementById('statWeeklySessions').innerText = stats.sessions.weekly || 0;
    document.getElementById('statMonthlyMins').innerText    = stats.minutes.monthly || 0;
    document.getElementById('totalSessions').innerText      = sessions.length;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ÿßŸÑŸáÿØŸÅ ÿßŸÑŸäŸàŸÖŸä
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveDailyGoal() {
    const input = parseInt(document.getElementById('dailyGoalInput').value);
    if (!input || input < 1) { showNotification('ÿ£ÿØÿÆŸÑ ÿ±ŸÇŸÖÿßŸã ÿµÿ≠Ÿäÿ≠ÿßŸã', 'error'); return; }
    dailyGoal = input;
    localStorage.setItem('medorus_daily_goal', dailyGoal);
    updateGoalProgress();
    showNotification('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸáÿØŸÅ ÿßŸÑŸäŸàŸÖŸä ‚úÖ', 'success');
}

function updateGoalProgress() {
    const wrapper = document.getElementById('goalProgressWrapper');
    if (!wrapper) return; // ‚úÖ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßŸÑÿπŸÜÿµÿ±
    if (!dailyGoal) { wrapper.style.display = 'none'; return; }
    wrapper.style.display = 'block';
    const current = stats.sessions.daily || 0;
    const percent = Math.min((current / dailyGoal) * 100, 100);
    document.getElementById('goalBarFill').style.width    = percent + '%';
    document.getElementById('goalCurrentLabel').innerText = current + ' ÿ¨ŸÑÿ≥ÿ©';
    document.getElementById('goalTargetLabel').innerText  = '/ ' + dailyGoal;
    updateLuxPanel();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑÿßÿ™
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateAnalytics() {
    const hours = new Array(24).fill(0);
    sessions.forEach(s => { if (s.hour >= 0 && s.hour < 24) hours[s.hour] += s.duration; });

    let maxHour = -1, maxVal = 0;
    hours.forEach((val, i) => { if (val > maxVal) { maxVal = val; maxHour = i; } });

    let timeLabel = 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÉÿßŸÅŸäÿ©';
    if (maxHour >= 0 && maxVal > 0) {
        const period = maxHour < 12 ? 'üåÖ ÿßŸÑÿµÿ®ÿßÿ≠' : maxHour < 18 ? '‚òÄÔ∏è ÿßŸÑÿ∏ŸáŸäÿ±ÿ©' : 'üåô ÿßŸÑŸÑŸäŸÑ';
        timeLabel = period + ' (ÿßŸÑÿ≥ÿßÿπÿ© ' + maxHour + ':00)';
    }
    document.getElementById('bestTimeInsight').innerText = timeLabel;

    const totalMins = sessions.reduce((sum, s) => sum + s.duration, 0);
    document.getElementById('avgSession').innerText    = sessions.length > 0 ? Math.round(totalMins / sessions.length) : 0;
    document.getElementById('totalHours').innerText   = (totalMins / 60).toFixed(1);
    document.getElementById('totalSessions').innerText= sessions.length;

    updateStreak(false);
    renderWeeklyChart();
    renderSubjectAnalysis();
    updateStatsUI();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ÿßŸÑÿ±ÿ≥ŸÖ ÿßŸÑÿ®ŸäÿßŸÜŸä ÿßŸÑÿ£ÿ≥ÿ®ŸàÿπŸä ‚Äî FIX 5 ŸÖÿµÿ≠ŸéŸëÿ≠
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderWeeklyChart() {
    const container = document.getElementById('weeklyChart');
    container.innerHTML = '';

    const dayNames  = ['ÿ£ÿ≠ÿØ','ÿ•ÿ´ŸÜŸäŸÜ','ÿ´ŸÑÿßÿ´ÿßÿ°','ÿ£ÿ±ÿ®ÿπÿßÿ°','ÿÆŸÖŸäÿ≥','ÿ¨ŸÖÿπÿ©','ÿ≥ÿ®ÿ™'];
    const weekData  = [0, 0, 0, 0, 0, 0, 0];
    const todayDay  = new Date().getDay();

    // ‚úÖ FIX 5: ŸÜÿ≠ÿ≥ÿ® ÿ®ÿØÿßŸäÿ© ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ ÿ®ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖÿ≠ŸÑŸä ŸÅŸÇÿ∑
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const weekStart = new Date(today);
    weekStart.setDate(weekStart.getDate() - weekStart.getDay());

    sessions.forEach(s => {
        const sDate    = new Date(s.date);
        const sDateKey = toDateKey(sDate);
        const sDay     = sDate.getDay();

        // ŸÜÿ≠ÿ≥ÿ® ÿ®ÿØÿßŸäÿ© ÿ£ÿ≥ÿ®Ÿàÿπ ÿßŸÑÿ¨ŸÑÿ≥ÿ©
        const sWeekStart = new Date(sDate);
        sWeekStart.setHours(0, 0, 0, 0);
        sWeekStart.setDate(sWeekStart.getDate() - sWeekStart.getDay());

        if (toDateKey(sWeekStart) === toDateKey(weekStart)) {
            weekData[sDay] += s.duration;
        }
    });

    const maxVal    = Math.max(...weekData, 1);
    const maxHeight = 120;

    dayNames.forEach((day, idx) => {
        const height  = Math.round((weekData[idx] / maxVal) * maxHeight);
        const isToday = idx === todayDay;
        const wrapper = document.createElement('div');
        wrapper.className = 'chart-bar-wrapper';

        const bar = document.createElement('div');
        bar.className = 'chart-bar' + (isToday ? ' today-bar' : '');
        bar.style.height = height + 'px';

        if (weekData[idx] > 0) {
            const valLabel = document.createElement('span');
            valLabel.className = 'chart-value';
            valLabel.innerText = weekData[idx] + 'ÿØ';
            bar.appendChild(valLabel);
        }

        const label = document.createElement('div');
        label.className = 'chart-label';
        label.innerText = day;
        if (isToday) label.style.color = 'var(--accent)';

        wrapper.appendChild(bar);
        wrapper.appendChild(label);
        container.appendChild(wrapper);
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸàÿßÿØ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSubjectAnalysis() {
    const container = document.getElementById('subjectAnalysis');
    container.innerHTML = '';

    const subjectStats = {};
    sessions.forEach(s => {
        const sub = s.subject || 'ÿπÿßŸÖ';
        subjectStats[sub] = (subjectStats[sub] || 0) + s.duration;
    });

    const sorted = Object.entries(subjectStats).sort((a, b) => b[1] - a[1]);

    if (sorted.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-chart-pie"></i><p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿ®ÿπÿØ</p></div>';
        return;
    }

    const top      = sorted[0];
    container.innerHTML += `
        <div class="insight-card green">
            <div class="insight-title">üèÜ ÿßŸÑÿ£ŸÉÿ´ÿ± ÿØÿ±ÿßÿ≥ÿ©</div>
            <div class="insight-value">${top[0]} ‚Äî ${top[1]} ÿØŸÇŸäŸÇÿ© (${(top[1]/60).toFixed(1)} ÿ≥ÿßÿπÿ©)</div>
        </div>`;

    if (subjects.length > 0) {
        const studiedNames = sorted.map(s => s[0]);
        const neglected    = subjects.filter(sub => !studiedNames.includes(sub.name));
        if (neglected.length > 0) {
            container.innerHTML += `
                <div class="insight-card warning">
                    <div class="insight-title">‚ö†Ô∏è ŸÖŸàÿßÿØ ÿ™ÿ≠ÿ™ÿßÿ¨ ÿßŸáÿ™ŸÖÿßŸÖ</div>
                    <div class="insight-value">${neglected.map(s => s.name).join(' ¬∑ ')}</div>
                </div>`;
        }
    }

    const total = sorted.reduce((sum, e) => sum + e[1], 0);
    sorted.forEach(([name, mins]) => {
        const color = subjects.find(s => s.name === name)?.color || '#6B7280';
        const pct   = total > 0 ? Math.round((mins / total) * 100) : 0;
        container.innerHTML += `
            <div style="margin-bottom:12px;">
                <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                    <span style="font-weight:600;">${name}</span>
                    <span style="color:var(--text-light);font-size:0.85rem;">${mins} ÿØ (${pct}%)</span>
                </div>
                <div class="goal-bar-bg">
                    <div class="goal-bar-fill" style="width:${pct}%;background:${color};"></div>
                </div>
            </div>`;
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ÿßŸÑÿ™ŸÇŸàŸäŸÖ ‚Äî FIX 4: streak-day ŸÖÿµÿ≠ŸéŸëÿ≠
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCalendar() {
    const grid       = document.getElementById('calendarGrid');
    const monthLabel = document.getElementById('calendarMonth');
    grid.innerHTML   = '';

    const monthNames = ['ŸäŸÜÿßŸäÿ±','ŸÅÿ®ÿ±ÿßŸäÿ±','ŸÖÿßÿ±ÿ≥','ÿ£ÿ®ÿ±ŸäŸÑ','ŸÖÿßŸäŸà','ŸäŸàŸÜŸäŸà',
                        'ŸäŸàŸÑŸäŸà','ÿ£ÿ∫ÿ≥ÿ∑ÿ≥','ÿ≥ÿ®ÿ™ŸÖÿ®ÿ±','ÿ£ŸÉÿ™Ÿàÿ®ÿ±','ŸÜŸàŸÅŸÖÿ®ÿ±','ÿØŸäÿ≥ŸÖÿ®ÿ±'];
    const dayNames   = ['ÿ£ÿ≠ÿØ','ÿ•ÿ´ŸÜŸäŸÜ','ÿ´ŸÑÿßÿ´ÿßÿ°','ÿ£ÿ±ÿ®ÿπÿßÿ°','ÿÆŸÖŸäÿ≥','ÿ¨ŸÖÿπÿ©','ÿ≥ÿ®ÿ™'];

    monthLabel.innerText = monthNames[currentCalendarDate.getMonth()] + ' ' + currentCalendarDate.getFullYear();

    dayNames.forEach(d => {
        const el = document.createElement('div');
        el.className = 'calendar-day-name';
        el.innerText = d;
        grid.appendChild(el);
    });

    const year      = currentCalendarDate.getFullYear();
    const month     = currentCalendarDate.getMonth();
    const firstDay  = new Date(year, month, 1).getDay();
    const daysCount = new Date(year, month + 1, 0).getDate();
    const today     = new Date();

    // ÿ¨ŸÖÿπ ÿ£ŸäÿßŸÖ ÿßŸÑÿØÿ±ÿßÿ≥ÿ©
    const studyDaysMap = {};
    sessions.forEach(s => {
        const key = toDateKey(new Date(s.date));
        studyDaysMap[key] = (studyDaysMap[key] || 0) + 1;
    });
    const studyDaysSet = new Set(Object.keys(studyDaysMap));

    // ŸÅÿ±ÿßÿ∫ÿßÿ™ ŸÇÿ®ŸÑ ÿßŸÑŸäŸàŸÖ ÿßŸÑÿ£ŸàŸÑ
    for (let i = 0; i < firstDay; i++) {
        grid.appendChild(document.createElement('div'));
    }

    for (let day = 1; day <= daysCount; day++) {
        const cell    = document.createElement('div');
        cell.className = 'calendar-day';
        cell.innerText = day;

        const dateKey = toDateKey(new Date(year, month, day));

        if (isSameDay(new Date(year, month, day), today)) {
            cell.classList.add('today');
        }

        const count = studyDaysMap[dateKey] || 0;
        if (count > 0) {
            cell.classList.add('has-study');
            if (count >= 3) cell.classList.add('many');
        }

        // ‚úÖ FIX 4: ŸÉŸÑ ŸäŸàŸÖ ŸÖŸàÿ¨ŸàÿØ ŸÅŸä studyDaysSet ŸäŸèÿπÿØŸë ÿ∂ŸÖŸÜ ÿßŸÑŸÄ streak
        if (studyDaysSet.has(dateKey)) {
            cell.classList.add('streak-day');
        }

        grid.appendChild(cell);
    }
}

function changeMonth(dir) {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + dir);
    renderCalendar();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ÿßŸÑŸÖŸàÿßÿØ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSubjects() {
    const container = document.getElementById('subjectTagsContainer');
    const noMsg     = document.getElementById('noSubjectsMsg');
    const statsContainer = document.getElementById('subjectStatsContainer');
    if (container) container.innerHTML = '';
    if (statsContainer) statsContainer.innerHTML = '';

    if (subjects.length === 0) {
        if (noMsg) noMsg.style.display = 'block';
    } else {
        if (noMsg) noMsg.style.display = 'none';
        subjects.forEach((sub, index) => {
            // ÿ¥ÿßÿ±ÿ© ÿßŸÑŸÖÿßÿØÿ© ŸÖÿπ ÿ≤ÿ± ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÑŸàŸÜ Ÿàÿ≠ÿ∞ŸÅ
            const tag = document.createElement('div');
            tag.className = 'subject-tag';
            tag.style.backgroundColor = sub.color;
            tag.style.position = 'relative';
            tag.innerHTML =
                '<span style="font-weight:700;">' + sub.name + '</span>' +
                '<label title="ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÑŸàŸÜ" style="cursor:pointer;margin-right:4px;display:inline-flex;align-items:center;">' +
                    '<i class="fas fa-palette" style="font-size:0.75rem;opacity:0.8;"></i>' +
                    '<input type="color" value="' + sub.color + '" style="position:absolute;width:0;height:0;opacity:0;" onchange="changeSubjectColor(' + index + ', this.value)">' +
                '</label>' +
                '<span class="remove-sub" onclick="removeSubject(' + index + ')" title="ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿßÿØÿ©"><i class="fas fa-times"></i></span>';
            container.appendChild(tag);
        });

        // ÿ®ÿ∑ÿßŸÇÿßÿ™ ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ŸÑŸÉŸÑ ŸÖÿßÿØÿ©
        if (statsContainer) {
            // ÿßÿ≠ÿ≥ÿ® ÿßŸÑÿØŸÇÿßÿ¶ŸÇ ŸÑŸÉŸÑ ŸÖÿßÿØÿ©
            const subMins = {};
            const subTasks = {};
            subjects.forEach(s => { subMins[s.name] = 0; subTasks[s.name] = 0; });
            sessions.forEach(s => { if (subMins.hasOwnProperty(s.subject)) subMins[s.subject] += s.duration; });
            tasks.forEach(t => { if (t.subject && subTasks.hasOwnProperty(t.subject)) subTasks[t.subject]++; });

            subjects.forEach(sub => {
                const mins  = subMins[sub.name] || 0;
                const hrs   = (mins / 60).toFixed(1);
                const tCount = subTasks[sub.name] || 0;
                const card  = document.createElement('div');
                card.className = 'card';
                card.style.cssText = 'border-right: 4px solid ' + sub.color + '; margin-bottom: 12px;';
                card.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                        <div style="display:flex;align-items:center;gap:10px;">
                            <div style="width:14px;height:14px;border-radius:50%;background:${sub.color};box-shadow:0 0 8px ${sub.color}88;flex-shrink:0;"></div>
                            <span style="font-weight:800;font-size:1rem;">${sub.name}</span>
                        </div>
                        <div style="display:flex;gap:6px;">
                            <label title="ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÑŸàŸÜ" style="cursor:pointer;">
                                <span style="padding:5px 10px;border-radius:8px;background:var(--primary-soft);font-size:0.75rem;color:var(--primary);display:inline-flex;align-items:center;gap:4px;">
                                    <i class="fas fa-palette"></i>
                                    <input type="color" value="${sub.color}" style="position:absolute;width:0;height:0;opacity:0;">
                                </span>
                            </label>
                            <button onclick="removeSubject(${subjects.indexOf(sub)})" style="padding:5px 10px;border:none;border-radius:8px;background:#fee2e2;color:#dc2626;cursor:pointer;font-size:0.75rem;font-family:'Tajawal',sans-serif;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                        <div style="background:var(--primary-soft);border-radius:10px;padding:10px;text-align:center;">
                            <div style="font-size:1.3rem;font-weight:800;color:var(--primary);">${hrs}</div>
                            <div style="font-size:0.68rem;color:var(--text-light);">ÿ≥ÿßÿπÿ© ÿØÿ±ÿßÿ≥ÿ©</div>
                        </div>
                        <div style="background:var(--primary-soft);border-radius:10px;padding:10px;text-align:center;">
                            <div style="font-size:1.3rem;font-weight:800;color:var(--primary);">${tCount}</div>
                            <div style="font-size:0.68rem;color:var(--text-light);">ŸÖŸáŸÖÿ© ŸÖÿ±ÿ™ÿ®ÿ∑ÿ©</div>
                        </div>
                    </div>`;
                // Fix index reference
                card.querySelectorAll('input[type="color"]').forEach(inp => {
                    inp.addEventListener('change', function() { changeSubjectColor(subjects.indexOf(sub), this.value); });
                });
                statsContainer.appendChild(card);
            });
        }
    }
    updateSubjectSelects();
}

function addSubjectFromPanel() {
    const nameInput  = document.getElementById('newSubjectNamePanel');
    const colorInput = document.getElementById('newSubjectColorPanel');
    if (!nameInput) return;
    const name = nameInput.value.trim();

    if (!name) { showNotification('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿßÿØÿ©', 'error'); return; }
    if (subjects.some(s => s.name === name)) { showNotification('Ÿáÿ∞Ÿá ÿßŸÑŸÖÿßÿØÿ© ŸÖŸàÿ¨ŸàÿØÿ© ŸÖÿ≥ÿ®ŸÇÿßŸã', 'warning'); return; }

    subjects.push({ name, color: colorInput.value });
    localStorage.setItem('medorus_subjects', JSON.stringify(subjects));
    nameInput.value = '';
    renderSubjectsPanel();
    updateSubjectSelects();
    showNotification('ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿßÿØÿ©: ' + name, 'success');
}

function renderSubjectsPanel() {
    const container = document.getElementById('subjectTagsContainerPanel');
    const noMsg     = document.getElementById('noSubjectsMsgPanel');
    if (!container) return;
    container.innerHTML = '';

    if (subjects.length === 0) {
        if (noMsg) noMsg.style.display = 'block';
    } else {
        if (noMsg) noMsg.style.display = 'none';
        subjects.forEach((sub, index) => {
            const tag = document.createElement('div');
            tag.className = 'subject-tag';
            tag.style.backgroundColor = sub.color;
            tag.style.position = 'relative';
            tag.innerHTML =
                '<span style="font-weight:700;">' + sub.name + '</span>' +
                '<span class="remove-sub" onclick="removeSubject(' + index + ')" title="ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿßÿØÿ©"><i class="fas fa-times"></i></span>';
            container.appendChild(tag);
        });
    }
}

function addSubject() {
    const nameInput  = document.getElementById('newSubjectName');
    const colorInput = document.getElementById('newSubjectColor');
    const name       = nameInput.value.trim();

    if (!name) { showNotification('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿßÿØÿ©', 'error'); return; }
    if (subjects.some(s => s.name === name)) { showNotification('Ÿáÿ∞Ÿá ÿßŸÑŸÖÿßÿØÿ© ŸÖŸàÿ¨ŸàÿØÿ© ŸÖÿ≥ÿ®ŸÇÿßŸã', 'warning'); return; }

    subjects.push({ name, color: colorInput.value });
    localStorage.setItem('medorus_subjects', JSON.stringify(subjects));
    nameInput.value = '';
    renderSubjects();
    renderSubjectsPanel();
    showNotification('ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿßÿØÿ©: ' + name, 'success');
}

function removeSubject(index) {
    const name = subjects[index].name;
    if (!confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ ŸÖÿßÿØÿ© "' + name + '"ÿü')) return;
    subjects.splice(index, 1);
    localStorage.setItem('medorus_subjects', JSON.stringify(subjects));
    renderSubjects();
    renderSubjectsPanel();
    updateSubjectSelects();
    showNotification('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿßÿØÿ©', 'info');
}

function changeSubjectColor(index, newColor) {
    if (index < 0 || index >= subjects.length) return;
    subjects[index].color = newColor;
    localStorage.setItem('medorus_subjects', JSON.stringify(subjects));
    renderSubjects();
    updateSubjectSelects();
    showNotification('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ŸÑŸàŸÜ ÿßŸÑŸÖÿßÿØÿ© ‚úÖ', 'success');
}

function updateSubjectSelects() {
    const ids = ['taskSubjectSelect', 'timerSubjectSelect', 'reviewSubjectSelect', 'examSubjectSelect'];
    const placeholders = {
        timerSubjectSelect:  'ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿßÿØÿ© (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)...',
        taskSubjectSelect:   'ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿßÿØÿ© (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)...',
        reviewSubjectSelect: 'ÿßŸÑŸÖÿßÿØÿ©...',
        examSubjectSelect:   'ÿ±ÿ®ÿ∑ ÿ®ŸÖÿßÿØÿ© (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)...',
    };
    ids.forEach(id => {
        const select = document.getElementById(id);
        if (!select) return;
        select.innerHTML = '<option value="">' + (placeholders[id] || '') + '</option>';
        subjects.forEach(sub => {
            const opt = document.createElement('option');
            opt.value = sub.name; opt.text = sub.name;
            select.appendChild(opt);
        });
    });
    updateTimerSubjectBadge();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ÿßŸÑŸÖŸáÿßŸÖ ‚Äî FIX 9: ÿ™ÿ≠ÿØŸäÿ´ ŸÅÿ±ÿØŸä ÿπŸÜÿØ toggle
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderTasks() {
    const container = document.getElementById('taskListContainer');
    container.innerHTML = '';
    updateXpCapNote();

    if (tasks.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-clipboard-list"></i><p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸáÿßŸÖ ÿ®ÿπÿØ</p></div>';
        return;
    }

    tasks.forEach((task, index) => {
        const div = document.createElement('div');
        div.className = 'todo-item ' + (task.completed ? 'completed' : '');
        div.setAttribute('draggable', 'true');
        div.dataset.index = index;

        let subjectColor = 'var(--primary-mid)';
        subjects.forEach(sub => { if (sub.name === task.subject) subjectColor = sub.color; });

        const subjectBadge = task.subject
            ? '<span class="task-subject" style="background:' + subjectColor + '">' + task.subject + '</span>'
            : '';

        div.innerHTML =
            '<span class="drag-handle"><i class="fas fa-grip-vertical"></i></span>' +
            '<div class="task-info" onclick="toggleTask(' + index + ', this)">' +
                subjectBadge +
                '<span class="task-text">' + task.text + '</span>' +
                (task.createdAt ? '<div style="font-size:0.7rem;color:var(--text-light);margin-top:3px;">' + task.createdAt + '</div>' : '') +
            '</div>' +
            '<button class="btn-icon" onclick="deleteTask(' + index + ')" style="color:#dc2626;flex-shrink:0;"><i class="fas fa-trash"></i></button>';

        // Drag & Drop
        div.addEventListener('dragstart', e => {
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', index);
            setTimeout(() => div.classList.add('dragging'), 0);
        });
        div.addEventListener('dragend', () => {
            div.classList.remove('dragging');
            container.querySelectorAll('.todo-item').forEach(el => el.classList.remove('drag-over'));
        });
        div.addEventListener('dragover', e => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            container.querySelectorAll('.todo-item').forEach(el => el.classList.remove('drag-over'));
            div.classList.add('drag-over');
        });
        div.addEventListener('dragleave', () => div.classList.remove('drag-over'));
        div.addEventListener('drop', e => {
            e.preventDefault();
            div.classList.remove('drag-over');
            const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
            const toIndex   = parseInt(div.dataset.index);
            if (fromIndex === toIndex) return;
            const moved = tasks.splice(fromIndex, 1)[0];
            tasks.splice(toIndex, 0, moved);
            localStorage.setItem('medorus_tasks', JSON.stringify(tasks));
            renderTasks();
        });

        container.appendChild(div);
    });
}

function addTask() {
    const text    = document.getElementById('taskInput')?.value.trim();
    const subject = document.getElementById('taskSubjectSelect')?.value || '';
    if (!text) { showNotification('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ŸÜÿµ ÿßŸÑŸÖŸáŸÖÿ©', 'error'); return; }

    tasks.unshift({ text, subject, completed: false, createdAt: new Date().toLocaleDateString('ar-DZ') });
    document.getElementById('taskInput').value = '';
    localStorage.setItem('medorus_tasks', JSON.stringify(tasks));
    renderTasks();

    // ‚úÖ FIX 11: ÿ≠ÿØ ŸäŸàŸÖŸä ŸÑŸÑŸÄ XP ŸÖŸÜ ÿßŸÑŸÖŸáÿßŸÖ
    const todayXP = getTodayTaskXP();
    if (todayXP < DAILY_TASK_XP_LIMIT) {
        addXP(10);
        addTodayTaskXP(10);
        showNotification('ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸáŸÖÿ© +10 ŸÜŸÇÿßÿ∑ ‚úÖ', 'success');
    } else {
        showNotification('ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸáŸÖÿ© ‚úÖ (ŸàÿµŸÑÿ™ ŸÑŸÑÿ≠ÿØ ÿßŸÑŸäŸàŸÖŸä ŸÑŸÑŸÜŸÇÿßÿ∑)', 'info');
    }

    updateTaskStats();
}

// ‚úÖ FIX 9: ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπŸÜÿµÿ± ÿßŸÑŸÅÿ±ÿØŸä ÿ®ÿØŸÑÿßŸã ŸÖŸÜ ÿ•ÿπÿßÿØÿ© ÿ±ÿ≥ŸÖ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ŸÉÿßŸÖŸÑÿ©
// ‚úÖ FIX XP: ÿÆÿµŸÖ ŸÜŸÇÿßÿ∑ ÿπŸÜÿØ ÿ•ŸÑÿ∫ÿßÿ° ÿ•ŸÉŸÖÿßŸÑ ÿßŸÑŸÖŸáŸÖÿ© ŸÑŸÖŸÜÿπ ÿßŸÑÿ™ŸÑÿßÿπÿ®
function toggleTask(index) {
    const isNowCompleted = !tasks[index].completed;
    tasks[index].completed = isNowCompleted;
    localStorage.setItem('medorus_tasks', JSON.stringify(tasks));

    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπŸÜÿµÿ± ŸÖÿ®ÿßÿ¥ÿ±ÿ©Ÿã
    const item = document.querySelector('.todo-item[data-index="' + index + '"]');
    if (item) {
        item.classList.toggle('completed', isNowCompleted);
    }

    if (isNowCompleted) {
        // ‚úÖ FIX 11: ÿ≠ÿØ ŸäŸàŸÖŸä ŸÑŸÑŸÄ XP ŸÖŸÜ ÿ•ŸÉŸÖÿßŸÑ ÿßŸÑŸÖŸáÿßŸÖ + ÿ™ÿ™ÿ®ÿπ XP ÿßŸÑŸÖŸÉÿ≥Ÿàÿ® ŸÑŸÉŸÑ ŸÖŸáŸÖÿ©
        const todayXP = getTodayTaskXP();
        if (todayXP < DAILY_TASK_XP_LIMIT) {
            addXP(15);
            addTodayTaskXP(15);
            tasks[index].xpEarned = 15; // ‚úÖ ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÄ XP ÿßŸÑŸÖŸÉÿ™ÿ≥ÿ® ŸÖŸÜ Ÿáÿ∞Ÿá ÿßŸÑŸÖŸáŸÖÿ© ÿ™ÿ≠ÿØŸäÿØÿßŸã
            localStorage.setItem('medorus_tasks', JSON.stringify(tasks));
            showNotification('ÿ£ÿ≠ÿ≥ŸÜÿ™! +15 ŸÜŸÇÿ∑ÿ© üéØ', 'success');
        } else {
            tasks[index].xpEarned = 0; // ŸÑŸÖ ÿ™Ÿèÿ∂ŸÅ ŸÜŸÇÿßÿ∑ (ÿ≠ÿØ ŸäŸàŸÖŸä)
            localStorage.setItem('medorus_tasks', JSON.stringify(tasks));
            showNotification('ÿ£ÿ≠ÿ≥ŸÜÿ™! üéØ', 'success');
        }
    } else {
        // ‚úÖ ÿÆÿµŸÖ ŸÅŸÇÿ∑ ŸÖÿß ŸÉŸèÿ≥ÿ® ŸÅÿπŸÑÿßŸã ŸÖŸÜ Ÿáÿ∞Ÿá ÿßŸÑŸÖŸáŸÖÿ© ÿ®ÿßŸÑÿ∞ÿßÿ™ (ÿØŸÇŸäŸÇ ŸàÿπÿßÿØŸÑ)
        const earned = tasks[index].xpEarned || 0;
        if (earned > 0) {
            addXP(-earned);
            addTodayTaskXP(-Math.min(earned, getTodayTaskXP()));
        }
        tasks[index].xpEarned = 0;
        localStorage.setItem('medorus_tasks', JSON.stringify(tasks));
        showNotification('ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ•ŸÜÿ¨ÿßÿ≤', 'info');
    }
    updateXpCapNote();
    refreshKnowledgeTree(); // üå≥ ÿ™ÿ≠ÿØŸäÿ´ ÿ¥ÿ¨ÿ±ÿ© ÿßŸÑŸÖÿπÿ±ŸÅÿ© ÿπŸÜÿØ ÿ•ŸÜÿ¨ÿßÿ≤ ŸÖŸáŸÖÿ©
    if (isNowCompleted) { trackChallengeTaskDone(); nouriOnTaskDone(); } // ‚öîÔ∏èüêá
}

function deleteTask(index) {
    if (!confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑŸÖŸáŸÖÿ©ÿü')) return;
    tasks.splice(index, 1);
    localStorage.setItem('medorus_tasks', JSON.stringify(tasks));
    renderTasks();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderNotes() {
    const container = document.getElementById('notesListContainer');
    container.innerHTML = '';

    if (notes.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-sticky-note"></i><p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ®ÿπÿØ</p></div>';
        return;
    }

    notes.forEach((note, index) => {
        const div = document.createElement('div');
        div.className = 'card';
        div.style.borderRight = '4px solid var(--accent)';
        div.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;">
                <div>
                    <p style="line-height:1.6;">${note.text.replace(/\n/g, '<br>')}</p>
                    <small style="color:var(--text-light);margin-top:6px;display:block;">${note.date}</small>
                </div>
                <button class="btn-icon" onclick="deleteNote(${index})" style="color:#ef4444;flex-shrink:0;">
                    <i class="fas fa-trash"></i>
                </button>
            </div>`;
        container.appendChild(div);
    });

    localStorage.setItem('medorus_notes', JSON.stringify(notes));
}

function sanitizeHTML(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function addNote() {
    const rawText = document.getElementById('noteInput').value.trim();
    if (!rawText) { showNotification('ÿßŸÑÿ±ÿ¨ÿßÿ° ŸÉÿ™ÿßÿ®ÿ© ŸÖŸÑÿßÿ≠ÿ∏ÿ©', 'error'); return; }

    // ‚úÖ ÿ™ÿπŸÇŸäŸÖ ÿßŸÑÿ•ÿØÿÆÿßŸÑ ŸÑŸÖŸÜÿπ ÿ´ÿ∫ÿ±ÿ© XSS
    const text = sanitizeHTML(rawText);
    notes.unshift({ text, date: new Date().toLocaleDateString('ar-DZ') });
    document.getElementById('noteInput').value = '';
    localStorage.removeItem('medorus_draft_note');
    renderNotes();
    showNotification('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ© ‚úÖ', 'success');
}

function deleteNote(index) {
    if (!confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ©ÿü')) return;
    notes.splice(index, 1);
    renderNotes();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ© ÿßŸÑŸÖÿ™ÿ®ÿßÿπÿØÿ©
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addReviewItem() {
    const topic    = document.getElementById('reviewTopicInput').value.trim();
    const subject  = document.getElementById('reviewSubjectSelect').value;
    const interval = parseInt(document.getElementById('reviewIntervalSelect').value);

    if (!topic) { showNotification('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖŸàÿ∂Ÿàÿπ', 'error'); return; }

    const nextDate = new Date();
    nextDate.setDate(nextDate.getDate() + interval);

    reviewItems.push({
        id:       Date.now(),
        topic,
        subject,
        interval,
        nextDate: toDateKey(nextDate),
        addedDate: getTodayKey(),
        done: false
    });

    localStorage.setItem('medorus_reviews', JSON.stringify(reviewItems));
    document.getElementById('reviewTopicInput').value = '';
    renderReviews();
    showNotification('ÿ™ŸÖÿ™ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑŸÖÿ±ÿßÿ¨ÿπÿ© ‚úÖ', 'success');
}

function markReviewDone(id) {
    const item = reviewItems.find(r => r.id === id);
    if (!item) return;

    // ÿ∂ÿπ ŸÖŸàÿπÿØÿßŸã ŸÑŸÑŸÖÿ±ÿßÿ¨ÿπÿ© ÿßŸÑÿ™ÿßŸÑŸäÿ©
    const next = new Date();
    next.setDate(next.getDate() + item.interval);
    item.nextDate = toDateKey(next);
    item.done     = false;

    addXP(5);
    localStorage.setItem('medorus_reviews', JSON.stringify(reviewItems));
    renderReviews();
    showNotification('‚úÖ ŸÖÿ±ÿßÿ¨ÿπÿ© ŸÜÿßÿ¨ÿ≠ÿ©! +5 ŸÜŸÇÿßÿ∑', 'success');
}

function deleteReviewItem(id) {
    reviewItems = reviewItems.filter(r => r.id !== id);
    localStorage.setItem('medorus_reviews', JSON.stringify(reviewItems));
    renderReviews();
}

function renderReviews() {
    const dueEl      = document.getElementById('reviewDueList');
    const upcomingEl = document.getElementById('reviewUpcomingList');
    if (!dueEl || !upcomingEl) return;
    dueEl.innerHTML      = '';
    upcomingEl.innerHTML = '';

    const today = getTodayKey();
    const due   = [];
    const upcoming = [];

    reviewItems.forEach(item => {
        if (item.nextDate <= today) due.push(item);
        else upcoming.push(item);
    });

    if (due.length === 0 && upcoming.length === 0) {
        dueEl.innerHTML = '<div class="empty-state"><i class="fas fa-rotate"></i><p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ±ÿßÿ¨ÿπÿßÿ™ ÿ®ÿπÿØ</p></div>';
        return;
    }

    if (due.length > 0) {
        const header = document.createElement('h3');
        header.style.cssText = 'margin:0 0 10px;font-size:0.95rem;color:var(--danger);display:flex;align-items:center;gap:8px;';
        header.innerHTML = '<i class="fas fa-bell"></i> ŸÖÿ≥ÿ™ÿ≠ŸÇÿ© ÿßŸÑÿ¢ŸÜ (' + due.length + ')';
        dueEl.appendChild(header);

        due.forEach(item => {
            const isOverdue = item.nextDate < today;
            const div = document.createElement('div');
            div.className = 'review-item ' + (isOverdue ? 'due-today' : '');
            const color = subjects.find(s => s.name === item.subject)?.color || 'var(--primary-mid)';

            div.innerHTML = `
                <div style="flex:1;">
                    <div style="font-weight:700;">${item.topic}</div>
                    ${item.subject ? '<span style="font-size:0.75rem;padding:2px 8px;border-radius:50px;background:' + color + ';color:white;">' + item.subject + '</span>' : ''}
                    <div style="font-size:0.75rem;color:var(--text-light);margin-top:3px;">ŸÉŸÑ ${item.interval} ÿ£ŸäÿßŸÖ</div>
                </div>
                <div class="review-actions">
                    <span class="review-badge ${isOverdue ? 'overdue' : 'today'}">${isOverdue ? 'ŸÖÿ™ÿ£ÿÆÿ±ÿ©' : 'ÿßŸÑŸäŸàŸÖ'}</span>
                    <button class="review-btn" onclick="markReviewDone(${item.id})"
                        style="background:var(--success);color:white;">‚úì ÿ™ŸÖÿ™</button>
                    <button class="review-btn" onclick="deleteReviewItem(${item.id})"
                        style="background:#fee2e2;color:#dc2626;">‚úï</button>
                </div>`;
            dueEl.appendChild(div);
        });
    }

    if (upcoming.length > 0) {
        const header = document.createElement('h3');
        header.style.cssText = 'margin:16px 0 10px;font-size:0.95rem;color:var(--primary);display:flex;align-items:center;gap:8px;';
        header.innerHTML = '<i class="fas fa-clock"></i> ŸÖÿ±ÿßÿ¨ÿπÿßÿ™ ŸÇÿßÿØŸÖÿ© (' + upcoming.length + ')';
        upcomingEl.appendChild(header);

        upcoming.sort((a, b) => a.nextDate.localeCompare(b.nextDate)).forEach(item => {
            const daysLeft = Math.ceil((new Date(item.nextDate) - new Date()) / 86400000);
            const div      = document.createElement('div');
            div.className  = 'review-item';
            const color    = subjects.find(s => s.name === item.subject)?.color || 'var(--primary-mid)';

            div.innerHTML = `
                <div style="flex:1;">
                    <div style="font-weight:700;">${item.topic}</div>
                    ${item.subject ? '<span style="font-size:0.75rem;padding:2px 8px;border-radius:50px;background:' + color + ';color:white;">' + item.subject + '</span>' : ''}
                </div>
                <div class="review-actions">
                    <span class="review-badge upcoming">ÿ®ÿπÿØ ${daysLeft} ŸäŸàŸÖ</span>
                    <button class="review-btn" onclick="deleteReviewItem(${item.id})"
                        style="background:#fee2e2;color:#dc2626;">‚úï</button>
                </div>`;
            upcomingEl.appendChild(div);
        });
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ÿ≠ÿßÿ≥ÿ®ÿ© ÿßŸÑÿßŸÖÿ™ÿ≠ÿßŸÜÿßÿ™
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addExam() {
    const name    = document.getElementById('examNameInput').value.trim();
    const date    = document.getElementById('examDateInput').value;
    const hours   = parseFloat(document.getElementById('examHoursInput').value);
    const subject = document.getElementById('examSubjectSelect').value;

    if (!name)             { showNotification('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑÿßŸÖÿ™ÿ≠ÿßŸÜ', 'error'); return; }
    if (!date)             { showNotification('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÖÿ™ÿ≠ÿßŸÜ', 'error'); return; }
    if (!hours || hours<1) { showNotification('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿ≥ÿßÿπÿßÿ™ ÿßŸÑÿØÿ±ÿßÿ≥ÿ©', 'error'); return; }

    const examDate = new Date(date);
    if (examDate < new Date()) { showNotification('ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÖÿ™ÿ≠ÿßŸÜ Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ŸÅŸä ÿßŸÑŸÖÿ≥ÿ™ŸÇÿ®ŸÑ', 'warning'); return; }

    examItems.push({ id: Date.now(), name, date, hours, subject, addedDate: getTodayKey() });
    localStorage.setItem('medorus_exams', JSON.stringify(examItems));

    document.getElementById('examNameInput').value  = '';
    document.getElementById('examDateInput').value  = '';
    document.getElementById('examHoursInput').value = '';

    renderExams();
    renderCalendar();
    showNotification('ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿßŸÖÿ™ÿ≠ÿßŸÜ ‚úÖ', 'success');
}

function deleteExam(id) {
    if (!confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿßŸÖÿ™ÿ≠ÿßŸÜÿü')) return;
    examItems = examItems.filter(e => e.id !== id);
    localStorage.setItem('medorus_exams', JSON.stringify(examItems));
    renderExams();
    renderCalendar();
}

function renderExams() {
    const container = document.getElementById('examsList');
    if (!container) return;
    container.innerHTML = '';

    const today = new Date(); today.setHours(0,0,0,0);
    const future = examItems.filter(e => new Date(e.date) >= today);
    future.sort((a,b) => new Date(a.date) - new Date(b.date));

    if (future.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-calendar-check"></i><p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿßŸÖÿ™ÿ≠ÿßŸÜÿßÿ™ ŸÖÿ∂ÿßŸÅÿ©</p></div>';
        return;
    }

    future.forEach(exam => {
        const examDate  = new Date(exam.date); examDate.setHours(0,0,0,0);
        const daysLeft  = Math.ceil((examDate - today) / 86400000);
        const dailyHrs  = daysLeft > 0 ? (exam.hours / daysLeft).toFixed(1) : exam.hours;
        const studied   = sessions.filter(s => s.subject === exam.subject).reduce((sum,s) => sum + s.duration/60, 0);
        const pct       = Math.min((studied / exam.hours) * 100, 100);

        const countClass = daysLeft <= 3 ? '' : daysLeft <= 7 ? 'warn' : 'safe';
        const color = subjects.find(s => s.name === exam.subject)?.color || 'var(--primary-mid)';

        const div = document.createElement('div');
        div.className = 'exam-item';
        div.innerHTML = `
            <div class="exam-header">
                <div>
                    <div class="exam-name">${exam.name}
                        ${exam.subject ? '<span style="font-size:0.75rem;padding:2px 8px;border-radius:50px;background:'+color+';color:white;margin-right:6px;">'+exam.subject+'</span>' : ''}
                    </div>
                    <div class="exam-detail">${exam.date} ¬∑ ${exam.hours} ÿ≥ÿßÿπÿ© ŸÖÿ∑ŸÑŸàÿ®ÿ©</div>
                </div>
                <div style="text-align:center;">
                    <div class="exam-countdown ${countClass}">${daysLeft}</div>
                    <div style="font-size:0.68rem;color:var(--text-light);">ŸäŸàŸÖ ŸÖÿ™ÿ®ŸÇŸä</div>
                </div>
            </div>
            <div class="exam-daily-hours">‚è± ${dailyHrs} ÿ≥ÿßÿπÿ©/ŸäŸàŸÖ</div>
            <div style="margin-top:10px;">
                <div class="goal-label">
                    <span>ÿßŸÑÿ™ŸÇÿØŸÖ: ${studied.toFixed(1)} / ${exam.hours} ÿ≥ÿßÿπÿ©</span>
                    <span>${Math.round(pct)}%</span>
                </div>
                <div class="goal-bar-bg" style="margin-top:5px;">
                    <div class="exam-progress-fill" style="width:${pct}%;background:${color};"></div>
                </div>
            </div>
            <div style="text-align:left;margin-top:10px;">
                <button class="review-btn" onclick="deleteExam(${exam.id})" style="background:#fee2e2;color:#dc2626;">üóë ÿ≠ÿ∞ŸÅ</button>
            </div>`;
        container.appendChild(div);
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ÿßŸÑÿ™Ÿàÿßÿ≤ŸÜ ÿßŸÑÿØÿ±ÿßÿ≥Ÿä
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderBalance() {
    const container = document.getElementById('balanceContent');
    if (!container) return;
    container.innerHTML = '';

    if (!subjects || subjects.length < 2) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-scale-balanced"></i><p>ÿ£ÿ∂ŸÅ ŸÖÿßÿØÿ™ŸäŸÜ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ ŸÑÿ±ÿ§Ÿäÿ© ÿßŸÑÿ™Ÿàÿßÿ≤ŸÜ</p></div>';
        return;
    }

    const subjectMins = {};
    subjects.forEach(s => { subjectMins[s.name] = 0; });
    sessions.forEach(s => {
        if (subjectMins.hasOwnProperty(s.subject)) {
            subjectMins[s.subject] += s.duration;
        }
    });

    const total      = Object.values(subjectMins).reduce((a,b) => a+b, 0);
    const ideal      = 100 / subjects.length;
    const actualPcts = {};
    subjects.forEach(s => { actualPcts[s.name] = total > 0 ? (subjectMins[s.name] / total) * 100 : 0; });

    // ÿ≠ÿ≥ÿßÿ® ÿØÿ±ÿ¨ÿ© ÿßŸÑÿ™Ÿàÿßÿ≤ŸÜ (0-100)
    const deviations = subjects.map(s => Math.abs(actualPcts[s.name] - ideal));
    const avgDev     = deviations.reduce((a,b) => a+b, 0) / deviations.length;
    const score      = Math.max(0, Math.round(100 - avgDev * 2));

    let scoreClass, scoreLabel;
    if      (score >= 80) { scoreClass = 'excellent'; scoreLabel = '‚öñÔ∏è ÿ™Ÿàÿßÿ≤ŸÜ ŸÖŸÖÿ™ÿßÿ≤!'; }
    else if (score >= 60) { scoreClass = 'good';      scoreLabel = 'üìä ÿ™Ÿàÿßÿ≤ŸÜ ÿ¨ŸäÿØ'; }
    else if (score >= 40) { scoreClass = 'fair';      scoreLabel = '‚ö†Ô∏è ÿ™Ÿàÿßÿ≤ŸÜ ŸÖÿ™Ÿàÿ≥ÿ∑'; }
    else                  { scoreClass = 'poor';      scoreLabel = '‚ùó Ÿäÿ≠ÿ™ÿßÿ¨ ÿ™ÿ≠ÿ≥ŸäŸÜÿßŸã'; }

    container.innerHTML = `
        <div class="balance-score-card ${scoreClass}">
            <div class="balance-score-num">${score}</div>
            <div class="balance-score-label">${scoreLabel}</div>
        </div>`;

    // ÿ¥ÿ±Ÿäÿ∑ ŸÑŸÉŸÑ ŸÖÿßÿØÿ©
    subjects.forEach(s => {
        const pct  = Math.round(actualPcts[s.name]);
        const diff = pct - Math.round(ideal);
        let alertClass, alertMsg;

        if      (Math.abs(diff) <= 5)  { alertClass = 'perfect'; alertMsg = '‚úÖ ŸÖÿ™Ÿàÿßÿ≤ŸÜ'; }
        else if (diff > 5)             { alertClass = 'over';    alertMsg = '‚ñ≤ ŸÖŸÅÿ±ÿ∑ +' + diff + '%'; }
        else                           { alertClass = 'under';   alertMsg = '‚ñº ŸÜÿßŸÇÿµ ' + diff + '%'; }

        container.innerHTML += `
            <div class="balance-subject-row">
                <span class="balance-subject-name">${s.name}</span>
                <div class="balance-subject-bar-bg">
                    <div class="balance-subject-bar-fill" style="width:${pct}%;background:${s.color};"></div>
                </div>
                <span class="balance-subject-pct">${pct}%</span>
            </div>
            <div class="balance-alert ${alertClass}" style="margin-bottom:12px;">
                <span>${alertMsg}</span>
                <span style="margin-right:auto;font-size:0.75rem;">${subjectMins[s.name]} ÿØŸÇŸäŸÇÿ©</span>
            </div>`;
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ÿ™ÿµÿØŸäÿ± / ÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ / ÿ≠ÿ∞ŸÅ ‚Äî FIX 16 ŸÖÿµÿ≠ŸéŸëÿ≠
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportData() {
    try {
    const data = {
        version: '8.0', xp: xp || 0, subjects: subjects || [], tasks: tasks || [],
        notes: notes || [], sessions: sessions || [], stats: stats || {},
        streak: streak || 0, lastStudyDate: lastStudyDate || '',
        dailyGoal: dailyGoal || 0, reviewItems: reviewItems || [], examItems: examItems || [],
        theme: localStorage.getItem('medorus_theme') || 'light',
        exportedAt: new Date().toISOString()
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href     = url;
    a.download = 'nourium-backup-' + toDateKey(new Date()) + '.json';
    a.click();
    URL.revokeObjectURL(url);
    showNotification('ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ‚úÖ', 'success');
    } catch(error) {
        showNotification('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™', 'error');
        console.error('Export error:', error);
    }
}

// ‚úÖ FIX 16: ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿµÿßÿ±ŸÖ ŸÖŸÜ ÿµÿ≠ÿ© ŸÖŸÑŸÅ ÿßŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ
function isValidBackup(data) {
    return data !== null &&
           typeof data === 'object' &&
           Array.isArray(data.sessions) &&
           Array.isArray(data.subjects) &&
           typeof data.xp === 'number' &&
           typeof data.version === 'string'; // ‚úÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ•ÿµÿØÿßÿ±
}

function importData() {
    const input    = document.createElement('input');
    input.type     = 'file';
    input.accept   = '.json';
    input.onchange = function(e) {
        const file   = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(ev) {
            try {
                const data = JSON.parse(ev.target.result);

                // ‚úÖ ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿµÿßÿ±ŸÖ ŸÖŸÜ ÿßŸÑÿ®ŸÜŸäÿ©
                if (!isValidBackup(data)) {
                    showNotification('ÿßŸÑŸÖŸÑŸÅ ŸÑÿß Ÿäÿ®ÿØŸà ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÖŸÜ Nourium', 'error');
                    return;
                }

                const defaults = {
                    medorus_xp:              data.xp ?? 0,
                    medorus_subjects:        JSON.stringify(data.subjects    || []),
                    medorus_tasks:           JSON.stringify(data.tasks       || []),
                    medorus_notes:           JSON.stringify(data.notes       || []),
                    medorus_sessions:        JSON.stringify(data.sessions    || []),
                    medorus_streak:          data.streak ?? 0,
                    medorus_last_study_date: data.lastStudyDate || '',
                    medorus_daily_goal:      data.dailyGoal ?? 0,
                    medorus_reviews:         JSON.stringify(data.reviewItems || []),
                    medorus_exams:           JSON.stringify(data.examItems   || []),
                    medorus_stats:           JSON.stringify(data.stats || {
                        sessions: { daily:0, weekly:0, monthly:0 },
                        tasks:    { daily:0, weekly:0, monthly:0 },
                        minutes:  { daily:0, weekly:0, monthly:0 },
                        lastUpdate: new Date().toISOString()
                    }),
                };
                if (data.theme) defaults['medorus_theme'] = data.theme;

                Object.entries(defaults).forEach(([k, v]) => localStorage.setItem(k, String(v)));

                showNotification('ÿ™ŸÖ ÿßŸÑÿßÿ≥ÿ™Ÿäÿ±ÿßÿØ ‚úÖ ‚Äî ÿ¨ÿßÿ±Ÿä ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...', 'success');
                setTimeout(() => location.reload(), 1000);

            } catch(err) {
                showNotification('ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ ‚Äî ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿµÿ≠ÿ™Ÿá', 'error');
            }
        };
        reader.readAsText(file);
    };
    input.click();
}

function clearAllData() {
    if (!confirm('‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ± ŸÜŸáÿßÿ¶Ÿä: ÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ ŸÉŸÑ ÿ®ŸäÿßŸÜÿßÿ™ Nourium ÿ®ÿ¥ŸÉŸÑ ÿØÿßÿ¶ŸÖ!\n\nŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØÿü')) return;
    if (!confirm('ÿ™ÿ£ŸÉŸäÿØ ÿ£ÿÆŸäÿ±: ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ 100%ÿü ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜ Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°.')) return;

    // ‚úÖ ÿ≠ÿ∞ŸÅ ŸÖŸÅÿßÿ™Ÿäÿ≠ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ŸÅŸÇÿ∑ ÿ®ÿØŸÑÿßŸã ŸÖŸÜ localStorage.clear() ÿßŸÑÿÆÿ∑Ÿäÿ±
    const appKeys = [
        'medorus_xp', 'medorus_subjects', 'medorus_tasks', 'medorus_notes',
        'medorus_sessions', 'medorus_streak', 'medorus_last_study_date',
        'medorus_daily_goal', 'medorus_reviews', 'medorus_exams', 'medorus_stats',
        'medorus_theme', 'nourium_mood_logs', 'nourium_challenges',
        'nourium_tree_flowers', 'nourium_spirit_track', 'nourium_thikr_v3',
        'medorus_draft_note', 'nourium_yaseen_shown'
    ];
    // ÿ≠ÿ∞ŸÅ ŸÖŸÅÿßÿ™Ÿäÿ≠ task_xp_ ÿßŸÑŸÇÿØŸäŸÖÿ© ÿ£Ÿäÿ∂ÿßŸã
    Object.keys(localStorage).filter(k => k.startsWith('task_xp_')).forEach(k => localStorage.removeItem(k));
    appKeys.forEach(key => localStorage.removeItem(key));

    xp = 0; subjects = []; tasks = []; notes = []; sessions = [];
    streak = 0; lastStudyDate = null; dailyGoal = 0;
    reviewItems = []; examItems = [];
    stats = {
        sessions: { daily:0, weekly:0, monthly:0 },
        tasks:    { daily:0, weekly:0, monthly:0 },
        minutes:  { daily:0, weekly:0, monthly:0 },
        lastUpdate: new Date().toISOString()
    };
    timeLeft = 25 * 60; currentDuration = 25; timerMode = 'focus';
    sessionCompleted = false;

    updateLevelUI(); updateStatsUI(); updateStreak(false);
    renderSubjects(); updateSubjectSelects();
    renderTasks(); renderNotes(); renderReviews(); renderExams();
    updateTimerDisplay(); renderCalendar(); updateGoalProgress();
    updateLuxPanel(); checkStorageUsage();

    showNotification('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™', 'info');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ÿßŸÑÿØŸÑŸäŸÑ ÿßŸÑÿ±Ÿàÿ≠Ÿä ŸÑÿ∑ÿßŸÑÿ® ÿßŸÑÿ∑ÿ®
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function initSpiritualGuide() {
    // ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ™ÿ∞ŸÉŸäÿ± ÿßŸÑŸäŸàŸÖ
    if (yaseenReminderOn) {
        const lastShown = localStorage.getItem('nourium_yaseen_shown');
        const today     = new Date().toDateString();
        if (lastShown !== today) {
            const card = document.getElementById('yaseenCard');
            if (card) card.style.display = 'block';
        }
    }
    renderSpiritContent('before');
}

function dismissYaseenReminder() {
    localStorage.setItem('nourium_yaseen_shown', new Date().toDateString());
    const card = document.getElementById('yaseenCard');
    if (card) { card.style.animation = 'none'; card.style.opacity = '0'; card.style.transform = 'translateY(-10px)'; card.style.transition = '0.3s'; setTimeout(() => card.style.display = 'none', 300); }
}

function switchSpiritTab(tab, el) {
    spiritCurrentTab = tab;
    document.querySelectorAll('.spirit-nav-btn').forEach(t => t.classList.remove('active'));
    if (el) el.classList.add('active');
    if (tab === 'favs') renderFavoriteDuas();
    else renderSpiritContent(tab);
}

function renderSpiritContent(tab) {
    const container = document.getElementById('spiritContent');
    if (!container) return;
    const data = DUAS_DATA[tab];
    if (!data) return;
    container.innerHTML = '';

    // ÿ±ÿ£ÿ≥ ÿßŸÑŸÇÿ≥ŸÖ ‚Äî ŸÖÿ®ÿ≥Ÿëÿ∑
    const header = document.createElement('div');
    header.className = 'spirit-section-header';
    header.innerHTML = `
        <div class="spirit-section-icon">${data.icon}</div>
        <div>
            <div class="spirit-section-title">${data.title}</div>
            <div class="spirit-section-sub">${data.subtitle}</div>
        </div>`;
    container.appendChild(header);

    // ÿ®ÿ∑ÿßŸÇÿßÿ™ ÿßŸÑÿ£ÿØÿπŸäÿ©
    data.duas.forEach(dua => {
        container.appendChild(buildDuaCard(dua, data.color));
    });
}

function renderFavoriteDuas() {
    const container = document.getElementById('spiritContent');
    if (!container) return;
    container.innerHTML = '';

    if (favoriteDuas.length === 0) {
        container.innerHTML = '<div class="empty-state"><i class="fas fa-star"></i><p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ÿØÿπŸäÿ© ŸÖŸÅÿ∂ŸÑÿ© ÿ®ÿπÿØ</p><p style="font-size:0.78rem;margin-top:6px;">ÿßÿ∂ÿ∫ÿ∑ ‚≠ê ÿπŸÑŸâ ÿ£Ÿä ÿØÿπÿßÿ° ŸÑÿ≠ŸÅÿ∏Ÿá ŸáŸÜÿß</p></div>';
        return;
    }

    const header = document.createElement('div');
    header.className = 'spirit-section-header';
    header.innerHTML = '<div class="spirit-section-icon">‚≠ê</div><div><div class="spirit-section-title">ÿ£ÿØÿπŸäÿ™Ÿä ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©</div><div class="spirit-section-sub">' + favoriteDuas.length + ' ÿØÿπÿßÿ° ŸÖÿ≠ŸÅŸàÿ∏</div></div>';
    container.appendChild(header);

    // ÿßÿ¨ŸÖÿπ ŸÉŸÑ ÿßŸÑÿ£ÿØÿπŸäÿ© ŸÖŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ
    const allDuas = {};
    Object.values(DUAS_DATA).forEach(cat => cat.duas.forEach(d => { allDuas[d.id] = { ...d, color: cat.color }; }));

    favoriteDuas.forEach(id => {
        if (allDuas[id]) container.appendChild(buildDuaCard(allDuas[id], allDuas[id].color));
    });
}

function buildDuaCard(dua, accentColor) {
    const isFav = favoriteDuas.includes(dua.id);
    const card  = document.createElement('div');
    card.className = 'dua-card';
    card.id = 'duacard-' + dua.id;
    card.innerHTML = `
        <div class="dua-header" onclick="toggleDuaText('${dua.id}')" style="cursor:pointer;">
            <div class="dua-icon">ü§≤</div>
            <div style="flex:1;">
                <div class="dua-reveal-hint" id="duahint-${dua.id}" style="font-size:0.82rem;color:var(--text-muted);font-style:italic;">ÿßÿ∂ÿ∫ÿ∑ ŸÑÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿØÿπÿßÿ°...</div>
                <div class="dua-text" id="duatext-${dua.id}" style="display:none;">${dua.text}</div>
            </div>
        </div>
        <div class="dua-actions" id="duaactions-${dua.id}" style="display:none;">
            <button class="dua-action-btn ${isFav ? 'fav-active' : ''}" onclick="toggleDuaFav('${dua.id}', this)">
                <i class="fas fa-star"></i> ${isFav ? 'ŸÖÿ≠ŸÅŸàÿ∏' : 'ÿßÿ≠ŸÅÿ∏'}
            </button>
            <button class="dua-action-btn" onclick="copyDua('${dua.id}')">
                <i class="fas fa-copy"></i> ŸÜÿ≥ÿÆ
            </button>
        </div>`;
    return card;
}

function toggleDuaText(id) {
    const hint    = document.getElementById('duahint-' + id);
    const text    = document.getElementById('duatext-' + id);
    const actions = document.getElementById('duaactions-' + id);
    if (!text) return;
    const isVisible = text.style.display !== 'none';
    text.style.display    = isVisible ? 'none' : 'block';
    actions.style.display = isVisible ? 'none' : 'flex';
    hint.style.display    = isVisible ? 'block' : 'none';
}

function toggleDuaFav(id, btn) {
    const idx = favoriteDuas.indexOf(id);
    if (idx === -1) {
        favoriteDuas.push(id);
        btn.classList.add('fav-active');
        btn.innerHTML = '<i class="fas fa-star"></i> ŸÖÿ≠ŸÅŸàÿ∏';
        showNotification('‚≠ê ÿ™ŸÖÿ™ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑŸÖŸÅÿ∂ŸÑÿ©', 'success');
    } else {
        favoriteDuas.splice(idx, 1);
        btn.classList.remove('fav-active');
        btn.innerHTML = '<i class="fas fa-star"></i> ÿßÿ≠ŸÅÿ∏';
        showNotification('ÿ™ŸÖÿ™ ÿßŸÑÿ•ÿ≤ÿßŸÑÿ© ŸÖŸÜ ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©', 'info');
        if (spiritCurrentTab === 'favs') renderFavoriteDuas();
    }
    localStorage.setItem('nourium_fav_duas', JSON.stringify(favoriteDuas));
}

function getDuaTextById(id) {
    for (const cat of Object.values(DUAS_DATA)) {
        const found = cat.duas.find(d => d.id === id);
        if (found) return found.text;
    }
    return '';
}

function copyDua(id) {
    const text = getDuaTextById(id);
    if (!text) return;
    safeCopy(text, '‚úÖ ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿØÿπÿßÿ°');
}

function shareDua(id) {
    const text = getDuaTextById(id);
    if (!text) return;
    const shareText = text + '\n\nüì± ŸÖŸÜ ÿ™ÿ∑ÿ®ŸäŸÇ Nourium ‚Äî ŸÖŸÜÿßÿ±ÿ© ÿ∑ÿßŸÑÿ® ÿßŸÑÿ∑ÿ®';
    if (navigator.share) {
        navigator.share({ text: shareText }).catch(() => safeCopy(shareText, '‚úÖ ŸÜŸèÿ≥ÿÆ ŸÑŸÑŸÖÿ¥ÿßÿ±ŸÉÿ©'));
    } else {
        safeCopy(shareText, '‚úÖ ŸÜŸèÿ≥ÿÆ ŸÑŸÑŸÖÿ¥ÿßÿ±ŸÉÿ©');
    }
}

function showEmergencyDuas() {
    const old = document.getElementById('emergencyOverlay');
    if (old) old.remove();

    const data = DUAS_DATA.emergency;
    const overlay = document.createElement('div');
    overlay.className = 'share-overlay';
    overlay.id = 'emergencyOverlay';
    overlay.onclick = e => { if (e.target === overlay) overlay.remove(); };

    let duasHtml = data.duas.map(d => `
        <div class="dua-card">
            <div class="dua-header">
                <div class="dua-icon">‚ö°</div>
                <div class="dua-text">${d.text}</div>
            </div>
            <div class="dua-actions">
                <button class="dua-action-btn" onclick="copyDua('${d.id}')"><i class="fas fa-copy"></i> ŸÜÿ≥ÿÆ</button>
            </div>
        </div>`).join('');

    overlay.innerHTML = `
        <div class="share-modal" style="max-height:85vh;overflow-y:auto;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                <div>
                    <div style="font-weight:800;font-size:1rem;color:var(--danger);">ÿ£ÿØÿπŸäÿ© ÿπŸÜÿØ ÿßŸÑŸÜÿ≥ŸäÿßŸÜ ‚ö°</div>
                    <div style="font-size:0.78rem;color:var(--text-muted);margin-top:2px;">ÿ™ŸÜŸÅÿ≥ ÿ®ŸáÿØŸàÿ° Ÿàÿ±ÿØÿØ ÿ®ÿÆÿ¥Ÿàÿπ ü§ç</div>
                </div>
                <button onclick="document.getElementById('emergencyOverlay').remove()" style="background:none;border:none;font-size:1.3rem;cursor:pointer;color:var(--text-muted);">&times;</button>
            </div>
            <div style="height:1px;background:var(--border);margin:12px 0;"></div>
            ${duasHtml}
        </div>`;

    document.body.appendChild(overlay);
}

// ÿ±ÿ®ÿ∑ init ÿßŸÑÿØŸÑŸäŸÑ ÿßŸÑÿ±Ÿàÿ≠Ÿä ÿ®ŸÄ switchTab

function toggleYaseenReminder() {
    yaseenReminderOn = !yaseenReminderOn;
    localStorage.setItem('nourium_yaseen_reminder', yaseenReminderOn ? 'on' : 'off');
    const statusEl = document.getElementById('yaseenStatus');
    if (statusEl) statusEl.innerText = yaseenReminderOn ? 'ŸÖŸÅÿπŸëŸÑ' : 'ŸÖÿπÿ∑ŸëŸÑ';
    showNotification(yaseenReminderOn ? 'üîî ÿ™ÿ∞ŸÉŸäÿ± Ÿäÿ≥ ŸÖŸÅÿπŸëŸÑ' : 'üîï ÿ™ÿ∞ŸÉŸäÿ± Ÿäÿ≥ ŸÖÿπÿ∑ŸëŸÑ', 'info');
}

function updateYaseenToggleUI() {
    const statusEl = document.getElementById('yaseenStatus');
    if (statusEl) statusEl.innerText = yaseenReminderOn ? 'ŸÖŸÅÿπŸëŸÑ' : 'ŸÖÿπÿ∑ŸëŸÑ';
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ÿ£ÿØŸàÿßÿ™ ŸÖÿ≥ÿßÿπÿØÿ© ÿ•ÿ∂ÿßŸÅŸäÿ©
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚úÖ ÿØÿßŸÑÿ© ÿ¢ŸÖŸÜÿ© ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿπŸÜÿßÿµÿ± DOM
function safeGetElement(id) {
    const element = document.getElementById(id);
    if (!element) {
        console.warn(`‚ö†Ô∏è ÿßŸÑÿπŸÜÿµÿ± "${id}" ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä DOM`);
    }
    return element;
}

// ‚úÖ debounce ŸÑÿ™ÿ≠ÿ≥ŸäŸÜ ÿ£ÿØÿßÿ° ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ÿßÿ™ ÿßŸÑŸÖÿ™ŸÉÿ±ÿ±ÿ©
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

const debouncedUpdateLuxPanel = debounce(updateLuxPanel, 300);

// ‚úÖ ŸÖÿπÿßŸÑÿ¨ ÿπÿßŸÖ ŸÑŸÑÿ£ÿÆÿ∑ÿßÿ° ÿ∫Ÿäÿ± ÿßŸÑŸÖÿ™ŸàŸÇÿπÿ©
window.addEventListener('error', function(e) {
    console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ:', e.error || e.message);
});

window.addEventListener('unhandledrejection', function(e) {
    console.error('‚ùå Promise ŸÖÿ±ŸÅŸàÿ∂:', e.reason);
});

// ‚úÖ FIX: ÿ™ŸÜÿ∏ŸäŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ§ŸÇÿ™ÿßÿ™ ÿπŸÜÿØ ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑÿµŸÅÿ≠ÿ© ŸÑŸÖŸÜÿπ memory leaks
window.addEventListener('beforeunload', function() {
    if (typeof timerInterval !== 'undefined' && timerInterval)     clearInterval(timerInterval);
    if (typeof verseInterval !== 'undefined' && verseInterval)     clearInterval(verseInterval);
    if (typeof nouriIdleTimer !== 'undefined' && nouriIdleTimer)   clearInterval(nouriIdleTimer);
    if (typeof nouriAutoInterval !== 'undefined' && nouriAutoInterval) clearInterval(nouriAutoInterval);
    if (typeof orbBreathInterval !== 'undefined' && orbBreathInterval) clearTimeout(orbBreathInterval);
});

// ‚úÖ FIX: ÿ™ŸÜÿ∏ŸäŸÅ ŸÖŸÅÿßÿ™Ÿäÿ≠ task_xp_ ÿßŸÑŸÇÿØŸäŸÖÿ© ŸÑŸÖŸÜÿπ ÿ™ÿ±ÿßŸÉŸÖ localStorage
function cleanupOldTaskXP() {
    const today = getTodayKey();
    Object.keys(localStorage)
        .filter(k => k.startsWith('task_xp_'))
        .forEach(key => {
            const date = key.replace('task_xp_', '');
            if (date < today) localStorage.removeItem(key);
        });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  (ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initNotifSystem() {}
function requestNotifPermission() {}
function updateNotifPermissionBanner() {}
function updateNotifStatusBar() {}
function saveNotifSettings() {}
function loadNotifSettingsUI() {}
function scheduleAllNotifs() {}
function sendSmartNotif() {}
function queueSmartBanner() {}
function showNextBanner() {}
function dismissSmartBanner() {}
function sendSessionDoneNotif() {}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ŸÖŸäÿ≤ÿ© ŸÖÿ¥ÿßÿ±ŸÉÿ© ÿßŸÑÿ•ŸÜÿ¨ÿßÿ≤
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getShareData() {
    const level      = getCurrentLevel();
    const totalMins  = sessions.reduce((s, x) => s + x.duration, 0);
    const totalHrs   = (totalMins / 60).toFixed(1);
    const doneTasks  = tasks.filter(t => t.completed).length;

    // ÿßÿÆÿ™ÿ± ÿ•ŸÜÿ¨ÿßÿ≤ÿßŸã ÿ®ÿßÿ±ÿ≤ÿßŸã ŸÑŸÑÿπÿ±ÿ∂
    let achievement = '', achievementLabel = '';
    if (streak >= 30)        { achievement = 'üíé'; achievementLabel = streak + ' ŸäŸàŸÖÿßŸã ŸÖÿ™ÿ™ÿßŸÑŸäÿßŸã!'; }
    else if (streak >= 14)   { achievement = 'üî•'; achievementLabel = streak + ' ŸäŸàŸÖÿßŸã ŸÖÿ™ÿ™ÿßŸÑŸäÿßŸã!'; }
    else if (streak >= 7)    { achievement = '‚ö°'; achievementLabel = streak + ' ÿ£ŸäÿßŸÖ ŸÖÿ™ÿ™ÿßŸÑŸäÿ©!'; }
    else if (xp >= 3000)     { achievement = 'üèÜ'; achievementLabel = 'ŸÖÿ≥ÿ™ŸàŸâ: ' + level.name; }
    else if (totalHrs >= 100){ achievement = 'üíØ'; achievementLabel = totalHrs + ' ÿ≥ÿßÿπÿ© ÿØÿ±ÿßÿ≥ÿ©!'; }
    else if (doneTasks >= 50){ achievement = '‚úÖ'; achievementLabel = doneTasks + ' ŸÖŸáŸÖÿ© ŸÖŸÜÿ¨ÿ≤ÿ©!'; }
    else                     { achievement = level.icon; achievementLabel = 'ŸÖÿ≥ÿ™ŸàŸâ: ' + level.name; }

    return { level, totalHrs, doneTasks, achievement, achievementLabel };
}

function openShareModal() {
    // ÿ•ÿ∫ŸÑÿßŸÇ ÿ£Ÿä modal ŸÖŸÅÿ™Ÿàÿ≠
    const old = document.getElementById('shareOverlay');
    if (old) old.remove();

    const d = getShareData();

    const overlay = document.createElement('div');
    overlay.className = 'share-overlay';
    overlay.id = 'shareOverlay';
    overlay.onclick = function(e) { if (e.target === overlay) closeShareModal(); };

    overlay.innerHTML = `
        <div class="share-modal">
            <h2 style="margin-bottom:16px;font-size:1rem;"><i class="fas fa-share-alt" style="color:var(--primary-mid);"></i> ÿ¥ÿßÿ±ŸÉ ÿ•ŸÜÿ¨ÿßÿ≤ŸÉ</h2>

            <!-- ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿ®ÿ∑ÿßŸÇÿ© -->
            <div class="share-card-preview" id="shareCardPreview">
                <div class="share-logo">‚ú¶ NOURIUM ‚ú¶</div>
                <div class="share-achievement">${d.achievement}</div>
                <div class="share-title">${d.achievementLabel}</div>
                <div class="share-subtitle">${d.level.name}</div>
                <div class="share-stats-row">
                    <div class="share-stat-item">
                        <div class="share-stat-val">${d.totalHrs}</div>
                        <div class="share-stat-lbl">ÿ≥ÿßÿπÿ© ÿØÿ±ÿßÿ≥ÿ©</div>
                    </div>
                    <div class="share-stat-item">
                        <div class="share-stat-val">${xp}</div>
                        <div class="share-stat-lbl">ŸÜŸÇÿ∑ÿ© XP</div>
                    </div>
                    <div class="share-stat-item">
                        <div class="share-stat-val">${streak}</div>
                        <div class="share-stat-lbl">ŸäŸàŸÖ ŸÖÿ™ÿ™ÿßŸÑŸä üî•</div>
                    </div>
                </div>
            </div>

            <!-- ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑŸÖÿ¥ÿßÿ±ŸÉÿ© -->
            <div class="share-btns" style="grid-template-columns:1fr 1fr;">
                <button class="share-btn share-btn-copy" onclick="shareAsText()">
                    <i class="fas fa-copy"></i> ŸÜÿ≥ÿÆ ÿßŸÑŸÜÿµ
                </button>
                <button class="share-btn share-btn-img" onclick="shareAsImage()">
                    <i class="fas fa-image"></i> ÿ≠ŸÅÿ∏ ÿµŸàÿ±ÿ©
                </button>
                <button class="share-btn share-btn-close" onclick="closeShareModal()">
                    <i class="fas fa-times"></i> ÿ•ÿ∫ŸÑÿßŸÇ
                </button>
            </div>
        </div>`;

    document.body.appendChild(overlay);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  Accordion
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleAccordion(id) {
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.toggle('open');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  Panel Tabs
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchPanelTab(tabId, btn) {
    document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.panel-tab-content').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    const content = document.getElementById('panelTab-' + tabId);
    if (content) content.classList.add('active');
    if (tabId === 'subjects') renderSubjectsPanel();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MOOD TRACKER ‚Äî ÿ™ÿ™ÿ®ÿπ ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑŸÜŸÅÿ≥Ÿäÿ©
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ Data ‚îÄ‚îÄ
const MOODS = [
    { score: 5, emoji: 'ü§©', label: 'ŸÖŸÖÿ™ÿßÿ≤',  color: '#22c55e' },
    { score: 4, emoji: 'üòä', label: 'ÿ¨ŸäÿØ',    color: '#84cc16' },
    { score: 3, emoji: 'üòê', label: 'ÿπÿßÿØŸä',   color: '#f59e0b' },
    { score: 2, emoji: 'üòî', label: 'ŸÖÿ™ÿπÿ®',   color: '#f97316' },
    { score: 1, emoji: 'üòû', label: 'ÿµÿπÿ®',   color: '#ef4444' },
];

const MOOD_TIPS = [
    {
        id: 'box_breathing',
        icon: 'üå¨Ô∏è', color: '#6366f1',
        title: 'ÿ™ŸÜŸÅÿ≥ ÿßŸÑÿµŸÜÿØŸàŸÇ',
        duration: '4 ÿØŸÇÿßÿ¶ŸÇ',
        desc: 'ÿ™ŸÇŸÜŸäÿ© ÿπŸÑŸÖŸäÿ© ŸÑÿ™ŸáÿØÿ¶ÿ© ÿßŸÑÿ¨Ÿáÿßÿ≤ ÿßŸÑÿπÿµÿ®Ÿä Ÿàÿ™ÿÆŸÅŸäŸÅ ÿßŸÑŸÇŸÑŸÇ ŸÇÿ®ŸÑ ÿßŸÑÿßŸÖÿ™ÿ≠ÿßŸÜÿßÿ™',
        steps: [
            'ÿßÿ≥ÿ™ŸÜÿ¥ŸÇ ÿ®ÿ®ÿ∑ÿ° ŸÑŸÖÿØÿ© 4 ÿ´ŸàÿßŸÜŸç',
            'ÿßÿ≠ÿ®ÿ≥ ÿßŸÑŸÜŸÅÿ≥ 4 ÿ´ŸàÿßŸÜŸç',
            'ÿ£ÿÆÿ±ÿ¨ ÿßŸÑŸáŸàÿßÿ° ÿ®ÿ®ÿ∑ÿ° 4 ÿ´ŸàÿßŸÜŸç',
            'ÿßÿ≠ÿ®ÿ≥ 4 ÿ´ŸàÿßŸÜŸç ‚Äî ŸÉÿ±ÿ± 4 ŸÖÿ±ÿßÿ™',
        ]
    },
    {
        id: 'gratitude',
        icon: 'üôè', color: '#f59e0b',
        title: 'ŸÑÿ≠ÿ∏ÿ© ÿßŸÑÿ¥ŸÉÿ±',
        duration: '3 ÿØŸÇÿßÿ¶ŸÇ',
        desc: 'ÿßŸÉÿ™ÿ® 3 ÿ£ÿ¥Ÿäÿßÿ° ÿ™ÿ¥ÿπÿ± ÿ®ÿßŸÑÿßŸÖÿ™ŸÜÿßŸÜ ŸÑŸáÿß ‚Äî ŸäŸèÿ´ÿ®ÿ™ ÿßŸÑÿπŸÑŸÖ ÿ£ŸÜŸáÿß ÿ™ÿ±ŸÅÿπ ÿßŸÑŸÖÿ≤ÿßÿ¨',
        steps: [
            'ÿÆÿ∞ Ÿàÿ±ŸÇÿ© ÿ£Ÿà ŸÅÿ™ÿ≠ ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™',
            'ÿßŸÉÿ™ÿ® 3 ÿ£ÿ¥Ÿäÿßÿ° ÿ¨ŸäÿØÿ© ÿ≠ÿØÿ´ÿ™ ÿßŸÑŸäŸàŸÖ ŸàŸÑŸà ÿµÿ∫Ÿäÿ±ÿ©',
            'ÿßŸÉÿ™ÿ® ŸÑŸÖÿßÿ∞ÿß ÿ£ŸÜÿ™ ŸÖŸÖÿ™ŸÜ ŸÑŸÉŸÑ ŸÖŸÜŸáÿß',
            'ÿßŸÇÿ±ÿ£Ÿáÿß ÿ®ÿµŸàÿ™ ŸáÿßÿØÿ¶',
        ]
    },
    {
        id: 'movement',
        icon: 'üö∂', color: '#22c55e',
        title: 'ÿ≠ÿ±ŸÉÿ© ÿ≥ÿ±Ÿäÿπÿ©',
        duration: '5 ÿØŸÇÿßÿ¶ŸÇ',
        desc: 'ÿßŸÑÿ≠ÿ±ŸÉÿ© ÿ™Ÿèÿ∑ŸÑŸÇ ÿßŸÑÿ•ŸÜÿØŸàÿ±ŸÅŸäŸÜ Ÿàÿ™ŸÉÿ≥ÿ± ÿßŸÑÿ™ÿπÿ® ÿßŸÑÿ∞ŸáŸÜŸä ÿ®ÿπÿØ ÿ¨ŸÑÿ≥ÿ© ŸÖŸÉÿ´ŸÅÿ©',
        steps: [
            'ŸÇŸÅ Ÿàÿ™ŸÖÿØŸëÿØ ŸÑŸÑÿ£ÿπŸÑŸâ 10 ŸÖÿ±ÿßÿ™',
            'ÿßŸÖÿ¥Ÿê 20 ÿÆÿ∑Ÿàÿ© ŸÅŸä ÿßŸÑÿ∫ÿ±ŸÅÿ©',
            'ÿßŸÅÿπŸÑ 10 ŸÇÿ±ŸÅÿµÿßÿ° ÿ®ÿ∑Ÿäÿ¶ÿ©',
            'ŸÖÿØŸë ÿ±ŸÇÿ®ÿ™ŸÉ ŸäŸÖŸäŸÜÿßŸã ŸàŸäÿ≥ÿßÿ±ÿßŸã 5 ŸÖÿ±ÿßÿ™',
        ]
    },
    {
        id: 'grounding',
        icon: 'üåø', color: '#06b6d4',
        title: 'ÿ™ŸÖÿ±ŸäŸÜ ÿßŸÑÿ™ÿ£ÿ±Ÿäÿ∂ 5-4-3-2-1',
        duration: '3 ÿØŸÇÿßÿ¶ŸÇ',
        desc: 'ŸäŸèÿπŸäÿØ ÿßŸÑÿ™ÿ±ŸÉŸäÿ≤ ŸÑŸÑÿ≠ÿ∏ÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© ŸàŸäŸèŸáÿØŸëÿ¶ ÿßŸÑŸÇŸÑŸÇ ŸàÿßŸÑÿ™Ÿàÿ™ÿ± ÿ®ÿ≥ÿ±ÿπÿ©',
        steps: [
            'ÿßŸÜÿ∏ÿ± ÿ≠ŸàŸÑŸÉ: ÿ≠ÿØŸëÿØ 5 ÿ£ÿ¥Ÿäÿßÿ° ÿ™ÿ±ÿßŸáÿß',
            'ÿ≠ÿØŸëÿØ 4 ÿ£ÿ¥Ÿäÿßÿ° ÿ™ÿ≥ÿ™ÿ∑Ÿäÿπ ŸÑŸÖÿ≥Ÿáÿß',
            'ÿ≠ÿØŸëÿØ 3 ÿ£ÿµŸàÿßÿ™ ÿ™ÿ≥ŸÖÿπŸáÿß ÿßŸÑÿ¢ŸÜ',
            'ÿ≠ÿØŸëÿØ ÿ±ÿßÿ¶ÿ≠ÿ™ŸäŸÜ ‚Äî ÿ´ŸÖ ÿ∑ÿπŸÖÿßŸã Ÿàÿßÿ≠ÿØÿßŸã',
        ]
    },
    {
        id: 'dua_relax',
        icon: 'ü§≤', color: '#8b5cf6',
        title: 'ÿØÿπÿßÿ° ÿßŸÑÿ™ŸÅÿ±Ÿäÿ¨',
        duration: '2 ÿØŸÇŸäŸÇÿ©',
        desc: 'ÿ±ÿ®ÿ∑ ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑŸÜŸÅÿ≥Ÿäÿ© ÿ®ÿßŸÑÿ∞ŸÉÿ± ÿßŸÑÿ•ŸÑŸáŸä ŸäŸÖŸÜÿ≠ ÿ∑ŸÖÿ£ŸÜŸäŸÜÿ© ÿ≠ŸÇŸäŸÇŸäÿ© ŸàŸÖÿ≥ÿ™ÿØÿßŸÖÿ©',
        steps: [
            'ÿ™Ÿàÿ∂ÿ£ ÿ•ŸÜ ÿ£ŸÖŸÉŸÜ',
            'ÿßÿ¨ŸÑÿ≥ ÿ®ŸáÿØŸàÿ° Ÿàÿ£ÿ∫ŸÖÿ∂ ÿπŸäŸÜŸäŸÉ',
            'ŸÉÿ±ÿ±: ¬´ÿßŸÑŸÑŸáŸÖ ŸÑÿß ÿ≥ŸáŸÑ ÿ•ŸÑÿß ŸÖÿß ÿ¨ÿπŸÑÿ™Ÿá ÿ≥ŸáŸÑÿß¬ª 10 ŸÖÿ±ÿßÿ™',
            'ÿ´ŸÖ: ¬´ÿ≠ÿ≥ÿ®Ÿä ÿßŸÑŸÑŸá ŸàŸÜÿπŸÖ ÿßŸÑŸàŸÉŸäŸÑ¬ª 7 ŸÖÿ±ÿßÿ™ ÿ®ÿ™ÿ£ŸÖŸÑ',
        ]
    },
    {
        id: 'cold_water',
        icon: 'üíß', color: '#0ea5e9',
        title: 'ŸÖÿßÿ° ÿ®ÿßÿ±ÿØ ÿπŸÑŸâ ÿßŸÑŸàÿ¨Ÿá',
        duration: '1 ÿØŸÇŸäŸÇÿ©',
        desc: 'ŸäŸèŸÅÿπŸëŸÑ ÿ∫ÿ±Ÿäÿ≤ÿ© ÿßŸÑÿ∫Ÿàÿµ ŸàŸäÿ®ÿ∑Ÿëÿ¶ ÿ∂ÿ±ÿ®ÿßÿ™ ÿßŸÑŸÇŸÑÿ® ŸÅŸàÿ±ÿßŸã ‚Äî ŸÖÿ¨ÿ±Ÿëÿ® ÿπŸÑŸÖŸäÿßŸã',
        steps: [
            'ÿßÿ∞Ÿáÿ® ŸÑŸÑÿ≠ŸÖÿßŸÖ',
            'ÿßÿ∫ÿ≥ŸÑ Ÿàÿ¨ŸáŸÉ ÿ®ÿßŸÑŸÖÿßÿ° ÿßŸÑÿ®ÿßÿ±ÿØ 3 ŸÖÿ±ÿßÿ™',
            'ÿ£Ÿà ÿ∂ÿπ ŸÉŸäÿ≥ ÿ´ŸÑÿ¨ ÿπŸÑŸâ ÿ±ÿ≥ÿ∫ŸäŸÉ 30 ÿ´ÿßŸÜŸäÿ©',
            'ÿÆÿ∞ ŸÜŸÅÿ≥ÿßŸã ÿπŸÖŸäŸÇÿßŸã Ÿàÿßÿ≠ÿØÿßŸã ÿ®ÿπÿØŸáÿß',
        ]
    },
];

let moodLogs = JSON.parse(localStorage.getItem('nourium_mood_logs') || '[]');
let moodSelectedScore = null;

function saveMoodLogs() {
    localStorage.setItem('nourium_mood_logs', JSON.stringify(moodLogs));
}

// ‚îÄ‚îÄ Modal ‚îÄ‚îÄ
function openMoodModal(sessionLabel) {
    closeMoodModal();
    moodSelectedScore = null;
    const label = sessionLabel || 'ÿ≥ÿ¨ŸëŸÑ ŸÖÿ≤ÿßÿ¨ŸÉ ÿßŸÑÿ¢ŸÜ';

    const overlay = document.createElement('div');
    overlay.className = 'mood-overlay';
    overlay.id = 'moodOverlay';
    overlay.onclick = e => { if (e.target === overlay) closeMoodModal(); };

    overlay.innerHTML = `
    <div class="mood-sheet">
        <div class="mood-handle"></div>
        <div class="mood-sheet-title">üß† ${label}</div>
        <div class="mood-sheet-sub">ŸÉŸäŸÅ ŸÉÿßŸÜÿ™ ÿ≠ÿßŸÑÿ™ŸÉ ÿßŸÑŸÜŸÅÿ≥Ÿäÿ©ÿü</div>

        <div class="mood-emoji-row" id="moodEmojiRow">
            ${MOODS.map(m => `
            <button class="mood-emoji-btn" onclick="selectMoodEmoji(${m.score}, this)"
                    data-score="${m.score}" title="${m.label}">
                <div class="mood-emoji-icon">${m.emoji}</div>
                <div class="mood-emoji-label">${m.label}</div>
            </button>`).join('')}
        </div>

        <div class="mood-slider-row">
            <div class="mood-slider-hdr">
                <span>‚ö° ŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿ∑ÿßŸÇÿ©</span>
                <span class="mood-slider-val" id="moodEnergyVal">5</span>
            </div>
            <input type="range" class="mood-slider" id="moodEnergySlider"
                   min="1" max="10" value="5"
                   oninput="document.getElementById('moodEnergyVal').textContent=this.value">
        </div>

        <div class="mood-slider-row">
            <div class="mood-slider-hdr">
                <span>üéØ ŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿ™ÿ±ŸÉŸäÿ≤</span>
                <span class="mood-slider-val" id="moodFocusVal">5</span>
            </div>
            <input type="range" class="mood-slider" id="moodFocusSlider"
                   min="1" max="10" value="5"
                   oninput="document.getElementById('moodFocusVal').textContent=this.value">
        </div>

        <textarea class="mood-note" id="moodNoteInput" rows="2"
                  placeholder="ŸÖŸÑÿßÿ≠ÿ∏ÿ© ÿßÿÆÿ™Ÿäÿßÿ±Ÿäÿ©... (ŸÖÿß ÿßŸÑÿ∞Ÿä ÿ£ÿ´Ÿëÿ± ÿπŸÑŸâ ŸÖÿ≤ÿßÿ¨ŸÉÿü)"></textarea>

        <button class="mood-save-btn" onclick="saveMoodEntry()">
            ÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ≤ÿßÿ¨
        </button>
    </div>`;

    document.body.appendChild(overlay);
}

function selectMoodEmoji(score, btn) {
    moodSelectedScore = score;
    document.querySelectorAll('.mood-emoji-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
}

function closeMoodModal() {
    const el = document.getElementById('moodOverlay');
    if (el) el.remove();
}

function saveMoodEntry() {
    if (!moodSelectedScore) {
        showNotification('ÿßÿÆÿ™ÿ± ŸÖÿ≤ÿßÿ¨ŸÉ ÿ£ŸàŸÑÿßŸã üòä', 'warning');
        return;
    }
    const energy = parseInt(document.getElementById('moodEnergySlider').value);
    const focus  = parseInt(document.getElementById('moodFocusSlider').value);
    const note   = document.getElementById('moodNoteInput').value.trim();
    const mood   = MOODS.find(m => m.score === moodSelectedScore);

    const entry = {
        id:        Date.now(),
        date:      new Date().toISOString(),
        score:     moodSelectedScore,
        emoji:     mood.emoji,
        label:     mood.label,
        color:     mood.color,
        energy,
        focus,
        note,
    };

    moodLogs.unshift(entry);
    // Keep last 90 entries
    if (moodLogs.length > 90) moodLogs = moodLogs.slice(0, 90);
    saveMoodLogs();

    closeMoodModal();
    showNotification('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ŸÖÿ≤ÿßÿ¨ŸÉ ‚úÖ', 'success');
    nouriOnMoodSaved(moodSelectedScore); // üêá

    // Re-render if on mood tab
    if (document.getElementById('mood-section')?.classList.contains('active')) {
        renderMoodSection();
    }
}

// ‚îÄ‚îÄ Auto-prompt after session ‚îÄ‚îÄ
function promptMoodAfterSession() {
    setTimeout(() => {
        // Only if no mood logged this session (within 2 min)
        const twoMinAgo = Date.now() - 2 * 60 * 1000;
        const recent = moodLogs.find(l => new Date(l.date).getTime() > twoMinAgo);
        if (!recent) openMoodModal('ŸÉŸäŸÅ ŸÉÿßŸÜÿ™ ÿ¨ŸÑÿ≥ÿ© ÿßŸÑÿØÿ±ÿßÿ≥ÿ©ÿü');
    }, 1800); // after banner appears
}

// ‚îÄ‚îÄ Render Section ‚îÄ‚îÄ
function renderMoodSection() {
    renderMoodHero();
    renderMoodChart();
    renderMoodCorrelation();
    renderMoodTips();
    renderMoodLog();
}

function renderMoodHero() {
    const todayLogs = moodLogs.filter(l => toDateKey(new Date(l.date)) === getTodayKey());
    const latest    = todayLogs[0];

    const emojiEl = document.getElementById('moodTodayEmoji');
    const labelEl = document.getElementById('moodTodayLabel');
    const timeEl  = document.getElementById('moodTodayTime');
    if (!emojiEl) return;

    if (latest) {
        emojiEl.textContent = latest.emoji;
        labelEl.textContent = latest.label;
        timeEl.textContent  = new Date(latest.date).toLocaleTimeString('ar', { hour: '2-digit', minute: '2-digit' });
    } else {
        emojiEl.textContent = '‚Äî';
        labelEl.textContent = 'ŸÑŸÖ ÿ™ÿ≥ÿ¨ŸëŸÑ ÿ®ÿπÿØ ÿßŸÑŸäŸàŸÖ';
        timeEl.textContent  = '';
    }
}

function renderMoodChart() {
    const wrap = document.getElementById('moodChart7Days');
    if (!wrap) return;
    const days = [];
    for (let i = 6; i >= 0; i--) {
        const d = new Date(); d.setDate(d.getDate() - i);
        days.push(d);
    }
    const dayNames = ['ÿ£ÿ≠','ŸÜ','ÿ´','ÿ±','ÿÆ','ÿ¨','ÿ≥'];

    wrap.innerHTML = days.map(d => {
        const key  = toDateKey(d);
        const logs = moodLogs.filter(l => toDateKey(new Date(l.date)) === key);
        const avg  = logs.length ? Math.round(logs.reduce((s, l) => s + l.score, 0) / logs.length) : 0;
        const mood = MOODS.find(m => m.score === avg);
        const pct  = avg ? (avg / 5 * 100) : 8;
        const isToday = i => i === 0;
        const dayName  = dayNames[d.getDay()];
        const isToday_ = toDateKey(d) === getTodayKey();

        return `<div class="mood-bar-col">
            <div class="mood-bar-emoji">${mood ? mood.emoji : '‚¨ú'}</div>
            <div class="mood-bar" style="height:${pct}%;background:${mood ? mood.color : 'var(--border)'};${isToday_ ? 'box-shadow:0 0 8px ' + (mood ? mood.color : '#ccc') + '88;' : ''}"></div>
            <div class="mood-bar-day" style="${isToday_ ? 'color:var(--primary);font-weight:800;' : ''}">${dayName}</div>
        </div>`;
    }).join('');
}

function renderMoodCorrelation() {
    const cont = document.getElementById('moodCorrContent');
    if (!cont) return;
    if (moodLogs.length < 3) return;

    // Group mood logs by date, correlate with session duration on same day
    const dateMap = {};
    moodLogs.forEach(l => {
        const key = toDateKey(new Date(l.date));
        if (!dateMap[key]) dateMap[key] = { moods: [], energy: [], focus: [], sessionMins: 0 };
        dateMap[key].moods.push(l.score);
        dateMap[key].energy.push(l.energy);
        dateMap[key].focus.push(l.focus);
    });
    sessions.forEach(s => {
        const key = toDateKey(new Date(s.date));
        if (dateMap[key]) dateMap[key].sessionMins += s.duration || 0;
    });

    const rows = Object.values(dateMap).filter(d => d.sessionMins > 0);
    if (!rows.length) {
        cont.innerHTML = '<div style="text-align:center;color:var(--text-muted);font-size:0.83rem;padding:10px 0;">ÿ≥ÿ¨ŸëŸÑ ŸÖÿ≤ÿßÿ¨ŸÉ ŸÅŸä ÿ£ŸäÿßŸÖ ÿØÿ±ÿßÿ≥ÿ© ŸÑÿ±ÿ§Ÿäÿ© ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ</div>';
        return;
    }

    // Average by mood bucket
    const byMood = {};
    MOODS.forEach(m => { byMood[m.score] = { sessionMins: [], energy: [], focus: [] }; });
    Object.values(dateMap).forEach(d => {
        const avgMood = Math.round(d.moods.reduce((a, b) => a + b, 0) / d.moods.length);
        if (byMood[avgMood]) {
            byMood[avgMood].sessionMins.push(d.sessionMins);
            byMood[avgMood].energy.push(d.energy.reduce((a, b) => a + b, 0) / d.energy.length);
            byMood[avgMood].focus.push(d.focus.reduce((a, b) => a + b, 0) / d.focus.length);
        }
    });

    // Best mood for study
    let bestMood = null, bestMins = 0;
    MOODS.forEach(m => {
        const arr = byMood[m.score].sessionMins;
        if (!arr.length) return;
        const avg = arr.reduce((a, b) => a + b, 0) / arr.length;
        if (avg > bestMins) { bestMins = avg; bestMood = m; }
    });

    // Average energy / focus per mood score
    const avgEnergy = moodLogs.reduce((s, l) => s + l.energy, 0) / moodLogs.length;
    const avgFocus  = moodLogs.reduce((s, l) => s + l.focus, 0) / moodLogs.length;

    cont.innerHTML = `
        ${bestMood ? `<div style="background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.2);border-radius:10px;padding:10px 13px;margin-bottom:12px;font-size:0.8rem;color:var(--text);">
            üí° <strong>ŸÜŸÖÿ∑ ŸÖŸÉÿ™ÿ¥ŸÅ:</strong> ÿ•ŸÜÿ™ÿßÿ¨Ÿäÿ™ŸÉ ÿ£ÿπŸÑŸâ ÿπŸÜÿØŸÖÿß ŸÖÿ≤ÿßÿ¨ŸÉ <strong>${bestMood.emoji} ${bestMood.label}</strong> ‚Äî ÿßÿ¨ÿπŸÑ Ÿáÿ∞ÿß ÿßŸÑÿ¥ÿπŸàÿ± ŸáÿØŸÅÿßŸã ŸÇÿ®ŸÑ ÿßŸÑÿØÿ±ÿßÿ≥ÿ©
        </div>` : ''}
        <div class="mood-corr-row">
            <div class="mood-corr-label">‚ö° ÿßŸÑÿ∑ÿßŸÇÿ©</div>
            <div class="mood-corr-bg"><div class="mood-corr-fill" style="width:${avgEnergy * 10}%;background:#f59e0b;"></div></div>
            <div class="mood-corr-val">${avgEnergy.toFixed(1)}/10</div>
        </div>
        <div class="mood-corr-row">
            <div class="mood-corr-label">üéØ ÿßŸÑÿ™ÿ±ŸÉŸäÿ≤</div>
            <div class="mood-corr-bg"><div class="mood-corr-fill" style="width:${avgFocus * 10}%;background:#6366f1;"></div></div>
            <div class="mood-corr-val">${avgFocus.toFixed(1)}/10</div>
        </div>
        <div class="mood-corr-row">
            <div class="mood-corr-label">üìñ ŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑÿ¨ŸÑÿ≥ÿ©</div>
            <div class="mood-corr-bg"><div class="mood-corr-fill" style="width:${Math.min(100, bestMins / 1.5)}%;background:#22c55e;"></div></div>
            <div class="mood-corr-val">${(bestMins / 60).toFixed(1)}h</div>
        </div>`;
}

function renderMoodTips() {
    const cont = document.getElementById('moodTipsList');
    if (!cont) return;

    // Prioritize tips based on recent mood
    const recentMood = moodLogs[0];
    let tips = [...MOOD_TIPS];
    // If feeling stressed/tired, push calming tips first
    if (recentMood && recentMood.score <= 2) {
        tips = [
            MOOD_TIPS.find(t => t.id === 'box_breathing'),
            MOOD_TIPS.find(t => t.id === 'dua_relax'),
            MOOD_TIPS.find(t => t.id === 'cold_water'),
            ...MOOD_TIPS.filter(t => !['box_breathing','dua_relax','cold_water'].includes(t.id))
        ].filter(Boolean);
    }

    cont.innerHTML = tips.map(tip => `
    <div class="mood-tip-card" id="tip_${tip.id}" onclick="toggleMoodTip('${tip.id}')">
        <div class="mood-tip-accent" style="background:${tip.color};"></div>
        <div class="mood-tip-top">
            <div class="mood-tip-icon">${tip.icon}</div>
            <div class="mood-tip-title">${tip.title}</div>
            <div class="mood-tip-dur">${tip.duration}</div>
        </div>
        <div class="mood-tip-desc">${tip.desc}</div>
        <div class="mood-tip-steps" id="tipSteps_${tip.id}">
            ${tip.steps.map(s => `<div class="mood-tip-step">${s}</div>`).join('')}
        </div>
    </div>`).join('');
}

function toggleMoodTip(id) {
    const el = document.getElementById('tipSteps_' + id);
    if (el) el.classList.toggle('open');
}

function renderMoodLog() {
    const cont = document.getElementById('moodLogList');
    if (!cont) return;
    if (!moodLogs.length) {
        cont.innerHTML = '<div style="text-align:center;color:var(--text-muted);font-size:0.83rem;padding:14px 0;">ŸÑÿß ŸäŸàÿ¨ÿØ ÿ≥ÿ¨ŸÑ ÿ®ÿπÿØ ‚Äî ÿ≥ÿ¨ŸëŸÑ ŸÖÿ≤ÿßÿ¨ŸÉ ÿ®ÿπÿØ ŸÉŸÑ ÿ¨ŸÑÿ≥ÿ© üå±</div>';
        return;
    }
    cont.innerHTML = moodLogs.slice(0, 20).map(l => {
        const d = new Date(l.date);
        const dateStr = d.toLocaleDateString('ar-EG', { weekday: 'long', month: 'short', day: 'numeric' });
        const timeStr = d.toLocaleTimeString('ar', { hour: '2-digit', minute: '2-digit' });
        return `<div class="mood-log-item">
            <div class="mood-log-emoji">${l.emoji}</div>
            <div class="mood-log-info">
                <div class="mood-log-top">
                    <div class="mood-log-label">${l.label}</div>
                    <div class="mood-log-date">${dateStr} ¬∑ ${timeStr}</div>
                </div>
                ${l.note ? `<div class="mood-log-note">${l.note}</div>` : ''}
                <div class="mood-log-pills">
                    <span class="mood-log-pill">‚ö° ÿ∑ÿßŸÇÿ© ${l.energy}/10</span>
                    <span class="mood-log-pill">üéØ ÿ™ÿ±ŸÉŸäÿ≤ ${l.focus}/10</span>
                </div>
            </div>
        </div>`;
    }).join('');
}

function initMoodSection() {
    renderMoodSection();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CHALLENGES SYSTEM ‚Äî ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ÿ≠ÿØŸäÿßÿ™
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let chState = JSON.parse(localStorage.getItem('nourium_challenges') || 'null') || {
    dailyClaimed:  [],   // ids claimed today
    weeklyClaimed: [],   // ids claimed this week
    totalXp:       0,
    lastDayKey:    '',
    lastWeekKey:   '',
};

function saveChState() {
    localStorage.setItem('nourium_challenges', JSON.stringify(chState));
}

function getWeekKey() {
    const d = new Date();
    // Week starts Saturday (day 6). Get Saturday of this week.
    const day = d.getDay(); // 0=Sun
    const diff = (day >= 6) ? 0 : day + 1;
    const sat = new Date(d); sat.setDate(d.getDate() - diff);
    return sat.toISOString().slice(0, 10);
}

function resetChIfNeeded() {
    const todayKey = getTodayKey();
    const weekKey  = getWeekKey();
    if (chState.lastDayKey !== todayKey) {
        chState.dailyClaimed  = [];
        chState.lastDayKey    = todayKey;
    }
    if (chState.lastWeekKey !== weekKey) {
        chState.weeklyClaimed = [];
        chState.lastWeekKey   = weekKey;
    }
    saveChState();
}

// ‚îÄ‚îÄ Challenge Definitions ‚îÄ‚îÄ
function getDailyChallenges() {
    const todaySessions = sessions.filter(s => {
        const d = new Date(s.date);
        return toDateKey(d) === getTodayKey() && !(s.isBreak);
    });
    const todayMins   = todaySessions.reduce((sum, s) => sum + (s.duration || 0), 0);
    const todayHours  = todayMins / 60;
    const doneTodayTasks = (() => {
        const key = 'ch_done_tasks_' + getTodayKey();
        return parseInt(localStorage.getItem(key) || '0');
    })();

    return [
        {
            id:      'daily_4h',
            icon:    'üìñ',
            color:   '#6366f1',
            bgColor: 'rgba(99,102,241,0.1)',
            title:   'ŸÖÿßÿ±ÿßÿ´ŸàŸÜ ÿßŸÑÿ™ÿ±ŸÉŸäÿ≤',
            desc:    'ÿ£ŸÉŸÖŸÑ 4 ÿ≥ÿßÿπÿßÿ™ ÿØÿ±ÿßÿ≥ÿ© ÿßŸÑŸäŸàŸÖ',
            reward:  50,
            current: Math.min(todayHours, 4),
            target:  4,
            unit:    'ÿ≥ÿßÿπÿ©',
            fmt:     v => v.toFixed(1),
        },
        {
            id:      'daily_tasks',
            icon:    '‚úÖ',
            color:   '#22c55e',
            bgColor: 'rgba(34,197,94,0.1)',
            title:   'ŸÇÿßŸáÿ± ÿßŸÑŸÖŸáÿßŸÖ',
            desc:    'ÿ£ŸÉŸÖŸÑ 5 ŸÖŸáÿßŸÖ ÿßŸÑŸäŸàŸÖ',
            reward:  30,
            current: Math.min(doneTodayTasks, 5),
            target:  5,
            unit:    'ŸÖŸáÿßŸÖ',
            fmt:     v => Math.floor(v),
        },
        {
            id:      'daily_streak',
            icon:    'üî•',
            color:   '#f97316',
            bgColor: 'rgba(249,115,22,0.1)',
            title:   'ÿ≥ŸÑÿ≥ŸÑÿ© ŸÑÿß ÿ™ŸÜŸÉÿ≥ÿ±',
            desc:    'ÿ≠ÿßŸÅÿ∏ ÿπŸÑŸâ streak ÿßŸÑŸäŸàŸÖ (ÿ¨ŸÑÿ≥ÿ© Ÿàÿßÿ≠ÿØÿ© ÿ™ŸÉŸÅŸä)',
            reward:  20,
            current: todaySessions.length > 0 ? 1 : 0,
            target:  1,
            unit:    'ÿ¨ŸÑÿ≥ÿ©',
            fmt:     v => Math.floor(v),
        },
    ];
}

function getWeeklyChallenges() {
    const weekKey  = getWeekKey();
    const weekStart = new Date(weekKey);
    const weekSessions = sessions.filter(s => new Date(s.date) >= weekStart);

    // Most studied subject this week
    const subHours = {};
    subjects.forEach(s => { subHours[s.name] = 0; });
    weekSessions.forEach(s => {
        if (s.subject && subHours[s.subject] !== undefined)
            subHours[s.subject] += (s.duration || 0) / 60;
        else if (s.subject)
            subHours[s.subject] = (subHours[s.subject] || 0) + (s.duration || 0) / 60;
    });
    const topSubject = Object.entries(subHours).sort((a, b) => b[1] - a[1]);

    // Commitment: days studied this week / 7
    const studiedDays = new Set(weekSessions.map(s => toDateKey(new Date(s.date)))).size;
    const commitPct   = Math.round((studiedDays / 7) * 100);

    // Weekly hours total
    const weekHours = weekSessions.reduce((s, x) => s + (x.duration || 0), 0) / 60;

    return [
        {
            id:      'weekly_top',
            icon:    'üèÜ',
            color:   '#f59e0b',
            bgColor: 'rgba(245,158,11,0.1)',
            title:   'ÿßŸÑÿ•ŸÖÿ®ÿ±ÿßÿ∑Ÿàÿ± ÿßŸÑÿ£ŸÉÿßÿØŸäŸÖŸä',
            desc:    'ÿßÿØÿ±ÿ≥ 15 ÿ≥ÿßÿπÿ© Ÿáÿ∞ÿß ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ',
            reward:  100,
            current: Math.min(weekHours, 15),
            target:  15,
            unit:    'ÿ≥ÿßÿπÿ©',
            fmt:     v => v.toFixed(1),
            extra: topSubject.length
                ? { type: 'subjects', data: topSubject.slice(0, 4) }
                : null,
        },
        {
            id:      'weekly_commit',
            icon:    'üìä',
            color:   '#8b5cf6',
            bgColor: 'rgba(139,92,246,0.1)',
            title:   'ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿßŸÑÿ™ÿ≤ÿßŸÖ',
            desc:    'ÿßÿØÿ±ÿ≥ 5 ÿ£ŸäÿßŸÖ ŸÖŸÜ ÿ£ÿµŸÑ 7 Ÿáÿ∞ÿß ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ',
            reward:  80,
            current: Math.min(studiedDays, 5),
            target:  5,
            unit:    'ÿ£ŸäÿßŸÖ',
            fmt:     v => Math.floor(v),
            extra: { type: 'days', studiedDays, commitPct },
        },
    ];
}

// ‚îÄ‚îÄ Rendering ‚îÄ‚îÄ
function renderChallenges() {
    resetChIfNeeded();
    const daily  = getDailyChallenges();
    const weekly = getWeeklyChallenges();

    // Hero stats
    const dDone = daily.filter(c  => chState.dailyClaimed.includes(c.id)  || c.current >= c.target).length;
    const wDone = weekly.filter(c => chState.weeklyClaimed.includes(c.id) || c.current >= c.target).length;
    document.getElementById('chDoneToday').textContent  = dDone;
    document.getElementById('chTotalToday').textContent = daily.length;
    document.getElementById('chDoneWeek').textContent   = wDone;
    document.getElementById('chTotalWeek').textContent  = weekly.length;
    document.getElementById('chTotalXpEarned').textContent = chState.totalXp;

    // Render daily
    document.getElementById('chDailyList').innerHTML =
        daily.map(c => buildChCard(c, 'daily')).join('');

    // Render weekly
    document.getElementById('chWeeklyList').innerHTML =
        weekly.map(c => buildChWeeklyCard(c)).join('');
}

function buildChCard(c, type) {
    const claimed   = (type === 'daily'
        ? chState.dailyClaimed
        : chState.weeklyClaimed).includes(c.id);
    const completed = c.current >= c.target;
    const pct       = Math.min(100, Math.round((c.current / c.target) * 100));
    const isDone    = claimed || completed;

    return `<div class="ch-card ${isDone ? 'ch-done' : ''}" id="chcard_${c.id}">
        <div class="ch-card-accent" style="background:${c.color};"></div>
        <div class="ch-top">
            <div class="ch-icon-wrap" style="background:${c.bgColor};">${c.icon}</div>
            <div class="ch-info">
                <div class="ch-title">${c.title}</div>
                <div class="ch-desc">${c.desc}</div>
            </div>
            <div class="ch-reward">‚≠ê ${c.reward} XP</div>
        </div>
        ${isDone
            ? `<div class="ch-done-badge">‚úÖ ŸÖŸÉÿ™ŸÖŸÑ ‚Äî ÿ™ŸÖ ÿßÿ≥ÿ™ŸÑÿßŸÖ ${c.reward} XP</div>`
            : `<div class="ch-progress-row">
                <div class="ch-bar-bg">
                    <div class="ch-bar-fill ${pct >= 100 ? 'done' : ''}"
                         style="width:${pct}%;background:${c.color};"></div>
                </div>
                <div class="ch-pct">${pct}%</div>
               </div>
               <div style="font-size:0.72rem;color:var(--text-muted);margin-top:5px;">
                   ${c.fmt(c.current)} / ${c.fmt(c.target)} ${c.unit}
               </div>
               ${completed && !claimed
                   ? `<button class="ch-claim-btn" onclick="claimChallenge('${c.id}','${type}',${c.reward},this)">
                         <i class="fas fa-gift"></i> ÿßÿ≥ÿ™ŸÑŸÖ ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ©
                      </button>`
                   : ''
               }`
        }
    </div>`;
}

function buildChWeeklyCard(c) {
    const claimed   = chState.weeklyClaimed.includes(c.id);
    const completed = c.current >= c.target;
    const pct       = Math.min(100, Math.round((c.current / c.target) * 100));
    const isDone    = claimed || completed;

    let extraHtml = '';

    if (c.extra?.type === 'subjects' && c.extra.data.length) {
        const maxH = Math.max(...c.extra.data.map(([,h]) => h), 0.1);
        extraHtml = `<div class="ch-weekly-body">
            ${c.extra.data.map(([name, h]) => {
                const sub = subjects.find(s => s.name === name);
                const col = sub?.color || 'var(--primary-mid)';
                const w   = Math.round((h / maxH) * 100);
                return `<div class="ch-weekly-subject-row">
                    <div class="ch-weekly-dot" style="background:${col};"></div>
                    <div class="ch-weekly-name">${name}</div>
                    <div class="ch-weekly-bar-bg"><div class="ch-weekly-bar-fill" style="width:${w}%;background:${col};"></div></div>
                    <div class="ch-weekly-val">${h.toFixed(1)}h</div>
                </div>`;
            }).join('')}
        </div>`;
    }

    if (c.extra?.type === 'days') {
        const { studiedDays, commitPct } = c.extra;
        // last 7 days grid
        const days = [];
        for (let i = 6; i >= 0; i--) {
            const d = new Date(); d.setDate(d.getDate() - i);
            const key = toDateKey(d);
            const studied = sessions.some(s => toDateKey(new Date(s.date)) === key);
            const isToday = i === 0;
            const label   = d.toLocaleDateString('ar', { weekday: 'narrow' });
            days.push(`<div class="ch-ring-day ${studied ? 'studied' : 'empty'} ${isToday ? 'today' : ''}" title="${label}">${label}</div>`);
        }
        extraHtml = `<div class="ch-weekly-body">
            <div class="ch-ring-wrap">
                <svg class="ch-ring-svg" width="72" height="72" viewBox="0 0 72 72">
                    <circle cx="36" cy="36" r="30" fill="none" stroke="var(--border)" stroke-width="7"/>
                    <circle cx="36" cy="36" r="30" fill="none" stroke="${c.color}" stroke-width="7"
                        stroke-dasharray="${Math.round(commitPct * 1.885)} 188.5"
                        stroke-linecap="round"
                        transform="rotate(-90 36 36)"
                        style="transition:stroke-dasharray 0.8s ease;"/>
                    <text x="36" y="41" text-anchor="middle" font-size="14" font-weight="800"
                        fill="var(--text)" font-family="Tajawal,sans-serif">${commitPct}%</text>
                </svg>
                <div>
                    <div class="ch-ring-pct">${studiedDays} / 7</div>
                    <div class="ch-ring-label">ÿ£ŸäÿßŸÖ ÿßŸÑÿØÿ±ÿßÿ≥ÿ© Ÿáÿ∞ÿß ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ</div>
                    <div class="ch-ring-days">${days.join('')}</div>
                </div>
            </div>
        </div>`;
    }

    return `<div class="ch-weekly-card ${isDone ? 'ch-done' : ''}" id="chcard_${c.id}">
        <div class="ch-weekly-header">
            <div class="ch-weekly-icon" style="background:${c.bgColor};">${c.icon}</div>
            <div>
                <div class="ch-weekly-title">${c.title}</div>
                <div class="ch-weekly-sub">${c.desc}</div>
            </div>
            <div class="ch-reward" style="margin-right:auto;">‚≠ê ${c.reward} XP</div>
        </div>
        ${extraHtml}
        <div style="padding:0 18px 14px;">
            ${isDone
                ? `<div class="ch-done-badge">‚úÖ ŸÖŸÉÿ™ŸÖŸÑ ‚Äî ÿ™ŸÖ ÿßÿ≥ÿ™ŸÑÿßŸÖ ${c.reward} XP</div>`
                : `<div class="ch-progress-row">
                    <div class="ch-bar-bg">
                        <div class="ch-bar-fill ${pct >= 100 ? 'done' : ''}"
                             style="width:${pct}%;background:${c.color};"></div>
                    </div>
                    <div class="ch-pct">${pct}%</div>
                   </div>
                   <div style="font-size:0.72rem;color:var(--text-muted);margin-top:5px;">
                       ${c.fmt(c.current)} / ${c.fmt(c.target)} ${c.unit}
                   </div>
                   ${completed && !claimed
                       ? `<button class="ch-claim-btn" onclick="claimChallenge('${c.id}','weekly',${c.reward},this)">
                              <i class="fas fa-gift"></i> ÿßÿ≥ÿ™ŸÑŸÖ ÿßŸÑŸÖŸÉÿßŸÅÿ£ÿ©
                          </button>`
                       : ''
                   }`
            }
        </div>
    </div>`;
}

// ‚îÄ‚îÄ Claim ‚îÄ‚îÄ
function claimChallenge(id, type, xpAmount, btn) {
    if (type === 'daily' && !chState.dailyClaimed.includes(id)) {
        chState.dailyClaimed.push(id);
    } else if (type === 'weekly' && !chState.weeklyClaimed.includes(id)) {
        chState.weeklyClaimed.push(id);
    }
    chState.totalXp += xpAmount;
    saveChState();
    addXP(xpAmount);

    // Confetti burst
    const rect = btn.getBoundingClientRect();
    const emojis = ['üéâ','‚≠ê','üèÜ','‚ú®','üåü','üí´'];
    for (let i = 0; i < 8; i++) {
        const el = document.createElement('div');
        el.className = 'ch-confetti';
        el.textContent = emojis[i % emojis.length];
        el.style.cssText = `left:${rect.left + Math.random()*rect.width}px;top:${rect.top}px;`;
        el.style.animationDelay = (i * 0.08) + 's';
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 2200);
    }

    showNotification(`üéâ +${xpAmount} XP ŸÖŸÉÿßŸÅÿ£ÿ© ÿßŸÑÿ™ÿ≠ÿØŸä!`, 'success');
    setTimeout(renderChallenges, 400);
}

// ‚îÄ‚îÄ Track daily task completions for the challenges ‚îÄ‚îÄ
function trackChallengeTaskDone() {
    const key = 'ch_done_tasks_' + getTodayKey();
    const cur = parseInt(localStorage.getItem(key) || '0');
    localStorage.setItem(key, cur + 1);
    // Auto-check challenges if tab is open
    if (document.getElementById('challenges')?.classList.contains('active')) {
        renderChallenges();
    }
}

// ‚îÄ‚îÄ Hook into tab switch ‚îÄ‚îÄ
function initChallenges() {
    resetChIfNeeded();
    renderChallenges();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  KNOWLEDGE TREE ‚Äî ÿ¥ÿ¨ÿ±ÿ© ÿßŸÑŸÖÿπÿ±ŸÅÿ©
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const TREE_LEVELS = [
    { name: 'ÿ®ÿ∞ÿ±ÿ©',       icon: 'üå±', minH: 0,   maxH: 5,   nextLabel: '5 ÿ≥ÿßÿπÿßÿ™ ŸÑŸÑÿ®ÿ±ÿßÿπŸÖ'     },
    { name: 'ÿ®ÿ±ÿßÿπŸÖ',      icon: 'üåø', minH: 5,   maxH: 15,  nextLabel: '15 ÿ≥ÿßÿπÿ© ŸÑŸÑÿ¥ÿ™ŸÑÿ©'      },
    { name: 'ÿ¥ÿ™ŸÑÿ©',       icon: 'üå≥', minH: 15,  maxH: 30,  nextLabel: '30 ÿ≥ÿßÿπÿ© ŸÑŸÑÿ¥ÿ¨ÿ±ÿ©'       },
    { name: 'ÿ¥ÿ¨ÿ±ÿ©',       icon: 'üå≤', minH: 30,  maxH: 60,  nextLabel: '60 ÿ≥ÿßÿπÿ© ŸÑŸÑÿ∫ÿßÿ®ÿ©'       },
    { name: 'ÿ∫ÿßÿ®ÿ©',       icon: 'üèïÔ∏è', minH: 60,  maxH: 100, nextLabel: '100 ÿ≥ÿßÿπÿ© ŸÑŸÑÿ¨ŸÜÿ©'      },
    { name: 'ÿ¨ŸÜÿ© ÿßŸÑŸÖÿπÿ±ŸÅÿ©', icon: '‚ú®', minH: 100, maxH: 100, nextLabel: 'ŸàÿµŸÑÿ™ ÿßŸÑŸÇŸÖÿ©!'         },
];

const FLOWER_DEFS = [
    { id: 'f_first_task',    emoji: 'üå∏', label: 'ÿ£ŸàŸÑ ŸÖŸáŸÖÿ©',     cond: d => d.doneTasks >= 1  },
    { id: 'f_ten_tasks',     emoji: 'üå∫', label: '10 ŸÖŸáÿßŸÖ',       cond: d => d.doneTasks >= 10 },
    { id: 'f_first_session', emoji: 'üåº', label: 'ÿ£ŸàŸÑ ÿ¨ŸÑÿ≥ÿ©',     cond: d => d.totalHours >= 0.25 },
    { id: 'f_five_hours',    emoji: 'üåª', label: '5 ÿ≥ÿßÿπÿßÿ™',       cond: d => d.totalHours >= 5  },
    { id: 'f_twenty_hours',  emoji: 'üåπ', label: '20 ÿ≥ÿßÿπÿ©',       cond: d => d.totalHours >= 20 },
    { id: 'f_fifty_hours',   emoji: 'üíê', label: '50 ÿ≥ÿßÿπÿ©',       cond: d => d.totalHours >= 50 },
    { id: 'f_streak3',       emoji: 'üî•', label: '3 ÿ£ŸäÿßŸÖ ŸÖÿ™ÿ™ÿßŸÑŸäÿ©', cond: d => d.streak >= 3    },
    { id: 'f_streak7',       emoji: '‚ö°', label: '7 ÿ£ŸäÿßŸÖ',         cond: d => d.streak >= 7    },
    { id: 'f_streak30',      emoji: 'üå†', label: '30 ŸäŸàŸÖ',         cond: d => d.streak >= 30   },
    { id: 'f_allsubjects',   emoji: 'üåà', label: 'ŸÉŸÑ ÿßŸÑŸÖŸàÿßÿØ',     cond: d => d.subjectCount >= 3 },
    { id: 'f_review_done',   emoji: 'üçÄ', label: 'ŸÖÿ±ÿßÿ¨ÿπÿ© ŸÖÿ™ÿ®ÿßÿπÿØÿ©', cond: d => d.reviewDone >= 1 },
    { id: 'f_hundred_xp',   emoji: '‚≠ê',  label: '100 XP',         cond: d => d.xp >= 100      },
    { id: 'f_five_hundred',  emoji: 'üèÜ', label: '500 XP',         cond: d => d.xp >= 500      },
];

let treeAnimFrame = null;
let treeGrowth = 0; // 0‚Äì1 animation progress
let treeAnimating = false;
let treeUnlockedFlowers = JSON.parse(localStorage.getItem('nourium_tree_flowers') || '[]');

function getTreeData() {
    const totalMinutes = sessions.reduce((s, x) => s + (x.duration || 0), 0);
    const totalHours   = totalMinutes / 60;
    const doneTasks    = tasks.filter(t => t.completed).length;
    const reviewDone   = reviewItems.filter(r => r.done).length;
    return { totalHours, doneTasks, streak, subjectCount: subjects.length, xp, reviewDone };
}

function getTreeLevel(hours) {
    for (let i = TREE_LEVELS.length - 1; i >= 0; i--) {
        if (hours >= TREE_LEVELS[i].minH) return i;
    }
    return 0;
}

function renderTreeHeader() {
    const d = getTreeData();
    const lvlIdx = getTreeLevel(d.totalHours);
    const lvl = TREE_LEVELS[lvlIdx];
    const next = TREE_LEVELS[Math.min(lvlIdx + 1, TREE_LEVELS.length - 1)];
    const pct = lvlIdx === TREE_LEVELS.length - 1
        ? 100
        : Math.min(100, ((d.totalHours - lvl.minH) / (next.minH - lvl.minH)) * 100);

    document.getElementById('treeLevelIcon').textContent  = lvl.icon;
    document.getElementById('treeLevelName').textContent  = lvl.name;
    document.getElementById('treeLevelSub').textContent   = `${d.totalHours.toFixed(1)} ÿ≥ÿßÿπÿ© ÿØÿ±ÿßÿ≥ÿ©`;
    document.getElementById('treeHoursFill').style.width  = pct + '%';
    document.getElementById('treeNextGoal').textContent   = lvl.nextLabel;
}

function renderTreeBranches() {
    const grid = document.getElementById('treeBranchesGrid');
    if (!subjects.length) {
        grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:20px;color:var(--text-muted);font-size:0.85rem;">ÿ£ÿ∂ŸÅ ŸÖŸàÿßÿØŸÉ ÿßŸÑÿØÿ±ÿßÿ≥Ÿäÿ© ŸÖŸÜ ÿ™ÿ®ŸàŸäÿ® "ŸÖŸàÿßÿØ" ŸÑÿ™ÿ∏Ÿáÿ± ŸÅÿ±Ÿàÿπ ÿ¥ÿ¨ÿ±ÿ™ŸÉ üåø</div>';
        return;
    }
    const subHours = {};
    subjects.forEach(s => { subHours[s.id] = 0; });
    sessions.forEach(sess => {
        if (sess.subjectId && subHours[sess.subjectId] !== undefined)
            subHours[sess.subjectId] += (sess.duration || 0) / 60;
    });
    const maxH = Math.max(...subjects.map(s => subHours[s.id] || 0), 1);

    grid.innerHTML = subjects.map(s => {
        const h = (subHours[s.id] || 0).toFixed(1);
        const pct = Math.min(100, ((subHours[s.id] || 0) / maxH) * 100);
        const flowers = Math.floor(subHours[s.id] / 2); // ÿ≤Ÿáÿ±ÿ© ŸÉŸÑ ÿ≥ÿßÿπÿ™ŸäŸÜ
        const flowerStr = 'üå∏'.repeat(Math.min(flowers, 5)) || '‚Äî';
        const icon = getBranchIcon(s.name);
        return `<div class="branch-card">
            <div class="branch-card-color" style="background:${s.color};"></div>
            <div class="branch-icon">${icon}</div>
            <div class="branch-name">${s.name}</div>
            <div class="branch-hours">${h} ÿ≥ÿßÿπÿ©</div>
            <div class="branch-flowers">${flowerStr}</div>
            <div class="branch-bar-bg"><div class="branch-bar-fill" style="width:${pct}%;background:${s.color};"></div></div>
        </div>`;
    }).join('');
}

function getBranchIcon(name) {
    const n = name.toLowerCase();
    if (n.includes('ÿ™ÿ¥ÿ±Ÿäÿ≠') || n.includes('anatomy')) return 'ü¶¥';
    if (n.includes('ŸÅÿ≥ŸäŸàŸÑŸàÿ¨Ÿäÿß') || n.includes('physio')) return 'üíì';
    if (n.includes('ŸÉŸäŸÖŸäÿßÿ°') || n.includes('biochem')) return 'üß™';
    if (n.includes('ŸÖŸäŸÉÿ±Ÿàÿ®') || n.includes('micro')) return 'ü¶†';
    if (n.includes('ÿ®ÿßÿ´ŸàŸÑŸàÿ¨') || n.includes('pathol')) return 'üî¨';
    if (n.includes('ŸÅÿßÿ±ŸÖÿß') || n.includes('pharma')) return 'üíä';
    if (n.includes('ÿ¨ÿ±ÿßÿ≠') || n.includes('surgery')) return 'üî™';
    if (n.includes('ŸÜŸÅÿ≥') || n.includes('psych')) return 'üß†';
    if (n.includes('ÿ∑Ÿàÿßÿ±ÿ¶') || n.includes('emergency')) return 'üöë';
    if (n.includes('ÿ£ÿ∑ŸÅÿßŸÑ') || n.includes('pediatr')) return 'üë∂';
    return 'üìö';
}

function renderTreeFlowers() {
    const d = getTreeData();
    const grid = document.getElementById('treeFlowersGrid');
    const newlyUnlocked = [];

    FLOWER_DEFS.forEach(fl => {
        const unlocked = fl.cond(d);
        const wasLocked = !treeUnlockedFlowers.includes(fl.id);
        if (unlocked && wasLocked) {
            newlyUnlocked.push(fl);
            treeUnlockedFlowers.push(fl.id);
        }
    });

    if (newlyUnlocked.length) {
        localStorage.setItem('nourium_tree_flowers', JSON.stringify(treeUnlockedFlowers));
        newlyUnlocked.forEach(fl => spawnFlowerParticle(fl.emoji));
    }

    grid.innerHTML = FLOWER_DEFS.map(fl => {
        const unlocked = fl.cond(d);
        return `<div class="flower-badge ${unlocked ? '' : 'locked'}">
            <div class="flower-emoji">${fl.emoji}</div>
            <div class="flower-label">${fl.label}</div>
        </div>`;
    }).join('');
}

function spawnFlowerParticle(emoji) {
    const el = document.createElement('div');
    el.className = 'flower-particle';
    el.textContent = emoji;
    el.style.cssText = `left:${30 + Math.random() * 40}vw; top:${30 + Math.random() * 30}vh;`;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 3000);
}

function renderTreeMilestones() {
    const d = getTreeData();
    const cont = document.getElementById('treeMilestones');
    cont.innerHTML = TREE_LEVELS.map((lvl, i) => {
        const done    = d.totalHours >= lvl.minH;
        const current = getTreeLevel(d.totalHours) === i;
        const dotCls  = done ? (current ? 'current' : 'done') : '';
        return `<div class="milestone-item">
            <div class="milestone-dot ${dotCls}"></div>
            <div>
                <div class="milestone-text">${lvl.icon} ${lvl.name}</div>
                <div class="milestone-sub">${lvl.minH === 0 ? 'ÿßŸÑÿ®ÿØÿßŸäÿ©' : lvl.minH + ' ÿ≥ÿßÿπÿ© ÿØÿ±ÿßÿ≥ÿ©'}</div>
                ${done ? `<span class="milestone-badge">‚úÖ ŸÖŸÉÿ™ŸÖŸÑ</span>` : `<span class="milestone-badge" style="background:var(--bg);color:var(--text-muted);">${lvl.minH} ÿ≥ÿßÿπÿ© ŸÖÿ∑ŸÑŸàÿ®ÿ©</span>`}
            </div>
        </div>`;
    }).join('');
}

// ‚îÄ‚îÄ Canvas Tree Drawing ‚îÄ‚îÄ
function drawKnowledgeTree(growth) {
    const canvas = document.getElementById('knowledgeTreeCanvas');
    if (!canvas) return;
    const dpr = window.devicePixelRatio || 1;
    const W = canvas.offsetWidth || 360;
    const H = 320;
    canvas.width  = W * dpr;
    canvas.height = H * dpr;
    const ctx = canvas.getContext('2d');
    ctx.scale(dpr, dpr);

    const isDark = document.body.classList.contains('dark-mode');
    const bgColor = isDark ? '#11183A' : '#f0fdf4';
    const skyTop  = isDark ? '#0A0F1F' : '#e0f2fe';

    // Sky gradient
    const sky = ctx.createLinearGradient(0, 0, 0, H);
    sky.addColorStop(0, skyTop);
    sky.addColorStop(1, bgColor);
    ctx.fillStyle = sky;
    ctx.fillRect(0, 0, W, H);

    // Stars / sparkles (dark mode)
    if (isDark && growth > 0.3) {
        ctx.fillStyle = 'rgba(255,255,255,0.6)';
        [[0.1,0.1],[0.85,0.15],[0.2,0.35],[0.75,0.3],[0.5,0.08],[0.92,0.4]].forEach(([rx,ry]) => {
            const px = rx * W, py = ry * H * growth;
            ctx.beginPath();
            ctx.arc(px, py, 1, 0, Math.PI * 2);
            ctx.fill();
        });
    }

    // Ground
    const gnd = ctx.createLinearGradient(0, H - 40, 0, H);
    gnd.addColorStop(0, isDark ? '#14532d' : '#86efac');
    gnd.addColorStop(1, isDark ? '#052e16' : '#4ade80');
    ctx.fillStyle = gnd;
    ctx.fillRect(0, H - 40, W, 40);

    // Trunk
    const cx = W / 2;
    const groundY = H - 40;
    const trunkH = Math.min(growth * 220, 180);
    const trunkW = 14 + growth * 12;

    const trunkGrad = ctx.createLinearGradient(cx - trunkW, 0, cx + trunkW, 0);
    trunkGrad.addColorStop(0, '#78350f');
    trunkGrad.addColorStop(0.5, '#a16207');
    trunkGrad.addColorStop(1, '#78350f');
    ctx.fillStyle = trunkGrad;
    ctx.beginPath();
    ctx.moveTo(cx - trunkW / 2, groundY);
    ctx.quadraticCurveTo(cx - trunkW / 2 - 4, groundY - trunkH / 2,
                         cx, groundY - trunkH);
    ctx.quadraticCurveTo(cx + trunkW / 2 + 4, groundY - trunkH / 2,
                         cx + trunkW / 2, groundY);
    ctx.closePath();
    ctx.fill();

    // ‚úÖ FIX: ÿ≠ÿßŸÑÿ© ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© (ÿ®ÿ∞ÿ±ÿ©) ÿπŸÜÿØ ÿßŸÜÿπÿØÿßŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
    if (growth < 0.05) {
        ctx.font = '48px serif';
        ctx.textAlign = 'center';
        ctx.fillText('üå±', W/2, groundY - 30);
        ctx.font = 'bold 14px Tajawal, sans-serif';
        ctx.fillStyle = isDark ? 'rgba(165,212,255,0.7)' : '#475569';
        ctx.fillText('ÿßÿ®ÿØÿ£ ÿ¨ŸÑÿ≥ÿ™ŸÉ ÿßŸÑÿ£ŸàŸÑŸâ ŸÑÿ™ŸÜŸÖŸà ÿ¥ÿ¨ÿ±ÿ™ŸÉ!', W/2, groundY - 8);
        return;
    }

    // Branches and foliage
    const d = getTreeData();
    const subColors = subjects.length
        ? subjects.map(s => s.color)
        : ['#22c55e', '#3b82f6', '#f59e0b', '#ec4899'];

    const branchCount = Math.max(3, Math.min(subjects.length || 3, 6));
    const topY = groundY - trunkH;

    // Draw branch clusters
    for (let b = 0; b < branchCount; b++) {
        const angle = (Math.PI / (branchCount + 1)) * (b + 1);
        const branchLen = (50 + Math.random() * 30) * growth;
        const bx = cx + Math.cos(Math.PI - angle) * branchLen;
        const by = topY + Math.sin(Math.PI - angle) * branchLen * 0.5;

        // Branch line
        ctx.strokeStyle = '#92400e';
        ctx.lineWidth = 4 * growth;
        ctx.beginPath();
        ctx.moveTo(cx, topY);
        ctx.quadraticCurveTo(cx + Math.cos(Math.PI - angle) * branchLen * 0.5, topY - 20 * growth, bx, by);
        ctx.stroke();

        // Foliage blob
        const col = subColors[b % subColors.length];
        const r = (28 + b * 4) * growth;
        const folGrad = ctx.createRadialGradient(bx, by, 0, bx, by, r);
        folGrad.addColorStop(0, col + 'cc');
        folGrad.addColorStop(1, col + '44');
        ctx.fillStyle = folGrad;
        ctx.beginPath();
        ctx.arc(bx, by, r, 0, Math.PI * 2);
        ctx.fill();

        // Subject label on branch (if has name)
        if (subjects[b] && growth > 0.7) {
            ctx.fillStyle = isDark ? 'rgba(255,255,255,0.9)' : 'rgba(0,0,0,0.75)';
            ctx.font = `bold ${10 * growth}px Tajawal, sans-serif`;
            ctx.textAlign = 'center';
            ctx.fillText(subjects[b].name.slice(0, 6), bx, by + 4);
        }
    }

    // Central crown
    const crownR = (50 + growth * 40) * growth;
    const crownGrad = ctx.createRadialGradient(cx, topY, 0, cx, topY, crownR);
    crownGrad.addColorStop(0, '#4ade80cc');
    crownGrad.addColorStop(0.6, '#22c55e88');
    crownGrad.addColorStop(1, '#15803d33');
    ctx.fillStyle = crownGrad;
    ctx.beginPath();
    ctx.arc(cx, topY, crownR, 0, Math.PI * 2);
    ctx.fill();

    // Flowers on crown
    if (growth > 0.5) {
        const flowerEmojis = treeUnlockedFlowers.slice(0, 6);
        flowerEmojis.forEach((fid, i) => {
            const fl = FLOWER_DEFS.find(f => f.id === fid);
            if (!fl) return;
            const fAngle = (Math.PI * 2 / flowerEmojis.length) * i;
            const fr = crownR * 0.7;
            const fx = cx + Math.cos(fAngle) * fr;
            const fy = topY + Math.sin(fAngle) * fr * 0.6;
            ctx.font = `${14 * growth}px serif`;
            ctx.textAlign = 'center';
            ctx.fillText(fl.emoji, fx, fy);
        });
    }

    // Glow at tip (if high growth)
    if (growth > 0.8) {
        const glow = ctx.createRadialGradient(cx, topY - crownR * 0.3, 0, cx, topY - crownR * 0.3, 30);
        glow.addColorStop(0, 'rgba(250,204,21,0.3)');
        glow.addColorStop(1, 'rgba(250,204,21,0)');
        ctx.fillStyle = glow;
        ctx.beginPath();
        ctx.arc(cx, topY - crownR * 0.3, 30, 0, Math.PI * 2);
        ctx.fill();
    }
}

function animateTreeGrow() {
    if (treeAnimating) return;
    treeAnimating = true;
    const d = getTreeData();
    const target = Math.min(1, d.totalHours / 30); // full at 30h
    const startG = treeGrowth;
    let startTime = null;
    const duration = 1400;

    function step(ts) {
        if (!startTime) startTime = ts;
        const prog = Math.min(1, (ts - startTime) / duration);
        const ease = 1 - Math.pow(1 - prog, 3);
        treeGrowth = startG + (target - startG) * ease;
        drawKnowledgeTree(treeGrowth);
        if (prog < 1) {
            treeAnimFrame = requestAnimationFrame(step);
        } else {
            treeGrowth = target;
            treeAnimating = false;
            document.getElementById('treeCanvasHint').textContent = 'ÿßÿ∂ÿ∫ÿ∑ ŸÑÿ™ÿ¨ÿØŸäÿØ ÿßŸÑÿ£ŸÜŸäŸÖŸäÿ¥ŸÜ üåø';
        }
    }
    treeAnimFrame = requestAnimationFrame(step);
}

function initKnowledgeTree() {
    const canvas = document.getElementById('knowledgeTreeCanvas');
    if (!canvas) return;

    renderTreeHeader();
    renderTreeBranches();
    renderTreeFlowers();
    renderTreeMilestones();

    // Initial static draw
    const d = getTreeData();
    treeGrowth = Math.min(1, d.totalHours / 30);
    drawKnowledgeTree(treeGrowth);

    canvas.addEventListener('click', animateTreeGrow);
    canvas.addEventListener('touchend', (e) => { e.preventDefault(); animateTreeGrow(); });

    // Animate on first open
    setTimeout(animateTreeGrow, 300);
}

// Re-render tree when sessions change (hook into existing session save)
function refreshKnowledgeTree() {
    if (document.getElementById('tree-section')?.classList.contains('active')) {
        renderTreeHeader();
        renderTreeBranches();
        renderTreeFlowers();
        renderTreeMilestones();
        const d = getTreeData();
        treeGrowth = Math.min(1, d.totalHours / 30);
        drawKnowledgeTree(treeGrowth);
    }
}

// Hook into tab switch
const _origSwitchTab = window.switchTab;
document.addEventListener('DOMContentLoaded', function() {
    const origSwitchTab = switchTab;
    window.switchTab = function(tab, el) {
        origSwitchTab(tab, el);
        if (tab === 'tree-section') {
            setTimeout(initKnowledgeTree, 50);
        }
        if (tab === 'challenges') {
            setTimeout(initChallenges, 50);
        }
        if (tab === 'mood-section') {
            setTimeout(initMoodSection, 50);
        }
        if (tab === 'spiritual') {
            setTimeout(function() { initSpiritV3(); }, 50);
        }
    };
    // Re-draw on resize
    window.addEventListener('resize', () => {
        if (document.getElementById('tree-section')?.classList.contains('active')) {
            drawKnowledgeTree(treeGrowth);
        }
    });
});




// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  üåô SPIRITUAL REGULATION SYSTEM ‚Äî ÿπÿßŸÑŸÖ ÿßŸÑÿ±Ÿàÿ≠
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ Extended Duas Data (mood-based) ‚îÄ‚îÄ
const SPIRIT_DUAS = {
    study: {
        label: 'ŸÇÿ®ŸÑ ÿßŸÑŸÖÿ∞ÿßŸÉÿ±ÿ©', color: '#4338ca',
        duas: [
            { id: 'sp_s1', text: 'ÿßŸÑŸÑŸáŸÖ ÿ•ŸÜŸä ÿ£ÿ≥ÿ£ŸÑŸÉ ŸÅŸáŸÖ ÿßŸÑŸÜÿ®ŸäŸäŸÜ Ÿàÿ≠ŸÅÿ∏ ÿßŸÑŸÖÿ±ÿ≥ŸÑŸäŸÜ Ÿàÿ•ŸÑŸáÿßŸÖ ÿßŸÑŸÖŸÑÿßÿ¶ŸÉÿ© ÿßŸÑŸÖŸÇÿ±ÿ®ŸäŸÜ.' },
            { id: 'sp_s2', text: 'ÿ±ÿ® ÿßÿ¥ÿ±ÿ≠ ŸÑŸä ÿµÿØÿ±Ÿä ŸàŸäÿ≥ÿ± ŸÑŸä ÿ£ŸÖÿ±Ÿä Ÿàÿßÿ≠ŸÑŸÑ ÿπŸÇÿØÿ© ŸÖŸÜ ŸÑÿ≥ÿßŸÜŸä ŸäŸÅŸÇŸáŸàÿß ŸÇŸàŸÑŸä.' },
            { id: 'sp_s3', text: 'ÿßŸÑŸÑŸáŸÖ ÿßŸÜŸÅÿπŸÜŸä ÿ®ŸÖÿß ÿπŸÑŸÖÿ™ŸÜŸä ŸàÿπŸÑŸÖŸÜŸä ŸÖÿß ŸäŸÜŸÅÿπŸÜŸä Ÿàÿ≤ÿØŸÜŸä ÿπŸÑŸÖÿßŸã.' },
            { id: 'sp_s4', text: 'ÿßŸÑŸÑŸáŸÖ ÿßÿ¨ÿπŸÑ Ÿáÿ∞ÿß ÿßŸÑÿπŸÑŸÖ ÿÆÿßŸÑÿµÿßŸã ŸÑŸàÿ¨ŸáŸÉ ÿßŸÑŸÉÿ±ŸäŸÖ.' },
            { id: 'sp_s5', text: 'Ÿäÿß ŸÖÿπŸÑŸÖ ÿ•ÿ®ÿ±ÿßŸáŸäŸÖ ÿπŸÑŸÖŸÜŸäÿå ŸàŸäÿß ŸÖŸÅŸáŸÖ ÿ≥ŸÑŸäŸÖÿßŸÜ ŸÅŸáŸÖŸÜŸä.' },
        ]
    },
    tired: {
        label: 'ÿπŸÜÿØ ÿßŸÑÿ•ÿ±ŸáÿßŸÇ', color: '#7c3aed',
        duas: [
            { id: 'sp_t1', text: 'ÿßŸÑŸÑŸáŸÖ ÿ•ŸÜŸä ÿ£ÿπŸàÿ∞ ÿ®ŸÉ ŸÖŸÜ ÿßŸÑÿπÿ¨ÿ≤ ŸàÿßŸÑŸÉÿ≥ŸÑ ŸàÿßŸÑÿ¨ÿ®ŸÜ ŸàÿßŸÑÿ®ÿÆŸÑ ŸàÿßŸÑŸáÿ±ŸÖ Ÿàÿπÿ∞ÿßÿ® ÿßŸÑŸÇÿ®ÿ±.' },
            { id: 'sp_t2', text: 'ÿßŸÑŸÑŸáŸÖ ÿßÿ¨ÿπŸÑ ÿπÿ®ÿßÿØÿ™ŸÉ ÿ£ÿ≠ÿ® ÿßŸÑÿ£ÿ¥Ÿäÿßÿ° ÿ•ŸÑŸäŸë Ÿàÿ∑ÿßÿπÿ™ŸÉ ÿ£ÿ≥ŸáŸÑ ÿßŸÑÿ£ŸÖŸàÿ± ÿπŸÑŸäŸë.' },
            { id: 'sp_t3', text: 'ÿ≠ÿ≥ÿ®Ÿä ÿßŸÑŸÑŸá ŸàŸÜÿπŸÖ ÿßŸÑŸàŸÉŸäŸÑ ŸÜÿπŸÖ ÿßŸÑŸÖŸàŸÑŸâ ŸàŸÜÿπŸÖ ÿßŸÑŸÜÿµŸäÿ±.' },
            { id: 'sp_t4', text: 'ÿßŸÑŸÑŸáŸÖ ŸÇŸàŸëŸÜŸä Ÿàÿßÿ¥ÿ±ÿ≠ ÿµÿØÿ±Ÿä ŸÑŸÑÿπŸÑŸÖ Ÿàÿ£ŸÖÿØŸëŸÜŸä ÿ®ÿßŸÑÿ∑ÿßŸÇÿ© ŸàÿßŸÑÿµÿ®ÿ±.' },
        ]
    },
    anxiety: {
        label: 'ŸÇŸÑŸÇ ÿßŸÑÿßŸÖÿ™ÿ≠ÿßŸÜ', color: '#0369a1',
        duas: [
            { id: 'sp_a1', text: 'ÿßŸÑŸÑŸáŸÖ ŸÑÿß ÿ≥ŸáŸÑ ÿ•ŸÑÿß ŸÖÿß ÿ¨ÿπŸÑÿ™Ÿá ÿ≥ŸáŸÑÿßŸã Ÿàÿ£ŸÜÿ™ ÿ™ÿ¨ÿπŸÑ ÿßŸÑÿ≠ÿ≤ŸÜ ÿ•ÿ∞ÿß ÿ¥ÿ¶ÿ™ ÿ≥ŸáŸÑÿßŸã.' },
            { id: 'sp_a2', text: 'ÿ£ÿπŸàÿ∞ ÿ®ŸÉŸÑŸÖÿßÿ™ ÿßŸÑŸÑŸá ÿßŸÑÿ™ÿßŸÖÿßÿ™ ŸÖŸÜ ÿ¥ÿ± ŸÖÿß ÿÆŸÑŸÇ.' },
            { id: 'sp_a3', text: 'ÿßŸÑŸÑŸáŸÖ ÿ•ŸÜŸä ÿ£ÿ™ŸàŸÉŸÑ ÿπŸÑŸäŸÉ Ÿàÿ£ŸÅŸàŸëÿ∂ ÿ£ŸÖÿ±Ÿä ÿ•ŸÑŸäŸÉ Ÿàÿ£ÿ≥ÿ™ÿπŸäŸÜ ÿ®ŸÉ.' },
            { id: 'sp_a4', text: 'Ÿäÿß ÿ≠Ÿä Ÿäÿß ŸÇŸäŸàŸÖ ÿ®ÿ±ÿ≠ŸÖÿ™ŸÉ ÿ£ÿ≥ÿ™ÿ∫Ÿäÿ´ ÿ£ÿµŸÑÿ≠ ŸÑŸä ÿ¥ÿ£ŸÜŸä ŸÉŸÑŸá ŸàŸÑÿß ÿ™ŸÉŸÑŸÜŸä ÿ•ŸÑŸâ ŸÜŸÅÿ≥Ÿä ÿ∑ÿ±ŸÅÿ© ÿπŸäŸÜ.' },
            { id: 'sp_a5', text: 'ÿßŸÑŸÑŸáŸÖ ÿßŸÉÿ™ÿ® ŸÑŸä ÿßŸÑÿ™ŸàŸÅŸäŸÇ ŸàÿßŸÉÿ¥ŸÅ ÿπŸÜŸä ÿßŸÑŸáŸÖ ŸàÿßŸÑÿ∫ŸÖ ŸàÿßŸÑŸÇŸÑŸÇ.' },
        ]
    },
    motivation: {
        label: 'ŸÅŸÇÿØÿßŸÜ ÿßŸÑÿØÿßŸÅÿπ', color: '#065f46',
        duas: [
            { id: 'sp_m1', text: 'ÿßŸÑŸÑŸáŸÖ ÿ£ÿπŸÜŸä ÿπŸÑŸâ ÿ∞ŸÉÿ±ŸÉ Ÿàÿ¥ŸÉÿ±ŸÉ Ÿàÿ≠ÿ≥ŸÜ ÿπÿ®ÿßÿØÿ™ŸÉ.' },
            { id: 'sp_m2', text: 'ÿßŸÑŸÑŸáŸÖ ÿ≠ÿ®Ÿëÿ® ÿ•ŸÑŸäŸë ÿßŸÑÿπŸÑŸÖ Ÿàÿ≤ŸäŸëŸÜŸá ŸÅŸä ŸÇŸÑÿ®Ÿä.' },
            { id: 'sp_m3', text: 'ÿßŸÑŸÑŸáŸÖ ÿßÿ¨ÿπŸÑ ŸÑŸä ŸÅŸä ŸÉŸÑ ÿπŸÑŸÖ ŸÜÿµŸäÿ®ÿßŸã ŸàŸÅŸä ŸÉŸÑ ÿÆŸäÿ± ÿ≠ÿ∏ÿßŸã.' },
            { id: 'sp_m4', text: 'ÿßŸÑŸÑŸáŸÖ ÿßÿ±ÿ≤ŸÇŸÜŸä ÿßŸÑŸáŸÖÿ© ÿßŸÑÿπÿßŸÑŸäÿ© ŸàÿßŸÑÿ∑ŸÖŸàÿ≠ ÿßŸÑÿµÿßÿØŸÇ ŸÅŸä ÿ∑ŸÑÿ® ÿßŸÑÿπŸÑŸÖ.' },
        ]
    },
    frustrated: {
        label: 'ÿπŸÜÿØ ÿßŸÑÿ•ÿ≠ÿ®ÿßÿ∑', color: '#9a3412',
        duas: [
            { id: 'sp_f1', text: 'ÿßŸÑŸÑŸáŸÖ ÿ•ŸÜŸä ÿ£ÿ≥ÿ£ŸÑŸÉ ÿ±Ÿàÿ≠ÿßŸã ŸÖŸÜ ÿπŸÜÿØŸÉ Ÿàÿ±ÿ≠ŸÖÿ© Ÿàÿßÿ≥ÿπÿ© ŸàŸÅÿ±ÿ¨ÿßŸã ŸÇÿ±Ÿäÿ®ÿßŸã.' },
            { id: 'sp_f2', text: 'ÿ•ŸÜÿß ŸÑŸÑŸá Ÿàÿ•ŸÜÿß ÿ•ŸÑŸäŸá ÿ±ÿßÿ¨ÿπŸàŸÜÿå ÿßŸÑŸÑŸáŸÖ ÿ£ÿ¨ÿ±ŸÜŸä ŸÅŸä ŸÖÿµŸäÿ®ÿ™Ÿä ŸàÿßÿÆŸÑŸÅ ŸÑŸä ÿÆŸäÿ±ÿßŸã ŸÖŸÜŸáÿß.' },
            { id: 'sp_f3', text: 'ÿßŸÑŸÑŸáŸÖ ŸÑÿß ÿ™ÿ¨ÿπŸÑ ÿßŸÑÿØŸÜŸäÿß ÿ£ŸÉÿ®ÿ± ŸáŸÖŸä ŸàŸÑÿß ŸÖÿ®ŸÑÿ∫ ÿπŸÑŸÖŸä.' },
            { id: 'sp_f4', text: 'Ÿàÿπÿ≥Ÿâ ÿ£ŸÜ ÿ™ŸÉÿ±ŸáŸàÿß ÿ¥Ÿäÿ¶ÿßŸã ŸàŸáŸà ÿÆŸäÿ± ŸÑŸÉŸÖ ‚Äî ÿ£ÿ≠ÿ≥ŸÜ ÿßŸÑÿ∏ŸÜ ÿ®ÿßŸÑŸÑŸá.' },
        ]
    },
    after: {
        label: 'ÿ®ÿπÿØ ÿßŸÑÿ¨ŸÑÿ≥ÿ©', color: '#1e1b6b',
        duas: [
            { id: 'sp_af1', text: 'ÿßŸÑÿ≠ŸÖÿØ ŸÑŸÑŸá ÿßŸÑÿ∞Ÿä ÿ®ŸÜÿπŸÖÿ™Ÿá ÿ™ÿ™ŸÖ ÿßŸÑÿµÿßŸÑÿ≠ÿßÿ™.' },
            { id: 'sp_af2', text: 'ÿßŸÑŸÑŸáŸÖ ÿ®ÿßÿ±ŸÉ ŸÑŸä ŸÅŸäŸÖÿß ÿ™ÿπŸÑŸÖÿ™ Ÿàÿ´ÿ®Ÿëÿ™Ÿá ŸÅŸä ŸÇŸÑÿ®Ÿä.' },
            { id: 'sp_af3', text: 'ÿßŸÑŸÑŸáŸÖ ÿßÿ¨ÿπŸÑ Ÿáÿ∞ÿß ÿßŸÑÿπŸÑŸÖ ÿ≠ÿ¨ÿ© ŸÑŸä ŸÑÿß ÿπŸÑŸäŸë.' },
            { id: 'sp_af4', text: 'ÿßŸÑŸÑŸáŸÖ ÿßÿ¨ÿπŸÑ ÿπŸÖŸÑŸä Ÿáÿ∞ÿß ŸÅŸä ŸÖŸäÿ≤ÿßŸÜ ÿ≠ÿ≥ŸÜÿßÿ™Ÿä.' },
        ]
    },
    doctor: {
        label: 'ÿØÿπÿßÿ° ÿßŸÑÿ∑ÿ®Ÿäÿ®', color: '#065f46',
        duas: [
            { id: 'sp_dr1', text: 'ÿßŸÑŸÑŸáŸÖ ÿßÿ±ÿ≤ŸÇŸÜŸä ÿßŸÑÿ•ÿÆŸÑÿßÿµ ŸÅŸä ÿ™ÿπŸÑŸÖ ÿßŸÑÿ∑ÿ® ŸàÿÆÿØŸÖÿ© ÿßŸÑŸÖÿ±ÿ∂Ÿâ.' },
            { id: 'sp_dr2', text: 'ÿßŸÑŸÑŸáŸÖ ÿßÿ¨ÿπŸÑŸÜŸä ÿ∑ÿ®Ÿäÿ®ÿßŸã ÿ±ÿ≠ŸäŸÖÿßŸã ÿ™ÿ¨ÿπŸÑ ŸäÿØŸäŸë ÿ£ÿØÿßÿ© ÿ¥ŸÅÿßÿ° ÿ®ÿ•ÿ∞ŸÜŸÉ.' },
            { id: 'sp_dr3', text: 'ÿßŸÑŸÑŸáŸÖ ÿßŸÉÿ™ÿ® ŸÑŸä ÿ£ÿ¨ÿ± ŸÉŸÑ ŸÖÿ±Ÿäÿ∂ ÿ£ÿØÿßŸàŸäŸá ŸàŸÉŸÑ ÿ£ŸÑŸÖ ÿ£ÿÆŸÅŸÅŸá.' },
            { id: 'sp_dr4', text: 'ÿßŸÑŸÑŸáŸÖ ÿπŸÑŸÖŸÜŸä ŸÖŸÜ ÿπŸÑŸÖŸÉ ŸÖÿß ŸäŸÜŸÅÿπ ÿπÿ®ÿßÿØŸÉ Ÿàÿßÿ¨ÿπŸÑ ÿπŸÑŸÖŸä ŸÜŸàÿ±ÿßŸã ŸÑŸáŸÖ.' },
            { id: 'sp_dr5', text: 'ÿßŸÑŸÑŸáŸÖ ÿßÿ¨ÿπŸÑŸÜŸä ÿ≥ÿ®ÿ® ÿ¥ŸÅÿßÿ° ŸÑÿß ÿ≥ÿ®ÿ® ÿ£ŸÑŸÖÿå Ÿàÿ≥ÿ®ÿ® ÿ±ÿ≠ŸÖÿ© ŸÑÿß ÿ≥ÿ®ÿ® ŸÖÿπÿßŸÜÿßÿ©.' },
        ]
    },
};

// ‚îÄ‚îÄ Spiritual Tracker State ‚îÄ‚îÄ
let spiritTrack = JSON.parse(localStorage.getItem('nourium_spirit_track') || 'null') || {
    day: '', verse: false, thikr: false, prayer: false, tranq: 3
};
let spiritTrackHistory = JSON.parse(localStorage.getItem('nourium_spirit_history') || '[]');
let spiritFavs = JSON.parse(localStorage.getItem('nourium_spirit_favs') || '[]');
let spiritCat  = 'study';
let sosMuteUntil = 0;

function saveSpiritTrack() {
    localStorage.setItem('nourium_spirit_track', JSON.stringify(spiritTrack));
}
function saveSpiritHistory() {
    localStorage.setItem('nourium_spirit_history', JSON.stringify(spiritTrackHistory));
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
function initSpiritualGuide() {
    // Reset daily tracker if new day
    var today = getTodayKey();
    if (spiritTrack.day !== today) {
        // Archive yesterday
        if (spiritTrack.day) {
            spiritTrackHistory.unshift({ date: spiritTrack.day, tranq: spiritTrack.tranq, verse: spiritTrack.verse, thikr: spiritTrack.thikr, prayer: spiritTrack.prayer });
            if (spiritTrackHistory.length > 30) spiritTrackHistory = spiritTrackHistory.slice(0, 30);
            saveSpiritHistory();
        }
        spiritTrack = { day: today, verse: false, thikr: false, prayer: false, tranq: 3 };
        saveSpiritTrack();
    }

    renderSpiritHero();
    renderSpiritContextBanner();
    renderSpiritDuas('study');
    renderSpiritTracker();
    renderSpiritTranqChart();

    // Yaseen reminder
    if (yaseenReminderOn) {
        var lastShown = localStorage.getItem('nourium_yaseen_shown');
        if (lastShown !== new Date().toDateString()) {
            var card = document.getElementById('yaseenCard');
            if (card) card.style.display = 'block';
        }
    }
}

// ‚îÄ‚îÄ Hero Verse (daily rotation) ‚îÄ‚îÄ
function renderSpiritHero() {
    var dayIdx = new Date().getDate() % QURAN_VERSES.length;
    var v = QURAN_VERSES[dayIdx];
    var vEl = document.getElementById('spiritHeroVerse');
    var rEl = document.getElementById('spiritHeroRef');
    if (vEl) vEl.textContent = v.text;
    if (rEl) rEl.textContent = v.ref;

    // Tranquility in hero pill
    var tEl = document.getElementById('spiritTranqLabel');
    if (tEl) {
        var emojis = ['', 'üòî', 'üòê', 'üôÇ', 'üòä', 'ü§©'];
        tEl.textContent = 'ÿßŸÑÿ∑ŸÖÿ£ŸÜŸäŸÜÿ©: ' + emojis[spiritTrack.tranq];
    }
    // Summary pill
    var sEl = document.getElementById('spiritTrackerSummary');
    if (sEl) {
        var done = [spiritTrack.verse, spiritTrack.thikr, spiritTrack.prayer].filter(Boolean).length;
        sEl.textContent = done === 3 ? '‚úÖ ÿ£ŸÉŸÖŸÑÿ™ ŸäŸàŸÖŸäÿßÿ™ŸÉ ÿßŸÑÿ±Ÿàÿ≠Ÿäÿ©' : done + '/3 ŸÖŸÜ ÿßŸÑŸäŸàŸÖŸäÿ©';
    }
}

// ‚îÄ‚îÄ Context Banner: smart linking ‚îÄ‚îÄ
function renderSpiritContextBanner() {
    var banner = document.getElementById('spiritContextBanner');
    if (!banner) return;

    var todaySessions = sessions.filter(function(s) { return toDateKey(new Date(s.date)) === getTodayKey(); });
    var todayMins = todaySessions.reduce(function(sum, s) { return sum + (s.duration || 0); }, 0);

    var msg = null;
    if (todayMins === 0) {
        msg = { icon: 'üå±', title: 'ŸäŸàŸÖŸÉ ÿ®ÿØÿ£', text: 'ŸÑŸÖ ÿ™ÿØÿ±ÿ≥ ÿ®ÿπÿØ ÿßŸÑŸäŸàŸÖ. ŸÉŸÑ ÿ±ÿ≠ŸÑÿ© ÿ£ŸÑŸÅ ŸÖŸäŸÑ ÿ™ÿ®ÿØÿ£ ÿ®ÿÆÿ∑Ÿàÿ©.', dua: '¬´ÿ±ÿ® ÿßÿ¥ÿ±ÿ≠ ŸÑŸä ÿµÿØÿ±Ÿä ŸàŸäÿ≥ÿ± ŸÑŸä ÿ£ŸÖÿ±Ÿä¬ª' };
    } else if (todayMins >= 240) {
        msg = { icon: 'üèÜ', title: 'ŸÖÿß ÿ¥ÿßÿ° ÿßŸÑŸÑŸá ÿπŸÑŸäŸÉ!', text: 'ÿ£ÿ±ÿ®ÿπ ÿ≥ÿßÿπÿßÿ™ ÿ£Ÿà ÿ£ŸÉÿ´ÿ± ÿßŸÑŸäŸàŸÖ ‚Äî Ÿáÿ∞ÿß ÿ¨ŸáÿØ ŸÖÿ®ÿßÿ±ŸÉ.', dua: '¬´ÿßŸÑÿ≠ŸÖÿØ ŸÑŸÑŸá ÿßŸÑÿ∞Ÿä ÿ®ŸÜÿπŸÖÿ™Ÿá ÿ™ÿ™ŸÖ ÿßŸÑÿµÿßŸÑÿ≠ÿßÿ™¬ª' };
    } else if (streak === 0) {
        msg = { icon: 'ü§ç', title: 'ŸÉŸÑ ŸäŸàŸÖ ÿ®ÿØÿßŸäÿ© ÿ¨ÿØŸäÿØÿ©', text: 'ŸÑÿß ÿ®ÿ£ÿ≥ ‚Äî ŸÉŸÑ ŸÑÿ≠ÿ∏ÿ© ÿµÿßŸÑÿ≠ÿ© ŸÑŸÑÿ®ÿØÿ°. ÿßŸÑŸÑŸá ŸäÿπŸÑŸÖ ŸÜŸäÿ™ŸÉ.', dua: '¬´ÿ™Ÿàÿ®Ÿàÿß ÿ•ŸÑŸâ ÿßŸÑŸÑŸá ÿ™Ÿàÿ®ÿ© ŸÜÿµŸàÿ≠ÿßŸã¬ª' };
    } else if (streak >= 7) {
        msg = { icon: 'üî•', title: streak + ' ÿ£ŸäÿßŸÖ ŸÖÿ™ÿ™ÿßŸÑŸäÿ©!', text: 'ÿßÿ≥ÿ™ŸÖÿ±ÿßÿ±Ÿäÿ™ŸÉ ÿØŸÑŸäŸÑ ÿπŸÑŸâ ÿπÿ≤ŸäŸÖÿ© ÿ≠ŸÇŸäŸÇŸäÿ©.', dua: '¬´ÿßŸÑŸÑŸáŸÖ ÿ£ÿπŸÜŸä ÿπŸÑŸâ ÿ∞ŸÉÿ±ŸÉ Ÿàÿ¥ŸÉÿ±ŸÉ¬ª' };
    }

    if (msg) {
        banner.classList.remove('hidden');
        document.getElementById('scbIcon').textContent  = msg.icon;
        document.getElementById('scbTitle').textContent = msg.title;
        document.getElementById('scbText').textContent  = msg.text;
        document.getElementById('scbDua').textContent   = msg.dua;
    } else {
        banner.classList.add('hidden');
    }
}

// ‚îÄ‚îÄ Dua Library ‚îÄ‚îÄ
function switchSpiritCat(cat, btn) {
    spiritCat = cat;
    document.querySelectorAll('.spirit-cat-pill').forEach(function(b) { b.classList.remove('active'); });
    if (btn) btn.classList.add('active');
    renderSpiritDuas(cat);
}

function renderSpiritDuas(cat) {
    var list = document.getElementById('spiritDuaList');
    if (!list) return;
    if (cat === 'favs') { renderSpiritFavs(); return; }
    var data = SPIRIT_DUAS[cat];
    if (!data) return;

    list.innerHTML = '';
    data.duas.forEach(function(d) {
        var isFav = spiritFavs.includes(d.id);
        var preview = d.text.slice(0, 50) + (d.text.length > 50 ? '...' : '');

        var card = document.createElement('div');
        card.className = 'sdua-card';
        card.id = 'sduac_' + d.id;

        var accent = document.createElement('div');
        accent.className = 'sdua-accent';
        accent.style.background = data.color;

        var topRow = document.createElement('div');
        topRow.style.cssText = 'display:flex;align-items:center;gap:8px;';
        topRow.innerHTML = '<div class="sdua-emoji">ü§≤</div>' +
            '<div class="sdua-preview">' + preview + '</div>' +
            '<span class="sdua-expand-icon">‚ñº</span>';

        var body = document.createElement('div');
        body.className = 'sdua-body';

        var textEl = document.createElement('div');
        textEl.className = 'sdua-text';
        textEl.textContent = d.text;

        var actions = document.createElement('div');
        actions.className = 'sdua-actions';

        var favBtn = document.createElement('button');
        favBtn.className = 'sdua-btn' + (isFav ? ' fav-on' : '');
        favBtn.innerHTML = '<i class="fas fa-star"></i> ' + (isFav ? 'ŸÖÿ≠ŸÅŸàÿ∏' : 'ÿ≠ŸÅÿ∏');
        favBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            toggleSpiritFav(d.id, favBtn);
        });

        var copyBtn = document.createElement('button');
        copyBtn.className = 'sdua-btn';
        copyBtn.innerHTML = '<i class="fas fa-copy"></i> ŸÜÿ≥ÿÆ';
        copyBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            copySpiritDuaById(d.id);
        });

        actions.appendChild(favBtn);
        actions.appendChild(copyBtn);
        body.appendChild(textEl);
        body.appendChild(actions);
        card.appendChild(accent);
        card.appendChild(topRow);
        card.appendChild(body);

        card.addEventListener('click', function(e) {
            toggleSpiritDua(d.id, e);
        });

        list.appendChild(card);
    });
}

function toggleSpiritDua(id, event) {
    var card = document.getElementById('sduac_' + id);
    if (!card) return;
    var wasExpanded = card.classList.contains('expanded');
    document.querySelectorAll('.sdua-card.expanded').forEach(function(c) { c.classList.remove('expanded'); });
    if (!wasExpanded) {
        card.classList.add('expanded');
        var rect = card.getBoundingClientRect();
        var cx = rect.left + rect.width / 2;
        var cy = rect.top + 30;
        var emojis = ['‚ú®','ü§≤','üåô','üí´','‚≠ê','üåü'];
        for (var i = 0; i < 6; i++) {
            (function(idx) {
                var el = document.createElement('div');
                el.className = 'dua-sparkle';
                el.textContent = emojis[idx];
                var angle = (Math.PI * 2 / 6) * idx;
                var dist = 45 + Math.random() * 25;
                el.style.setProperty('--tx', Math.cos(angle) * dist + 'px');
                el.style.setProperty('--ty', (Math.sin(angle) * dist - 15) + 'px');
                el.style.left = cx + 'px';
                el.style.top = cy + 'px';
                el.style.animationDelay = (idx * 0.06) + 's';
                document.body.appendChild(el);
                setTimeout(function() { el.remove(); }, 950);
            })(i);
        }
    }
}

function renderSpiritFavs() {
    var list = document.getElementById('spiritDuaList');
    if (!list) return;
    if (!spiritFavs.length) {
        list.innerHTML = '<div class="empty-state"><i class="fas fa-star"></i><p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ÿØÿπŸäÿ© ŸÖÿ≠ŸÅŸàÿ∏ÿ© ÿ®ÿπÿØ</p><p style="font-size:0.78rem;margin-top:6px;">ÿßÿ∂ÿ∫ÿ∑ ‚≠ê ÿπŸÑŸâ ÿ£Ÿä ÿØÿπÿßÿ° ŸÑÿ≠ŸÅÿ∏Ÿá</p></div>';
        return;
    }
    var allDuas = {};
    Object.values(SPIRIT_DUAS).forEach(function(cat) {
        cat.duas.forEach(function(d) { allDuas[d.id] = { text: d.text, color: cat.color }; });
    });
    list.innerHTML = spiritFavs.map(function(id) {
        var d = allDuas[id];
        if (!d) return '';
        return '<div class="sdua-card">' +
            '<div class="sdua-accent" style="background:' + d.color + ';"></div>' +
            '<div class="sdua-emoji">ü§≤</div>' +
            '<div class="sdua-text">' + d.text + '</div>' +
            '<div class="sdua-actions">' +
                '<button class="sdua-btn fav-on" onclick="toggleSpiritFav(\'' + id + '\',this)">' +
                    '<i class="fas fa-star"></i> ŸÖÿ≠ŸÅŸàÿ∏' +
                '</button>' +
                '<button class="sdua-btn" data-id="' + id + '" onclick="copySpiritDuaById(this.dataset.id)">' +
                    '<i class="fas fa-copy"></i> ŸÜÿ≥ÿÆ' +
                '</button>' +
            '</div>' +
        '</div>';
    }).join('');
}

function toggleSpiritFav(id, btn) {
    var idx = spiritFavs.indexOf(id);
    if (idx === -1) {
        spiritFavs.push(id);
        btn.classList.add('fav-on');
        btn.innerHTML = '<i class="fas fa-star"></i> ŸÖÿ≠ŸÅŸàÿ∏';
        showNotification('‚≠ê ÿ™ŸÖÿ™ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑŸÖŸÅÿ∂ŸÑÿ©', 'success');
    } else {
        spiritFavs.splice(idx, 1);
        btn.classList.remove('fav-on');
        btn.innerHTML = '<i class="fas fa-star"></i> ÿ≠ŸÅÿ∏';
    }
    localStorage.setItem('nourium_spirit_favs', JSON.stringify(spiritFavs));
}

function copySpiritDua(text) {
    safeCopy(text, '‚úÖ ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿØÿπÿßÿ°');
}
function copySpiritDuaById(id) {
    var allDuas = {};
    Object.values(SPIRIT_DUAS).forEach(function(cat) {
        cat.duas.forEach(function(d) { allDuas[d.id] = d.text; });
    });
    var text = allDuas[id];
    if (text) safeCopy(text, '‚úÖ ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿØÿπÿßÿ°');
}

// ‚îÄ‚îÄ Tracker ‚îÄ‚îÄ
function renderSpiritTracker() {
    var items = ['verse', 'thikr', 'prayer'];
    items.forEach(function(k) {
        var el = document.getElementById('st_' + k);
        if (!el) return;
        if (spiritTrack[k]) { el.classList.add('done'); el.textContent = '‚úì'; }
        else { el.classList.remove('done'); el.textContent = ''; }
    });
    var slider = document.getElementById('spiritTranqSlider');
    if (slider) slider.value = spiritTrack.tranq;
    var valEl = document.getElementById('spiritTranqVal');
    if (valEl) {
        var emojis = ['', 'üòî', 'üòê', 'üôÇ', 'üòä', 'ü§©'];
        valEl.textContent = emojis[spiritTrack.tranq];
    }
}

function toggleSpiritTrack(key, el) {
    spiritTrack[key] = !spiritTrack[key];
    if (spiritTrack[key]) { el.classList.add('done'); el.textContent = '‚úì'; }
    else { el.classList.remove('done'); el.textContent = ''; }
    saveSpiritTrack();
    renderSpiritHero();
    showNotification(spiritTrack[key] ? '‚úÖ ÿ™ŸÖ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ' : 'ÿ™ŸÖ ÿßŸÑÿ•ŸÑÿ∫ÿßÿ°', 'success');
}

function onTranqChange(val) {
    spiritTrack.tranq = parseInt(val);
    saveSpiritTrack();
    var emojis = ['', 'üòî', 'üòê', 'üôÇ', 'üòä', 'ü§©'];
    var valEl = document.getElementById('spiritTranqVal');
    if (valEl) valEl.textContent = emojis[spiritTrack.tranq];
    renderSpiritHero();
}

// ‚îÄ‚îÄ Tranquility Chart ‚îÄ‚îÄ
function renderSpiritTranqChart() {
    var wrap = document.getElementById('spiritTranqChart');
    if (!wrap) return;
    var days = [];
    for (var i = 6; i >= 0; i--) {
        var d = new Date(); d.setDate(d.getDate() - i);
        days.push(d);
    }
    var dayNames = ['ÿ£ÿ≠','ŸÜ','ÿ´','ÿ±','ÿÆ','ÿ¨','ÿ≥'];
    wrap.innerHTML = days.map(function(d) {
        var key = toDateKey(d);
        var isToday = key === getTodayKey();
        var tranq = isToday ? spiritTrack.tranq : 0;
        if (!isToday) {
            var hist = spiritTrackHistory.find(function(h) { return h.date === key; });
            if (hist) tranq = hist.tranq;
        }
        var pct = tranq ? (tranq / 5 * 100) : 6;
        var colors = ['', '#ef4444','#f97316','#f59e0b','#84cc16','#22c55e'];
        return '<div class="stchart-col">' +
            '<div class="stchart-bar" style="height:' + pct + '%;background:' + (tranq ? colors[tranq] : 'var(--border)') + ';"></div>' +
            '<div class="stchart-day" style="' + (isToday ? 'color:var(--primary);font-weight:800;' : '') + '">' + dayNames[d.getDay()] + '</div>' +
        '</div>';
    }).join('');
}

// ‚îÄ‚îÄ Now Mode Actions ‚îÄ‚îÄ
function startBreathingExercise() {
    var overlay = document.createElement('div');
    overlay.id = 'breathOverlay';
    overlay.style.cssText = 'position:fixed;inset:0;z-index:500;background:rgba(4,8,16,0.92);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px;';
    var phases = [
        { label: 'ÿßÿ≥ÿ™ŸÜÿ¥ŸÇ...', cls: 'inhale', dur: 4 },
        { label: 'ÿßÿ≠ÿ®ÿ≥...', cls: 'hold', dur: 4 },
        { label: 'ÿ£ÿÆÿ±ÿ¨ ÿßŸÑŸáŸàÿßÿ°...', cls: 'exhale', dur: 4 },
        { label: 'ÿ™ŸàŸÇŸÅ...', cls: 'hold', dur: 4 },
    ];
    var cycle = 0, phase = 0, secs = 0;
    overlay.innerHTML = '<div style="color:rgba(199,210,254,0.5);font-size:0.75rem;margin-bottom:24px;">ÿ™ŸÜŸÅÿ≥ ÿßŸÑÿµŸÜÿØŸàŸÇ ¬∑ 30 ÿ´ÿßŸÜŸäÿ©</div>' +
        '<div id="breathRing" class="sos-breath-ring"><div style="font-size:2rem;" id="breathEmoji">üå¨Ô∏è</div></div>' +
        '<div class="sos-breath-label" id="breathLabel">ÿßÿ≥ÿ™ŸÜÿ¥ŸÇ...</div>' +
        '<div class="sos-step-label" id="breathCount">4</div>' +
        '<button onclick="document.getElementById("breathOverlay").remove()" style="margin-top:32px;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);border-radius:50px;padding:10px 24px;color:rgba(199,210,254,0.6);cursor:pointer;font-family:Tajawal,sans-serif;font-size:0.85rem;">ÿ•ŸÜŸáÿßÿ°</button>';
    document.body.appendChild(overlay);

    var interval = setInterval(function() {
        secs++;
        var p = phases[phase];
        var remaining = p.dur - (secs % p.dur || p.dur);
        var lEl = overlay.querySelector('#breathLabel');
        var cEl = overlay.querySelector('#breathCount');
        if (lEl) lEl.textContent = p.label;
        if (cEl) cEl.textContent = remaining;
        if (secs % p.dur === 0) { phase = (phase + 1) % phases.length; if (phase === 0) cycle++; }
        if (secs >= 30) { clearInterval(interval); setTimeout(function() { overlay.remove(); }, 1000); }
    }, 1000);
}

function showQuickThikr() {
    var thikrs = ['ÿ≥ÿ®ÿ≠ÿßŸÜ ÿßŸÑŸÑŸá Ÿàÿ®ÿ≠ŸÖÿØŸá (100 ŸÖÿ±ÿ©)', 'ŸÑÿß ÿ•ŸÑŸá ÿ•ŸÑÿß ÿßŸÑŸÑŸá Ÿàÿ≠ÿØŸá ŸÑÿß ÿ¥ÿ±ŸäŸÉ ŸÑŸá', 'ÿßÿ≥ÿ™ÿ∫ŸÅÿ± ÿßŸÑŸÑŸá ÿßŸÑÿπÿ∏ŸäŸÖ Ÿàÿ£ÿ™Ÿàÿ® ÿ•ŸÑŸäŸá', 'ÿ≥ÿ®ÿ≠ÿßŸÜ ÿßŸÑŸÑŸáÿå ÿßŸÑÿ≠ŸÖÿØ ŸÑŸÑŸáÿå ÿßŸÑŸÑŸá ÿ£ŸÉÿ®ÿ±'];
    var t = thikrs[Math.floor(Math.random() * thikrs.length)];
    showSpiritQuickModal('üìø ÿ∞ŸÉÿ± ÿ≥ÿ±Ÿäÿπ', t, 'ÿ±ÿØÿØŸáÿß ÿ®ÿ™ÿ£ŸÖŸÑ Ÿàÿ≠ÿ∂Ÿàÿ± ŸÇŸÑÿ®');
}

function showRefocusDua() {
    showSpiritQuickModal('üéØ ÿ•ÿπÿßÿØÿ© ÿ™ÿ±ŸÉŸäÿ≤', 'ÿßŸÑŸÑŸáŸÖ ŸÑÿß ÿ≥ŸáŸÑ ÿ•ŸÑÿß ŸÖÿß ÿ¨ÿπŸÑÿ™Ÿá ÿ≥ŸáŸÑÿßŸã Ÿàÿ£ŸÜÿ™ ÿ™ÿ¨ÿπŸÑ ÿßŸÑÿ≠ÿ≤ŸÜ ÿ•ÿ∞ÿß ÿ¥ÿ¶ÿ™ ÿ≥ŸáŸÑÿßŸã', 'ÿÆÿ∞ ŸÜŸÅÿ≥ÿßŸã ÿπŸÖŸäŸÇÿßŸã ÿ´ŸÖ ÿ±ÿØÿØ Ÿáÿ∞ÿß ÿßŸÑÿØÿπÿßÿ°');
}

function showPreStudyDua() {
    showSpiritQuickModal('üìñ ÿØÿπÿßÿ° ÿßŸÑŸÖÿ∞ÿßŸÉÿ±ÿ©', 'ÿ±ÿ® ÿßÿ¥ÿ±ÿ≠ ŸÑŸä ÿµÿØÿ±Ÿä ŸàŸäÿ≥ÿ± ŸÑŸä ÿ£ŸÖÿ±Ÿä Ÿàÿßÿ≠ŸÑŸÑ ÿπŸÇÿØÿ© ŸÖŸÜ ŸÑÿ≥ÿßŸÜŸä ŸäŸÅŸÇŸáŸàÿß ŸÇŸàŸÑŸä', 'ŸÇŸÑŸáÿß ÿ®ŸÜŸäÿ© ÿµÿßÿØŸÇÿ© ŸÇÿ®ŸÑ ÿßŸÑÿ¥ÿ±Ÿàÿπ ŸÅŸä ÿßŸÑÿØÿ±ÿßÿ≥ÿ©');
}

function closeSpiritQuickModal() { var el = document.getElementById('spiritQuickModal'); if (el) el.remove(); }

function showSpiritQuickModal(title, text, hint) {
    var old = document.getElementById('spiritQuickModal');
    if (old) old.remove();
    var el = document.createElement('div');
    el.id = 'spiritQuickModal';
    el.style.cssText = 'position:fixed;inset:0;z-index:800;background:rgba(0,0,0,0.6);backdrop-filter:blur(6px);display:flex;align-items:flex-end;justify-content:center;';
    el.onclick = function(e) { if (e.target === el) el.remove(); };
    el.innerHTML = '<div style="background:var(--card-bg);border-radius:24px 24px 0 0;padding:24px 20px 36px;width:100%;max-width:480px;box-shadow:0 -8px 40px rgba(0,0,0,0.25);animation:moodSlideUp 0.3s ease;">' +
        '<div style="width:40px;height:4px;border-radius:2px;background:var(--border);margin:0 auto 16px;"></div>' +
        '<div style="font-size:1rem;font-weight:800;color:var(--text);text-align:center;margin-bottom:14px;">' + title + '</div>' +
        '<div style="font-size:1rem;font-weight:700;color:var(--text);line-height:1.9;direction:rtl;text-align:center;background:var(--bg);border-radius:14px;padding:16px 14px;margin-bottom:12px;">' + text + '</div>' +
        '<div style="font-size:0.76rem;color:var(--text-muted);text-align:center;margin-bottom:16px;">' + hint + '</div>' +
        '<button onclick="closeSpiritQuickModal()" style="width:100%;padding:12px;border:none;border-radius:50px;background:var(--primary);color:white;font-size:0.9rem;font-weight:800;cursor:pointer;font-family:Tajawal,sans-serif;">ÿ™ŸÖ ü§ç</button>' +
    '</div>';
    document.body.appendChild(el);
}

// ‚îÄ‚îÄ ŸÖŸÑÿ¨ÿ¶Ÿä ‚Äî SOS ‚îÄ‚îÄ
function openSpiritSOS() {
    var old = document.getElementById('spiritSOSOverlay');
    if (old) old.remove();

    var el = document.createElement('div');
    el.id = 'spiritSOSOverlay';
    el.className = 'spirit-sos-overlay';
    el.style.cssText = 'position:fixed;inset:0;z-index:2000;background:linear-gradient(175deg,#040810 0%,#0a0f1e 50%,#0f1630 100%);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 28px;animation:sosFadeIn 0.4s ease;';

    el.innerHTML =
        '<button onclick="closeSpiritSOS()" style="position:absolute;top:20px;left:20px;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);border-radius:50%;width:38px;height:38px;color:rgba(255,255,255,0.6);cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;">‚úï</button>' +

        '<div style="font-size:0.6rem;letter-spacing:3px;color:rgba(199,210,254,0.35);text-transform:uppercase;margin-bottom:32px;">ŸÖŸÑÿ¨ÿ¶Ÿä</div>' +

        '<div id="sosBreathRing" style="width:110px;height:110px;border-radius:50%;border:1.5px solid rgba(99,102,241,0.3);display:flex;align-items:center;justify-content:center;margin-bottom:10px;position:relative;">' +
            '<div style="font-size:1.8rem;">ü§ç</div>' +
        '</div>' +
        '<div id="sosBreathLabel" style="font-size:0.95rem;font-weight:700;color:#c7d2fe;margin-bottom:4px;">ÿßÿ≥ÿ™ŸÜÿ¥ŸÇ...</div>' +
        '<div id="sosBreathCount" style="font-size:0.75rem;color:rgba(199,210,254,0.4);margin-bottom:36px;">4</div>' +

        '<div style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.07);border-radius:16px;padding:18px 22px;text-align:center;width:100%;margin-bottom:14px;">' +
            '<div style="font-size:1rem;font-weight:700;color:#e0e7ff;line-height:1.9;direction:rtl;">Ô¥ø ÿ≠Ÿéÿ≥Ÿíÿ®ŸèŸÜŸéÿß ÿßŸÑŸÑŸéŸëŸáŸè ŸàŸéŸÜŸêÿπŸíŸÖŸé ÿßŸÑŸíŸàŸéŸÉŸêŸäŸÑŸè Ô¥æ</div>' +
            '<div style="font-size:0.62rem;color:rgba(199,210,254,0.35);margin-top:6px;">ÿ≥Ÿàÿ±ÿ© ÿ¢ŸÑ ÿπŸÖÿ±ÿßŸÜ ‚Äì 173</div>' +
        '</div>' +

        '<div style="background:rgba(99,102,241,0.07);border:1px solid rgba(99,102,241,0.15);border-radius:14px;padding:16px 20px;text-align:center;width:100%;margin-bottom:28px;">' +
            '<div style="font-size:0.9rem;font-weight:700;color:#a5b4fc;line-height:1.9;direction:rtl;">¬´ÿßŸÑŸÑŸáŸÖ ÿ•ŸÜŸä ÿ£ÿ≥ÿ£ŸÑŸÉ ÿßŸÑÿ≥ŸÉŸäŸÜÿ© ŸàÿßŸÑÿ∑ŸÖÿ£ŸÜŸäŸÜÿ© ŸÅŸä ŸÇŸÑÿ®Ÿä¬ª</div>' +
        '</div>' +

        '<button onclick="closeSpiritSOS()" style="width:100%;padding:14px;border:1px solid rgba(99,102,241,0.3);border-radius:50px;background:rgba(99,102,241,0.12);color:#a5b4fc;font-size:0.9rem;font-weight:800;cursor:pointer;font-family:Tajawal,sans-serif;">ÿπÿØÿ™ ÿ•ŸÑŸäŸÉ Ÿäÿß ÿ±ÿ® üïäÔ∏è</button>';

    document.body.appendChild(el);
    sosMuteUntil = Date.now() + 20 * 60 * 1000;

    var p = 0, s = 0;
    var phases = ['inhale','hold','exhale','hold'];
    var phaseLabels = ['ÿßÿ≥ÿ™ŸÜÿ¥ŸÇ...','ÿßÿ≠ÿ®ÿ≥...','ÿ£ÿÆÿ±ÿ¨ ÿßŸÑŸáŸàÿßÿ°...','ÿßÿ≥ŸÉŸÜ...'];
    var labelEl = document.getElementById('sosBreathLabel');
    var countEl = document.getElementById('sosBreathCount');
    var bInterval = setInterval(function() {
        s++;
        var remaining = 4 - (s % 4 || 4);
        if (countEl) countEl.textContent = remaining;
        if (s % 4 === 0) { p = (p+1) % phases.length; if (labelEl) labelEl.textContent = phaseLabels[p]; }
        if (!document.getElementById('spiritSOSOverlay')) clearInterval(bInterval);
    }, 1000);
}

function closeSpiritSOS() {
    var el = document.getElementById('spiritSOSOverlay');
    if (el) { el.style.opacity = '0'; el.style.transition = 'opacity 0.4s'; setTimeout(function() { el.remove(); }, 400); }
}

// ‚îÄ‚îÄ Smart Spiritual Triggers ‚îÄ‚îÄ
function triggerSpiritAfterSession(durationMins) {
    if (durationMins >= 90) {
        setTimeout(function() {
            showSpiritQuickModal('üèÜ ŸÖÿß ÿ¥ÿßÿ° ÿßŸÑŸÑŸá!', 'ÿßŸÑÿ≠ŸÖÿØ ŸÑŸÑŸá ÿßŸÑÿ∞Ÿä ÿ®ŸÜÿπŸÖÿ™Ÿá ÿ™ÿ™ŸÖ ÿßŸÑÿµÿßŸÑÿ≠ÿßÿ™', 'ÿ¨ŸÑÿ≥ÿ© ÿßÿ≥ÿ™ÿ´ŸÜÿßÿ¶Ÿäÿ© ‚Äî ' + durationMins + ' ÿØŸÇŸäŸÇÿ© ŸÖŸÜ ÿßŸÑÿπÿ∑ÿßÿ°');
        }, 3000);
    }
}

function isSpiritMuted() {
    return Date.now() < sosMuteUntil;
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SPIRIT WORLD v2 ‚Äî ŸÜÿ∏ÿßŸÖ ÿßŸÑÿßÿ≥ÿ™ŸÇÿ±ÿßÿ± ÿßŸÑŸÜŸÅÿ≥Ÿä
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ Breath Orb ‚îÄ‚îÄ
var orbBreathingActive = false;
var orbBreathInterval  = null;

function startOrbBreathing() {
    if (orbBreathingActive) { stopOrbBreathing(); return; }
    orbBreathingActive = true;

    var orb      = document.getElementById('spiritOrb');
    var emojiEl  = document.getElementById('spiritOrbEmoji');
    var hintEl   = orb ? orb.querySelector('.spirit-orb-hint') : null;

    if (hintEl) hintEl.textContent = 'ÿßŸÜŸÇÿ± ŸÑŸÑÿ•ŸäŸÇÿßŸÅ';

    var phases = [
        { emoji: 'ü´Å', label: 'ÿßÿ≥ÿ™ŸÜÿ¥ŸÇ...', dur: 4000,
          scale: 'scale(1.25)', color: 'rgba(99,102,241,0.3)' },
        { emoji: '‚è∏Ô∏è', label: 'ÿßÿ≠ÿ®ÿ≥...',   dur: 4000,
          scale: 'scale(1.25)', color: 'rgba(139,92,246,0.25)' },
        { emoji: 'üå¨Ô∏è', label: 'ÿ£ÿÆÿ±ÿ¨...',  dur: 4000,
          scale: 'scale(0.85)', color: 'rgba(99,102,241,0.1)' },
        { emoji: '‚è∏Ô∏è', label: 'ÿ™ŸàŸÇŸÅ...',  dur: 4000,
          scale: 'scale(0.85)', color: 'rgba(139,92,246,0.08)' },
    ];
    var pIdx = 0;

    function runPhase() {
        if (!orbBreathingActive) return;
        var ph = phases[pIdx % phases.length];
        if (emojiEl)  emojiEl.textContent = ph.emoji;
        if (orb) {
            orb.style.transition = 'transform ' + (ph.dur/1000) + 's ease-in-out, background ' + (ph.dur/1000) + 's ease-in-out';
            orb.style.transform  = ph.scale;
            orb.style.background = 'radial-gradient(circle at 38% 35%, ' + ph.color + ', rgba(99,102,241,0.04) 55%, transparent 70%)';
        }
        // Show phase label near orb
        var wrap = document.getElementById('spiritOrbWrap');
        if (wrap) {
            var existing = wrap.querySelector('.orb-phase-label');
            if (existing) existing.remove();
            var lbl = document.createElement('div');
            lbl.className = 'orb-phase-label';
            lbl.style.cssText = 'position:absolute;bottom:-32px;left:50%;transform:translateX(-50%);font-size:0.75rem;font-weight:800;color:rgba(199,210,254,0.6);white-space:nowrap;letter-spacing:1px;';
            lbl.textContent = ph.label;
            wrap.appendChild(lbl);
        }
        pIdx++;
        orbBreathInterval = setTimeout(runPhase, ph.dur);
    }
    runPhase();
}

function stopOrbBreathing() {
    orbBreathingActive = false;
    clearTimeout(orbBreathInterval);
    var orb     = document.getElementById('spiritOrb');
    var emojiEl = document.getElementById('spiritOrbEmoji');
    var hintEl  = orb ? orb.querySelector('.spirit-orb-hint') : null;
    var wrap    = document.getElementById('spiritOrbWrap');

    if (orb) {
        orb.style.transition = 'transform 0.8s ease, background 0.8s ease';
        orb.style.transform  = '';
        orb.style.background = '';
    }
    if (emojiEl) emojiEl.textContent = 'üå¨Ô∏è';
    if (hintEl)  hintEl.textContent  = 'ÿßŸÜŸÇÿ± ŸÑŸÑÿ™ŸÜŸÅÿ≥';
    if (wrap) { var lbl = wrap.querySelector('.orb-phase-label'); if (lbl) lbl.remove(); }
}

// ‚îÄ‚îÄ Spirit √ó Productivity Correlation ‚îÄ‚îÄ
function renderSpiritProdCorrelation() {
    var cont = document.getElementById('spiritProdCard');
    if (!cont) return;

    // Need at least 3 days of tranq data
    if (!spiritTrackHistory || spiritTrackHistory.length < 3) return;

    // Build day map: date ‚Üí { tranq, studyMins }
    var dayMap = {};
    spiritTrackHistory.forEach(function(h) {
        dayMap[h.day] = { tranq: h.tranq || 3, studyMins: 0 };
    });
    sessions.forEach(function(s) {
        var key = toDateKey(new Date(s.date));
        if (dayMap[key]) dayMap[key].studyMins += (s.duration || 0);
    });

    var rows = Object.values(dayMap).filter(function(d) { return d.studyMins > 0; });
    if (rows.length < 2) return;

    // Group by tranq score
    var byTranq = { 1:[], 2:[], 3:[], 4:[], 5:[] };
    rows.forEach(function(r) { byTranq[r.tranq].push(r.studyMins); });

    var avgByTranq = {};
    [1,2,3,4,5].forEach(function(t) {
        if (byTranq[t].length) {
            avgByTranq[t] = Math.round(byTranq[t].reduce(function(a,b){return a+b;},0) / byTranq[t].length);
        }
    });

    // Find best tranq
    var bestTranq = 3;
    var bestMins  = 0;
    Object.keys(avgByTranq).forEach(function(t) {
        if (avgByTranq[t] > bestMins) { bestMins = avgByTranq[t]; bestTranq = parseInt(t); }
    });

    var tranqEmojis = { 1:'üòî', 2:'üòê', 3:'üôÇ', 4:'üòä', 5:'ü§©' };
    var maxMins = Math.max.apply(null, Object.values(avgByTranq).concat([1]));

    var barsHtml = [1,2,3,4,5].map(function(t) {
        var mins = avgByTranq[t] || 0;
        var pct  = Math.round((mins / maxMins) * 100);
        var color = t >= 4 ? '#818cf8' : t === 3 ? '#a78bfa' : 'rgba(199,210,254,0.2)';
        return '<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;">' +
            '<div style="font-size:0.62rem;color:rgba(199,210,254,0.45);font-weight:700;">' + (mins ? Math.round(mins/60*10)/10+'h' : '‚Äî') + '</div>' +
            '<div style="width:100%;height:48px;background:rgba(255,255,255,0.04);border-radius:6px;display:flex;align-items:flex-end;overflow:hidden;">' +
            '<div style="width:100%;height:' + pct + '%;background:' + color + ';border-radius:4px 4px 0 0;transition:height 0.6s ease;"></div>' +
            '</div>' +
            '<div style="font-size:1rem;">' + tranqEmojis[t] + '</div>' +
            '</div>';
    }).join('');

    cont.innerHTML =
        '<div style="font-size:0.8rem;font-weight:800;color:rgba(224,231,255,0.8);margin-bottom:6px;">üîó ÿ∑ŸÖÿ£ŸÜŸäŸÜÿ™ŸÉ √ó ÿ≥ÿßÿπÿßÿ™ ÿØÿ±ÿßÿ≥ÿ™ŸÉ</div>' +
        '<div style="font-size:0.72rem;color:rgba(199,210,254,0.4);margin-bottom:14px;line-height:1.5;">' +
            'ÿ•ŸÜÿ™ÿßÿ¨Ÿäÿ™ŸÉ ÿ£ÿπŸÑŸâ ÿπŸÜÿØŸÖÿß ÿ∑ŸÖÿ£ŸÜŸäŸÜÿ™ŸÉ <strong style="color:#a5b4fc;">' + tranqEmojis[bestTranq] + ' ' + bestTranq + '/5</strong>' +
        '</div>' +
        '<div style="display:flex;align-items:flex-end;gap:8px;height:80px;">' + barsHtml + '</div>';
}

// ‚îÄ‚îÄ Smart Context Banner v2: Ÿäÿ™ŸÉŸäŸÅ ŸÖÿπ ŸÉŸÑ ÿ≠ÿßŸÑÿ© ‚îÄ‚îÄ
function renderSpiritContextBannerV2() {
    var banner = document.getElementById('spiritContextBanner');
    if (!banner) return;

    var todaySessions = sessions.filter(function(s) {
        return toDateKey(new Date(s.date)) === getTodayKey();
    });
    var todayMins = todaySessions.reduce(function(s, x) { return s + (x.duration || 0); }, 0);
    var streakNow = streak || 0;

    var msg = null;

    // No study today
    if (todayMins === 0) {
        msg = { icon:'üå±', title:'ÿßŸÑŸäŸàŸÖ ÿ®ÿØÿ£ ŸÑŸÑÿ™Ÿà', text:'ŸÉŸÑ ÿ±ÿ≠ŸÑÿ© ÿ™ÿ®ÿØÿ£ ÿ®ÿÆÿ∑Ÿàÿ©. ÿßÿ®ÿØÿ£ ÿ¨ŸÑÿ≥ÿ© Ÿàÿßÿ≠ÿØÿ© ÿµÿ∫Ÿäÿ±ÿ©.', dua:'¬´ŸàŸéŸÇŸèŸÑ ÿ±ŸéŸëÿ®ŸêŸë ÿ≤ŸêÿØŸíŸÜŸêŸä ÿπŸêŸÑŸíŸÖŸãÿß¬ª' };
    }
    // Streak just broke (no session yesterday)
    else if (streakNow === 0) {
        msg = { icon:'ü§ç', title:'ŸÑÿß ÿ®ÿ£ÿ≥ÿå ŸÉŸÑŸÜÿß ŸÜÿ™ÿπÿ´ÿ±', text:'ÿßŸÑÿßÿ≥ÿ™ŸÖÿ±ÿßÿ± ŸÖÿπ ÿßŸÑÿπŸÇÿ®ÿßÿ™ ŸáŸà ÿßŸÑÿ•ŸÜÿ¨ÿßÿ≤ ÿßŸÑÿ≠ŸÇŸäŸÇŸä. ÿßÿ®ÿØÿ£ ŸÖŸÜ ÿ¨ÿØŸäÿØ ÿßŸÑŸäŸàŸÖ.', dua:'¬´ÿ•ŸÜŸéŸë ŸÖŸéÿπŸé ÿßŸÑŸíÿπŸèÿ≥Ÿíÿ±Ÿê ŸäŸèÿ≥Ÿíÿ±Ÿãÿß¬ª' };
    }
    // Long session done
    else if (todayMins >= 90) {
        msg = { icon:'‚ú®', title:'ŸÖÿß ÿ¥ÿßÿ° ÿßŸÑŸÑŸá!', text:'ÿ¨ŸÑÿ≥ÿ© ' + Math.round(todayMins/60*10)/10 + ' ÿ≥ÿßÿπÿ© ‚Äî ÿ¨ŸáÿØ ÿ≠ŸÇŸäŸÇŸä Ÿäÿ≥ÿ™ÿ≠ŸÇ ÿßŸÑÿ¥ŸÉÿ±.', dua:'¬´ÿßŸÑÿ≠ŸÖÿØ ŸÑŸÑŸá ÿßŸÑÿ∞Ÿä ÿ®ŸÜÿπŸÖÿ™Ÿá ÿ™ÿ™ŸÖ ÿßŸÑÿµÿßŸÑÿ≠ÿßÿ™¬ª' };
    }
    // Good streak
    else if (streakNow >= 7) {
        msg = { icon:'üî•', title:streakNow + ' ÿ£ŸäÿßŸÖ ŸÖÿ™ÿ™ÿßŸÑŸäÿ©!', text:'Ÿáÿ∞ÿß ÿßŸÑÿ™ÿ≤ÿßŸÖ ŸÜÿßÿØÿ±. ŸÜŸàÿ±Ÿä ŸÅÿÆŸàÿ± ÿ®ŸÉ ÿ¨ÿØÿßŸã.', dua:'¬´ŸÖŸÜ ÿ≥ŸÑŸÉ ÿ∑ÿ±ŸäŸÇÿßŸã ŸäŸÑÿ™ŸÖÿ≥ ŸÅŸäŸá ÿπŸÑŸÖÿßŸã ÿ≥ŸáŸëŸÑ ÿßŸÑŸÑŸá ÿ®Ÿá ÿ∑ÿ±ŸäŸÇÿßŸã ÿ•ŸÑŸâ ÿßŸÑÿ¨ŸÜÿ©¬ª' };
    }

    if (!msg) { banner.classList.add('hidden'); return; }

    banner.classList.remove('hidden');
    document.getElementById('scbIcon').textContent  = msg.icon;
    document.getElementById('scbTitle').textContent = msg.title;
    document.getElementById('scbText').textContent  = msg.text;
    document.getElementById('scbDua').textContent   = msg.dua;
}

// ‚îÄ‚îÄ Override initSpiritualGuide to call new functions ‚îÄ‚îÄ
var _origInitSpirit = typeof initSpiritualGuide === 'function' ? initSpiritualGuide : null;
function initSpiritualGuideV2() {
    if (_origInitSpirit) _origInitSpirit();
    renderSpiritContextBannerV2();
    renderSpiritProdCorrelation();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  REDESIGN v2 ‚Äî New Layout Logic
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ Snapshot Card ‚îÄ‚îÄ
function updateSnapshotCard() {
    const todaySessions = sessions.filter(s => toDateKey(new Date(s.date)) === getTodayKey());
    const todayMins  = todaySessions.reduce((sum, s) => sum + (s.duration || 0), 0);
    const todayHours = (todayMins / 60).toFixed(1);
    const goalMins   = (dailyGoal || 120);
    const pct        = Math.min(100, Math.round((todayMins / goalMins) * 100));

    const level = getCurrentLevel ? getCurrentLevel() : { icon: 'üéì', name: 'ÿßÿ®ÿØÿ£' };

    const snapH  = document.getElementById('snapHours');
    const snapS  = document.getElementById('snapStreak');
    const snapL  = document.getElementById('snapLevel');
    const snapLN = document.getElementById('snapLevelName');
    const snapB  = document.getElementById('snapHoursBar');

    if (snapH)  snapH.textContent  = todayHours;
    if (snapS)  snapS.textContent  = streak + ' üî•';
    if (snapL)  snapL.textContent  = level.icon;
    if (snapLN) snapLN.textContent = level.name;
    if (snapB)  snapB.style.width  = pct + '%';
}

// ‚îÄ‚îÄ System Collapse ‚îÄ‚îÄ
let systemOpen = false;
function toggleSystemCollapse() {
    systemOpen = !systemOpen;
    const body    = document.getElementById('systemBody');
    const chevron = document.getElementById('systemChevron');
    if (body)    body.classList.toggle('open', systemOpen);
    if (chevron) chevron.classList.toggle('open', systemOpen);
}

// ‚îÄ‚îÄ More Menu ‚îÄ‚îÄ
const MORE_SECTIONS = [
    { id: 'profile',      icon: '‚öôÔ∏è',  label: 'ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™' },
    { id: 'notes',        icon: 'üìù',  label: 'ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™'   },
    { id: 'subjects',     icon: 'üìö',  label: 'ŸÖŸàÿßÿØŸä'     },
];

function openMoreMenu() {
    const overlay = document.getElementById('moreMenuOverlay');
    const grid    = document.getElementById('moreMenuGrid');
    if (!overlay || !grid) return;
    grid.innerHTML = MORE_SECTIONS.map(s =>
        `<div class="more-tile" onclick="closeMoreMenu();switchTab('${s.id}',null)">
            <div class="more-tile-icon">${s.icon}</div>
            <div class="more-tile-label">${s.label}</div>
        </div>`
    ).join('');
    overlay.style.display = 'block';
    requestAnimationFrame(() => {
        const sheet = document.getElementById('moreMenuSheet');
        if (sheet) { sheet.style.transform = 'translateY(100%)'; sheet.style.transition = 'transform 0.3s cubic-bezier(.4,0,.2,1)'; }
        requestAnimationFrame(() => { if (sheet) sheet.style.transform = 'translateY(0)'; });
    });
}
function closeMoreMenu() {
    const overlay = document.getElementById('moreMenuOverlay');
    if (overlay) overlay.style.display = 'none';
}

// ‚îÄ‚îÄ Override switchTab to handle new nav & growth hub ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', function() {
    // Patch the existing switchTab to update snapshot & handle nav
    const _baseSwitchTab = window.switchTab;

    window.switchTab = function(tab, el) {
        // Map 'home-center' to 'home'
        if (tab === 'home-center') tab = 'home';

        // Call the base (which handles sections + tab init)
        if (typeof _baseSwitchTab === 'function') _baseSwitchTab(tab, el);

        // Update nav active state for 5-tab nav
        const NAV_MAP = {
            'home': 0, 'spiritual': 4,
            'tasks': 1, 'review': 1,
            'growth': 3, 'analytics': 3, 'tree-section': 3,
            'challenges': 3, 'mood-section': 3, 'balance': 3,
            'exams': 3, 'subjects': 3, 'notes': 3,
            'profile': 3,
        };
        const navItems = document.querySelectorAll('.bottom-nav .nav-item');
        navItems.forEach(n => n.classList.remove('active'));
        const idx = NAV_MAP[tab];
        if (idx !== undefined && navItems[idx]) navItems[idx].classList.add('active');

        if (tab === 'home') updateSnapshotCard();
    };

    // Initial snapshot
    updateSnapshotCard();

    // Patch updateGoalProgress to also refresh snapshot
    const _origGoal = window.updateGoalProgress;
    if (_origGoal) {
        window.updateGoalProgress = function() {
            _origGoal();
            updateSnapshotCard();
        };
    }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NOURI ‚Äî ÿßŸÑÿ£ÿ±ŸÜÿ® ÿßŸÑŸÖÿ±ÿßŸÅŸÇ üêá
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const NOURI_MSGS = {
    start: [
        "ÿ®ÿ≥ŸÖ ÿßŸÑŸÑŸáÿå ŸÑŸÜÿ®ÿØÿ£! ÿ≥ÿ£ŸÉŸàŸÜ ŸáŸÜÿß ÿ∑ŸàÿßŸÑ ÿßŸÑÿ¨ŸÑÿ≥ÿ© ü§´üêæ",
        "ÿßŸÑŸÑŸáŸÖ ÿßŸÜŸÅÿπŸÜŸä ÿ®ŸÖÿß ÿπŸÑŸÖÿ™ŸÜŸä ‚Äî ŸáŸäÿß ŸÜÿ∞ÿßŸÉÿ±! üìñ",
        "ŸÉŸÑ ÿ¨ŸÑÿ≥ÿ© ÿØÿ±ÿßÿ≥ÿ© ŸáŸä ÿÆÿ∑Ÿàÿ© ŸÜÿ≠Ÿà ÿ≠Ÿäÿßÿ© ÿ™ŸÜŸÇÿ∞Ÿáÿß ü©∫",
        "ÿ±ŸÉŸëÿ≤ Ÿàÿ£ŸÜÿß ÿ£ÿ±ÿßŸÇÿ®ŸÉ ÿ®ÿµŸÖÿ™ ‚ú®",
    ],
    running: [
        "ŸÉŸÑ ÿ≥ÿßÿπÿ© ÿØÿ±ÿßÿ≥ÿ© ÿßŸÑŸäŸàŸÖ ŸáŸä ÿ≠Ÿäÿßÿ© ÿ™ŸÜŸÇÿ∞Ÿáÿß ÿ∫ÿØÿßŸã ü©∫",
        "ÿßŸÑÿ™ÿ¥ÿ±Ÿäÿ≠ ÿµÿπÿ®ÿü ÿ£ŸÜÿ™ ÿ£ŸÇŸàŸâ ŸÖŸÜ ÿ£Ÿä ÿπÿ∂ŸÑÿ© ŸÅŸä ÿßŸÑÿ¨ÿ≥ŸÖ üí™",
        "ÿßÿ¥ÿ±ÿ® ŸÇŸÑŸäŸÑÿßŸã ŸÖŸÜ ÿßŸÑŸÖÿßÿ° ‚Äî ÿπŸÇŸÑŸÉ Ÿäÿ≠ÿ™ÿßÿ¨ ÿßŸÑÿ™ÿ±ÿ∑Ÿäÿ® üíß",
        "ŸÜŸàÿ±Ÿä ŸÅÿÆŸàÿ± ÿ®ŸÉ ÿ¨ÿØÿßŸãÿå ÿßÿ≥ÿ™ŸÖÿ± ŸÅŸä ÿßŸÑÿ™ÿ£ŸÑŸÇ ‚ú®",
        "ŸÑÿß ÿ™ŸÇŸÑŸÇ ÿ®ÿ¥ÿ£ŸÜ ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©ÿå ÿ±ŸÉŸëÿ≤ ÿπŸÑŸâ ÿßŸÑÿÆÿ∑Ÿàÿ© ÿßŸÑŸÇÿßÿØŸÖÿ© üèîÔ∏è",
        "ÿπŸÇŸÑŸÉ ŸÖÿ´ŸÑ ÿßŸÑÿπÿ∂ŸÑÿ©ÿå ŸÉŸÑŸÖÿß ŸÖÿ±ŸëŸÜÿ™Ÿá ÿ®ÿ™ÿ±ŸÉŸäÿ≤ ÿ£ÿµÿ®ÿ≠ ÿ£ŸÇŸàŸâ üß†",
        "ÿ£ŸÜÿ™ ŸÑÿß ÿ™ÿØÿ±ÿ≥ ŸÅŸÇÿ∑ÿå ÿ£ŸÜÿ™ ÿ™ÿ®ŸÜŸä ÿ∑ÿ®Ÿäÿ®ÿßŸã ŸäÿπÿßŸÑÿ¨ ÿßŸÑŸÜÿßÿ≥ üíô",
        "ÿ¨ŸÑÿ≥ÿ© Ÿàÿßÿ≠ÿØÿ© ÿ®ÿ™ÿ±ŸÉŸäÿ≤ ÿ™ÿ≥ÿßŸàŸä ÿ´ŸÑÿßÿ´ ÿ¨ŸÑÿ≥ÿßÿ™ ÿ®ÿ™ÿ¥ÿ™ÿ™ üéØ",
    ],
    done: [
        "ÿ£ÿ≠ÿ≥ŸÜÿ™! ÿ¨ŸÑÿ≥ÿ© ÿ±ÿßÿ¶ÿπÿ© ‚Äî ÿßŸÑÿ≠ŸÖÿØ ŸÑŸÑŸá üéâ",
        "ŸÖÿß ÿ¥ÿßÿ° ÿßŸÑŸÑŸá ÿπŸÑŸäŸÉ! ÿßÿ≥ÿ™ÿ±ÿßÿ≠ÿ© ŸÇÿµŸäÿ±ÿ© ÿ™ÿ≥ÿ™ÿ≠ŸÇŸáÿß üåü",
        "ÿ£ŸÉŸÖŸÑÿ™ ÿ¨ŸÑÿ≥ÿ©! Ÿáÿ∞ÿß ÿßÿ≥ÿ™ÿ´ŸÖÿßÿ± ÿ≠ŸÇŸäŸÇŸä ŸÅŸä ŸÖÿ≥ÿ™ŸÇÿ®ŸÑŸÉ üèÜ",
        "ŸÜŸàÿ±Ÿä ŸäÿµŸÅŸÇ ŸÑŸÉ! üëè ÿßÿ≥ÿ™ÿ±ÿ≠ ŸÇÿ®ŸÑ ÿßŸÑÿ¨ŸÑÿ≥ÿ© ÿßŸÑŸÇÿßÿØŸÖÿ©",
    ],
    break: [
        "ŸàŸÇÿ™ ÿßŸÑÿßÿ≥ÿ™ÿ±ÿßÿ≠ÿ© ‚Äî ÿ™ŸÜŸÅŸëÿ≥ Ÿàÿßÿ®ÿ™ÿ≥ŸÖ üåø",
        "Ÿáÿ∞Ÿá ÿßŸÑÿØŸÇÿßÿ¶ŸÇ ÿ™ÿ¥ÿ≠ŸÜ ÿπŸÇŸÑŸÉ ŸÖŸÜ ÿ¨ÿØŸäÿØ ‚ö°",
        "ÿ≠ÿ±ŸëŸÉ ÿ¨ÿ≥ŸÖŸÉ ŸÇŸÑŸäŸÑÿßŸãÿå ÿ≥Ÿäÿ≥ÿßÿπÿØ ÿπŸÑŸâ ÿßŸÑÿ™ÿ±ŸÉŸäÿ≤ üö∂",
    ],
    task: [
        "ŸÖŸáŸÖÿ© ŸÖŸÜÿ¨ÿ≤ÿ©! ŸÉŸÑ ÿÆÿ∑Ÿàÿ© ÿµÿ∫Ÿäÿ±ÿ© ÿ™ŸèŸÇÿ±Ÿëÿ®ŸÉ üéØ",
        "ÿ£ÿ≠ÿ≥ŸÜÿ™! ÿßŸÑŸÖŸáÿßŸÖ ÿßŸÑŸÖŸÜÿ¨ÿ≤ÿ© ÿ™ÿ®ŸÜŸä ÿßŸÑÿ´ŸÇÿ© üí™",
        "ŸÖÿß ÿ¥ÿßÿ° ÿßŸÑŸÑŸá! ŸÜŸàÿ±Ÿä Ÿäÿ≠ÿ™ŸÅŸÑ ÿ®ŸÉ üéä",
    ],
    mood_bad: [
        "ÿ£ÿ≥ŸÖÿπŸÉ ‚Äî ÿßŸÑÿØÿ±ÿßÿ≥ÿ© ÿµÿπÿ®ÿ© ÿ£ÿ≠ŸäÿßŸÜÿßŸãÿå ŸÑŸÉŸÜŸÉ ŸÑÿ≥ÿ™ Ÿàÿ≠ÿØŸÉ ü§ç",
        "ÿÆÿ∞ ŸÜŸÅÿ≥ÿßŸã ÿπŸÖŸäŸÇÿßŸã... ÿ´ŸÖ ÿπŸèÿØ ŸÑŸà ÿ™ÿ≥ÿ™ÿ∑Ÿäÿπ üå¨Ô∏è",
        "ÿ£ŸàŸÇÿßÿ™ ÿßŸÑÿµÿπŸàÿ®ÿ© ÿ™ÿµŸÜÿπ ÿ£ÿ∑ÿ®ÿßÿ° ÿπÿ∏ŸÖÿßÿ°. ÿ´ŸÇ ÿ®ÿßŸÑÿπŸÖŸÑŸäÿ© üíô",
    ],
    mood_good: [
        "Ÿáÿ∞ÿß ÿßŸÑÿ¥ÿπŸàÿ± ÿßŸÑÿ¨ŸäÿØ ‚Äî ÿßÿ≥ÿ™ÿ´ŸÖÿ±Ÿá ÿßŸÑÿ¢ŸÜ ŸÅŸä ÿßŸÑÿØÿ±ÿßÿ≥ÿ©! üî•",
        "ÿ∑ÿßŸÇÿ™ŸÉ ÿπÿßŸÑŸäÿ© ÿßŸÑŸäŸàŸÖÿå ŸáŸäÿß ŸÜÿ≥ÿ™ÿ∫ŸÑŸáÿß üöÄ",
        "ŸÖÿ≤ÿßÿ¨ŸÉ ŸÖŸÖÿ™ÿßÿ≤ = ÿ¨ŸÑÿ≥ÿ© ŸÖÿ´ÿßŸÑŸäÿ©! ŸäÿßŸÑŸÑŸá üí´",
    ],
    idle: [
        "ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ≥ÿ™ÿπÿØ ŸÑÿ¨ŸÑÿ≥ÿ© ÿ¨ÿØŸäÿØÿ©ÿü üêæ",
        "ŸÜŸàÿ±Ÿä ŸäŸÜÿ™ÿ∏ÿ±ŸÉ! ÿßÿ∂ÿ∫ÿ∑ ÿßÿ®ÿØÿ£ ŸÖÿ™Ÿâ ÿ™ÿ¥ÿßÿ° üåü",
        "ÿÆÿ∑Ÿàÿ© Ÿàÿßÿ≠ÿØÿ© ŸÑŸÑÿ£ŸÖÿßŸÖ ÿ£ŸÅÿ∂ŸÑ ŸÖŸÜ ÿßŸÑŸàŸÇŸàŸÅ üèîÔ∏è",
        "Ô¥ø ŸàŸéŸÇŸèŸÑ ÿ±ŸéŸëÿ®ŸêŸë ÿ≤ŸêÿØŸíŸÜŸêŸä ÿπŸêŸÑŸíŸÖŸãÿß Ô¥æ ‚ú®",
    ],
    streak: [
        " ÿ£ŸäÿßŸÖ ŸÖÿ™ÿ™ÿßŸÑŸäÿ©! ÿ£ŸÜÿ™ ÿßÿ≥ÿ™ÿ´ŸÜÿßÿ¶Ÿä ÿ≠ŸÇÿßŸã üî•",
        " ŸäŸàŸÖ ŸÖÿ™ÿ™ÿßŸÑŸä! ŸÑÿß ÿ™ŸÉÿ≥ÿ± Ÿáÿ∞Ÿá ÿßŸÑÿ≥ŸÑÿ≥ŸÑÿ© ÿßŸÑÿ∞Ÿáÿ®Ÿäÿ© ü•á",
    ],
};

let nouriSpeakTimer   = null;
let nouriIdleTimer    = null;
let nouriAutoInterval = null;

function nouriSpeak(text, duration) {
    if (!duration) duration = 6000;
    const bubble = document.getElementById('nouriBubble');
    const svg    = document.getElementById('nouriSvg');
    if (!bubble || !svg) return;
    if (nouriSpeakTimer) clearTimeout(nouriSpeakTimer);
    bubble.textContent = text;
    bubble.classList.add('visible');
    svg.classList.remove('speaking');
    void svg.offsetWidth;
    svg.classList.add('speaking');
    nouriSpeakTimer = setTimeout(function() {
        bubble.classList.remove('visible');
        svg.classList.remove('speaking');
    }, duration);
}

function nouriPick(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
}

function nouriSpeakManual() {
    var msg = isRunning ? nouriPick(NOURI_MSGS.running) : nouriPick(NOURI_MSGS.idle);
    nouriSpeak(msg);
}

function nouriCelebrate() {
    var svg = document.getElementById('nouriSvg');
    if (!svg) return;
    svg.classList.remove('celebrate');
    void svg.offsetWidth;
    svg.classList.add('celebrate');
    setTimeout(function() { svg.classList.remove('celebrate'); }, 2000);
}

function nouriSetMoodColor(score) {
    var fills = document.querySelectorAll('.nouri-body-fill');
    var colorMap = {
        5: ['#6ee7b7', '#a7f3d0'],
        4: ['#a78bfa', '#c4b5fd'],
        3: ['#fcd34d', '#fde68a'],
        2: ['#fb923c', '#fdba74'],
        1: ['#f87171', '#fca5a5'],
    };
    var pair = colorMap[score] || colorMap[4];
    fills.forEach(function(el, i) { el.style.fill = i === 0 ? pair[0] : pair[1]; });
}

function nouriOnTaskDone() {
    setTimeout(function() { nouriSpeak(nouriPick(NOURI_MSGS.task)); }, 300);
}

function nouriOnMoodSaved(score) {
    var msgs = score <= 2 ? NOURI_MSGS.mood_bad : score >= 4 ? NOURI_MSGS.mood_good : null;
    if (msgs) setTimeout(function() { nouriSpeak(nouriPick(msgs), 7000); }, 800);
    nouriSetMoodColor(score);
}

function nouriOnStreak(days) {
    if (days > 1) {
        var msg = days + NOURI_MSGS.streak[days % 2];
        setTimeout(function() { nouriCelebrate(); nouriSpeak(msg, 8000); }, 600);
    }
}

function nouriStartIdleWatch() {
    if (nouriIdleTimer) clearInterval(nouriIdleTimer);
    nouriIdleTimer = setInterval(function() {
        if (!isRunning) nouriSpeak(nouriPick(NOURI_MSGS.idle));
    }, 3600000);
}

// Override toggleTimer to hook start
(function() {
    var _orig = toggleTimer;
    toggleTimer = function() {
        var wasRunning = isRunning;
        _orig();
        if (!wasRunning && isRunning) {
            setTimeout(function() { nouriSpeak(nouriPick(NOURI_MSGS.start)); }, 400);
            if (nouriAutoInterval) clearInterval(nouriAutoInterval);
            nouriAutoInterval = setInterval(function() {
                if (isRunning) nouriSpeak(nouriPick(NOURI_MSGS.running));
            }, 600000);
        }
    };
})();

document.addEventListener('DOMContentLoaded', function() {
    // Greet on load
    setTimeout(function() {
        var greeting = streak > 2
            ? streak + NOURI_MSGS.streak[0]
            : nouriPick(NOURI_MSGS.idle);
        nouriSpeak(greeting, 7000);
    }, 2200);

    // Apply mood color from latest log today
    if (typeof moodLogs !== 'undefined' && moodLogs.length) {
        var last = moodLogs[0];
        if (typeof toDateKey === 'function' && toDateKey(new Date(last.date)) === getTodayKey()) {
            nouriSetMoodColor(last.score);
        }
    }

    nouriStartIdleWatch();
});


function enterFocusMode() {
    document.body.classList.add('focus-mode');
    // ‚úÖ ÿ™ŸÅÿπŸäŸÑ Ÿàÿ∂ÿπ ÿßŸÑÿ¥ÿßÿ¥ÿ© ÿßŸÑŸÉÿßŸÖŸÑÿ© ŸÑÿ™ŸÇŸÑŸäŸÑ ÿßŸÑÿ™ÿ¥ÿ™ÿ™
    try {
        const el = document.documentElement;
        if (el.requestFullscreen) el.requestFullscreen();
        else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
        else if (el.mozRequestFullScreen) el.mozRequestFullScreen();
    } catch(e) {}
}

function exitFocusMode() {
    document.body.classList.remove('focus-mode');
    // ‚úÖ ÿßŸÑÿÆÿ±Ÿàÿ¨ ŸÖŸÜ Ÿàÿ∂ÿπ ÿßŸÑÿ¥ÿßÿ¥ÿ© ÿßŸÑŸÉÿßŸÖŸÑÿ© ÿπŸÜÿØ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑÿ¨ŸÑÿ≥ÿ©
    try {
        if (document.fullscreenElement || document.webkitFullscreenElement) {
            if (document.exitFullscreen) document.exitFullscreen();
            else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
        }
    } catch(e) {}
}

function closeShareModal() {
    const el = document.getElementById('shareOverlay');
    if (el) el.remove();
}

function buildShareText() {
    const d = getShareData();
    return [
        'üéì ÿ•ŸÜÿ¨ÿßÿ≤Ÿä ŸÅŸä Nourium',
        '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
        d.achievement + ' ' + d.achievementLabel,
        'üìö ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ: ' + d.level.name,
        '‚è± ÿ≥ÿßÿπÿßÿ™ ÿßŸÑÿØÿ±ÿßÿ≥ÿ©: ' + d.totalHrs + ' ÿ≥ÿßÿπÿ©',
        '‚úÖ ÿßŸÑŸÖŸáÿßŸÖ ÿßŸÑŸÖŸÜÿ¨ÿ≤ÿ©: ' + d.doneTasks,
        'üî• ÿßŸÑÿ£ŸäÿßŸÖ ÿßŸÑŸÖÿ™ÿ™ÿßŸÑŸäÿ©: ' + streak,
        '‚≠ê ÿßŸÑŸÜŸÇÿßÿ∑: ' + xp + ' XP',
        '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
        'üì± Nourium ‚Äî ŸÖŸÜÿßÿ±ÿ© ÿ∑ÿßŸÑÿ® ÿßŸÑÿ∑ÿ®'
    ].join('\n');
}

function shareAsText() {
    const text = buildShareText();
    safeCopy(text, '‚úÖ ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ•ŸÜÿ¨ÿßÿ≤!');
    closeShareModal();
}

function fallbackCopy(text) {
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.cssText = 'position:fixed;top:-9999px;left:-9999px;opacity:0;';
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    try { document.execCommand('copy'); showNotification('‚úÖ ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ!', 'success'); }
    catch(e) { showNotification('ÿ™ÿπÿ∞Ÿëÿ± ÿßŸÑŸÜÿ≥ÿÆ ‚Äî Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÜÿ≥ÿÆ ŸäÿØŸàŸäÿßŸã', 'warning'); }
    document.body.removeChild(ta);
    closeShareModal();
}

// ÿØÿßŸÑÿ© ŸÜÿ≥ÿÆ ÿ¢ŸÖŸÜÿ© ŸÖŸàÿ≠ÿØÿ© ‚Äî ÿ™ÿπŸÖŸÑ ŸÅŸä ŸÉŸÑ ÿßŸÑÿ®Ÿäÿ¶ÿßÿ™
function safeCopy(text, successMsg) {
    const msg = successMsg || '‚úÖ ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ';
    const doFallback = () => {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.cssText = 'position:fixed;top:-9999px;left:-9999px;opacity:0;';
        document.body.appendChild(ta);
        ta.focus(); ta.select();
        try { document.execCommand('copy'); showNotification(msg, 'success'); }
        catch(e) { showNotification('ÿ™ÿπÿ∞Ÿëÿ± ÿßŸÑŸÜÿ≥ÿÆ ‚Äî ÿßŸÜÿ≥ÿÆ ŸäÿØŸàŸäÿßŸã', 'warning'); }
        document.body.removeChild(ta);
    };

    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(
            () => showNotification(msg, 'success'),
            ()  => doFallback()
        );
    } else {
        doFallback();
    }
}

function shareAsImage() {
    const d       = getShareData();
    const canvas  = document.getElementById('shareCanvas');
    const W = 800, H = 480;
    canvas.width  = W;
    canvas.height = H;
    const ctx     = canvas.getContext('2d');

    // ÿÆŸÑŸÅŸäÿ© ŸÖÿ™ÿØÿ±ÿ¨ÿ©
    const grad = ctx.createLinearGradient(0, 0, W, H);
    grad.addColorStop(0,   '#0A0F1F');
    grad.addColorStop(0.5, '#11183A');
    grad.addColorStop(1,   '#6366F1');
    ctx.fillStyle = grad;
    if (ctx.roundRect) {
        ctx.beginPath(); ctx.roundRect(0, 0, W, H, 32); ctx.fill();
    } else {
        ctx.fillRect(0, 0, W, H);
    }

    // ÿØÿßÿ¶ÿ±ÿ© ÿ∂Ÿàÿ° ÿπŸÑŸàŸäÿ©
    const glow = ctx.createRadialGradient(W - 80, 80, 0, W - 80, 80, 220);
    glow.addColorStop(0, 'rgba(99,102,241,0.25)');
    glow.addColorStop(1, 'rgba(99,102,241,0)');
    ctx.fillStyle = glow;
    ctx.fillRect(0, 0, W, H);

    // ÿ¥ÿπÿßÿ±
    ctx.font = 'bold 18px sans-serif';
    ctx.fillStyle = 'rgba(255,255,255,0.55)';
    ctx.textAlign = 'center';
    ctx.fillText('‚ú¶  NOURIUM  ‚ú¶', W / 2, 52);

    // ÿ£ŸäŸÇŸàŸÜÿ© ÿßŸÑÿ•ŸÜÿ¨ÿßÿ≤
    ctx.font = '90px sans-serif';
    ctx.fillText(d.achievement, W / 2, 170);

    // ÿßŸÑŸÜÿµ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä
    ctx.font = 'bold 34px sans-serif';
    ctx.fillStyle = '#A5B4FC';
    ctx.fillText(d.achievementLabel, W / 2, 230);

    // ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ
    ctx.font = '20px sans-serif';
    ctx.fillStyle = 'rgba(255,255,255,0.75)';
    ctx.fillText(d.level.name, W / 2, 268);

    // ÿÆÿ∑ ŸÅÿßÿµŸÑ
    ctx.strokeStyle = 'rgba(255,255,255,0.15)';
    ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(80, 295); ctx.lineTo(W - 80, 295); ctx.stroke();

    // ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ‚Äî 3 ÿ£ÿπŸÖÿØÿ©
    const cols = [
        { val: d.totalHrs, lbl: 'ÿ≥ÿßÿπÿ© ÿØÿ±ÿßÿ≥ÿ©' },
        { val: xp,         lbl: 'ŸÜŸÇÿ∑ÿ© XP'    },
        { val: streak,     lbl: 'ŸäŸàŸÖ ŸÖÿ™ÿ™ÿßŸÑŸä üî•' },
    ];
    const colW = W / 3;
    cols.forEach((c, i) => {
        const cx = colW * i + colW / 2;
        ctx.font = 'bold 38px sans-serif';
        ctx.fillStyle = '#ffffff';
        ctx.textAlign = 'center';
        ctx.fillText(String(c.val), cx, 358);
        ctx.font = '15px sans-serif';
        ctx.fillStyle = 'rgba(255,255,255,0.6)';
        ctx.fillText(c.lbl, cx, 384);
    });

    // ÿ™ÿ∞ŸäŸäŸÑ
    ctx.font = '14px sans-serif';
    ctx.fillStyle = 'rgba(255,255,255,0.35)';
    ctx.textAlign = 'center';
    ctx.fillText('Nourium ‚Äî ŸÖŸÜÿßÿ±ÿ© ÿ∑ÿßŸÑÿ® ÿßŸÑÿ∑ÿ®', W / 2, H - 22);

    // ÿ™ÿ≠ŸÖŸäŸÑ
    try {
        const link = document.createElement('a');
        link.download = 'nourium-achievement.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
        showNotification('‚úÖ ÿßŸÑÿµŸàÿ±ÿ© ÿ¨ÿßŸáÿ≤ÿ© ‚Äî ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ŸÖÿ¨ŸÑÿØ ÿßŸÑÿ™ŸÜÿ≤ŸäŸÑÿßÿ™', 'success');
        closeShareModal();
    } catch(e) {
        showNotification('ÿ™ÿπÿ∞Ÿëÿ± ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿµŸàÿ±ÿ©', 'error');
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BRAND IDENTITY ‚Äî Splash Screen
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function initSplash() {
    const splash = document.getElementById('splashScreen');
    if (!splash) return;

    // Show splash for 1.6s then fade out
    setTimeout(() => {
        splash.classList.add('hiding');
        setTimeout(() => {
            splash.style.display = 'none';
        }, 650);
    }, 1600);
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BRAND ‚Äî Timer Card Light Wave on Session Start
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Light wave triggers when timer starts
const _brandToggleTimer = window.toggleTimer || toggleTimer;
document.addEventListener('DOMContentLoaded', function() {
    // Light wave on session start via MutationObserver on timer display class
    const timerEl = document.getElementById('timer');
    if (timerEl) {
        const obs = new MutationObserver(() => {
            if (timerEl.classList.contains('running')) {
                const timerCard = document.querySelector('.timer-card');
                if (timerCard) {
                    timerCard.classList.remove('session-active');
                    void timerCard.offsetWidth;
                    timerCard.classList.add('session-active');
                }
            }
        });
        obs.observe(timerEl, { attributes: true, attributeFilter: ['class'] });
    }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BRAND ‚Äî Dark mode on first visit (matches brand identity)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function applyDefaultTheme() {
    const storedTheme = localStorage.getItem('medorus_theme');
    if (!storedTheme) {
        // First visit: apply dark mode as brand default
        document.body.classList.add('dark-mode');
        localStorage.setItem('medorus_theme', 'dark');
        const icon = document.getElementById('themeIcon');
        if (icon) icon.className = 'fas fa-sun';
    }
})();


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SPIRIT WORLD v3 ‚Äî ÿßŸÑÿ±Ÿàÿ≠ ÿßŸÑÿ¨ÿØŸäÿØÿ©
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÜŸäÿßÿ™ ‚îÄ‚îÄ
const NIYYA_TEXTS = [
    'ÿßŸÑŸÑŸáŸÖ ÿ•ŸÜŸä ÿ£ÿ∑ŸÑÿ® ÿßŸÑÿπŸÑŸÖ ÿßÿ®ÿ™ÿ∫ÿßÿ°Ÿã ŸÑŸàÿ¨ŸáŸÉ ÿßŸÑŸÉÿ±ŸäŸÖ',
    'ÿßŸÑŸÑŸáŸÖ ÿßÿ¨ÿπŸÑ Ÿáÿ∞ÿß ÿßŸÑÿπŸÑŸÖ ŸÜŸàÿ±ÿßŸã ŸÅŸä ŸÇŸÑÿ®Ÿä Ÿàÿ≠ÿ¨ÿ©Ÿã ŸÑŸä ŸÑÿß ÿπŸÑŸäŸë',
    'ÿßŸÑŸÑŸáŸÖ ÿ•ŸÜŸä ÿ£ÿ™ÿπŸÑŸÖ ŸÑÿ£ŸÜŸÅÿπ ÿ®Ÿá ÿ£ŸÖÿ™Ÿä Ÿàÿ£ÿ±ÿ∂ŸäŸÉ Ÿäÿß ÿ±ÿ®',
    'ÿßŸÑŸÑŸáŸÖ ÿ®ÿßÿ±ŸÉ ŸÑŸä ŸÅŸä ŸàŸÇÿ™Ÿä ŸàÿπŸÑŸÖŸä Ÿàÿßÿ¨ÿπŸÑŸá ÿÆÿßŸÑÿµÿßŸã ŸÑŸÉ',
    'ÿßŸÑŸÑŸáŸÖ ÿ£ÿπŸÜŸä ÿπŸÑŸâ ÿßŸÑÿπŸÑŸÖ ÿßŸÑÿ∞Ÿä ŸäŸèŸÇÿ±Ÿëÿ®ŸÜŸä ŸÖŸÜŸÉ',
];

// ‚îÄ‚îÄ ÿ®ŸäÿßŸÜÿßÿ™ ÿ¢Ÿäÿßÿ™ ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ ‚îÄ‚îÄ
const WEEKLY_VERSES = [
    { text: 'Ô¥ø ŸàŸéŸÇŸèŸÑ ÿ±ŸéŸëÿ®ŸêŸë ÿ≤ŸêÿØŸíŸÜŸêŸä ÿπŸêŸÑŸíŸÖŸãÿß Ô¥æ', ref: 'ÿ≥Ÿàÿ±ÿ© ÿ∑Ÿá ‚Äì ÿßŸÑÿ¢Ÿäÿ© 114', tafsir: 'ÿßŸÑÿπŸÑŸÖ ŸÜŸàÿ± ŸäŸèÿ∂ÿßÿ° ÿ®Ÿá ÿßŸÑŸÇŸÑÿ®. ÿßÿ¨ÿπŸÑ ÿ∑ŸÑÿ®ŸÉ ŸÑŸá ÿÆÿßŸÑÿµÿßŸã ŸÑŸàÿ¨Ÿá ÿßŸÑŸÑŸá.' },
    { text: 'Ô¥ø ŸäŸéÿ±ŸíŸÅŸéÿπŸê ÿßŸÑŸÑŸéŸëŸáŸè ÿßŸÑŸéŸëÿ∞ŸêŸäŸÜŸé ÿ¢ŸÖŸéŸÜŸèŸàÿß ŸÖŸêŸÜŸÉŸèŸÖŸí ŸàŸéÿßŸÑŸéŸëÿ∞ŸêŸäŸÜŸé ÿ£ŸèŸàÿ™ŸèŸàÿß ÿßŸÑŸíÿπŸêŸÑŸíŸÖŸé ÿØŸéÿ±Ÿéÿ¨Ÿéÿßÿ™Ÿç Ô¥æ', ref: 'ÿ≥Ÿàÿ±ÿ© ÿßŸÑŸÖÿ¨ÿßÿØŸÑÿ© ‚Äì ÿßŸÑÿ¢Ÿäÿ© 11', tafsir: 'ÿ±ŸÅÿπÿ© ÿßŸÑÿØÿ±ÿ¨ÿßÿ™ ŸÅŸä ÿßŸÑÿØŸÜŸäÿß ŸàÿßŸÑÿ¢ÿÆÿ±ÿ© ŸàÿπÿØŸå ÿ•ŸÑŸáŸäŸå ŸÑÿ∑ÿßŸÑÿ® ÿßŸÑÿπŸÑŸÖ ÿßŸÑŸÖÿÆŸÑÿµ.' },
    { text: 'Ô¥ø ÿ•ŸêŸÜŸéŸë ŸÖŸéÿπŸé ÿßŸÑŸíÿπŸèÿ≥Ÿíÿ±Ÿê ŸäŸèÿ≥Ÿíÿ±Ÿãÿß Ô¥æ', ref: 'ÿ≥Ÿàÿ±ÿ© ÿßŸÑÿ¥ÿ±ÿ≠ ‚Äì ÿßŸÑÿ¢Ÿäÿ© 6', tafsir: 'ŸÖÿπ ŸÉŸÑ ÿµÿπŸàÿ®ÿ© ŸäŸÖÿ± ÿ®ŸÉ ŸÅÿ±ÿ¨Ÿå ŸÇÿßÿØŸÖ. ÿßŸÑŸÑŸá ŸÑÿß ŸäŸèÿ∂Ÿäÿπ ÿ¨ŸáÿØ ŸÖŸÜ ÿ¨ÿßŸáÿØ.' },
    { text: 'Ô¥ø ŸàŸéŸÖŸéŸÜ ŸäŸéÿ™ŸéŸëŸÇŸê ÿßŸÑŸÑŸéŸëŸáŸé ŸäŸéÿ¨ŸíÿπŸéŸÑ ŸÑŸéŸëŸáŸè ŸÖŸéÿÆŸíÿ±Ÿéÿ¨Ÿãÿß Ô¥æ', ref: 'ÿ≥Ÿàÿ±ÿ© ÿßŸÑÿ∑ŸÑÿßŸÇ ‚Äì ÿßŸÑÿ¢Ÿäÿ© 2', tafsir: 'ÿßŸÑÿ™ŸÇŸàŸâ ŸÖŸÅÿ™ÿßÿ≠ ÿßŸÑŸÅÿ±ÿ¨. ÿ•ÿ∞ÿß ÿ£ÿπŸäŸäÿ™ŸÉ ÿßŸÑŸÖÿ≥ÿ£ŸÑÿ© ŸÅÿ™ÿ∞ŸÉŸëÿ± ÿ±ÿ®ŸÉ.' },
    { text: 'Ô¥ø ŸÅŸéÿßÿ∞ŸíŸÉŸèÿ±ŸèŸàŸÜŸêŸä ÿ£Ÿéÿ∞ŸíŸÉŸèÿ±ŸíŸÉŸèŸÖŸí Ô¥æ', ref: 'ÿ≥Ÿàÿ±ÿ© ÿßŸÑÿ®ŸÇÿ±ÿ© ‚Äì ÿßŸÑÿ¢Ÿäÿ© 152', tafsir: 'ÿßŸÑÿ∞ŸÉÿ± ŸÅŸä ŸÑÿ≠ÿ∏ÿßÿ™ ÿßŸÑÿØÿ±ÿßÿ≥ÿ© ŸäŸèŸÜŸäÿ± ÿßŸÑÿ∞ŸáŸÜ ŸàŸäŸèÿ´ÿ®Ÿëÿ™ ÿßŸÑÿ≠ŸÅÿ∏.' },
];

// ‚îÄ‚îÄ ÿ®ŸäÿßŸÜÿßÿ™ ÿ£ÿØÿπŸäÿ© ÿ∑ÿßŸÑÿ®ÿ© ÿßŸÑÿπŸÑŸÖ ‚îÄ‚îÄ
const STUDY_DUAS_DATA = [
    {
        id: 'sd_before', icon: 'üìñ', title: 'ŸÇÿ®ŸÑ ÿßŸÑŸÖÿ∞ÿßŸÉÿ±ÿ©', hint: 'ÿßŸÜŸÇÿ± ŸÑÿπÿ±ÿ∂ ÿßŸÑÿØÿπÿßÿ°',
        dua: 'ÿßŸÑŸÑŸáŸÖ ÿ•ŸÜŸä ÿ£ÿ≥ÿ£ŸÑŸÉ ŸÅŸáŸÖÿßŸã ŸÅŸä ÿßŸÑŸÇÿ±ÿ¢ŸÜÿå Ÿàÿ≠ŸÅÿ∏ÿßŸã ŸÑŸÑÿπŸÑŸÖÿå Ÿàÿ™Ÿäÿ≥Ÿäÿ±ÿßŸã ŸÅŸä ÿßŸÑÿ£ŸÖÿ±. ÿ±ÿ® ÿßÿ¥ÿ±ÿ≠ ŸÑŸä ÿµÿØÿ±Ÿä ŸàŸäÿ≥ÿ± ŸÑŸä ÿ£ŸÖÿ±Ÿä.'
    },
    {
        id: 'sd_forget', icon: 'üß†', title: 'ÿπŸÜÿØ ÿßŸÑŸÜÿ≥ŸäÿßŸÜ', hint: 'ÿßŸÜŸÇÿ± ŸÑÿπÿ±ÿ∂ ÿßŸÑÿØÿπÿßÿ°',
        dua: 'ÿßŸÑŸÑŸáŸÖ Ÿäÿß ŸÖÿπŸÑŸÖ ÿ¢ÿØŸÖ ÿπŸÑŸëŸÖŸÜŸäÿå ŸàŸäÿß ŸÖŸÅŸáŸëŸÖ ÿ≥ŸÑŸäŸÖÿßŸÜ ŸÅŸáŸëŸÖŸÜŸäÿå Ÿàÿ£ÿπÿØ ŸÖÿß ŸÜÿ≥Ÿäÿ™ ÿ•ŸÑŸäŸë ÿ®ÿ±ÿ≠ŸÖÿ™ŸÉ Ÿäÿß ÿ£ÿ±ÿ≠ŸÖ ÿßŸÑÿ±ÿßÿ≠ŸÖŸäŸÜ.'
    },
    {
        id: 'sd_after', icon: '‚úÖ', title: 'ÿ®ÿπÿØ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°', hint: 'ÿßŸÜŸÇÿ± ŸÑÿπÿ±ÿ∂ ÿßŸÑÿØÿπÿßÿ°',
        dua: 'ÿßŸÑÿ≠ŸÖÿØ ŸÑŸÑŸá ÿßŸÑÿ∞Ÿä ÿ®ŸÜÿπŸÖÿ™Ÿá ÿ™ÿ™ŸÖ ÿßŸÑÿµÿßŸÑÿ≠ÿßÿ™. ÿßŸÑŸÑŸáŸÖ ÿ®ÿßÿ±ŸÉ ŸÑŸä ŸÅŸäŸÖÿß ÿ™ÿπŸÑŸÖÿ™ Ÿàÿ´ÿ®Ÿëÿ™Ÿá ŸÅŸä ŸÇŸÑÿ®Ÿä Ÿàÿßÿ¨ÿπŸÑŸá ŸÜŸàÿ±ÿßŸã ŸäŸáÿØŸäŸÜŸä.'
    },
    {
        id: 'sd_hard', icon: 'üí°', title: 'ÿπŸÜÿØ ÿµÿπŸàÿ®ÿ© ÿßŸÑŸÅŸáŸÖ', hint: 'ÿßŸÜŸÇÿ± ŸÑÿπÿ±ÿ∂ ÿßŸÑÿØÿπÿßÿ°',
        dua: 'ÿßŸÑŸÑŸáŸÖ ŸÑÿß ÿ≥ŸáŸÑ ÿ•ŸÑÿß ŸÖÿß ÿ¨ÿπŸÑÿ™Ÿá ÿ≥ŸáŸÑÿßŸãÿå Ÿàÿ£ŸÜÿ™ ÿ™ÿ¨ÿπŸÑ ÿßŸÑÿ≠ÿ≤ŸÜ ÿ•ÿ∞ÿß ÿ¥ÿ¶ÿ™ ÿ≥ŸáŸÑÿßŸã. Ÿäÿ≥Ÿëÿ± ŸÑŸä Ÿáÿ∞ÿß ÿßŸÑÿπŸÑŸÖ ÿ®ÿ±ÿ≠ŸÖÿ™ŸÉ.'
    },
];

// ‚îÄ‚îÄ ÿ≠ÿßŸÑÿ© ÿπÿØÿßÿØ ÿßŸÑÿ∞ŸÉÿ± ‚îÄ‚îÄ
let thikrState = JSON.parse(localStorage.getItem('nourium_thikr_v3') || 'null') || {
    day: '', tasbih: 0, salah: 0
};

function saveThikrState() {
    thikrState.day = new Date().toDateString();
    localStorage.setItem('nourium_thikr_v3', JSON.stringify(thikrState));
}

function checkThikrDayReset() {
    if (thikrState.day !== new Date().toDateString()) {
        thikrState.tasbih = 0;
        thikrState.salah  = 0;
        thikrState.day    = new Date().toDateString();
        saveThikrState();
    }
}

function incrementThikr(type) {
    checkThikrDayReset();
    thikrState[type]++;
    saveThikrState();
    var el = document.getElementById(type === 'tasbih' ? 'thikrTasbih' : 'thikrSalah');
    if (el) {
        el.textContent = thikrState[type];
        el.style.transform = 'scale(1.3)';
        setTimeout(function() { el.style.transform = 'scale(1)'; }, 150);
        el.style.transition = 'transform 0.15s ease';
    }
}

function resetThikr() {
    if (!confirm('ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿπÿØÿßÿØ ÿßŸÑÿ∞ŸÉÿ± ŸÑŸáÿ∞ÿß ÿßŸÑŸäŸàŸÖÿü')) return;
    thikrState.tasbih = 0;
    thikrState.salah  = 0;
    saveThikrState();
    renderThikrCounts();
}

function renderThikrCounts() {
    checkThikrDayReset();
    var t = document.getElementById('thikrTasbih');
    var s = document.getElementById('thikrSalah');
    if (t) t.textContent = thikrState.tasbih;
    if (s) s.textContent = thikrState.salah;
}

// ‚îÄ‚îÄ ÿßŸÑŸÜŸäÿ© ‚îÄ‚îÄ
let niyyaIndex = parseInt(localStorage.getItem('nourium_niyya_idx') || '0');

function renewNiyya() {
    niyyaIndex = (niyyaIndex + 1) % NIYYA_TEXTS.length;
    localStorage.setItem('nourium_niyya_idx', niyyaIndex);
    var el = document.getElementById('spNiyyaText');
    if (!el) return;
    el.style.opacity = '0';
    setTimeout(function() {
        el.textContent = NIYYA_TEXTS[niyyaIndex];
        el.style.opacity = '1';
    }, 250);
}

function renderNiyya() {
    var el = document.getElementById('spNiyyaText');
    if (el) el.textContent = NIYYA_TEXTS[niyyaIndex];
}

// ‚îÄ‚îÄ ÿ¢Ÿäÿ© ÿßŸÑÿ£ÿ≥ÿ®Ÿàÿπ ‚îÄ‚îÄ
function renderWeekVerse() {
    var weekNum = Math.floor(Date.now() / (7 * 24 * 3600 * 1000)) % WEEKLY_VERSES.length;
    var v = WEEKLY_VERSES[weekNum];
    var t = document.getElementById('spWeekVerseText');
    var r = document.getElementById('spWeekVerseRef');
    var tf = document.getElementById('spWeekVerseTafsir');
    if (t) t.textContent = v.text;
    if (r) r.textContent = v.ref;
    if (tf) tf.textContent = v.tafsir;
}

// ‚îÄ‚îÄ ÿ≤ÿßÿØ ÿ∑ÿßŸÑÿ®ÿ© ÿßŸÑÿπŸÑŸÖ ‚îÄ‚îÄ
function renderStudyDuas() {
    var grid = document.getElementById('spStudyDuasGrid');
    if (!grid) return;
    grid.innerHTML = '';
    STUDY_DUAS_DATA.forEach(function(d) {
        var card = document.createElement('div');
        card.className = 'sp-dua-card';
        card.id = 'spdua_' + d.id;

        var iconEl = document.createElement('div');
        iconEl.className = 'sp-dua-icon';
        iconEl.textContent = d.icon;

        var titleEl = document.createElement('div');
        titleEl.className = 'sp-dua-title';
        titleEl.textContent = d.title;

        var hintEl = document.createElement('div');
        hintEl.className = 'sp-dua-hint';
        hintEl.textContent = d.hint;

        var body = document.createElement('div');
        body.className = 'sp-dua-body';

        var textEl = document.createElement('div');
        textEl.className = 'sp-dua-full-text';
        textEl.textContent = d.dua;

        var copyBtn = document.createElement('button');
        copyBtn.className = 'sp-dua-copy-btn';
        copyBtn.innerHTML = 'üìã ŸÜÿ≥ÿÆ';
        copyBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            safeCopy(d.dua, '‚úÖ ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿØÿπÿßÿ°');
        });

        body.appendChild(textEl);
        body.appendChild(copyBtn);
        card.appendChild(iconEl);
        card.appendChild(titleEl);
        card.appendChild(hintEl);
        card.appendChild(body);

        card.addEventListener('click', function() { toggleStudyDua(d.id, card); });
        grid.appendChild(card);
    });
}

function toggleStudyDua(id, card) {
    var wasOpen = card.classList.contains('open');
    document.querySelectorAll('.sp-dua-card.open').forEach(function(c) { c.classList.remove('open'); });
    if (!wasOpen) {
        card.classList.add('open');
        // ÿßÿ≠ÿ™ŸÅÿßÿ°
        var rect = card.getBoundingClientRect();
        var cx = rect.left + rect.width / 2, cy = rect.top + 20;
        ['‚ú®','ü§≤','üí´','üåô'].forEach(function(e, i) {
            var el = document.createElement('div');
            el.className = 'sp-dua-sparkle';
            el.textContent = e;
            var angle = (Math.PI * 2 / 4) * i;
            el.style.setProperty('--tx', Math.cos(angle) * 40 + 'px');
            el.style.setProperty('--ty', (Math.sin(angle) * 35 - 10) + 'px');
            el.style.left = cx + 'px'; el.style.top = cy + 'px';
            el.style.animationDelay = (i * 0.07) + 's';
            document.body.appendChild(el);
            setTimeout(function() { el.remove(); }, 900);
        });
    }
}

// ‚îÄ‚îÄ initSpiritV3 ‚îÄ‚îÄ
function initSpiritV3() {
    renderNiyya();
    renderWeekVerse();
    renderStudyDuas();
    renderThikrCounts();
}

// ‚îÄ‚îÄ ÿßÿ≠ÿ™ÿ≥ÿßÿ® ÿßŸÑÿ£ÿ¨ÿ± ‚îÄ‚îÄ
let ihtisabOn = false;

function toggleIhtisab() {
    ihtisabOn = !ihtisabOn;
    var check = document.getElementById('ihtisabCheck');
    var label = document.getElementById('ihtisabLabel');
    if (check) { check.textContent = ihtisabOn ? '‚úì' : ''; check.classList.toggle('on', ihtisabOn); }
    if (label) { label.classList.toggle('on', ihtisabOn); }
}

function showIhtisabDoneBanner() {
    if (!ihtisabOn) return;
    ihtisabOn = false;
    var check = document.getElementById('ihtisabCheck');
    var label = document.getElementById('ihtisabLabel');
    if (check) { check.textContent = ''; check.classList.remove('on'); }
    if (label) { label.classList.remove('on'); }

    // ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ®ÿßŸÜÿ± ÿ£ÿ≥ŸÅŸÑ ÿßŸÑŸÖÿ§ŸÇÿ™
    var existing = document.getElementById('ihtisabDoneBanner');
    if (existing) existing.remove();
    var banner = document.createElement('div');
    banner.id = 'ihtisabDoneBanner';
    banner.className = 'ihtisab-done-banner';
    banner.innerHTML = '<div class="ihtisab-done-text">ŸÉÿ™ÿ® ÿßŸÑŸÑŸá ŸÑŸÉ ÿ£ÿ¨ÿ± ŸÜŸäÿ™ŸÉ ü§ç<br><span style="font-size:0.78rem;opacity:0.7;">Ÿàÿ•ŸÜ ÿ¥ÿßÿ° ÿßŸÑŸÑŸá ÿ™Ÿèÿ±ŸÅÿπ ÿØÿ±ÿ¨ÿ™ŸÉ ÿ®ŸÖÿß ÿßÿ≠ÿ™ÿ≥ÿ®ÿ™</span></div>';
    var wrap = document.getElementById('ihtisabWrap');
    if (wrap && wrap.parentNode) {
        wrap.parentNode.insertBefore(banner, wrap.nextSibling);
        setTimeout(function() { if (banner.parentNode) banner.remove(); }, 6000);
    }
}

</script>

<!-- Firebase v8 (Stable for local files) -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>

<script>
  window.addEventListener("load", function() {

    if (typeof firebase === "undefined") {
      console.error("Firebase did NOT load ‚ùå");
      return;
    }

    const firebaseConfig = {
      apiKey: "AIzaSyDorbb8nLo4y_YK4o3DGx1aQFS4DmJ6yK4",
      authDomain: "nourium-study-app-8eadd.firebaseapp.com",
      projectId: "nourium-study-app-8eadd",
      storageBucket: "nourium-study-app-8eadd.appspot.com",
      messagingSenderId: "520628377794",
      appId: "1:520628377794:web:cc099110b4f23d51fc035b"
    };

    firebase.initializeApp(firebaseConfig);

    console.log("Firebase Connected ‚úÖ");

  });
</script>
<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDorbb8nLo4y_YK4o3DGx1aQFS4DmJ6yK4",
    authDomain: "nourium-study-app-8eadd.firebaseapp.com",
    projectId: "nourium-study-app-8eadd",
    storageBucket: "nourium-study-app-8eadd.appspot.com",
    messagingSenderId: "520628377794",
    appId: "1:520628377794:web:cc099110b4f23d51fc035b"
  };

  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.firestore();

  console.log("Firebase Connected ‚úÖ");
</script>
</body>
</html>
